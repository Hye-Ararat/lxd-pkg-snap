name: lxd
base: core18
assumes:
  - snapd2.39
version: "4.10"
grade: stable
summary: LXD - the container lightervisor
description: |-
 LXD is a container manager for system containers.

 It offers a REST API to remotely manage containers over the network,
 using an image based workflow and with support for live migration.

 Images are available for all Ubuntu releases and architectures as well
 as for a wide number of other Linux distributions.

 LXD containers are lightweight, secure by default and a great
 alternative to virtual machines.


 Supported configuration options (snap set lxd [<key>=<value>...]):

   - ceph.builtin: Use snap-specific Ceph configuration [default=false]
   - ceph.external: Use the system's ceph tools (ignores ceph.builtin) [default=false]
   - criu.enable: Enable experimental live-migration support [default=false]
   - daemon.debug: Increase logging to debug level [default=false]
   - daemon.group: Set group of users that can interact with LXD [default=lxd]
   - daemon.preseed: Pass a YAML configuration to `lxd init` on initial start
   - daemon.syslog: Send LXD log events to syslog [default=false]
   - lvm.external: Use the system's LVM tools [default=false]
   - lxcfs.pidfd: Start per-container process tracking [default=false]
   - lxcfs.loadavg: Start tracking per-container load average [default=false]
   - lxcfs.cfs: Consider CPU shares for CPU usage [default=false]
   - openvswitch.builtin: Run a snap-specific OVS daemon [default=false]
   - shiftfs.enable: Enable shiftfs support [default=auto]

confinement: strict

apps:
  # Main commands
  activate:
    command: commands/daemon.activate
    daemon: oneshot
    plugs:
      - lxd-support
      - system-observe

  daemon:
    command: commands/daemon.start
    reload-command: commands/daemon.reload
    stop-command: commands/daemon.stop
    stop-timeout: 600s
    restart-condition: on-failure
    daemon: simple
    slots: [lxd]
    plugs:
      - lxd-support
      - network-bind
      - system-observe
    sockets:
      unix:
        listen-stream: $SNAP_COMMON/lxd/unix.socket
        socket-mode: 0660

  lxc:
    command: commands/lxc
    completer: etc/bash_completion.d/snap.lxd.lxc
    plugs:
      - lxd-support
      - system-observe

  lxd:
    command: commands/lxd
    plugs:
      - lxd-support
      - system-observe

  # Sub-commands
  benchmark:
    command: commands/lxd-benchmark
    plugs:
      - lxd-support
      - system-observe
  buginfo:
    command: commands/buginfo
    plugs:
      - lxd-support
      - system-observe
  check-kernel:
    command: commands/lxd-check-kernel
    plugs:
      - lxd-support
      - system-observe
  lxc-to-lxd:
    command: commands/lxc-to-lxd
    plugs:
      - lxd-support
      - system-observe
  migrate:
    command: commands/lxd-migrate
    plugs:
      - lxd-support
      - system-observe

hooks:
  configure:
    plugs:
      - network
      - system-observe
  remove:
    plugs:
      - lxd-support
      - system-observe

parts:
  # Dependencies
  btrfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - btrfs-tools
    prime:
      - bin/btrfs
      - bin/btrfstune
      - bin/mkfs.btrfs

  ceph:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ceph-common
      - libdb5.3
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/ceph
      - bin/python
      - bin/python2*
      - bin/rbd
      - lib/python2.7
      - lib/*/libpython2.7.so*
      - -lib/python2.7/sitecustomize.py
      - lib/*/ceph
      - lib/*/libboost_iostreams.so.*
      - lib/*/libboost_program_options.so.*
      - lib/*/libboost_random.so.*
      - lib/*/libboost_regex.so.*
      - lib/*/libboost_system.so.*
      - lib/*/libboost_thread.so.*
      - lib/*/libcephfs*
      - lib/*/libdb-5.3.so
      - lib/*/libicudata.so.*
      - lib/*/libicui18n.so.*
      - lib/*/libicuuc.so.*
      - lib/*/libnspr4.so
      - lib/*/libnss3.so
      - lib/*/libibverbs.so*
      - lib/*/nss/libsoftokn3.so
      - lib/*/nss/libfreeblpriv3.so
      - lib/*/libnssutil3.so
      - lib/*/libplc4.so
      - lib/*/libplds4.so
      - lib/*/librados.so.*
      - lib/*/librbd.so.*
      - lib/*/libsmime3.so
      - lib/*/libsnappy*

  criu:
    source: https://github.com/checkpoint-restore/criu
    source-tag: v3.15
    source-type: git
    source-depth: 1
    plugin: nil
    build-packages:
      - asciidoc
      - libcap-dev
      - libnet1-dev
      - libnl-3-dev
      - libprotobuf-c-dev
      - libprotobuf-dev
      - protobuf-c-compiler
      - protobuf-compiler
      - python
      - xmlto
    stage-packages:
      - libnet1
      - libprotobuf-c1
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "armv7l" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      make
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/criu/"
      cp criu/criu "${SNAPCRAFT_PART_INSTALL}/criu/"
    organize:
      usr/lib/: lib/
    prime:
      - criu/*
      - lib/*/libnet*
      - lib/*/libproto*

  dqlite:
    after:
      - raft
      - sqlite
    source: https://github.com/canonical/dqlite
    source-type: git
    source-depth: 1
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libdqlite*so*
      - lib/*/libuv*

  edk2:
    source: https://github.com/tianocore/edk2
    source-type: git
    source-tag: IRRELEVANT
    source-depth: 1
    plugin: nil
    build-packages:
      - acpica-tools
      - nasm
      - uuid-dev
    override-pull: |-
      set -ex
      git clone https://github.com/tianocore/edk2 . -b edk2-stable202008

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      # Fix submodules
      sed -i "s#https://git.cryptomilk.org/projects/cmocka#https://gitlab.com/cmocka/cmocka#g" .gitmodules
      git submodule update --init --recursive

      # Apply patches
      patch -p1 < "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0001-force-DUID-LLT.patch"
      cp "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0002-logo.bmp" MdeModulePkg/Logo/Logo.bmp
      patch -p1 < "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0003-boot-delay.patch"

      ARCH="X64"
      PKG="OvmfPkg/OvmfPkgX64.dsc"
      FV_CODE="OVMF_CODE"
      FV_VARS="OVMF_VARS"
      if [ "$(uname -m)" = "aarch64" ]; then
          ARCH="AARCH64"
          PKG="ArmVirtPkg/ArmVirtQemu.dsc"
          FV_CODE="QEMU_EFI"
          FV_VARS="QEMU_VARS"
      fi

      # Run in a bash sub-shell as edksetup.sh requires it
      set -ex
      (
      cat << EOF
          . ./edksetup.sh
          make -C BaseTools ARCH=${ARCH}
          build -a ${ARCH} -t GCC49 -b RELEASE -p ${PKG} \
            -DSECURE_BOOT_ENABLE=TRUE \
            -DNETWORK_IP4_ENABLE=TRUE \
            -DNETWORK_IP6_ENABLE=TRUE \
            -DNETWORK_TLS_ENABLE=TRUE \
            -DNETWORK_HTTP_BOOT_ENABLE=TRUE \
            -DFD_SIZE_2MB \
            -DTPM2_ENABLE=TRUE
      EOF
      ) | bash -e

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      cp Build/*/*/FV/${FV_CODE}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
      cp Build/*/*/FV/${FV_VARS}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"

      if [ "$(uname -m)" = "aarch64" ]; then
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"
      fi

    prime:
      - share/qemu/*

  libmnl:
    source: https://git.netfilter.org/libmnl
    source-type: git
    source-tag: libmnl-1.0.4
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libmnl*so*

  libnftnl:
    after:
      - libmnl
    source: https://git.netfilter.org/libnftnl
    source-type: git
    source-tag: libnftnl-1.1.8
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libnftnl*so*

  libseccomp:
    source: https://github.com/seccomp/libseccomp
    source-type: git
    source-tag: v2.5.1
    source-depth: 1
    plugin: autotools
    build-packages:
      - gperf
    organize:
      usr/lib/: lib/
    prime:
      - lib/libseccomp*so*

  libtpms:
    source: https://github.com/stefanberger/libtpms
    source-type: git
    source-tag: v0.7.4
    source-depth: 1
    plugin: autotools
    configflags:
      - --with-tpm2
      - --with-openssl
    organize:
      usr/lib/: lib/
    prime:
      - lib/libtpms*so*

  libusb:
    source: https://github.com/libusb/libusb
    source-type: git
    source-tag: v1.0.24
    source-depth: 1
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libusb*so*

  logrotate:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - logrotate
      - libpopt0
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    stage:
      - bin/logrotate
    prime:
      - bin/logrotate
      - lib/*/libpopt*so*

  lvm:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - dmeventd
      - lvm2
      - thin-provisioning-tools
    organize:
      sbin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/cache_*
      - bin/dmeventd
      - bin/era_*
      - bin/lv*
      - bin/pdata_tools
      - bin/pv*
      - bin/thin_*
      - bin/vg*
      - -bin/vgimportclone
      - -bin/lvmconf
      - -bin/lvmdump
      - -bin/lvmetad
      - -bin/lvmpolld
      - etc/lvm/lvm.conf
      - lib/*/device-mapper/*
      - lib/*/libaio.so*
      - lib/*/libdevmapper*
      - lib/*/liblvm*
      - lib/*/libreadline.so*

  nano:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - nano
    organize:
      usr/bin/: bin/
    prime:
      - bin/nano
      - etc/nanorc

  nftables:
    after:
      - libmnl
      - libnftnl
    source: https://git.netfilter.org/nftables
    source-type: git
    source-tag: v0.9.7
    plugin: autotools
    configflags:
      - --with-json
    build-packages:
      - libjansson-dev
      - libreadline-dev
    stage-packages:
      - libjansson4
    organize:
      sbin/: bin/
      usr/lib/: lib/
    prime:
      - bin/nft
      - lib/*/libjansson*so*
      - lib/libnftables*so*

  nvidia-container:
    after:
      - libseccomp
    source: https://github.com/NVIDIA/libnvidia-container
    source-type: git
    source-tag: v1.3.1
    source-depth: 1
    plugin: make
    build-packages:
      - bmake
      - curl
      - lsb-release
    override-build: |-
      set -ex

      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/bin/"
      cp ${SNAPCRAFT_PROJECT_DIR}/snapcraft/wrappers/nvidia-container-cli "${SNAPCRAFT_PART_INSTALL}/bin/"

      set +ex
      snapcraftctl build
    organize:
      usr/local/bin/nvidia-container-cli: bin/nvidia-container-cli.real
      usr/local/lib: lib/
    prime:
      - bin/nvidia-container-cli*
      - lib/libnvidia-container.so*

  openvswitch:
    source: https://github.com/openvswitch/ovs
    source-type: git
    source-tag: v2.14.0
    source-depth: 1
    plugin: autotools
    stage-packages:
      - uuid-runtime
    organize:
      sbin/: bin/
      usr/bin/: bin/
    prime:
      - bin/ovs-appctl
      - bin/ovs-vsctl
      - bin/ovs-vswitchd
      - bin/ovsdb-*
      - bin/uuidgen
      - share/openvswitch/

  ovn:
    after:
      - openvswitch
    source: https://github.com/ovn-org/ovn
    source-type: git
    source-tag: v20.09.0
    source-depth: 1
    configflags:
      - --with-ovs-source=../../openvswitch/build/
    plugin: autotools
    prime:
      - bin/ovn-nbctl

  spice-protocol:
    source: https://gitlab.freedesktop.org/spice/spice-protocol
    source-type: git
    source-tag: v0.14.3
    source-depth: 1
    plugin: meson
    prime: []

  spice-server:
    after:
      - spice-protocol
    source: https://gitlab.freedesktop.org/spice/spice
    source-type: git
    source-tag: v0.14.3
    source-depth: 1
    plugin: meson
    meson-parameters:
      - --prefix=/
      - -Dgstreamer=no
      - -Dmanual=false
      - -Dlz4=false
      - -Dsasl=false
      - -Dopus=disabled
      - -Dsmartcard=disabled
      - -Dtests=false
    build-packages:
      - libjpeg-turbo8-dev
      - python3-pyparsing
      - python3-six
    stage-packages:
      - libjpeg-turbo8
      - libpixman-1-0
    organize:
      sbin/: bin/
      usr/lib: lib/
      usr/local/lib/: lib/
    prime:
      - lib/*/libjpeg*so*
      - lib/*/libspice-server*so*
      - lib/*/libpixman*so*

  swtpm:
    after:
      - libseccomp
      - libtpms
    source: https://github.com/stefanberger/swtpm
    source-type: git
    source-tag: v0.5.2
    source-depth: 1
    plugin: autotools
    build-packages:
      - expect
      - gawk
      - iproute2
      - python3-cryptography
      - python3-setuptools
      - socat
    configflags:
      - --with-seccomp
      - --with-openssl
      - --without-cuse
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      lib/swtpm/: lib/
    prime:
      - bin/swtpm
      - lib/libswtpm*so*

  qemu:
    after:
      - libseccomp
      - libusb
      - spice-protocol
      - spice-server
    source: IRRELEVANT
    source-type: git
    plugin: autotools
    install-via: prefix
    configflags:
      - --disable-bochs
      - --disable-cloop
      - --disable-dmg
      - --disable-docs
      - --disable-guest-agent
      - --disable-parallels
      - --disable-qed
      - --disable-sheepdog
      - --disable-slirp
      - --disable-user
      - --disable-vdi
      - --disable-vnc
      - --disable-xen
      - --enable-attr
      - --enable-cap-ng
      - --enable-kvm
      - --enable-libusb
      - --enable-usb-redir
      - --enable-linux-aio
      - --enable-numa
      - --enable-pie
      - --enable-rbd
      - --enable-seccomp
      - --enable-spice
      - --enable-system
      - --enable-tcg
      - --enable-tools
      - --enable-vhost-crypto
      - --enable-vhost-kernel
      - --enable-vhost-net
      - --enable-vhost-scsi
      - --enable-vhost-user
      - --enable-vhost-vsock
      - --enable-virtfs
      - --firmwarepath=/snap/lxd/current/share/qemu/
      - --localstatedir=/var/
    build-packages:
      - bison
      - flex
      - pkg-config
      - libaio-dev
      - libcap-ng-dev
      - libglib2.0-dev
      - libnuma-dev
      - libpixman-1-dev
      - librbd-dev
      - libusbredirhost-dev
    stage-packages:
      - genisoimage
      - libmagic1
      - libnuma1
      - libpixman-1-0
      - libusbredirhost1
      - libusbredirparser1
    override-pull: |-
      set -ex
      git clone https://github.com/qemu/qemu . -b v5.2.0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && [ "$(uname -m)" != "ppc64le" ] && [ "$(uname -m)" != "s390x" ] && exit 0

      set -ex
      # Mangle the configure a bit
      QEMUARCH="$(uname -m)"
      [ "${QEMUARCH}" = "ppc64le" ] && QEMUARCH="ppc64"
      sed -i "s/^unset target_list$/target_list=\"${QEMUARCH}-softmmu\"/" configure
      sed -i 's#libseccomp_minver=".*#libseccomp_minver="0.0"#g' configure
      sed -i "s#https://git.qemu.org/git#https://github.com/qemu#g" .gitmodules

      set +ex
      snapcraftctl build
    organize:
      libexec/: bin/
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/genisoimage*
      - bin/mkisofs*
      - bin/qemu-system-*
      - bin/qemu-img*
      - bin/virtfs-proxy-helper*
      - bin/virtiofsd*
      - lib/*/libmagic*so*
      - lib/*/libnuma*so*
      - lib/*/libpixman*so*
      - lib/*/libusbredir*so*
      - share/qemu/keymaps*
      - share/qemu/efi-virtio.rom*
      - share/qemu/kvmvapic.bin*
      - share/qemu/s390-*.img*
      - share/qemu/slof.bin*
      - share/qemu/vgabios-*.bin*

  qemu-ovmf-secureboot:
    after:
      - edk2
      - qemu
    source: https://github.com/puiterwijk/qemu-ovmf-secureboot
    source-type: git
    source-depth: 1
    plugin: nil
    build-packages:
      - xorriso
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      set -ex
      rm -Rf iso-root vfat-root shell.iso
      mkdir -p iso-root vfat-root/efi/boot
      cp ../../edk2/build/Build/*/*/*/Shell.efi vfat-root/efi/boot/bootx64.efi
      cp ../../edk2/build/Build/*/*/*/EnrollDefaultKeys.efi vfat-root/
      "${SNAPCRAFT_STAGE}/bin/qemu-img" convert --image-opts driver=vvfat,floppy=on,fat-type=12,label=UEFI_SHELL,dir=vfat-root iso-root/shell.img
      xorriso --as mkisofs -input-charset ASCII -J -rational-rock -e shell.img -no-emul-boot -o shell.iso iso-root/

      # Basic aarch64 support
      if [ "$(uname -m)" = "aarch64" ]; then
          sed -i ovmf-vars-generator \
              -e "s/'-machine', machinetype,/'-machine', 'virt', '-cpu', 'cortex-a57',/" \
              -e "/charserial1/d" \
              -e "s/ide-cd/scsi-cd/" \
              -e "s/'-device',$/'-device', 'virtio-scsi-pci,id=scsi', '-device',/"
      elif [ "$(uname -m)" = "x86_64" ]; then
          cp -f "${SNAPCRAFT_STAGE}/share/qemu/kvmvapic.bin" .
      fi

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      python3 ovmf-vars-generator \
        --qemu-binary "${SNAPCRAFT_STAGE}/bin/qemu-system-$(uname -m)" \
        --print-output --disable-smm --skip-testing \
        --oem-string "$(cat ${SNAPCRAFT_PROJECT_DIR}/snapcraft/etc/ubuntu-sb.crt)" \
        --ovmf-binary "${SNAPCRAFT_STAGE}/share/qemu/OVMF_CODE.fd" \
        --ovmf-template-vars "${SNAPCRAFT_STAGE}/share/qemu/OVMF_VARS.fd" \
        --uefi-shell-iso shell.iso \
        "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.ms.fd"
    prime:
      - share/qemu/*

  raft:
    source: https://github.com/canonical/raft
    source-type: git
    source-depth: 1
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libraft*so*

  sqlite:
    source: https://github.com/sqlite/sqlite
    source-type: git
    source-depth: 1
    source-tag: version-3.34.0
    plugin: autotools
    build-packages:
      - tcl
    override-build: |-
      set -ex

      git log -1 --format=format:%ci%n | sed -e 's/ [-+].*$//;s/ /T/;s/^/D /' > manifest
      git log -1 --format=format:%H > manifest.uuid
      cp /usr/share/misc/config.guess .
      cp /usr/share/misc/config.sub .
      autoreconf -f -i

      set +ex
      snapcraftctl build
    prime:
      - bin/sqlite3
      - lib/libsqlite3*so*

  squashfs-tools-ng:
    source: https://github.com/AgentD/squashfs-tools-ng
    source-type: git
    source-tag: v1.0.3
    source-depth: 1
    plugin: autotools
    build-packages:
      - liblzma-dev
    prime:
      - bin/sqfs2tar
      - bin/tar2sqfs
      - lib/libsquashfs.so*

  vim:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - vim-tiny
    organize:
      usr/bin/: bin/
      usr/share/vim/vim*/debian.vim: etc/vimrc
    prime:
      - bin/vim.tiny
      - etc/vimrc

  xfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xfsprogs
    organize:
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/xfs_admin
      - bin/xfs_db
      - bin/xfs_growfs
      - bin/xfs_repair
      - bin/mkfs.xfs

  xtables:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ebtables
      - iptables
      - xtables-addons-common
    organize:
      usr/lib/*/xtables/*: lib/xtables/
      lib/ebtables/*: lib/
      sbin/: bin/
    prime:
      - bin/ebtables
      - etc/ethertypes
      - etc/protocols
      - lib/libebt*
      - lib/xtables/*

  xz:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xz-utils
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/lzma
      - bin/xz
      - lib/*/liblzma*so*
    override-build: |
      snapcraftctl build

      # Include the lzma symlink
      ln -s xz "${SNAPCRAFT_PART_INSTALL}/usr/bin/lzma"

  zfs-0-6:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.6.5.11
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick fb963d33ee0dd350143ba1c9cd35d5f7d86910d2  # Fix endian build problem on ppc64el

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-7:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.7.13
    source-depth: 1
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-8:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.8.6
    source-depth: 1
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-2-0:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-2.0.1
    source-depth: 1
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zstd:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - zstd
    organize:
      usr/bin/: bin/
    prime:
      - bin/pzstd
      - bin/zstd

  # Core components
  lxc:
    after:
      - libseccomp
    source: https://github.com/lxc/lxc
    source-type: git
    source-tag: lxc-4.0.6
    build-packages:
      - libapparmor-dev
      - libcap-dev
      - libgnutls28-dev
      - libselinux1-dev
      - pkg-config
    plugin: autotools
    configflags:
      - --disable-api-docs
      - --disable-bash
      - --disable-doc
      - --disable-examples
      - --disable-memfd-rexec
      - --disable-tests
      - --disable-tools
      - --enable-apparmor
      - --enable-seccomp
      - --enable-selinux
      - --enable-capabilities
      - --with-rootfs-path=/var/snap/lxd/common/lxc/
      - --libexecdir=/snap/lxd/current/libexec/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/libexec: libexec
      share/lxc/hooks: lxc/hooks
    prime:
      - bin/lxc-checkconfig
      - lib/liblxc.so.1
      - lib/liblxc.so.1.*
      - lxc/config/common.conf.d
      - lxc/hooks/nvidia
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick b1710cdb0378b998055a88e9b439a9c9d1577973  # commands: fix check for seccomp notify support
      git cherry-pick 9d6a3de70086d46f7562ac689d10ca1e36b237a1  # configure: skip libseccomp tests if it is disabled
      git cherry-pick 563ec46266b8967f0ee60e0032bbe66b3b37207c  # conf: fix containers retaining CAP_NET_ADMIN
      git cherry-pick 5a13595b7bc3db36e3f0cdf6f03758591a019d93  # cgroups: fix cgroup mounting
      git cherry-pick 93ce8339d91c9684b739cd65b8b97e9d24ab1371  # lsm: remove obsolute comment about constructor
      git cherry-pick 027f9f8225874b683d70d1ebcce4ae8682522e65  # lxc_attach: include rexec conditionally
      git cherry-pick d12b5190ca8fe3966496858e8c5db508a86ad40a  # tree-wide: fix some header inclusions
      git cherry-pick db574851e6d025ee0daf4afefafa0a05297ad4b5  # initutils: fix missing includes
      git cherry-pick a8d0ef4f131a823b3f4e078f7191c4486725e303  # configure: support static binaries
      git cherry-pick 7b16be129acf38f3a1aae63e98a867df82a5d826  # autotools: enable static builds for tools
      git cherry-pick 132024c5e8b4617f4fd804a54d710651735711a8  # autotools: enable static builds for commands
      git cherry-pick 4fc3bbd45c25a995b3decbdd953a389a365bc369  # tree-wide: fix compilation with-Wstrict-prototypes -Wold-style-definition
      git cherry-pick 5fd525dfdbedf8babe469190e3cb696f01e0f353  # config: update ax_pthread.m4
      git cherry-pick 63efab747c92667a3fea097337133c82152a9ef7  # configure: add AC_SYS_LARGEFILE checking
      git cherry-pick 0564659714a5ed51883a491fd99c725192aece43  # autotools: update build
      git cherry-pick 65bd3f8b4c50ba919fe46af661698f5bb620c695  # file_utils: introduce read_file_at()
      git cherry-pick 329b11dca1312440f57a0bf87632a928e3206c4d  # string_utils: add must_make_path_relative()
      git cherry-pick f8ea20d88b6e8cc202adf4bd0d8cc10ff70cce52  # cgroups: coding style fixes
      git cherry-pick 391d314b7aa2087608b898399fb53a9dd259266c  # cgroups: rework cg_unified_init()
      git cherry-pick c825d4704266c3517288895184d9232c55e1b7f8  # cgroups: detect and record cgroup2 freezer support
      git cherry-pick 3886f4a8d9665f418c3846d16c5141753640c51f  # criu: handle cgroup2 freezer
      git cherry-pick c1c7d42cf757c46068ef3a0eeea5a8f6c88d7f5e  # mkdir -p /proc /sys on container startup
      git cherry-pick 6cec518d16b53d9416dd5a370c01c006de21e8ec  # conf: fix coding style
      git cherry-pick 4b7db20ee44ed94e948fa81da7030ad3fdf31cd8  # conf: coding style fixes
      git cherry-pick f06e80de163680ae7cd92fe8de9ae60ff3bea266  # conf: move proc and sys mountpoint creation int lxc_mount_auto_mounts()
      git cherry-pick 30d5a566e364a9e9a9f838ceee5f46c1fa5cde6c  # attach: invert child/parent handling
      git cherry-pick e95c4c2d9b3bef0073855eda11a0a9aaa7fe6879  # attach: use __do_free cleanup macro for cwd
      git cherry-pick 6e9fd7e90b8b638e7b11966653228ba0139c95a1  # attach: tweak logging
      git cherry-pick b994e6f273e2f6e9b94973a6554b02a897bb30fc  # attach: use __do_close for labelfd
      git cherry-pick 084378794a535478961aeb8cf006221043f83bb0  # attach: coding style fixes
      git cherry-pick 02c90439e65a1627e925cfdcda29ba898cca8d97  # attach: use free_disarm()
      git cherry-pick 7379954b39a312972c05971274b7848a49a0c5c6  # attach: s/attach_child_main/do_attach/g
      git cherry-pick e8a2d23cc7b3ad0f360be5c1f91e570755b06024  # attach: mark do_attach() as __noreturn
      git cherry-pick 43a6efe7b1002ed2d5770c54fa5682d68d1df1b5  # attach: make do_attach() void
      git cherry-pick c16fae6d41f6aa9f1a758f8bfc218b7bd7316a93  # attach: use close_prot_errno_disarm()
      git cherry-pick 252605bccc19a0c3d75030842aac2760ac16abd5  # attach: add some DEBUG() logging to stdfd dpulication

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/
      ln -s /var/snap/lxd/common/lxc/local.conf $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/01-local.conf
      sed -i "s#includedir=.*#includedir=$SNAPCRAFT_PART_INSTALL/include#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc
      sed -i "s#libdir=.*#libdir=$SNAPCRAFT_PART_INSTALL/lib#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc

  lxcfs:
    source: https://github.com/lxc/lxcfs
    source-type: git
    source-tag: lxcfs-4.0.7
    build-packages:
      - libfuse-dev
      - libpam0g-dev
      - pkg-config
    stage-packages:
      - fuse
    plugin: autotools
    configflags:
      - --datarootdir=/snap/lxd/current/
      - --localstatedir=/var/snap/lxd/common/var/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/lxcfs: lxcfs
      lib/lxcfs: lib
    prime:
      - bin/fusermount
      - lib/*/libfuse.so.*

      - bin/lxcfs
      - lib/liblxcfs.so

      - lxc
      - lxcfs
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick 725e90b5d67e264ee4a7ff0851c79728feab1da8  # proc_cpuview: release lock before returning

      set +ex
      snapcraftctl build
      set -ex

      sed -i "s#\${LXC_ROOTFS_MOUNT}/var/snap/lxd/common/var/lib/lxcfs/#\${LXC_ROOTFS_MOUNT}/var/lib/lxcfs/#g" $SNAPCRAFT_PART_INSTALL/snap/lxd/current/lxcfs/lxc.mount.hook

  lxd:
    source: https://github.com/lxc/lxd
    source-type: git
    source-tag: lxd-4.10
    after:
      - lxc
      - dqlite
      - sqlite
    build-packages:
      - libacl1-dev
      - libudev-dev
      - pkg-config
    stage-packages:
      - acl
      - attr
      - dnsmasq-base
      - gdisk
      - iw
      - netbase
      - pciutils
      - pigz
      - rsync
      - squashfs-tools
      - usbutils
      - xdelta3
    plugin: nogetgo
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd
    go-packages:
      - github.com/lxc/lxd/lxc
      - github.com/lxc/lxd/lxc-to-lxd
      - github.com/lxc/lxd/lxd
      - github.com/lxc/lxd/lxd-benchmark
    override-build: |
      set -ex

      # Git cherry-picks
      cd ../src
      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick 55bcb19ef8055d9cc493595a46cffe197801feec  # client: Fix output of GetClusterMemberNames
      git cherry-pick 158e4af834e7a3faaafdcb49b0f61fba9131684d  # openvswitch/ovs.go: Simplify return in Installed method
      git cherry-pick 4a24322ab39364cdfb258858d248c1f9ec34bb5a  # rbac/server.go: Sleep for seconds instead of nanoseconds
      git cherry-pick 80db2d3f80264ac321294a6673cfeb9ee42f7b91  # lxd/instance/drivers/driver/qemu: Updates SaveConfigFile to return nil
      git cherry-pick d4f2dc3a92160c5c30b655dbf7b7ba01c3efb552  # lxd/api/internal: Updates internalImportFromRecovery to call inst.SaveConfigFile
      git cherry-pick f7fbff5aa1ca529a50997616933281edcbe52ea3  # test/suites/backup: Adds test to check exec works after recovery of running container
      git cherry-pick ac9ddfb5e998f20c746a584ee8173345fccbcd94  # cluster/raft/file_snapshot.go: defer after checking error
      git cherry-pick 1a4bfbf909369ad0335b59aad7ab074b4b25a14e  # lxd/storage/drivers/driver/cephfs/volumes: Updates RenameVolume newName arg to newVolName to bring inline with other drivers
      git cherry-pick 6793c10d59a424230fcb8186f9c765f62ad9ee1b  # lxd/storage/drivers/driver/ceph/volumes: Fix UnmountVolume to actually deactivate VM block volumes
      git cherry-pick 250a3925e2bcf20c55fffdf92b4913e4e1d48856  # lxd/storage/drivers/driver/ceph/volumes: Fix RenameVolume to also rename FS volume for VM volumes
      git cherry-pick 7c57ba7d87800c43e791e1ac421c1088c9da48fd  # test/suites/container/devices/nic/bridged: Adds port isolation feature test
      git cherry-pick 6db2e8bee6fbd42012ad5310a7fd037784a09797  # lxc/network: Adds support for attaching instance to a managed network using `network` property
      git cherry-pick fdd6ef9e4d004f3ceb4d8a20f0da01dfba9645ea  # test/suites/container/devices/proxy: Ensure ipv6 nat tests use a network with stateful DHCPv6 enabled
      git cherry-pick f55684db8a376643cf5568cfc9861d76c3e83df0  # test/suites/network: Updates static IPv6 allocation test to actually test stateful DHCPv6
      git cherry-pick 6efe0c82844ab65a0a0ba619500ffdd172030e2f  # test/suites/container/devices/nic/bridged: Improve validation of DHCPv6 allocation
      git cherry-pick 732a627178e2b4db74d7e8ed2f1fa13ddc391967  # lxc/query: Prevent using --project
      git cherry-pick 719fd3887353b667c528413b769ce4e9f6ed09ae  # i18n: Update translation templates
      git cherry-pick 96ed165ec0f657d877fd2f5935458169daaaefb8  # lxd/utils: Compare all addresses from lookup in IsAddressCovered, lxc#8340
      git cherry-pick c26c4025b3479603d1d047819f9b301c137490e5  # lxd/resources: Support DMI for CPU information
      git cherry-pick a1f8d3d51c362f342c323d6080f8f1b1af5031d9  # lxd/device/nic/routed: Ensure IP neighbour proxy entries are removed on stop
      git cherry-pick 97b09969f7ea4a11d5ede018794c4bf897e7f895  # lxd/device/nic/routed: Adds duplicate address detection
      git cherry-pick d452755ce9f9b828180e6aa0c53ea85b957f5805  # lxd/device/disk: Validate size field properly
      git cherry-pick f823c0ec601300ca0a2c91cdf621d1da504e01e8  # lxd/device/nic/bridged: Only attempt to release DHCP leases if bridge interface exists
      git cherry-pick 51fdde0ed699a446832ef877440e58e92667229a  # lxd/device/nic/bridged: Improve error context prefix in networkClearLease
      git cherry-pick 21665838e45c89afbf69529a3c2a292329512a23  # lxd/device/nic/bridged: Use %q for error quoting in networkClearLease
      git cherry-pick 70c33d143bd20218ba62d0bf3da3fd9bcb1de470  # lxd/device/nic/bridged: Improve error context prefix in State
      git cherry-pick d2ae591af9d4968776ad2c774074f13da0fb2f09  # lxd/instance: Fix progress on ceph instance move
      git cherry-pick 7bf04fa33f9c684e377e7d5d5755d8962c26fe6c  # lxd/storage/backend/lxd: Use volume config in UpdateInstanceBackupFile so that volume.block.filesystem setting is used
      git cherry-pick deca6f7f2cbd76774670a693f81f20a55eb5dc9d  # lxd/storage/drivers/utils: Adds filesystem being used to TryMount error
      git cherry-pick feacd71317078cb3d337b1a8c5904b9186f06432  # lxd: Smarter handling of volatile keys in projects
      git cherry-pick 68b825b08a0480967776941dcfd55992f6fec03a  # lxd/project: Strip volatile on copy/migrate
      git cherry-pick 4a475aa482a636dfed8fe300123f18294ab49ec5  # tests: Update project restrictions test
      git cherry-pick b368d1ab951c4472dc4ca966989da8fc5e9fd2de  # lxd/instance/drivers/driver/lxc: Copy parent volume config to snapshot volume config in lxcCreate
      git cherry-pick 9b8ef9a7eb3885d8911efa93ccfe81c47a05ea65  # lxd/instance/drivers/driver/qemu: Copy parent volume config to snapshot volume config in qemuCreate
      git cherry-pick d57a8f50d130437de0c12408cced18e41910d301  # lxd/instance/drivers/driver/lxc: Umount instance after CRIU state path check in Restore
      git cherry-pick f37aa9621ad6c6dea9b780195db5eb55d1e8d469  # lxd/instance/drivers/driver/lxc: Avoid duplicated call to UpdateBackupFile in Restore
      git cherry-pick fdc6b73dc6af5779fde1ce991826f3e571d36dcb  # lxd/instance/drivers/driver/lxc: Log instance restarting after snapshot restore
      git cherry-pick a0f45e98a06408dadbe10f697829f2072cdb9096  # lxd/instance/drivers/driver/lxc: Always run UpdateBackupFile in Update
      git cherry-pick 59924fa7e0ed75aac9f3784acdfd90b082739324  # lxd/instance/drivers/driver/qemu: Removes unnecessary call to UnmountInstance in Restore
      git cherry-pick ce1ac69f3d4a75b5f66dc51c8bfa7df2ca314907  # lxd/instance/drivers/driver/qemu: Remove unnecessary call to UpdateBackupFile
      git cherry-pick 68c1f9529603fab619e6a6a45cb6887fb561e72e  # lxd/instance/drivers/driver/qemu: Log instance restarting after snapshot restore
      git cherry-pick 92727b0ea7de1b3df225d24e40553002e1d18b5d  # doc/rest-api: Fix typo
      git cherry-pick fd20dc631c0944b8e448182eb0bac8a8edcaac30  # doc/rest-api: Fix missing escaping
      git cherry-pick d558014d7ee3c00449bc8f84073eb9afd81fd410  # lxd/instance: Tweak error and resource links
      git cherry-pick afb1e0dd5ec3434ec7afd824f679dce52a8145c3  # api: Adds support for bulk instance state change.
      git cherry-pick ce509dbf253bf95f754d9d20a1b60fb00429574c  # shared/api: Adds support for bulk instance state change.
      git cherry-pick a0876aca6cfde9992d8378350f60a9ca0b51c583  # doc: Adds doc for bulk instance state change endpoint.
      git cherry-pick f16eebefb1a8b708b0b39fb0b661a673bf999cfa  # lxd: Adds support for bulk instance state change.
      git cherry-pick 38c2b3e54dfff14d826584772744759422121784  # client: Adds support for bulk instance state change.
      git cherry-pick 962fd498dca4f2771bd958cf1c8c16eb79925fd3  # lxd: Process bulk action in parallel
      git cherry-pick 2919314d2eddd52e7ac1c290594c5a23aa175364  # test/suites/snapshots: Adds snapshot block.filesystem config check for LVM & Ceph
      git cherry-pick 9f55844d6b1c83803b1e5393ab063465c1b257aa  # lxd/instances: Reduce code duplication
      git cherry-pick 374f620f8c8420d8c21cc57256c0888b0c12b5a5  # shared/api: Change mass update API
      git cherry-pick 4b0e63f65062226d1ba25e624a88de63448ada8c  # lxd/instances: Update to new bulk API
      git cherry-pick f65d1a258b90da683487e6f9c6c027a3bef4c00f  # doc/rest-api: Update for new bulk API
      git cherry-pick 3e74d4cf9bfc921936dfd7164e4a3256073dd9c4  # client: Re-order functions
      git cherry-pick a8ed29e60d5b248b58f5366d545d5c385593cb6e  # lxd: Rename container functions
      git cherry-pick d1ca4c973d18ba3dcca7dc9f9cd173a8f2ec871d  # lxd/instance_state: Simplify
      git cherry-pick 1e25e895bbc86315ddba032d3e86102af5a79404  # lxd/instance: Refactor state handling
      git cherry-pick 5053c28f5c21ff8cb5006c537cd987fa5b4ef8f7  # lxd/instances_state: Simplify logic
      git cherry-pick f15938c0ee19ef65c830a25f7887e0493ff5391f  # lxd/instance/drivers: Move ephemeral restart logic
      git cherry-pick 4dce56fb652b635f429f95373a2eeaa8b0e465c7  # lxd/vm: Expose ISO images as SCSI cdroms
      git cherry-pick 8e38603cdde29a4960889d425cb4126eb4c0468f  # lxd/storage: Cleanup CreateInstanceFromCopy
      git cherry-pick 99337ddb231538dd04db38a4a98072d7f647edb9  # lxd/storage/utils: Updates VolumeDBCreate to accept volume and content type typed arguments
      git cherry-pick 97800c753a2154140daacb3a298e778f5e2cd1d0  # lxd/storage/backend/lxd: Error quoting and wrapping
      git cherry-pick a94f406a980479f25ccc000b560ae521759ec040  # lxd/storage/backend/lxd: Expand argument type in updateVolumeDescriptionOnly
      git cherry-pick 82f3317f104aa90dedf30edc85e3805ca7accf54  # lxd/storage/backend/lxd: VolumeDBCreate updated usage
      git cherry-pick df248aa56c744edc6acd9b9ba1cbe077a8c8d37a  # lxd/network: Add check for overlapping ovn.ranges and dhcp.ranges
      git cherry-pick 61ec407fce890dc51e338cfe67dc6931c807c510  # lxd/db/instances: Improve error message from CreateInstanceConfig
      git cherry-pick 3e30a9f769acbba25cba568bfebbcac801a47107  # lxd/instance/drivers/driver/common: Adds insertConfigkey function
      git cherry-pick 8896261d03fb6e0da22dcc4e010a48cf8ebd4493  # lxd/instance/drivers/driver/lxc: Updates FillNetworkDevice to use d.insertConfigkey
      git cherry-pick abef6ef8392029644d1a141ff8ea03527dd343f5  # lxd/instance/drivers/driver/qemu: Updates FillNetworkDevice to use d.insertConfigkey
      git cherry-pick f7f4e4633ad6fde4cd6bd2624c06f233652b82db  # lxc/instance/drivers/driver/common: Removes empty value check from insertConfigkey
      git cherry-pick ec9a5302ed4e1ac8016bee55f8efe877663be371  # lxd/instance/drivers: Detect failed volatile key generation
      git cherry-pick e580cfb8792babd2b1ec23aeb307c928e5c124ab  # lxd/instance/drivers/driver/lxc: Fix volatile config key scoping issue in FillNetworkDevice
      git cherry-pick ee0bddfc35d07d73885e5c1396f829c7f42c7d08  # lxd/network/driver/bridge: Only validate non-overlapping DHCPv6 ranges with OVN ranges when stateful DHPCv6 being used
      git cherry-pick c49be133d804b5c4a649d3995c0906bf3194c2ac  # lxd/instance/drivers/driver/common: Prevent existing row check from wiping out desired key value in insertConfigkey
      git cherry-pick eceeac283eb71bbec87d52383c713cc133337d07  # lxd/instance/drivers: More checks and error contexts in FillNetworkDevice
      git cherry-pick e176c0b8d55eb06062b70abc012d7e942f735e22  # lxd/instance/drivers/driver/qemu: Error alignment with container driver in Rename
      git cherry-pick 5adfc6f4617d776abf553f5eec1c433cada5fd19  # lxd/storage/utils: Improves error in VolumeDBCreate
      git cherry-pick 5cf821fb4d809df9ee3779a887e7d850331a4a12  # lxd/db/storage/volumes: Populates ProjectName field in GetLocalStoragePoolVolumeSnapshotsWithType
      git cherry-pick 960db72900eb8c867305d2b7566a504fb8e3237f  # lxd/instance/drivers/driver/lxc: Error context in Rename
      git cherry-pick d41c9ad676ec6a8aae33d9ecbb1c9522de4800a7  # lxd/instances/post: Unwraps long error and using double quotes placeholder
      git cherry-pick 7a2f554731bfd63e8e31aec73c93d826368e36b1  # lxd/instance/instance/interface: Adds TemplateTrigger type and constants for template trigger types
      git cherry-pick b845ea806bbd1ee1f7e7796ca491a9eff1f401c3  # lxd/instance: Adds instanceCreateAsCopyOpts argument for instanceCreateAsCopy options
      git cherry-pick 676d3c2a9648099bbf0d67a177036e4d07ed3979  # lxd/instances/post: instanceCreateAsCopy updated usage
      git cherry-pick d6fb79aa2a4148413a2070cb12c0b2a6b5d1dfe6  # lxd/instance/instance/interface: Updates DeferTemplateApply to accept TemplateTrigger type argument
      git cherry-pick 01f512e299ee0429f7552b917a16102f6d012ebd  # lxd/instance/drivers/driver/common: Updates DeferTemplateApply to accept a TemplateTrigger type argument
      git cherry-pick 3e7a74b69ddf42d2362c161806766c8a8018f93f  # lxd/storage/backend: inst.DeferTemplateApply usage
      git cherry-pick 86b47fe8461e121bafa2346348cbf656a75a76c2  # lxd/instances/post: inst.DeferTemplateApply usage
      git cherry-pick 8f0e05b32eb950d9cde1c81d76f453dad7052938  # lxd/instance/drivers/driver/lxc: Updates templateApplyNow to accept a TemplateTrigger argument
      git cherry-pick d29b5d03cd38bdabed8100c1760e105aa799f7ec  # lxd/instance/drivers/driver/lxc: d.templateApplyNow usage
      git cherry-pick bf188cbde9225c78cdfced68456dba6d2d8c91ff  # lxd/instance/drivers/driver/qemu: Updates templateApplyNow to accept a TriggerTemplate type argument
      git cherry-pick b38f7a6d2da862c38b5864e99826c55638e451cc  # lxd/instance/drivers/driver/qemu: d.templateApplyNow usage
      git cherry-pick a731f4339d3265ea7961e74a4d0ddc21d880ddf1  # lxd/instance/instance/interface: Adds applyTemplateTrigger argument to Rename
      git cherry-pick 7e481a4c27624b20c8b506f93e46944b4bc785a8  # lxd/instance/drivers/driver/lxc: Adds applyTemplateTrigger argument to Rename
      git cherry-pick ce3946ed729769d74105ce311df0dd63b7a42afe  # lxd/instance/drivers/driver/qemu: Adds applyTemplateTrigger argument to Rename
      git cherry-pick 69cac0f2f38620a35071c69e15a88ccf6ad4e7c0  # lxd/instance/post: inst.Rename usage
      git cherry-pick 8a9e2c4d22fb71b94881130da3a79bbcc9dcf197  # lxd/instance/snapshot: sc.Rename usage
      git cherry-pick 5d06c927e573bf275b55b7ed4c1396327e6c2832  # lxd/storage/backend/lxd: Removes call to deferred template apply in RenameInstance
      git cherry-pick 2fec9dcb546982bdbd864ed59485aa5c88f4a63f  # lxd/instance/test: c.Rename usage
      git cherry-pick 9ed0464f8e416a2690944f67433dbd5381f50138  # shared/api: Add Pool field to InstancePost
      git cherry-pick b9e1a00d5812df4f5ed151b19999159c8c5743eb  # client: Add extension check for pool migration
      git cherry-pick 1cffb28b66d3295e361f178f9890f85b41d77aeb  # test: Add tests for volatile.apply_template config during create, copy and move
      git cherry-pick 427b4f808012144358f7a92a2583830e277febee  # test: Adds check for volatile.apply_template state after rename
      git cherry-pick 08131f853a7d76eda54a42342ec7c25255963272  # test: Add test for moving instance between pools without renaming
      git cherry-pick ea21cb483dde14c256150bd3297016b2798dcd75  # lxd/images: Skip keys with empty values
      git cherry-pick c84070fd43deb81e05f42eddc84d5bff46fd356b  # lxd/device: Fix instance type validations
      git cherry-pick 60239d5dd27ec9e9d1b9968378fb39b9e32e94df  # shared/instance: Adds ErrNoRootDisk error var and returns it from GetRootDiskDevice
      git cherry-pick 30887fe0ef52d6c7948fd84dcc4d985f6120d1a6  # lxd/instance: Enforces that target instance should have valid root disk config after DB create in instanceCreateAsCopy
      git cherry-pick c43dcc17dee3483c722bfd194a978240d9df21d4  # lxd/instance: Don't assume root disk is called "root" when copying snapshots from a source instance
      git cherry-pick cc0986b7a1decf50f39b4ab8a40a328614e21205  # lxd/db/query/retry: Adds detection of checkpoint in progress to IsRetriableError
      git cherry-pick bfae314d458d5fa15b6a1660b77a107b9b279f16  # lxd/instance/drivers/driver_qemu: attempt to kill qemu proc on stop
      git cherry-pick e8163cbeee0d8206d29d8163a71fd3f268579160  # lxd/instance/driver_qemu: Add check for qemu cmdline args to pid()
      git cherry-pick f474e695c4e36854d9352addb3725a3c5b59f194  # forkproxy: prevent zombies
      git cherry-pick 9667b0920c412ee0d6e046a2b98aa57a2d29eb66  # lxd: Change some references of container to instance in comments
      git cherry-pick fac1d949e4d6f06d99bf500bc8bbad9e81d1cf60  # lxd/instance/post: Change error message to instance from container in instancePost
      git cherry-pick 15f9541bd95ab760c5ff1431a7cbd43b3bb351c4  # lxd/main/forkdns: Returns empty AAAA record response when equivalent A record exists
      git cherry-pick 689784349d7d8d761e26241009ac20630612c31c  # lxd/main/forkdns: Fixes typo in comment
      git cherry-pick d90f5245aa83e63ade25103895bedfc146d37b46  # test: Adds test for empty AAAA response when equivalent A record exist in clustering forkdns
      git cherry-pick 778d8867bc00f286a10c1cca81e573733f6c159c  # lxd/device/pci: Consider DeviceUnbind successful on missing driver
      git cherry-pick 75c38b140af963195d5bb31085205255f0ee21d1  # shared/validate: Validate PCI addresses
      git cherry-pick 9a81b2ddabd5c96a197a0d06c443fe170ad54fd8  # lxd/device/gpu: Validate PCI addresses
      git cherry-pick 2dbacb148e349ce0d045f4e739485c6362716e82  # lxd/device: Add function to validate PCI path
      git cherry-pick 2312de1dff38c2b63d2741db633522e397c2e83d  # lxd/device/gpu_mdev: Valdiate PCI address and path
      git cherry-pick 8473045ff595e154b508d89888f9274b92498bad  # lxd/device/gpu_physical: Validate PCI address and path
      git cherry-pick 04b1f624f58751d650935bb52bab4c2cbb9353c6  # lxd/instance/qemu: Cleanup VGA ROM check
      git cherry-pick 8075f1d8235ba49d390e3fc1fcdfbb4800ab6c3a  # lxd/network/driver/bridge: Update DHCPv4Subnet to return fan bridge address subnet when in fan mode
      git cherry-pick 12eff7c16266bae721324ec001b288896ea5db59  # lxd/device/nic/bridge: Updates validateConfig to use parent networks DHCP subnet functions when validating address
      git cherry-pick 36f73f21c64d8ba20b0bdd5bd0bd39e5b0080fff  # shared/termios: Fix static builds
      git cherry-pick e4265373183ab36ab13f11f5162aef0c87fc3464  # shared/idmap: Fix shared/ build on non-cgo
      git cherry-pick 1686c141f6867fa7ca104333dc5eeff7a13477ee  # shared/instancewriter/: Fix shared/ build on non-cgo
      git cherry-pick bfb9746d748a8fce179c92f7404c8e13a4d8118d  # shared/eagain: Restrict to Linux
      git cherry-pick 0c8fd1c6bd5b8975344242fd28346319c75aec4f  # shared/subprocess: Restrict to unix
      git cherry-pick b6ad37a20a32b60d3913109b0f2bd7d8ecf76a02  # lxd/db/generate: Move DB generator
      git cherry-pick 2d3d262fec4fc631c1a4c4a61a19edd68740d91f  # github: Replace Travis and Appveyor with Actions

      # Download any new dependencies
      export GOPATH=$(realpath ../go)
      go get -t -d ./...

      # Setup for our shared libraries
      sed -i "/\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/canonical/go-dqlite/internal/bindings/server.go
      sed -i "/^\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/mattn/go-sqlite3/sqlite3.go

      # Run the standard build
      set +ex
      snapcraftctl build
      set -ex

      # Build the agent (special build tags)
      CGO_ENABLED=0 go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd-agent" -tags=agent,netgo github.com/lxc/lxd/lxd-agent

      # Setup bash completion
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/
      cp scripts/bash/lxd-client ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/share/misc/: share/misc/
      var/lib/usbutils/usb.ids: share/misc/
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/dnsmasq
      - bin/getfattr
      - bin/setfattr
      - bin/iw
      - bin/pigz
      - bin/rsync
      - bin/setfacl
      - bin/sgdisk
      - bin/unsquashfs
      - bin/xdelta3

      - etc/bash_completion.d/snap.lxd.lxc

      - share/misc

      - bin/lxc
      - bin/lxc-to-lxd
      - bin/lxd
      - bin/lxd-agent
      - bin/lxd-benchmark

  lxd-migrate:
    source: lxd-migrate/
    after:
      - lxd
      - sqlite
    plugin: go
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd-pkg-snap/lxd-migrate
    override-build: |
      set -ex

      # Setup for our shared libraries
      sed -i "/^\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/mattn/go-sqlite3/sqlite3.go

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p ${SNAPCRAFT_PART_INSTALL}/bin/
      cp scripts/upgrade-bridge ${SNAPCRAFT_PART_INSTALL}/bin/upgrade-bridge
    prime:
      - bin/lxd-migrate
      - bin/upgrade-bridge

  shmounts:
    source: shmounts/
    plugin: make
    prime:
      - bin/setup-shmounts

  snap-query:
    source: snap-query/
    plugin: go
    go-importpath: github.com/lxc/lxd-pkg-snap/snap-query
    prime:
      - bin/snap-query

  strip:
    source: snapcraft/empty
    after:
      - btrfs
      - ceph
      - dqlite
      - libseccomp
      - logrotate
      - lvm
      - nano
      - nvidia-container
      - openvswitch
      - ovn
      - raft
      - sqlite
      - squashfs-tools-ng
      - vim
      - xfs
      - xtables
      - xz
      - zfs-0-6
      - zfs-0-7
      - zfs-0-8
      - lxc
      - lxcfs
      - criu
      - lxd
      - lxd-migrate
      - shmounts
      - snap-query
    plugin: nil
    override-prime: |
      set -x

      # Strip some of the heavy bits
      strip -s ${SNAPCRAFT_PRIME}/bin/lxc
      strip -s ${SNAPCRAFT_PRIME}/bin/lxd*
      strip -s ${SNAPCRAFT_PRIME}/bin/snap*
      strip -s ${SNAPCRAFT_PRIME}/lib/liblxc*
      strip -s ${SNAPCRAFT_PRIME}/lib/libdqlite*
      strip -s ${SNAPCRAFT_PRIME}/lib/libsqlite*

      for zfs in zfs-0.6 zfs-0.7 zfs-0.8 zfs-2.0; do
          [ ! -d "${SNAPCRAFT_PRIME}/${zfs}" ] && continue
          strip -s ${SNAPCRAFT_PRIME}/${zfs}/bin/* ${SNAPCRAFT_PRIME}/${zfs}/lib/*
      done

      [ -e "${SNAPCRAFT_PRIME}/criu/criu" ] && strip -s ${SNAPCRAFT_PRIME}/criu/criu

      exit 0

  wrappers:
    plugin: dump
    source: snapcraft/
    organize:
      hooks/: snap/hooks/
