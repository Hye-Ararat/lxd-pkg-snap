name: lxd
base: core18
assumes:
  - snapd2.39
version: "4.1"
grade: stable
summary: LXD - the container lightervisor
description: |-
 LXD is a container manager for system containers.

 It offers a REST API to remotely manage containers over the network,
 using an image based workflow and with support for live migration.

 Images are available for all Ubuntu releases and architectures as well
 as for a wide number of other Linux distributions.

 LXD containers are lightweight, secure by default and a great
 alternative to virtual machines.

 Supported configuration options (snap set lxd [<key>=<value>...]):
   - ceph.builtin: Use snap-specific ceph configuration [default=false]
   - criu.enable: Enable experimental live-migration support [default=false]
   - daemon.debug: Increases logging to debug level [default=false]
   - daemon.group: Group of users that can interact with LXD [default=lxd]
   - daemon.preseed: A YAML configuration to feed `lxd init` on initial start
   - lxcfs.pidfd: Start per-container process tracking [default=false]
   - lxcfs.loadavg: Start tracking per-container load average [default=false]
   - lxcfs.cfs: Consider CPU shares for CPU usage [default=false]
   - openvswitch.builtin: Run a snap-specific OVS daemon [default=false]
   - shiftfs.enable: Enable shiftfs support [default=auto]

confinement: strict

apps:
  # Main commands
  activate:
    command: commands/daemon.activate
    daemon: oneshot
    plugs:
      - lxd-support
      - system-observe

  daemon:
    command: commands/daemon.start
    reload-command: commands/daemon.reload
    stop-command: commands/daemon.stop
    stop-timeout: 600s
    restart-condition: on-failure
    daemon: simple
    slots: [lxd]
    plugs:
      - lxd-support
      - network-bind
      - system-observe
    sockets:
      unix:
        listen-stream: $SNAP_COMMON/lxd/unix.socket
        socket-mode: 0660

  lxc:
    command: commands/lxc
    completer: etc/bash_completion.d/snap.lxd.lxc
    plugs:
      - lxd-support
      - system-observe

  lxd:
    command: commands/lxd
    plugs:
      - lxd-support
      - system-observe

  # Sub-commands
  benchmark:
    command: commands/lxd-benchmark
    plugs:
      - lxd-support
      - system-observe
  buginfo:
    command: commands/buginfo
    plugs:
      - lxd-support
      - system-observe
  check-kernel:
    command: commands/lxd-check-kernel
    plugs:
      - lxd-support
      - system-observe
  lxc-to-lxd:
    command: commands/lxc-to-lxd
    plugs:
      - lxd-support
      - system-observe
  migrate:
    command: commands/lxd-migrate
    plugs:
      - lxd-support
      - system-observe

hooks:
  configure:
    plugs:
      - network
      - system-observe
  remove:
    plugs:
      - lxd-support
      - system-observe

parts:
  # Dependencies
  btrfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - btrfs-tools
    prime:
      - bin/btrfs
      - bin/btrfstune
      - bin/mkfs.btrfs

  ceph:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ceph-common
      - libdb5.3
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/ceph
      - bin/python
      - bin/python2*
      - bin/rbd
      - lib/python2.7
      - lib/*/libpython2.7.so*
      - -lib/python2.7/sitecustomize.py
      - lib/*/ceph
      - lib/*/libboost_iostreams.so.*
      - lib/*/libboost_program_options.so.*
      - lib/*/libboost_random.so.*
      - lib/*/libboost_regex.so.*
      - lib/*/libboost_system.so.*
      - lib/*/libboost_thread.so.*
      - lib/*/libcephfs*
      - lib/*/libdb-5.3.so
      - lib/*/libicudata.so.*
      - lib/*/libicui18n.so.*
      - lib/*/libicuuc.so.*
      - lib/*/libnspr4.so
      - lib/*/libnss3.so
      - lib/*/libibverbs.so*
      - lib/*/nss/libsoftokn3.so
      - lib/*/nss/libfreeblpriv3.so
      - lib/*/libnssutil3.so
      - lib/*/libplc4.so
      - lib/*/libplds4.so
      - lib/*/librados.so.*
      - lib/*/librbd.so.*
      - lib/*/libsmime3.so
      - lib/*/libsnappy*

  dqlite:
    after:
      - libco
      - raft
      - sqlite
    source: https://github.com/canonical/dqlite
    source-type: git
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libdqlite*so*
      - lib/*/libuv*

  edk2:
    after:
      - qemu
    source: https://github.com/tianocore/edk2
    source-type: git
    source-tag: edk2-stable202002
    plugin: nil
    build-packages:
      - acpica-tools
      - nasm
      - uuid-dev
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      ARCH="X64"
      PKG="OvmfPkg/OvmfPkgX64.dsc"
      FV_CODE="OVMF_CODE"
      FV_VARS="OVMF_VARS"
      if [ "$(uname -m)" = "aarch64" ]; then
          ARCH="AARCH64"
          PKG="ArmVirtPkg/ArmVirtQemu.dsc"
          FV_CODE="QEMU_EFI"
          FV_VARS="QEMU_VARS"
      fi

      # Run in a bash sub-shell as edksetup.sh requires it
      set -ex
      (
      cat << EOF
          . ./edksetup.sh
          make -C BaseTools ARCH=${ARCH}
          build -a ${ARCH} -t GCC49 -b RELEASE -p ${PKG} \
            -DNETWORK_HTTP_BOOT_ENABLE=TRUE \
            -DSECURE_BOOT_ENABLE=TRUE \
            -DFD_SIZE_2MB \
            -DTPM2_ENABLE=TRUE
      EOF
      ) | bash -e

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      cp Build/*/*/FV/${FV_CODE}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
      cp Build/*/*/FV/${FV_VARS}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"

      if [ "$(uname -m)" = "aarch64" ]; then
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"
      fi

    prime:
      - share/qemu/*

  libco:
    source: https://github.com/canonical/libco
    source-type: git
    plugin: make
    organize:
      usr/lib/: lib/
    prime:
      - lib/libco*so*

  libmnl:
    source: https://git.netfilter.org/libmnl
    source-type: git
    source-tag: libmnl-1.0.4
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libmnl*so*

  libnftnl:
    after:
      - libmnl
    source: https://git.netfilter.org/libnftnl
    source-type: git
    source-tag: libnftnl-1.1.6
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libnftnl*so*

  libseccomp:
    source: https://github.com/seccomp/libseccomp
    source-type: git
    plugin: autotools
    build-packages:
      - gperf
    organize:
      usr/lib/: lib/
    prime:
      - lib/libseccomp*so*

  logrotate:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - logrotate
      - libpopt0
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    stage:
      - bin/logrotate
    prime:
      - bin/logrotate
      - lib/*/libpopt*so*

  lvm:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - dmeventd
      - lvm2
      - thin-provisioning-tools
    organize:
      sbin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/cache_*
      - bin/dmeventd
      - bin/era_*
      - bin/lv*
      - bin/pdata_tools
      - bin/pv*
      - bin/thin_*
      - bin/vg*
      - -bin/vgimportclone
      - -bin/lvmconf
      - -bin/lvmdump
      - -bin/lvmetad
      - -bin/lvmpolld
      - etc/lvm/lvm.conf
      - lib/*/device-mapper/*
      - lib/*/libaio.so*
      - lib/*/libdevmapper*
      - lib/*/liblvm*
      - lib/*/libreadline.so*

  nano:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - nano
    organize:
      usr/bin/: bin/
    prime:
      - bin/nano
      - etc/nanorc

  nftables:
    after:
      - libmnl
      - libnftnl
    source: https://git.netfilter.org/nftables
    source-type: git
    source-tag: v0.9.4
    plugin: autotools
    configflags:
      - --with-json
    build-packages:
      - libjansson-dev
      - libreadline-dev
    stage-packages:
      - libjansson4
    organize:
      sbin/: bin/
      usr/lib/: lib/
    prime:
      - bin/nft
      - lib/*/libjansson*so*
      - lib/libnftables*so*

  nvidia-container:
    after:
      - libseccomp
    source: https://github.com/NVIDIA/libnvidia-container
    source-type: git
    source-tag: v1.1.1
    plugin: make
    build-packages:
      - bmake
      - curl
      - lsb-release
    override-build: |-
      set -ex

      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/bin/"
      cp ${SNAPCRAFT_PROJECT_DIR}/snapcraft/wrappers/nvidia-container-cli "${SNAPCRAFT_PART_INSTALL}/bin/"

      set +ex
      snapcraftctl build
    organize:
      usr/local/bin/nvidia-container-cli: bin/nvidia-container-cli.real
      usr/local/lib: lib/
    prime:
      - bin/nvidia-container-cli*
      - lib/libnvidia-container.so*

  openvswitch:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - openvswitch-switch
      - uuid-runtime
    organize:
      usr/bin/: bin/
      usr/lib/openvswitch-switch/: bin/
      usr/sbin/: bin/
      usr/share/: share/
    prime:
      - bin/ovs-appctl
      - bin/ovs-vsctl
      - bin/ovs-vswitchd
      - bin/ovsdb-*
      - bin/uuidgen
      - share/openvswitch/

  qemu:
    after:
      - libseccomp
    source: https://git.qemu.org/git/qemu.git
    source-type: git
    source-tag: v5.0.0
    plugin: autotools
    configflags:
      - --disable-docs
      - --disable-slirp
      - --disable-user
      - --enable-attr
      - --enable-cap-ng
      - --enable-kvm
      - --enable-linux-aio
      - --enable-pie
      - --enable-rbd
      - --enable-seccomp
      - --enable-system
      - --enable-tools
      - --enable-vhost-crypto
      - --enable-vhost-kernel
      - --enable-vhost-net
      - --enable-vhost-scsi
      - --enable-vhost-user
      - --enable-vhost-vsock
      - --enable-virtfs
      - --enable-vnc
      - --firmwarepath=/snap/lxd/current/share/qemu/
    build-packages:
      - bison
      - flex
      - pkg-config
      - libcap-ng-dev
      - libglib2.0-dev
      - libpixman-1-dev
      - libaio-dev
      - librbd-dev
    stage-packages:
      - genisoimage
      - libmagic1
      - libpixman-1-0
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && [ "$(uname -m)" != "ppc64le" ] && [ "$(uname -m)" != "s390x" ] && exit 0

      set -ex
      # Mangle the configure a bit
      QEMUARCH="$(uname -m)"
      [ "${QEMUARCH}" = "ppc64le" ] && QEMUARCH="ppc64"
      sed -i "s/^unset target_list$/target_list=\"${QEMUARCH}-softmmu\"/" configure
      sed -i 's#libseccomp_minver=".*#libseccomp_minver="0.0"#g' configure

      set +ex
      snapcraftctl build
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/genisoimage*
      - bin/mkisofs*
      - bin/qemu-system-*
      - bin/qemu-img*
      - bin/virtfs-proxy-helper*
      - lib/*/libmagic*so*
      - lib/*/libpixman*so*
      - share/qemu/keymaps*
      - share/qemu/efi-virtio.rom*
      - share/qemu/kvmvapic.bin*
      - share/qemu/s390-*.img*
      - share/qemu/slof.bin*
      - share/qemu/vgabios-*.bin*

  qemu-ovmf-secureboot:
    after:
      - edk2
      - qemu
    source: https://github.com/puiterwijk/qemu-ovmf-secureboot
    source-type: git
    plugin: nil
    build-packages:
      - xorriso
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      set -ex
      rm -Rf iso-root vfat-root shell.iso
      mkdir -p iso-root vfat-root/efi/boot
      cp ../../edk2/build/Build/*/*/*/Shell.efi vfat-root/efi/boot/bootx64.efi
      cp ../../edk2/build/Build/*/*/*/EnrollDefaultKeys.efi vfat-root/
      "${SNAPCRAFT_STAGE}/bin/qemu-img" convert --image-opts driver=vvfat,floppy=on,fat-type=12,label=UEFI_SHELL,dir=vfat-root iso-root/shell.img
      xorriso --as mkisofs -input-charset ASCII -J -rational-rock -e shell.img -no-emul-boot -o shell.iso iso-root/

      # Basic aarch64 support
      if [ "$(uname -m)" = "aarch64" ]; then
          sed -i ovmf-vars-generator \
              -e "s/'-machine', machinetype,/'-machine', 'virt', '-cpu', 'cortex-a57',/" \
              -e "/charserial1/d" \
              -e "s/ide-cd/scsi-cd/" \
              -e "s/'-device',$/'-device', 'virtio-scsi-pci,id=scsi', '-device',/"
      elif [ "$(uname -m)" = "x86_64" ]; then
          cp -f "${SNAPCRAFT_STAGE}/share/qemu/kvmvapic.bin" .
      fi

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      python3 ovmf-vars-generator \
        --qemu-binary "${SNAPCRAFT_STAGE}/bin/qemu-system-$(uname -m)" \
        --print-output --disable-smm --skip-testing \
        --oem-string "$(cat ${SNAPCRAFT_PROJECT_DIR}/snapcraft/etc/ubuntu-sb.crt)" \
        --ovmf-binary "${SNAPCRAFT_STAGE}/share/qemu/OVMF_CODE.fd" \
        --ovmf-template-vars "${SNAPCRAFT_STAGE}/share/qemu/OVMF_VARS.fd" \
        --uefi-shell-iso shell.iso \
        "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.ms.fd"
    prime:
      - share/qemu/*

  raft:
    source: https://github.com/canonical/raft
    source-type: git
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libraft*so*

  sqlite:
    source: https://github.com/canonical/sqlite
    source-type: git
    source-tag: version-3.30.1+replication4
    plugin: autotools
    configflags:
      - --enable-replication
    build-packages:
      - tclsh
    override-build: |-
      set -ex

      git log -1 --format=format:%ci%n | sed -e 's/ [-+].*$//;s/ /T/;s/^/D /' > manifest
      git log -1 --format=format:%H > manifest.uuid
      cp /usr/share/misc/config.guess .
      cp /usr/share/misc/config.sub .
      autoreconf -f -i

      set +ex
      snapcraftctl build
    prime:
      - bin/sqlite3
      - lib/libsqlite3*so*

  squashfs-tools-ng:
    source: https://github.com/AgentD/squashfs-tools-ng
    source-type: git
    source-tag: v0.8
    plugin: autotools
    build-packages:
      - liblzma-dev
    prime:
      - bin/sqfs2tar
      - bin/tar2sqfs
      - lib/libsquashfs.so*

  vim:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - vim-tiny
    organize:
      usr/bin/: bin/
      usr/share/vim/vim*/debian.vim: etc/vimrc
    prime:
      - bin/vim.tiny
      - etc/vimrc

  xfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xfsprogs
    organize:
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/xfs_admin
      - bin/xfs_db
      - bin/xfs_growfs
      - bin/xfs_repair
      - bin/mkfs.xfs

  xtables:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ebtables
      - iptables
      - xtables-addons-common
    organize:
      usr/lib/*/xtables/*: lib/xtables/
      lib/ebtables/*: lib/
      sbin/: bin/
    prime:
      - bin/ebtables
      - etc/ethertypes
      - etc/protocols
      - lib/libebt*
      - lib/xtables/*

  xz:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xz-utils
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/xz
      - lib/*/liblzma*so*

  zfs-0-6:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.6.5.11
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick fb963d33ee0dd350143ba1c9cd35d5f7d86910d2  # Fix endian build problem on ppc64el

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-7:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.7.13
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-8:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.8.4
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  # Core components
  lxc:
    after:
      - libseccomp
    source: https://github.com/lxc/lxc
    source-type: git
    source-tag: lxc-4.0.2
    build-packages:
      - libapparmor-dev
      - libcap-dev
      - libgnutls28-dev
      - libselinux1-dev
      - pkg-config
    plugin: autotools
    configflags:
      - --disable-selinux
      - --disable-tests
      - --disable-examples
      - --disable-doc
      - --disable-tools
      - --disable-api-docs
      - --disable-bash
      - --disable-memfd-rexec
      - --enable-apparmor
      - --enable-seccomp
      - --enable-selinux
      - --enable-capabilities
      - --with-rootfs-path=/var/snap/lxd/common/lxc/
      - --libexecdir=/snap/lxd/current/libexec/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/libexec: libexec
      share/lxc/hooks: lxc/hooks
    prime:
      - bin/lxc-checkconfig
      - lib/liblxc.so.1
      - lib/liblxc.so.1.*
      - lxc/config/common.conf.d
      - lxc/hooks/nvidia
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick d51d0df41ef0f85a127daf84468189655499a6e3  # apparmor: Allow boot_id
      git cherry-pick 3a4031f03696e339c9d6d4cc16af2e771ae7e45f  # src/lxc/network: Fixes netlink attribute type 1 has an invalid length message
      git cherry-pick ba9eab74b8e7c9bcafadb83809f5f07c21318e2d  # cgroups: ignore cgroup2 limits on non-cgroup2 layouts
      git cherry-pick 6001872d082dffce5e328049788c7f1ae0864789  # common.conf: add cgroup2 default device limits
      git cherry-pick 8cce8b5930d3718b11217561bda78dcaa84dfdee  # cgroups: premount cgroups on cgroup2-only systems
      git cherry-pick 0343423e578ef608d6a5c2518de0d7bcbac5887b  # conf: introduce userns_exec_mapped_root()
      git cherry-pick 0baff7b7f54824d8f829a8d7a82b3423db03d305  # conf: support console setup on containers without rootfs
      git cherry-pick 63910a22283059853f0c799f6dcdc369c83518a0  # terminal: remove unneeded if condition
      git cherry-pick c91e492a17a1b24bb77f8089db7c98ca6619fa40  # gcc: add -Warray-bounds, -Wrestrict, -Wreturn-local-addr, -Wstringop-overflow
      git cherry-pick 52d2862cf6965596a2c0eb6bd3c8d9a2e66e9bb2  # compiler: support new access attributes
      git cherry-pick b467fc359118eafa0df761ab55d5ebe78ba4fb75  # tree-wide: this is all rather TODO than FIXME
      git cherry-pick 1cbdec6a1b89132cda4f4c5bd329124c6076b7e5  # yum: remove unused module
      git cherry-pick ab398a1bb9fe21c1049537e20b7ed6bb5cf843a5  # tools/lxc-ls: shutup lgtm
      git cherry-pick 7821133aab5113d629f4cb25e70b124c84903142  # tools/lxc-ls: shut up lgtm more
      git cherry-pick cf52a093d1b9b3b05cde8b43360bd3991b5196de  # confile: fix order independence of network keys
      git cherry-pick ea2a67a6b0c4995fa102021602ea6db93fd4bed8  # lxccontainer: small cleanup to lxc_check_inherited() calls
      git cherry-pick dd2f1aad65c19798bbd7c3de73c60b8ba48216d4  # start: remove unused lxc_zero_handler()
      git cherry-pick 3f96727b459cf032330d42f94b892e1b8c3de707  # lxccontainer: use close_prot_errno_disarm() on state_socket_pair
      git cherry-pick 755d1e1fecca4e841a9906b4b851f8da8ca31f4f  # start: fix container reboot
      git cherry-pick e758df857049176d9c1c132cdde096ce3b554ec5  # start: cleanup file descriptor inheritance
      git cherry-pick 3f924551c9963040e8048e7c7cdb06b9f1768d3e  # log: cleanup syslog handling
      git cherry-pick de4d585ee420862b9a927f04f80d9fbe5ca71de8  # console: only create detached mount when a console is requested
      git cherry-pick 5524656d86fd78be693dbd0f2cd278ed8b8da42c  # syscall_numbers: handle ia64 syscall numbers correctly
      git cherry-pick ef301301c68ad432cfd6beb82fd2da1fdeb78983  # syscall_numbers: add clone3()
      git cherry-pick 6aefab38c133edd2d4c6721ebf6312cac544ccdc  # process_utils: introduce new process_utils.{c,h}
      git cherry-pick a62eb3aa12b57fa83a5335eb9769d37d46e7444d  # process_utils: add clone3() support
      git cherry-pick c3d189153f5534db211defe25bf3c3256e6c564f  # mainloop: add lxc_mainloop_add_handler_events
      git cherry-pick 64df0b2f366c80318910981af9c007b06f3a29f9  # cgfsng: deduplicate freeze code
      git cherry-pick 0842a4652e5788b4f82a424d0a7ee2c2b2240b81  # cgfsng: use EPOLLPRI when polling cgroup.events
      git cherry-pick 7ebcd704bee176dd2f8700c6497d8a6f60ba12a4  # process_utils: make lxc use clone3() whenever possible
      git cherry-pick df7d58b75aca3c710d62e37365a22142d2317981  # network: restore old behavior
      git cherry-pick fc0a8697b4a5a995e4863c48bda30fb6d805dc91  # network: fix {mac,ip,v}lan device creation
      git cherry-pick d7df095654693074aa3e581a78282bb0ad6b6944  # bionic: s/lxc_raw_execveat()/execveat()/g
      git cherry-pick 92a8d6e061cbe516cacd9f143506908e7ed89b6c  # network: use __instantiate_ns_common() in instantiate_ns_phys() too
      git cherry-pick 323a156937cfc9b08e2bb7a43b2600d3b9cd3960  # lxc-usernsexec: dumb down from error to warning message
      git cherry-pick b8025217f72d32cd2a02d772527761edb8a8384d  # lxc-usernsexec: don't fail on setgroups()
      git cherry-pick 0c9e185c962513661f5b26222770074946efcf25  # travis: Restrict coverity to gcc on bionic on amd64
      git cherry-pick dc89b0d7954c85981056407b0305621b598007c9  # introduce lxc.cgroup.dir.{monitor,container,container.inner}
      git cherry-pick bba910b2ff2cca6fbca41c53e39581169e0278de  # cgroups: remove unused variable
      git cherry-pick 3537c31640caf42185608cf93524e2f04a4727d9  # cgroup isolation: handle devices cgroup early
      git cherry-pick 8bbfacd2b488d6d681dbf59a2df7256b137e0f6e  # improve LXC_CMD_GET_CGROUP compatibility
      git cherry-pick 202e017e59cf395d88da37544ee2ef5e3d84c3a0  # cgroups: be less alarming when creating cgroups
      git cherry-pick 53fbc128f3b4758173d1aa63ead91e3e85bd68cd  # commands: make limiting cgroup callbacks unreachable
      git cherry-pick c5acbe98bc4f35599dd27db753e8c73cca21906c  # api_extensions: add "pidfd"
      git cherry-pick bfbd606e6f1cf33bb04ae10bbfadfa10907b9284  # Add test of lxc-usernsexec

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/
      ln -s /var/snap/lxd/common/lxc/local.conf $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/01-local.conf
      sed -i "s#includedir=.*#includedir=$SNAPCRAFT_PART_INSTALL/include#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc
      sed -i "s#libdir=.*#libdir=$SNAPCRAFT_PART_INSTALL/lib#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc

  lxcfs:
    source: https://github.com/lxc/lxcfs
    source-type: git
    source-tag: lxcfs-4.0.3
    build-packages:
      - libfuse-dev
      - libpam0g-dev
      - pkg-config
    stage-packages:
      - fuse
    plugin: autotools
    configflags:
      - --datarootdir=/snap/lxd/current/
      - --localstatedir=/var/snap/lxd/common/var/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/lxcfs: lxcfs
      lib/lxcfs: lib
    prime:
      - bin/fusermount
      - lib/*/libfuse.so.*

      - bin/lxcfs
      - lib/liblxcfs.so

      - lxc
      - lxcfs
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick 7dddc7f335ec5644663112d346ecbd7fe5882163  # proc_fuse: silence error when we find no memlimit
      git cherry-pick 2e7b4138eae5b1cb4c4b6d2c87b45c5425f0c693  # sysfs: cpuinfo: show cgroup cpuset value
      git cherry-pick 10f4d9fb7b28a59a0f4e1104bf2e788cf6726c5b  # sysfs_fuse: remove logically dead code
      git cherry-pick 4179492059341d56eaf39dfd9ba132015fbe2076  # Fix https://github.com/lxc/lxcfs/issues/404
      git cherry-pick 1fdb0df9d21a5073f5d6c3012763429d5bfad404  # coverity: Use build custom build script
      git cherry-pick d1ecd2ea9ffead09852621f689af99499ac69de9  # bindings: fix init pid hashing
      git cherry-pick fde6b415e6015118ad74c772f53612df9dbae05e  # bindings: make opts pointer const
      git cherry-pick a506a056ca643dd0aab6c0b1037f19dc762b528e  # bindings: use brackets to make logic clearer
      git cherry-pick 1c8082f22c671ec8eefad097c4530356416eaf7c  # bindings: cleanup cache locking
      git cherry-pick 6146b6d4025e460ee6c62d537555696256a72399  # bindings: cleanup init pid verification

      set +ex
      snapcraftctl build
      set -ex

      sed -i "s#\${LXC_ROOTFS_MOUNT}/var/snap/lxd/common/var/lib/lxcfs/#\${LXC_ROOTFS_MOUNT}/var/lib/lxcfs/#g" $SNAPCRAFT_PART_INSTALL/snap/lxd/current/lxcfs/lxc.mount.hook

  criu:
    source: https://github.com/checkpoint-restore/criu
    source-tag: v3.14
    source-type: git
    plugin: nil
    build-packages:
      - asciidoc
      - libcap-dev
      - libnet1-dev
      - libnl-3-dev
      - libprotobuf-c-dev
      - libprotobuf-dev
      - protobuf-c-compiler
      - protobuf-compiler
      - python
      - xmlto
    stage-packages:
      - libnet1
      - libprotobuf-c1
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "armv7l" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      make
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/criu/"
      cp criu/criu "${SNAPCRAFT_PART_INSTALL}/criu/"
    organize:
      usr/lib/: lib/
    prime:
      - criu/*
      - lib/*/libnet*
      - lib/*/libproto*

  lxd:
    source: https://github.com/lxc/lxd
    source-type: git
    source-tag: lxd-4.1
    after:
      - lxc
      - dqlite
      - sqlite
    build-packages:
      - libacl1-dev
      - libudev-dev
      - pkg-config
    stage-packages:
      - acl
      - attr
      - dnsmasq-base
      - gdisk
      - iw
      - netbase
      - pciutils
      - pigz
      - rsync
      - squashfs-tools
      - usbutils
      - xdelta3
    plugin: nogetgo
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd
    go-packages:
      - github.com/lxc/lxd/lxc
      - github.com/lxc/lxd/lxc-to-lxd
      - github.com/lxc/lxd/lxd
      - github.com/lxc/lxd/lxd-benchmark
    override-build: |
      set -ex

      # Git cherry-picks
      cd ../src
      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick 19b15efbf341d07c036fc7086a91f384dcbeca93  # shared/generate/db: Fix generation of Exists method
      git cherry-pick 5c8ceafce2996147ba1b66e7273b4e272961ca20  # lxd/db: Make generated code stable across "make update-schema" runs
      git cherry-pick 4a0452aff81e4690d57df8a6111789f0cdca3d5e  # lxd/db: Leverage code-generation for certificates
      git cherry-pick fc0d4c4158413248e940ce602a9080a6d60b256f  # shared: Rewrite OpenPty without cgo
      git cherry-pick 539b6bb5fe7cd2e2f48b4f9dabfa78f5fb7e2424  # openpty: use O_CLOEXEC directly
      git cherry-pick c11dc379f3b1a6d668ff0a84a2f81d56d2823073  # openpty: use fchown()
      git cherry-pick 5b0b96f67ae4597b24aab6f68c9b75c44857185b  # openpty: first unlock the master, then get a slave fd
      git cherry-pick 117e1b9d6d22c78ea16616559c9f0f184d40a222  # openpty: use TIOCGPTPEER if available
      git cherry-pick 2517fefd67f5cbd01bad43662246a515727f6517  # lxd/storage/drivers/driver/lvm/utils: Adds lvmSnapshotSeparator constant and updates lvmFullVolumeName to use it
      git cherry-pick 5c8f968ca54415f89fa709f30e452ab4e4b37d3e  # lxd/storage/drivers/driver/lvm/utils: Adds lvmEscapedHyphen and updates lvmFullVolumeName usage
      git cherry-pick f5ba1cc4ff67772c27c4badc8bb6f4fe2ff3deb3  # lxd/storage/drivers/driver/lvm/utils: Adds parseLogicalVolumeSnapshot function
      git cherry-pick ae6faf612e0f94c1746ccf327d584a19e5ee0404  # lxd/storage/drivers/driver/lvm/utils: Adds tests for parseLogicalVolumeSnapshot
      git cherry-pick e7208789c5b22de9d48d7a2b067d879f55a1cbfd  # lxd/storage/drivers/driver/lvm/volumes: Updates VolumeSnapshots to use parseLogicalVolumeSnapshot
      git cherry-pick 23154b0681140075628292bb0ced61b36240bef1  # test: Adds tests for snapshot naming conflicts
      git cherry-pick b1f42348373b67c8167c7ce3b37f80f331cd7dc9  # lxd/firewall/drivers: Fix nft syntax
      git cherry-pick 5799eea6a617e02f49e22bd7438d7ba0406dd5e5  # lxc/project: Fix remote handling
      git cherry-pick d853d7173979c093d4171e7b4d0519495f060cc4  # tests: Fix bad project switch call
      git cherry-pick 3709620f86bdab0ef20b18355dfa4e73e0fef0cf  # lxd/seccomp: Fix profile conflict between projects
      git cherry-pick b063df724d1a3268bfddc5c61b60e78eacd93e42  # lxd/storage/drivers/driver/lvm/utils: Adds activateVolume and deactivateVolume functions
      git cherry-pick b4e7a04489605cf3be60ec29316d9db31d61872a  # lxd/storage/drivers/driver/lvm/utils: Set --setactivationskip on in createLogicalVolume
      git cherry-pick 78e5d62d28690ce246805fde8406891b3fff0f90  # lxd/storage/drivers/driver/lvm/utils: Set --setactivationskip on in createLogicalVolumeSnapshot
      git cherry-pick 75de186ab0f7662073174b3028764eb8636ad0a3  # lxd/storage/drivers/driver/lvm/utils: Activate volume in copyThinpoolVolume when regeneration FS UUID
      git cherry-pick eac5bc7a4e798b3208cb5ed19f7c3aa10677fe12  # lxd/storage/drivers/driver/lvm: Dont activate all volumes on pool mount
      git cherry-pick dc2c52cce372e8901fa020c3228e65adbe50a054  # lxd/storage/drivers/driver/lvm/volumes: Activate volume before generic copy in CreateVolumeFromCopy
      git cherry-pick d4f423d46d600a78f932bf3b48f9cd0fc3b167f8  # lxd/storage/drivers/driver/lvm/volumes: Activate volume in SetVolumeQuota
      git cherry-pick 7ed97165c2af784f1f1c875f333ff7524c1a97c3  # lxd/storage/drivers/driver/lvm/volumes: Activate volume in MountVolume
      git cherry-pick cc902e404db4c06cae5e8b7de14ec060f4a6142d  # lxd/storage/drivers/driver/lvm/volumes: Deactivate volume in UnmountVolume
      git cherry-pick 7384a1362991a44a4563cf231a5cb42a36df85c3  # lxd/storage/drivers/driver/lvm/volumes: Acticate volume before generic migrate in MigrateVolume
      git cherry-pick a5d2259cff88e3a73c85e675453b0767bd3642d1  # lxd/storage/drivers/driver/lvm/volumes: Activate volume in MountVolumeSnapshot
      git cherry-pick 33063b7f5b0d9bb4999fe41bd80ed876569abc37  # lxd/storage/drivers/driver/lvm/volumes: Deactivate volume in UnmountVolumeSnapshot
      git cherry-pick c52848c167d053d044203e68442cbbc4555022e5  # lxd/storage/drivers/driver/lvm/volumes: Activate volume before FS UUID regen in RestoreVolume
      git cherry-pick 90d976c59862d5741f042838f9b0f39ef143a7a6  # openpty: fix TIOCGPTPEER usage
      git cherry-pick 2340417ec1e39ab48dd9917f580fa2fe00efb9e0  # Make network address bind error fatal when clustered
      git cherry-pick 6c692a0f9cf54a0937ad5de5f226ce4f49e3abf9  # lxd/storage/drivers/driver/btrfs/utils: Renames metadatHeader to restorationHeader
      git cherry-pick a99ac5ba5e6a75be4f31e7f45877cf4f312cafbf  # lxd/storage/drivers/driver/btrfs/volumes: d.restorationHeader usage
      git cherry-pick 4c1c444eeeb3cb77e70ca0e85c348ef863d94899  # lxd/storage/drivers/driver/btrfs/volumes: Clarifies comments in MigrateVolume
      git cherry-pick 811753d345ecee39d09246f01456381e540af79f  # lxd/storage/drivers/driver/btrfs/volumes: Adds safety net against failed matching of subvolumes
      git cherry-pick b03b4ae80cd7bf9ab018d39644bb4eec3e60a5bc  # lxd/storage/drivers/driver/btrfs/utils: Fix deleteSubvolume to support recursive delete with intermediate ro subvols
      git cherry-pick 2b5b51dd9823a565652fa4c32746acd529b3566e  # lxd/storage/drivers/utils: Mark BTRFSSubVolumeMakeRo and BTRFSSubVolumeMakeRw deprecated
      git cherry-pick 24daebe649d726ee20bfb1f56594acc26c90d4a2  # lxd/storage/drivers/driver/btrfs/volumes: Updates RestoreVolume to restore subvolume ro property
      git cherry-pick f83a725093dc2b36224ef5e23f3b4ec556940ff4  # test: Adds BTRFS subvolume tests
      git cherry-pick e3b384d63a4c561a4f07e2d3f1ff1e36f73a166d  # lxd/storage/memorypipe: Fixes issue with partial reads losing data
      git cherry-pick 955977fe0a2fe2d6d2418e8fd945af6fc54792fc  # lxd/storage/drivers/driver/btrfs/volumes: Restores subvolumes ro property in CreateVolumeFromCopy
      git cherry-pick 6fa2d703f11fd68a8bf261e719fdd0816b113b54  # lxd/storage/drivers/driver/btrfs/utils: Adds marshal tags to BTRFSSubVolume and BTRFSMetaDataHeader
      git cherry-pick e16274d989ccf143db92044d7702ca2b7ee23252  # lxd/device/nic/bridged: Updates github.com/mdlayher/netx/eui64
      git cherry-pick fc48ec80c7b2d06cbc92ccfc85468197b2942a9d  # fix IPVLAN docs
      git cherry-pick 7d36f347aa1eafcac096e65b084233e125a858ba  # lxd/cluster: Don't run a connection proxy when connecting with the Go dqlite client
      git cherry-pick b07eb49305191e52b16300da0f7b87bbf55fce53  # lxd/cluster: Extract dqlite network proxy logic to standalone function and support cancellation
      git cherry-pick b0ae3dbe7a778e736a8d2c3ebe79da40080284ce  # lxd/cluster: Use dqliteProxy in raftDial
      git cherry-pick 8742ad0b8397293650754d3841270333b101e628  # lxd/cluster: Use ReadClose() to gracefully stop the dqlite proxy
      git cherry-pick 53d7227ad3317e99a9255d544d00e281e73d132f  # lxd/device/device/utils/generic: Removes deviceNameEncode and deviceNameDecode
      git cherry-pick 6a808c5d3f07b8dc18ed1c80e8fc70c046a61335  # lxd/storage/drivers/utils: Adds PathNameEncode and PathNameDecode
      git cherry-pick ca6fe9a580b0e3007e7b694fcad0d630babe0cbe  # lxd/device/device: PathNameEncode and PathNameDecode usage
      git cherry-pick 523b154a94d88a23219c5d3eeac57241f0372f0c  # lxd/storage/drivers/driver/types: Adds OptimizedBackupHeader field to Info
      git cherry-pick 96b43cc75e3da8a046f628228a392e952fc59779  # lxd/backup/backup: Adds OptimizedHeader field to Info struct
      git cherry-pick 1af82b6d7107e53aac28be5a5f506f29c1b2c2bd  # lxd/backup: Updates backupWriteIndex to populate the OptimizedHeader field
      git cherry-pick c4c4bbbe4c9626ba6d7b2d19f291936f4b58e23a  # lxd/storage/drivers/driver/btrfs: Sets OptimizedBackupHeader to true in Info struct response
      git cherry-pick 027157884b8ed13c08b99a0a123622c5b14b2ff6  # lxd/storage/drivers/driver/btrfs/utils: Adds warning to BTRFSSubVolume and BTRFSMetaDataHeader about shared usage
      git cherry-pick 88244a190fdb8e26ab4ca76301199ef5a9bfe774  # lxd/storage/drivers/driver/btrfs/volumes: Updates BackupVolume to add subvolumes to optimized backup file
      git cherry-pick 11db1ab45021a33cd2de3a1c84c9411d19a339fc  # lxd/storage/drivers/interface: Update CreateVolumeFromBackup to pass srcBackup backup.Info
      git cherry-pick e7b7ff81991d83e0293ebf6d95abd8492efb3bed  # lxd/storage/backend/lxd: Pass srcBackup in CreateInstanceFromBackup
      git cherry-pick 32c36132b52c64e8f04d2e757a4d35bece875ca8  # lxd/storage/drivers: CreateVolumeFromBackup srcBackup backup.Info usage
      git cherry-pick e6617bda5c4b1db2d3618117f1637a48f5273cec  # lxd/backup/backup: Updates GetInfo to set optimizedHeaderFalse false if not present in yaml file
      git cherry-pick 84bca19eeeb307000de8f08c4e681b65c8fe4091  # lxd/storage/drivers/driver/btrfs/utils: Adds loadOptimizedBackupHeader
      git cherry-pick 9fe186bf22fc02169ab1ad9ef7f0c02b1ea7c829  # lxd/storage/drivers/driver/btrfs/volumes: Updates CreateVolumeFromBackup to restore subvolumes using optimized header file
      git cherry-pick cbdca1f26cd82715cf4da8346104e95353c79fda  # lxd/storage/drivers/driver/btrfs/volumes: Simplifies parent volume logic in BackupVolume
      git cherry-pick e45411b87ab17fa845755ad70a34805047891a06  # lxd/storage/drivers/driver/btrfs/volumes: Simplifies parent volume logic for MigrateVolume
      git cherry-pick 8698f2ac9ee77a87949ee49ce085c2c12c410e93  # test: Adds BTRFS backup subvolume tests
      git cherry-pick 6433d35b5988add90614b1e37ad86993ab2979cb  # lxd/storage/drivers/driver/btrfs/utils: Removes receiveSubvolume
      git cherry-pick 9cd32f57a619f76be686dc4f21c33f36a06f4c32  # lxd/storage/drivers/driver/btrfs/utils: Adds receiveSubVolume function
      git cherry-pick 4746e072b64fc79c1aa781ed8c07a6ffce3d76f9  # lxd/storage/drivers/driver/btrfs/volumes: Updates CreateVolumeFromMigration to use receiveSubVolume
      git cherry-pick 375ce45456e9f0789a48541704014a1695896a0f  # lxd/resources/memory: Fix memory calculation
      git cherry-pick f7d28ce46880598f85d96107546453825ae89457  # lxd: Improve logging of shutdown errors
      git cherry-pick 61ea7804fc3352f8c44929544e6c5c8ef7407ea4  # lxd/instances/post: Delete restored instance on backup post hook failure
      git cherry-pick 98ac1124b1e00cbaa4416b3bd6dd7b8a59184a41  # Fix 'how to mount home directory' shiftfs FAQ
      git cherry-pick 25e7a11c4b4daa08636dc75bff8578271fdbd342  # shared: build fs_{32,64}bit.go on mips*
      git cherry-pick 08e739fcbb6d14aca75d3b7ff3a1b8f6d47465b1  # lxd/util: build fs_{32,64}bit.go on mips*
      git cherry-pick 51b8879f617926ca57a5c543a57ee53385bce77d  # lxd/rsync: Adds optional rsync arguments to LocalCopy
      git cherry-pick 54c54b7603e3d8c66fe7e20adf98042c6dbada67  # lxd/storage/utils: Fixes ImageUnpack to not erase generated rootfs block file when doing rsync
      git cherry-pick 68ee8bd0dfd9671faefb6e95af7eb7cefbf214ef  # ethtool: don't report -1 for speed in ethtoolLink()
      git cherry-pick aebc3dbbd7f4f5fbd39827ce61b9b577f31f5989  # lxd/storage/quota/projectquota: Fixes leaking file handles in quota_set_path and quota_get_path
      git cherry-pick 6f5a4f43cd8218aab04e4d1c715f871394fdcc83  # lxd/storage/quota/projectquota: Adds inherit argument to quota_set_path
      git cherry-pick 0ee371669945f42f150f4f9b639d0084da004b3a  # lxd/storage/quota/projectquota: Updates SetProject to recursively set project and support non-directory files
      git cherry-pick e0577383e5edc10456adf62525bc343a0cb5671c  # lxd/storage/drivers/driver/dir/utils: Updates deleteQuota to use DeleteProject
      git cherry-pick e8aebb3badf3ae48e9421f3bd6c6936e1a2cbc50  # lxd/storage/drivers/driver/dir/volumes: Adds quota revert in CreateVolumeFromBackup post hook
      git cherry-pick 406821ba58e04f442b7ff79cdf1af68addcfbf15  # Always skip offline servers when rebalancing
      git cherry-pick 34b77e54a997533b9a78b51515f11ad7a542e98b  # When demoting a voter to spare, transition to stand-by first
      git cherry-pick c5f436137987837a978dd18c36b51903085de4bf  # test/clustering: Make sure that a killed voter can't dsirupt current leader
      git cherry-pick 7dec71f8d0513e6bdfcd680d825d47fc76757565  # lxd/cluster: Use a dedicated channel to stop the dqlite proxy
      git cherry-pick 73daa54bf6688d097f293d8f808b9c9c0933e18c  # lxd: Call Deamon.Kill() also when receiving signals (so db transactions won't be retried)
      git cherry-pick 258e20e656d498da14b05730efc2af37926dcf83  # lxd/db: Add Cluster.Kill() method to prevent retrying upon shutdown
      git cherry-pick 0a46bae0680a047f92ffc7e2ea055f8fb7aa7aeb  # lxd/firewall/drivers/driver/nftables/templates: Fixes proxy nat rule dynamic family
      git cherry-pick 041174437c3cfbee3855da10633f142ae0f0b2ae  # shared/util_linux.go: cast Rdev uint64 for mips
      git cherry-pick e17b282282d9a4e411efb2648c6fbce961e0d892  # lxd/storage/quota/projectquota.go: cast Rdev uint64 for mips
      git cherry-pick 43b913776738a7f8d5e8033718259d079f086dea  # lxd/device/device_utils_unix.go: cast Rdev uint64 for mips
      git cherry-pick 95d213e414aa945070072df2c6836fa99849e37c  # lxd/device/gpu.go: cast Rdev uint64 for mips
      git cherry-pick 43c3fbe7e884b7a2afc88fecf1c1d8d5e80c8de6  # shared: Reimplement GetPollRevents without cgo
      git cherry-pick 47b898e3e9600c3bca3846f2694000511051c868  # lxd-agent: Build statically
      git cherry-pick bd90123fd871988a168d44023ce366d649110993  # Drop gccgo
      git cherry-pick 2b67df761f9712172d614a5c127736ab2b03556b  # lxd-p2c: Drop cgo
      git cherry-pick 980ef31ed078f9a97383f089c50e3b9e665d066d  # shared/ucred: Cleanup package
      git cherry-pick e2dcbb6786f80643c8267d3897abaf2c4e9b77dd  # lxd/api: Don't strip double slashes
      git cherry-pick c34d180fcc791f5a37bb66f2868d4869c9ec3d13  # lxd/operations: Improve error message when database insertion fails
      git cherry-pick 7a87788cbf187f2a656a5cedf79a5620dfde0e72  # lxd/db: Change UpdateCertificate to RenameCertificate (only renaming supported)
      git cherry-pick 12cb01c706a8126fa53439f24d9dfb44ba8815ca  # lxd/db: Rename containers.go to instances.go
      git cherry-pick db98707060e9d6ce14fe9a40f7e230e33dc0d2cd  # shared/generate/db: Statement for deleting references (config and devices)
      git cherry-pick 8bdaffa9dcf6eec0d6d66f2789b1669a9201c6c6  # lxd/db: Generate delete stements for profile config and devices
      git cherry-pick e051168ac9d2f9bd95a7a1470e6f6168c1b99c19  # shared/generate/db: update statement: take ID instead of natural key
      git cherry-pick e9f37db5d724189b78723b22d6bc406d0c8d83d8  # shared/generate/db: Handle config and devices in Update method
      git cherry-pick 9a92da7252f2f8e6e00ab54c4725b745e660d30c  # lxd/db: Generate Update method for profiles
      git cherry-pick 82ab2cc0084212b9f7f749f3764ac90104e98452  # lxd: Plug new UpdateProfile() db method into doProfileUpdate
      git cherry-pick e4a907db1947d35ff9d2285194c898c2ac0985df  # lxd: Plug new UpdateProfile() db method into updatePoolPropertyForAllObjects
      git cherry-pick 71f642ec9e55b90cc4dad5cd27d9c2538e6b83f7  # lxd/db: Generate delete statements for instance config, devices and profiles
      git cherry-pick ec27de7383a25a8931e1b4c5264992dc776ed054  # lxd/db: Generate UpdateInstance method
      git cherry-pick 566fc4e39940a62ec95d33492accf395a51f192d  # lxd/instance: Plug the new UpdateInstance method and replace legacy logic
      git cherry-pick 1a43b6be4ae3a21ec2ce00f288b06217b46086a9  # lxd/db: Drop AddDevicesToEntity
      git cherry-pick d23c3ada138c2129368c0b70031d184c5aab98e7  # lxd/storage/drivers/driver/common: Logging quoting consistency
      git cherry-pick 8a09d17774103bcaa621274225bf8ff531c03f60  # lxd/storage/drivers: Adds storage_lvm_skipactivation patch
      git cherry-pick 25800c760580fc95e16184054218f339f0cb475e  # test: Drive-by fix for flaky clustering rebalance test
      git cherry-pick 208ad6f73d60d0b679e753cd0c007c75fff7e4ca  # Recommend to increase the value of aio-max-nr for production use
      git cherry-pick 33b8ecfeb4c0c2369b6866be39366aadd72a3622  # lxd/firewall/firewall/interface: Change definition of Compat() to return compat issue error
      git cherry-pick b3f3013db74bbf2fba135874bf14d66c2fd8bf0b  # lxd/firewall/drivers/driver/nftables: Updates Compat() to return compat issues as error
      git cherry-pick 964f6522faf25b8c35efdea4998f5bc2b18e99ec  # lxd/firewall/drivers/drivers/xtables: Updates Compat() to return compat issues as error
      git cherry-pick ffe56f7c1cd46c9a7a5e073baa42665c66555167  # shared/simplestreams: Support uefi1.img
      git cherry-pick fc2fdde1c84dc76c667668b8032eb798f9e9e785  # lxd/firewall/firewall/load: Updates driver detection to warn when falling back to non-compatible xtables
      git cherry-pick cf5900aec46790458d2631d0b711d74883a63faa  # lxd/storage/pools: Improves delete pool error info
      git cherry-pick ea079696a3e5974a4baef8cf69f1893ac4310b54  # instance_exec: don't panic
      git cherry-pick 928bf63bb303f872cc4b62cd9f7cadfd343747c3  # lxd/qemu: Handle quoted raw.qemu
      git cherry-pick 5007a03f285a7de7c052b777d11dc15b0ad240c6  # lxd/main_forkproxy: Reduce logging
      git cherry-pick c11bf20310f0adbb15408b5ef67da64b56caa0ee  # lxd/networks: Warn on small IPv6 subnets
      git cherry-pick b10d82bfd1f7fe7e377ea371898aa7a2aa60d77e  # lxd/network: Force DHCP custom gateway
      git cherry-pick b138b97e6e97676737d7b988035654c3c9da5ea3  # lxc/list: Add disk and memory columns
      git cherry-pick 56bbf329f997a5b5fcb79756d82027bb0f609349  # i18n: Update translation template
      git cherry-pick dc5bc5c0c219aead58fb71c30d02f293f43e3694  # lxd/storage/drivers: Make sure tar reader context is cancelled before defer
      git cherry-pick 0e810277298f25776029799150f5c004ad4228ca  # lxc/list: Fix test
      git cherry-pick 6c8d748a8f6552cff0371ab3962854914b7c3814  # shared/archive: Wraps cancelFunc to wait until unpacker process has finished in CompressedTarReader
      git cherry-pick ca21c0a0de10e6cfa692986ba9f6b386066189d0  # lxd/cluster: Transfer leadership before adjusting roles, not after
      git cherry-pick 48c7bac7f7440d7a708d344c15a6274ad9fc6fb7  # lxd/cluster: Add time skew detection
      git cherry-pick 53c56de9c7fd776db9fcbd455bbaaafb91a9c070  # test: Wait a few more seconds for the rebalance to happen
      git cherry-pick 3d708969ea142863ed4e7422c6287492926a9d0e  # lxd/daemon.go: Don't try to rebalance after shutdown sequence has started
      git cherry-pick d31d03a21843522c06b1649f73aa6d76e8257fec  # lxd/cluster: Don't try to rebalance a standalone node
      git cherry-pick 763d5248ca26cbf3414f06772300ab63aa837814  # lxc/ucred: Simplify logic
      git cherry-pick 114877d68e6fa1b2e846266314ffc7d283d0ce6b  # lxd/qemu: Cleanup arch checks
      git cherry-pick 8f4f540c60d26efcb3a6d6a1d4d3bf3419a96f1c  # lxd/qemu: Add s390x support
      git cherry-pick 6a703c35391b81cdf57da9575a5e1bcfb9947056  # lxd/api: Fail /internal/ready requests made after shutdown has started
      git cherry-pick c3a15195b235909dc37cb51b8102acc3038ccc3e  # forkfile: port to using pidfds
      git cherry-pick 7458bef3f7a0109b6188663c2eb833cf738d9c53  # forkmount: port to using pidfds
      git cherry-pick ff45fc4dc30e2143b3062dffa4f5925203aaae22  # forkproxy: port to using pidfds
      git cherry-pick 96f76e593f2f3f505d29aeaa7ef1d3402db4794d  # syscall_numbers: update
      git cherry-pick 43549a5f9db7af859dc6e96996712b1a880d71cf  # forknet: port to pidfds
      git cherry-pick 019b077076ab66ca6eafb5a3e7dc0f2e5dfd0483  # forkuevent: port to pidfds
      git cherry-pick 6e2c41542a015f5072d131c3fc5c1f032e3c17f4  # forksyscall: port to pidfds
      git cherry-pick 7471b9625bf3516ecd419037b7f33f3314b0361c  # daemon: record "pidfd" extension
      git cherry-pick a7974fd02d1412630502b18f472fd0f4ed67920e  # lxd/storage/lvm: Correct bad VG name in patch
      git cherry-pick 9d254746706cb80d8b5794f7953067ea06cca272  # shared/subprocess: Better handle slow systems
      git cherry-pick 5a22992888a512f47497730e2525cc1e93e98160  # tests: Don't assume bridge MTU can be forced up
      git cherry-pick b0c696af0aa844e64b23f50758538849ac1dbd0d  # lxd/db: Use query.SelectString helper in GetLocalImages()
      git cherry-pick cfadcced45d5a6b4d900f00d7b922b959b5aaa40  # lxd/db: Use query.SelectString helper in GetImagesFingerprints()
      git cherry-pick 04224c88b1300816a9513ea0225eff030437e4c2  # shared/generate/db: Support int64 fields
      git cherry-pick 31b497b0daae425ef3ef607568340630ac68a789  # lxd/db: Initial code generation for images (without references)
      git cherry-pick cd5d8b0bc0d24294bca6c045fcb4c8b05859dc0d  # lxd/db: Use the generated GetImages code to implement GetExpiredImages
      git cherry-pick 0078c4ad6408fef5857aabc8985b032d4a15b363  # lxd/db: Use query.SelectObjects helper in GetImageSource
      git cherry-pick 58b655e721d463dd619b84cbdba4edffdfdadb7c  # lxd/db: Use query.SelectStrings helper in ImageSourceGetCachedFingerprint
      git cherry-pick 68293cd3a755251aee182fb853d332ecc3ef3554  # lxd/db: Use query.Count helper in ImageExists
      git cherry-pick 999a788c871b7360f8c3a52409553e0216872e30  # lxd/db: Use query.Count helper in ImageIsReferencedByOtherProjects
      git cherry-pick 9dec4bf566fb841c0043d5f599dbdd3577da3e62  # lxd/db: Use query.UpsertObject helper in CreateImageSource
      git cherry-pick 475610ed23804d615209b590b347b2c5afa9cf84  # lxd/db: Use auto-generated GetImages() to implement GetImage()
      git cherry-pick 2e11f7707e459375b79b8ff8bab92b81d2941942  # lxd/cluster: Drive-by fix for flaky rebalance test
      git cherry-pick feb6ba6b53f81671ca72c97757b2ae27b4658f3c  # lxd/db: Use auto-generated GetImages to implement GetImageFromAnyProject
      git cherry-pick 6b57a2174e27bab9e4434d79a839c037095993d5  # lxd/db: Usage query.DeleteObject to implement DeleteImage
      git cherry-pick 1ba3e7997a0da8d2b31e1ba48060861aadea3784  # lxd/db: Use query.SelectStrings to implement GetImageAliases
      git cherry-pick f74fee1df98e59e52e056957fe3015c531b896bd  # lxd/db: Use a single transaction in GetImageAlias
      git cherry-pick d62ae0ce018923819117402e3e77f80904854b56  # lxd/db: Use a single transaction in DeleteImageAlias
      git cherry-pick fb72bb217e97be8dcd303f1d1631e3f0a83619f9  # lxd/db: Use single transaction in CreateImageAlias
      git cherry-pick 7fb385295224462536b56a546580d713f0db15a4  # lxd/db: Usage single transaction in CreateImage
      git cherry-pick aace94197eb29b8358e0a6a1b86d8a3c9b069050  # lxd/db: Use query.SelectIntegers helper in GetPoolsWithImage
      git cherry-pick 59bfa055ef46351e82e41c7638bd647d0cb28010  # lxd/db: Use a single transaction in GetPoolNamesFromIDs
      git cherry-pick 738f4610244fe911b820fe50de300b7f64067a39  # lxd/db: Use explicit transaction in GetInstanceProjectAndName
      git cherry-pick 26a42430f58a8b6f4f622ca8f5aa56dd5c870255  # lxd/db: Drop unused DeleteInstanceConfig
      git cherry-pick 90dc83a9c2365a110c472cfc9cd25c789aef0eb2  # fork*: add "--" to not misinterpret negative integers as flags
      git cherry-pick a8bfcae8e585f46c17231428e62d65f780adf628  # lxd/storage/utils: Removes unused name arg from VolumeFillDefault
      git cherry-pick 7832dbcfb169d12aa65f0cdb4bd3902da20a8644  # lxd/instance/drivers: storagePools.VolumeFillDefault usage
      git cherry-pick 987968f54a06b6fcfbe4bb894a6e2fd3e6d3c173  # lxd/patches: driver.VolumeFillDefault usage
      git cherry-pick feb360f7d653ff02743443d1607ec1eb4215250a  # lxd/storage/utils: VolumeFillDefault usage
      git cherry-pick d2e75f18121f17909b070c6e738bf5d891082d22  # lxd/storage/utils: Updates VolumeValidateConfig to require volume type
      git cherry-pick 974979cdc5ba6edaf40a67b085426242a7f2c837  # lxd/storage/utils: Adds VolumeDBTypeToType function
      git cherry-pick 58ff71e5e2b53b2ff75362f0e00fbc99dfa10f0d  # lxd/storage/utils: Updates VolumeDBCreate to pass volume type
      git cherry-pick da07c97c13a5ea70f1b3bf29ba607dbf0dc2da97  # lxd/storage/drivers/utils: Updates ensureVolumeBlockFile to reject unsafe volume shrinking
      git cherry-pick db44b7f1132098c11f0a3f2004ef8303d52497ee  # lxd/storage/drivers/geneirc/vfs: Removes genericVFSResizeBlockFile
      git cherry-pick 0c731f5982f541cd3e8deffa96e979cedbee1bbd  # lxd/storage/drivers: ensureVolumeBlockFile usage
      git cherry-pick 00bfc41a03cb95f356349b8a12308774b07868e4  # lxd/storage/drivers/volume: Adds SetQuota function
      git cherry-pick ee933b7cbd1127ad3ac4e5fe96898da032313ef3  # lxd/storage/drivers/volume: Adds config functions
      git cherry-pick f943f047e881435d711feab1aa12c9c931bad4b3  # lxd/storage/drivers/driver/lvm/utils: Removes functions moved into Volume struct
      git cherry-pick b900e88b4b2328077a5aa199071e42d8efe7f79f  # lxd/storage/drivers/driver/lvm/utils: Usage of volume config functions
      git cherry-pick b5cd5af6fa02a0c117cf26cf74d4f68dc4c456a2  # lxd/storage/drivers/driver/lvm/volumes: Volume config function usage
      git cherry-pick ee5b8b4871e885d232764850734ea771d670dcc3  # lxd/storage/drivers: Replace volumeSize() with vol.ConfigSize()
      git cherry-pick e20b071c44a28187e3096810c2de867f1ac7ce59  # forknet: add missing "--" to forknet invocation on detach
      git cherry-pick cab94c851407bad20b14c6506f54165d2e51f5d1  # process_utils: remove a bunch of unused functions
      git cherry-pick 666853963fafdd06050e1c7ee6aaa7755c7c8d73  # lxd: Make use of ExitCode
      git cherry-pick ca8c175dca9b695c80948c85aef7942673ad88f9  # share/subprocess: Reduce sleep back to 5
      git cherry-pick 4f82acaeb38498725c998bd9ac1acd9959885c63  # lxd/instances/lxc: Fix calls to forknet
      git cherry-pick 5cfc51497a5b6cc797922fc5ab5b672fa751f3cf  # forkmount: prevent interpreting negative numbers as flags
      git cherry-pick 813785f1204f85fcedfb6123fd8a444bd26f6b5b  # shared/subprocess: Ensure monitor routine exits
      git cherry-pick f369612e66efe1dd002edec3fc4ee17503125b8f  # shared/subprocess: Properly reset state
      git cherry-pick f861c17d172ba615ac3933d70a1f59c41841c50b  # tests: Fix btrfs test on non-shiftfs
      git cherry-pick b99470f18932fc77df1b09053c9c96bc4c5e793a  # tests: Old kernels don't let you rmdir btrfs
      git cherry-pick 0017346306c917cfc93035dc6382a917d17ed437  # shared/subprocess: Fix Stop handling
      git cherry-pick d1ed6fe67dfb40f522df6b0652f78ceb5b28488f  # lxd/storage/utils: Updates ImageUnpack to detect too small volume for qcow2 image and increase size before unpack
      git cherry-pick c60177b10f1521232d7efc73479860938f8d1fb8  # lxd/storage/utils: Adds checks to ImageUnpack before enlarging volume
      git cherry-pick 9fd0edfae8c320bc23fdd0a0fed4f4f997b094fa  # lxd/storage/drivers/driver/types: Updates VolumeFiller Fill function to take a Volume
      git cherry-pick 101e186a9725a40ee1d88f4f9c4bcaacfbad5758  # lxd/storage: Updates volume filler usage to supply Volume rather than mount path
      git cherry-pick 0d5084afdeeb4ff2d8fca83302f9dd7eff4bc3ab  # lxd/storage/drivers/volume: Adds ConfigSizeFromSource function
      git cherry-pick 7132585c6ed1d668782ff6503abe54a0daa65223  # lxd/storage/drivers/driver/lvm/utils: Updates copyThinpoolVolume to only use vol.config["size"] for resizing
      git cherry-pick ca3bf3683af41c7526657a29d205b0e2a113ad46  # lxd/storage/drivers/driver/lvm/utils: Updates Volume type in createLogicalVolumeSnapshot definition
      git cherry-pick e53a007cb6b37f84736a6e29746a1e957256cddd  # lxd/storage/drivers/driver/common: Adds runFiller function
      git cherry-pick 96eccef556e370dfe0349e2e15423711e7a5bcff  # lxd/storage/backend/lxd: Updates imageFiller to return volume size
      git cherry-pick 399b495ff78f936d065cada6860d01bdd83f33fd  # lxd/storage/backend/lxd: Updates CreateInstanceFromImage to load image vol DB record
      git cherry-pick 23b5fc333908c39a50449424cd83facd701fcc6b  # lxd/storage/backend/lxd: Updates EnsureImage to record volatile.rootfs.size for block images
      git cherry-pick 18e94164d9df28171d1052ca6219f25e608fca21  # lxd/storage/drivers/driver/types: Updates VolumeFiller definition to store size
      git cherry-pick 0a77fe2a88c8ed41809d1c07e97f9773e51ecd9e  # lxd/storage/utils: Validates volatile.rootfs.size key for image volumes in validateVolumeCommonRules
      git cherry-pick 51866ab1b931dacce20496597a0e9e442029b13b  # lxd/storage/utils: Updates ImageUnpack to return image virtual size
      git cherry-pick 2d864791be3f86d697e5f67b5cddd656583aa1fc  # lxd/storage/drivers/driver/btrfs/volumes: d.runFiller usage
      git cherry-pick d587d7bacd5f000dd51e356469ab9b42c864000f  # lxd/storage/drivers/driver/ceph/volumes: d.runFiller usage
      git cherry-pick d508e3920ad36f01ef33aa63ff225767338b74ba  # lxd/storage/drivers/driver/cephfs/volumes: d.runFiller usage
      git cherry-pick 69f533fff398fd76c402ab0eee455c41c23b3cad  # lxd/storage/drivers/driver/dir/volumes: d.runFiller usage
      git cherry-pick e2d4c1aad4cfbdaffd3b9c4f3fd7a0486f2525c6  # lxd/storage/drivers/driver/lvm/volumes: d.runFiller usage
      git cherry-pick bbf5a94938e42ba58e26419022d2cbb53feea1fa  # lxd/storage/drivers/driver/zfs/volumes: d.runFiller usage
      git cherry-pick 4c99ca70a20031ce4dbb9e6d3cb0b421973816b0  # lxd/storage/drivers/volume: Adds SetConfigSize function
      git cherry-pick df841ce3353732bff3f4db3956cd67c3438df039  # lxd/storage/backend/lxd: Updates CreateInstanceFromImage to use vol.ConfigSizeFromSource to dervice volume size
      git cherry-pick 647fd4290f443293bd9d0ddc3712d1381ce4256c  # lxd/storage/drivers: Updates CreateVolumeFromCopy to only use vol.config["size"] for resizing
      git cherry-pick e7e50897e285921da7559d85e72d83b1e4719bab  # lxd: Reduce number of transactions in containerPostClusteringMigrate
      git cherry-pick 1968db8fe5528d5c06ced1ba3d3d29d1ec289768  # lxd/db: Use query.SelectStrings helper in LegacyContainersList
      git cherry-pick 364e4b28a77146e1b823714ce7c3950f948c0843  # lxd/db: Rename dbDeviceTypeToString to deviceTypeToString
      git cherry-pick 2d87129f08eb083b3dd6a39b301de7652e875748  # lxd/db: Group ClusterTx image methods together
      git cherry-pick 815803313c42f2df652b5c86fc669c44fe11a5d4  # lxd/db: Rename ImageSourceGetCachedFingerprint to GetCachedImageSourceFingerprint
      git cherry-pick 32aef5e312cc63b5425f53b9f47d4d7343e939f7  # lxd/storage/drivers/utils: ensureVolumeBlockFile comment clarification
      git cherry-pick 2d02ced95747119517b4eda914feec8531b259ea  # lxd/storage/drivers/utils: Renames BlockDevSizeBytes to BlockDiskSizeBytes
      git cherry-pick 02ed4130dd8c9153d5325c347fb21ffd9c6de504  # lxd/storage/utils: drivers.BlockDiskSizeBytes usage
      git cherry-pick 42a9e24d51ae12ef6491028045696e1196d63f37  # lxd/storage/utils: Simplifies InstanceDiskBlockSize with drivers.BlockDiskSizeBytes usage
      git cherry-pick 3b82eaa828c6a0b4bb0ee404c3faa7ed37fe2e5b  # lxd/storage/drivers/generic/vfs: Simplifies genericVFSBackupVolume with drivers.BlockDiskSizeBytes usage
      git cherry-pick 64774a62300d5eee2f89e55b0ddaae43caffc4e3  # lxd/storage/backend/lxd: Whitespace in CreateInstanceFromBackup
      git cherry-pick 7a9d0aa87a97838d37fca160767d45833a4ce19b  # lxd/storage/drivers/driver/ceph/volumes: BlockDiskSizeBytes usage in SetQuota
      git cherry-pick 74e4e2c82b455eb9e129419dd0e8eacf37292d95  # lxd/storage/drivers: Updates dir and btrfs to support filler volume enlargement
      git cherry-pick f7d4c77149cee70e7a44bcf20240989906f94d3b  # lxd/db: Group ClusterTx instance methods together
      git cherry-pick fde2fc0186aa54cb8a90e02fc202501dfdb5d09b  # lxd/db: Rename AddProfilesToInstance to addProfilesToInstance
      git cherry-pick 97529641ad6873a3946ee99b8b6ff80b0a351109  # lxd/db: Move instance backup methods to backups.go
      git cherry-pick d0c948d949bf5b6dd4ae0584cff40e5dd5b20331  # lxd/db: Rename InstanceBackupArgs to InstanceBackup
      git cherry-pick 25925027c1f6a9384da90376d65846788697b8c5  # lxd/db: Remove unused profile functions
      git cherry-pick eb4711d505b7500e6b06ded344ddea8f37f76e60  # lxd/db: Move storage volumes methods to storage_volumes.go
      git cherry-pick 1bac7968219e6ecb2423b36ad5671fd90da587fc  # lxd/storage/drivers/volume/test: Adds tests for Volume.ConfigSizeFromSource()
      git cherry-pick f446474082e1dd32272fb16b2754f4fbd24920c4  # forkuevent: fix slice allocation
      git cherry-pick f673b791bf96b3e81366f6fb365a5026b2763906  # lxd/images: Set CreatedAt on publish
      git cherry-pick 5b5d38b5481f5b6dcfa95ef7e1834c86b6e30640  # unix-hotplug: fix uevent injection
      git cherry-pick c91e018f4f873993b02b69ed03a3bcb57ff65976  # lxd: New command line option to trace SQL statements
      git cherry-pick c64465ccabf2f406cd23f6a030f94c5eb3688cb9  # lxd/firewall/drivers/drivers/xtables: Updates iptablesInUse to kill process once first rule found
      git cherry-pick 550717c80a979339b547c25785fe9049b2ef8c97  # lxd/backup: Fixes hang in backupCreate when invalid compression argument supplied
      git cherry-pick deef1786e9d93037c366bf24de5ffc82f467bd20  # lxd/storage/utils: Removes duplicated qemu-img call in ImageUnpack
      git cherry-pick b29fb09d3aa123374d4f1dd4a68263d090294609  # lxd/storage/utils: Switch to qemu-img dd mode in ImageUnpack
      git cherry-pick ba6635a6980738f5ba1415ea19121f4519418611  # lxd/storage/drivers/utils: Exports MinBlockBoundary
      git cherry-pick 23ef563b75a2d8dbe61ff2d460d8ae4ce72da820  # lxd/storage/drivers: MinBlockBoundary usage
      git cherry-pick 8f0d53be88303cc56155827e1159ed4cfd383062  # lxd/resources: Handle missing cache size/type
      git cherry-pick ba13dea98924e7334f20ef0f10fed22f04b59c42  # Update documentation with backup compression
      git cherry-pick 61559861b2c2d211dd13192d3ca0a84654bd0daa  # lxd/rbac: New notification API
      git cherry-pick 2f468ffc6d136329e762f44b5f6753b28dd4f39c  # lxd/firewall/nft: Enhance support detection
      git cherry-pick 6f6965bb9a8afbe6ef7a6155dbfd1d087a3793ae  # Fix regression in GetImageFromAnyProject
      git cherry-pick e3d998fe351951d2e8dfead0be23bac2b6513b0b  # doc/security: Adds notes about IPv6 router advertisement security

      # Download any new dependencies
      export GOPATH=$(realpath ../go)
      go get -t -d ./...

      # Setup for our shared libraries
      sed -i "/\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/canonical/go-dqlite/internal/bindings/server.go
      sed -i "/^\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/mattn/go-sqlite3/sqlite3.go

      # Run the standard build
      set +ex
      snapcraftctl build
      set -ex

      # Build the agent (special build tags)
      CGO_ENABLED=0 go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd-agent" -tags=agent,netgo github.com/lxc/lxd/lxd-agent

      # Setup bash completion
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/
      echo 'export PATH="${PATH}:/snap/bin:/var/lib/snapd/snap/bin"' > ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
      cat scripts/bash/lxd-client >> ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/share/misc/: share/misc/
      var/lib/usbutils/usb.ids: share/misc/
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/dnsmasq
      - bin/getfattr
      - bin/setfattr
      - bin/iw
      - bin/pigz
      - bin/rsync
      - bin/setfacl
      - bin/sgdisk
      - bin/unsquashfs
      - bin/xdelta3

      - etc/bash_completion.d/snap.lxd.lxc

      - share/misc

      - bin/lxc
      - bin/lxc-to-lxd
      - bin/lxd
      - bin/lxd-agent
      - bin/lxd-benchmark

  lxd-migrate:
    source: lxd-migrate/
    after:
      - lxd
      - sqlite
    plugin: go
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd-pkg-snap/lxd-migrate
    override-build: |
      set -ex

      # Setup for our shared libraries
      sed -i "/^\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/mattn/go-sqlite3/sqlite3.go

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p ${SNAPCRAFT_PART_INSTALL}/bin/
      cp scripts/upgrade-bridge ${SNAPCRAFT_PART_INSTALL}/bin/upgrade-bridge
    prime:
      - bin/lxd-migrate
      - bin/upgrade-bridge

  shmounts:
    source: shmounts/
    plugin: make
    prime:
      - bin/setup-shmounts

  snap-query:
    source: snap-query/
    plugin: go
    go-importpath: github.com/lxc/lxd-pkg-snap/snap-query
    prime:
      - bin/snap-query

  strip:
    source: snapcraft/empty
    after:
      - btrfs
      - ceph
      - dqlite
      - libco
      - libseccomp
      - logrotate
      - lvm
      - nano
      - nvidia-container
      - openvswitch
      - raft
      - sqlite
      - squashfs-tools-ng
      - vim
      - xfs
      - xtables
      - xz
      - zfs-0-6
      - zfs-0-7
      - zfs-0-8
      - lxc
      - lxcfs
      - criu
      - lxd
      - lxd-migrate
      - shmounts
      - snap-query
    plugin: nil
    override-prime: |
      set -x

      # Strip some of the heavy bits
      strip -s ${SNAPCRAFT_PRIME}/bin/lxc
      strip -s ${SNAPCRAFT_PRIME}/bin/lxd*
      strip -s ${SNAPCRAFT_PRIME}/bin/snap*
      strip -s ${SNAPCRAFT_PRIME}/lib/liblxc*
      strip -s ${SNAPCRAFT_PRIME}/lib/libdqlite*
      strip -s ${SNAPCRAFT_PRIME}/lib/libsqlite*

      for zfs in zfs-0.6 zfs-0.7 zfs-0.8; do
          [ ! -d "${SNAPCRAFT_PRIME}/${zfs}" ] && continue
          strip -s ${SNAPCRAFT_PRIME}/${zfs}/bin/* ${SNAPCRAFT_PRIME}/${zfs}/lib/*
      done

      [ -e "${SNAPCRAFT_PRIME}/criu/criu" ] && strip -s ${SNAPCRAFT_PRIME}/criu/criu

      exit 0

  wrappers:
    plugin: dump
    source: snapcraft/
    organize:
      hooks/: snap/hooks/
