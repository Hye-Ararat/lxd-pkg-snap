name: lxd
version: 2.18
grade: stable
summary: LXD - the container lightervisor
description: LXD is a container manager for system containers.
 It offers a REST API to remotely manage containers over the network,
 using an image based workflow and with support for live migration.

 Images are available for all Ubuntu releases and architectures as well
 as for a wide number of other Linux distributions.

 LXD containers are lightweight, secure by default and a great
 alternative to virtual machines.
confinement: strict

apps:
  benchmark:
    command: wrappers/lxd-benchmark
    plugs: [lxd-support]
  check-kernel:
    command: wrappers/lxd-check-kernel
    plugs: [lxd-support]
  daemon:
    command: wrappers/daemon.start
    reload-command: wrappers/daemon.reload
    stop-command: wrappers/daemon.stop
    stop-timeout: 600s
    restart-condition: always
    daemon: simple
    plugs: [lxd-support]
    slots: [lxd]
  lxc:
    command: wrappers/lxc
    plugs: [lxd-support]
    aliases: [lxc]
    completer: etc/bash_completion.d/snap.lxd.lxc
  lxd:
    command: wrappers/lxd
    plugs: [lxd-support]
  migrate:
    command: wrappers/lxd-migrate
    plugs: [lxd-support]

hooks:
  configure:
    plugs: [network]

parts:
  # Dependencies
  btrfs:
    plugin: nil
    stage-packages:
      - btrfs-tools
    prime:
      - bin/btrfs
      - bin/mkfs.btrfs

  ceph:
    plugin: nil
    stage-packages:
      - ceph-common
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/ceph
      - bin/python
      - bin/python2*
      - bin/rbd
      - lib/python2.7
      - -lib/python2.7/sitecustomize.py
      - lib/*/libboost_iostreams.so.*
      - lib/*/libboost_program_options.so.*
      - lib/*/libboost_random.so.*
      - lib/*/libboost_regex.so.*
      - lib/*/libboost_system.so.*
      - lib/*/libboost_thread.so.*
      - lib/*/libicudata.so.*
      - lib/*/libicui18n.so.*
      - lib/*/libicuuc.so.*
      - lib/*/libnspr4.so
      - lib/*/libnss3.so
      - lib/*/nss/libsoftokn3.so
      - lib/*/nss/libfreeblpriv3.so
      - lib/*/libnssutil3.so
      - lib/*/libplc4.so
      - lib/*/libplds4.so
      - lib/*/librados.so.*
      - lib/*/librbd.so.*
      - lib/*/libsmime3.so

  go:
    source-tag: go1.8.3

  lvm:
    plugin: nil
    stage-packages:
      - dmeventd
      - lvm2
      - thin-provisioning-tools
    organize:
      sbin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/cache_*
      - bin/dmeventd
      - bin/era_*
      - bin/lv*
      - bin/pdata_tools
      - bin/pv*
      - bin/thin_*
      - bin/vg*
      - etc/lvm/lvm.conf
      - lib/*/device-mapper/*
      - lib/*/libaio.so*
      - lib/*/libdevmapper*
      - lib/*/liblvm*
      - lib/*/libreadline.so*

  openvswitch:
    plugin: nil
    stage-packages:
      - openvswitch-switch
      - uuid-runtime
    organize:
      usr/bin/: bin/
      usr/lib/openvswitch-switch/: bin/
      usr/sbin/: bin/
      usr/share/: share/
    prime:
      - bin/ovs-*
      - bin/ovsdb-*
      - bin/uuidgen
      - share/openvswitch/

  zfs:
    plugin: nil
    stage-packages:
      - zfsutils-linux
    organize:
      sbin/: bin/
      usr/lib/: lib/
    prime:
      - bin/zfs
      - bin/zpool
      - lib/libnvpair.so.*
      - lib/libuutil.so.*
      - lib/libzfs_core.so.*
      - lib/libzfs.so.*
      - lib/libzpool.so.*

  # Core components
  lxc:
    source: https://github.com/lxc/lxc
    source-type: git
    source-tag: lxc-2.1.0
    prepare: |-
      set -ex
      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"
    build-packages:
      - libapparmor-dev
      - libcap-dev
      - libgnutls28-dev
      - libseccomp-dev
      - libselinux1-dev
      - pkg-config
    plugin: autotools
    configflags:
      - --disable-selinux
      - --disable-python
      - --disable-lua
      - --disable-tests
      - --disable-examples
      - --disable-doc
      - --disable-api-docs
      - --disable-bash
      - --disable-cgmanager
      - --enable-apparmor
      - --enable-seccomp
      - --enable-selinux
      - --enable-capabilities
      - --with-rootfs-path=/var/snap/lxd/common/lxc/
      - --libexecdir=/snap/lxd/current/libexec/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/libexec: libexec
    prime:
      - bin/lxc-checkconfig
      - lib/liblxc.so.1
      - lib/liblxc.so.1.3.0
      - libexec/lxc/lxc-monitord
      - lxc/config/common.conf.d
    install: |-
      set -ex
      mkdir -p $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/
      ln -s /var/snap/lxd/common/lxc/local.conf $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/01-local.conf
      sed -i "s#includedir=.*#includedir=$SNAPCRAFT_PART_INSTALL/include#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc
      sed -i "s#libdir=.*#libdir=$SNAPCRAFT_PART_INSTALL/lib#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc

  lxcfs:
    source: https://github.com/lxc/lxcfs
    source-type: git
    source-tag: lxcfs-2.0.7
    prepare: |-
      set -ex
      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"
      git cherry-pick 23e74df60646518ec423668f910f7f10e8c00b27 # 0001-pam-non-functional-changes.patch
      git cherry-pick b217984d0a60c62e10d812179b5aca2fda54c90a # 0002-pam-report-back-we-found-the-unified-hierarchy.patch
      git cherry-pick 6702a9e2b102135f1d622d7349104096cd56867b # 0003-bindings-add-mountpoint-for-unified-hierarchy.patch
      git cherry-pick ab932db16d4282f26ee003f1593619bc279a4941 # 0004-pam-chown-cgroup.procs-file-on-unified-hierarchy.patch
      git cherry-pick 5b4ecae5e786af8d876556904d65c2a5f16128cf # 0005-bindings-calculate-uptime-via-proc-pid-stat.patch
      git cherry-pick 2d9cd3b3655319710e1baafad9453ef69e75e950 # 0006-bindings-calculate-btime-correctly.patch
      git cherry-pick 5dcba7d16daadc45e2e25cca3eef8caa5bbe05c4 # 0007-tests-fix-invalid-comparison.patch
      git cherry-pick 72dd97f7ecfa1e118f4b33b3d694694fcf6fd120 # 0008-temporarily-revert-the-virtualization-of-btime-field.patch
    build-packages:
      - libfuse-dev
      - libpam0g-dev
      - pkg-config
    stage-packages:
      - fuse
    plugin: autotools
    configflags:
      - --datarootdir=/snap/lxd/current/
      - --localstatedir=/var/snap/lxd/common/var/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/lxcfs: lxcfs
    prime:
      - bin/fusermount
      - lib/*/libfuse.so.*

      - bin/lxcfs
      - lib/liblxcfs.so
      - lib/liblxcfs.so.*

      - lxc
      - lxcfs
    install: |-
      set -ex
      sed -i "s#\${LXC_ROOTFS_MOUNT}/var/snap/lxd/common/var/lib/lxcfs/#\${LXC_ROOTFS_MOUNT}/var/lib/lxcfs/#g" $SNAPCRAFT_PART_INSTALL/snap/lxd/current/lxcfs/lxc.mount.hook

  lxd:
    source: https://github.com/lxc/lxd
    source-type: git
    source-tag: lxd-2.18
    prepare: |-
      set -ex
      cd ../src
      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"
      git cherry-pick bf2a221d1e8f7493dc8bb78cb7471966d1c34c5a  # dnsmasq static on renames
      git cherry-pick 02c93305a9d33b5ccf71b5dc5fd471451daf8fec  # dnsmasq version handling
      git cherry-pick fc6528884afba76fb96043f376d58f4f0271e991  # Extract uname handling code
      git cherry-pick 0002355d93d88880ad708cb7f0cc84a82f573fe8  # Add helper to create temp files
      git cherry-pick bb5ecf8fb53228ad93878e3e44e89aa95a2159f1  # Add some architecture aliases
      git cherry-pick dbdb5db247f112aa2863c7314d82d4b4f4b01bc6  # Add helper to parse os-release
      git cherry-pick ad742c736c078826f301f547ef1d3101c8b2f23c  # Add helper to get distro info
      git cherry-pick f512caac5b6f30fb6c226b73350d0180bdd41d38  # Extend UA
      git cherry-pick a364b4d99ea6bacf6dabea42d584866746c2c380  # Fix uname handling on some arches
      git cherry-pick 1d52364d269e0d8a7702b8bbe5817e9361feda2c  # Only include kernel version in UA
      git cherry-pick 9e9ba857b63cfe2d8e74aff5406b308c7049ce18  # Move testhelpers into osarch
      git cherry-pick 30c859499e24ba6255508cd664c09cf4c1731bbe  # log15 API breakage
      git cherry-pick d337eddac8e28634e6dd761281422f0ec17bd103  # Fix bad DB upgrade
      git cherry-pick e9312b0072a7b88fdfaa2121b4963288de6288ec  # Cache expiry
      git cherry-pick 9d095eeecaaf857ad79a964828d5c60400085b34  # UploadedAt as RFC3399
      git cherry-pick 1f80dd55cc2499639131cc5df4a5286bcfad87aa  # Convert UploadedAt
      git cherry-pick 1f8b9d14013f9d0ec71a62349031d111d5886ee0  # Fix handling of config triggers
      git cherry-pick 1ff9be263db592b432bd64b4945acb29cfff49a5  # Don't update images while pruning
      git cherry-pick 7f945d1b6bfdb83ffd00fa026c7d42738b8b30e4  # Fix list of updatable images
      git cherry-pick e01e79150ebf888966cbfc93ea3740f62ed22dd8  # Fix storage remote operations
      git cherry-pick be3b8ec723fb549dec7fbb060e9889ccb9e881c2  # Fix renaming networks
      git cherry-pick 59e42cfb65698248a1d77e7eb08f9aae6e957898  # Support canceling parallel downloads
      git cherry-pick bf26aa3cf47c4a8d5105bb20426cc378ab2f4bba  # Don't update network limits unconditionally
    after:
      - go
      - lxc
    build-packages:
      - pkg-config
      - libacl1-dev
      - libsqlite3-dev
    stage-packages:
      - acl
      - dnsmasq-base
      - ebtables
      - rsync
      - squashfs-tools
      - vim-tiny
    plugin: go
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd
    go-packages:
      - github.com/lxc/lxd/lxc
      - github.com/lxc/lxd/lxd
      - github.com/lxc/lxd/lxd-benchmark
    install: |-
      set -ex
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/
      echo 'export PATH="${PATH}:/snap/bin:/var/lib/snapd/snap/bin"' > ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
      cat ../src/config/bash/lxd-client >> ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
      sbin/: bin/
      usr/share/vim/vim74/debian.vim: etc/vimrc
    prime:
      - bin/dnsmasq
      - bin/ebtables
      - bin/rsync
      - bin/setfacl
      - bin/unsquashfs
      - bin/vim.tiny
      - lib/*/libsqlite3*

      - etc/vimrc
      - etc/bash_completion.d/snap.lxd.lxc

      - bin/lxc
      - bin/lxd
      - bin/lxd-benchmark

  lxd-migrate:
    source: lxd-migrate/
    after:
      - go
      - lxd
    build-packages:
      - libsqlite3-dev
    plugin: go
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd-pkg-snap/lxd-migrate
    install: |-
      set -ex
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/bin/
      cp scripts/upgrade-bridge ${SNAPCRAFT_PART_INSTALL}/bin/upgrade-bridge
    prime:
      - bin/lxd-migrate
      - bin/upgrade-bridge

  wrappers:
    plugin: dump
    source: snapcraft/
    organize:
      hooks/: snap/hooks/
