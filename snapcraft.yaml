name: lxd
version: 2.17
grade: stable
summary: LXD - the container lightervisor
description: LXD is a container manager for system containers.
 It offers a REST API to remotely manage containers over the network,
 using an image based workflow and with support for live migration.

 Images are available for all Ubuntu releases and architectures as well
 as for a wide number of other Linux distributions.

 LXD containers are lightweight, secure by default and a great
 alternative to virtual machines.
confinement: strict

apps:
  benchmark:
    command: wrappers/lxd-benchmark
    plugs: [lxd-support]
  check-kernel:
    command: wrappers/lxd-check-kernel
    plugs: [lxd-support]
  daemon:
    command: wrappers/daemon.start
    reload-command: wrappers/daemon.reload
    stop-command: wrappers/daemon.stop
    stop-timeout: 600s
    restart-condition: always
    daemon: simple
    plugs: [lxd-support]
    slots: [lxd]
  lxc:
    command: wrappers/lxc
    plugs: [lxd-support]
    aliases: [lxc]
    completer: etc/bash_completion.d/snap.lxd.lxc
  lxd:
    command: wrappers/lxd
    plugs: [lxd-support]
  migrate:
    command: wrappers/lxd-migrate
    plugs: [lxd-support]

hooks:
  configure:
    plugs: [network]

parts:
  # Dependencies
  btrfs:
    plugin: nil
    stage-packages:
      - btrfs-tools
    prime:
      - bin/btrfs
      - bin/mkfs.btrfs

  ceph:
    plugin: nil
    stage-packages:
      - ceph-common
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/ceph
      - bin/python
      - bin/python2*
      - bin/rbd
      - lib/python2.7
      - -lib/python2.7/sitecustomize.py
      - lib/*/libboost_iostreams.so.*
      - lib/*/libboost_program_options.so.*
      - lib/*/libboost_random.so.*
      - lib/*/libboost_regex.so.*
      - lib/*/libboost_system.so.*
      - lib/*/libboost_thread.so.*
      - lib/*/libicudata.so.*
      - lib/*/libicui18n.so.*
      - lib/*/libicuuc.so.*
      - lib/*/libnspr4.so
      - lib/*/libnss3.so
      - lib/*/nss/libsoftokn3.so
      - lib/*/nss/libfreeblpriv3.so
      - lib/*/libnssutil3.so
      - lib/*/libplc4.so
      - lib/*/libplds4.so
      - lib/*/librados.so.*
      - lib/*/librbd.so.*
      - lib/*/libsmime3.so

  go:
    source-tag: go1.8.3

  lvm:
    plugin: nil
    stage-packages:
      - dmeventd
      - lvm2
      - thin-provisioning-tools
    organize:
      sbin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/cache_*
      - bin/dmeventd
      - bin/era_*
      - bin/lv*
      - bin/pdata_tools
      - bin/pv*
      - bin/thin_*
      - bin/vg*
      - etc/lvm/lvm.conf
      - lib/*/device-mapper/*
      - lib/*/libaio.so*
      - lib/*/libdevmapper*
      - lib/*/liblvm*
      - lib/*/libreadline.so*

  openvswitch:
    plugin: nil
    stage-packages:
      - openvswitch-switch
      - uuid-runtime
    organize:
      usr/bin/: bin/
      usr/lib/openvswitch-switch/: bin/
      usr/sbin/: bin/
      usr/share/: share/
    prime:
      - bin/ovs-*
      - bin/ovsdb-*
      - bin/uuidgen
      - share/openvswitch/

  zfs:
    plugin: nil
    stage-packages:
      - zfsutils-linux
    organize:
      sbin/: bin/
      usr/lib/: lib/
    prime:
      - bin/zfs
      - bin/zpool
      - lib/libnvpair.so.*
      - lib/libuutil.so.*
      - lib/libzfs_core.so.*
      - lib/libzfs.so.*
      - lib/libzpool.so.*

  # Core components
  lxc:
    source: https://github.com/lxc/lxc
    source-type: git
    source-tag: lxc-2.0.8
    prepare: |-
      set -ex
      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"
      git cherry-pick d3264db2e39f57dc9ffb7996cf0e7e039942c6d9 # 0003-utils-fix-num-parsing-functions.patch
      git cherry-pick ba7e919e738eb0661cd25eb265df63b6c27f363b # 0004-tests-lxc_safe_-u-int-add-corner-case-tests.patch
      git cherry-pick 52c2c35311cf89609ba74b80cd905e4a361c8f05 # 0005-lxc-attach-allow-for-situations-without-dev-tty.patch
      git cherry-pick 30f1523a682930addbfab2c489b7547a3ea9d604 # 0006-start-don-t-call-lxc_map_ids-without-id-map.patch
      git cherry-pick ea45f04d2711b92e9025ab02762723254be16aad # 0007-conf-fix-build-without-libcap.patch
      git cherry-pick e13ca528c235c2b69cc3d6343be45e1ddccf9d7f # 0008-start-pin-rootfs-when-privileged.patch
      git cherry-pick 3ddaa189b6f6c6153e3ebeff87ef7689714e3995 # 0009-conf-ile-allow-to-clear-all-config-items.patch
      git cherry-pick fc2ae783372a790de1b02be18a96f57c970a37bd # 0010-utils-fix-ppc64le-builds.patch
    build-packages:
      - libapparmor-dev
      - libcap-dev
      - libgnutls28-dev
      - libseccomp-dev
      - pkg-config
    plugin: autotools
    configflags:
      - --disable-selinux
      - --disable-python
      - --disable-lua
      - --disable-tests
      - --disable-examples
      - --disable-doc
      - --disable-api-docs
      - --disable-bash
      - --disable-cgmanager
      - --enable-apparmor
      - --enable-seccomp
      - --enable-capabilities
      - --with-rootfs-path=/var/snap/lxd/common/lxc/
      - --libexecdir=/snap/lxd/current/libexec/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/libexec: libexec
    prime:
      - bin/lxc-checkconfig
      - lib/liblxc.so.1
      - lib/liblxc.so.1.2.0
      - libexec/lxc/lxc-monitord
      - lxc/config/common.conf.d
    install: |-
      set -ex
      mkdir -p $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/
      ln -s /var/snap/lxd/common/lxc/local.conf $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/01-local.conf
      sed -i "s#includedir=.*#includedir=$SNAPCRAFT_PART_INSTALL/include#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc
      sed -i "s#libdir=.*#libdir=$SNAPCRAFT_PART_INSTALL/lib#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc

  lxcfs:
    source: https://github.com/lxc/lxcfs
    source-type: git
    source-tag: lxcfs-2.0.7
    prepare: |-
      set -ex
      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"
      git cherry-pick 23e74df60646518ec423668f910f7f10e8c00b27 # 0001-pam-non-functional-changes.patch
      git cherry-pick b217984d0a60c62e10d812179b5aca2fda54c90a # 0002-pam-report-back-we-found-the-unified-hierarchy.patch
      git cherry-pick 6702a9e2b102135f1d622d7349104096cd56867b # 0003-bindings-add-mountpoint-for-unified-hierarchy.patch
      git cherry-pick ab932db16d4282f26ee003f1593619bc279a4941 # 0004-pam-chown-cgroup.procs-file-on-unified-hierarchy.patch
      git cherry-pick 5b4ecae5e786af8d876556904d65c2a5f16128cf # 0005-bindings-calculate-uptime-via-proc-pid-stat.patch
      git cherry-pick 2d9cd3b3655319710e1baafad9453ef69e75e950 # 0006-bindings-calculate-btime-correctly.patch
      git cherry-pick 5dcba7d16daadc45e2e25cca3eef8caa5bbe05c4 # 0007-tests-fix-invalid-comparison.patch
      git cherry-pick 72dd97f7ecfa1e118f4b33b3d694694fcf6fd120 # 0008-temporarily-revert-the-virtualization-of-btime-field.patch
    build-packages:
      - libfuse-dev
      - libpam0g-dev
      - pkg-config
    stage-packages:
      - fuse
    plugin: autotools
    configflags:
      - --datarootdir=/snap/lxd/current/
      - --localstatedir=/var/snap/lxd/common/var/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/lxcfs: lxcfs
    prime:
      - bin/fusermount
      - lib/*/libfuse.so.*

      - bin/lxcfs
      - lib/liblxcfs.so
      - lib/liblxcfs.so.*

      - lxc
      - lxcfs
    install:
      set -ex
      sed -i "s#\${LXC_ROOTFS_MOUNT}/var/snap/lxd/common/var/lib/lxcfs/#\${LXC_ROOTFS_MOUNT}/var/lib/lxcfs/#g" $SNAPCRAFT_PART_INSTALL/snap/lxd/current/lxcfs/lxc.mount.hook

  lxd:
    source: https://github.com/lxc/lxd
    source-type: git
    source-tag: lxd-2.17
    prepare: |-
      set -ex
      cd ../src
      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"
      git cherry-pick 16f0aecd767da415c961161f1931be150d795365 # 0001-network-Switch-to-a-directory-based-dhcp-host.patch
      git cherry-pick 24a519d3ea2b02bf5ab22501a8c162b420e12ccc # 0002-network-Make-dnsmasq-quiet-when-not-in-debug-mode.patch
      git cherry-pick 0c138f1f5a6f676b400ac41d091795543770cf67 # 0003-shared-Fix-growing-of-buf-in-GroupId.patch
      git cherry-pick f4b6f27e367ace763bcb3508a26c2634e7b82491 # 0004-Fix-live-migration-bad-URL-in-dumpsuccess.patch
      git cherry-pick 09e0667c0fa3280d8370cee479de8a9cc938e187 # 0005-apparmor-Support-new-stacking-syntax.patch
    after:
      - go
      - lxc
    build-packages:
      - pkg-config
      - libacl1-dev
      - libsqlite3-dev
    stage-packages:
      - acl
      - dnsmasq-base
      - ebtables
      - rsync
      - squashfs-tools
      - vim-tiny
    plugin: go
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd
    go-packages:
      - github.com/lxc/lxd/lxc
      - github.com/lxc/lxd/lxd
      - github.com/lxc/lxd/test/lxd-benchmark
    install: |-
      set -ex
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/
      cp ../src/config/bash/lxd-client ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
      sbin/: bin/
      usr/share/vim/vim74/debian.vim: etc/vimrc
    prime:
      - bin/dnsmasq
      - bin/ebtables
      - bin/rsync
      - bin/setfacl
      - bin/unsquashfs
      - bin/vim.tiny
      - lib/*/libsqlite3*

      - etc/vimrc
      - etc/bash_completion.d/snap.lxd.lxc

      - bin/lxc
      - bin/lxd
      - bin/lxd-benchmark

  lxd-migrate:
    source: lxd-migrate/
    after:
      - go
      - lxd
    build-packages:
      - libsqlite3-dev
    plugin: go
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd-pkg-snap/lxd-migrate
    install: |-
      set -ex
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/bin/
      cp scripts/upgrade-bridge ${SNAPCRAFT_PART_INSTALL}/bin/upgrade-bridge
    prime:
      - bin/lxd-migrate
      - bin/upgrade-bridge

  wrappers:
    plugin: dump
    source: snapcraft/
    organize:
      hooks/: snap/hooks/
