name: lxd
base: core18
assumes:
  - snapd2.39
version: "4.11"
grade: stable
summary: LXD - the container lightervisor
description: |-
 LXD is a container manager for system containers.

 It offers a REST API to remotely manage containers over the network,
 using an image based workflow and with support for live migration.

 Images are available for all Ubuntu releases and architectures as well
 as for a wide number of other Linux distributions.

 LXD containers are lightweight, secure by default and a great
 alternative to virtual machines.


 Supported configuration options (snap set lxd [<key>=<value>...]):

   - ceph.builtin: Use snap-specific Ceph configuration [default=false]
   - ceph.external: Use the system's ceph tools (ignores ceph.builtin) [default=false]
   - criu.enable: Enable experimental live-migration support [default=false]
   - daemon.debug: Increase logging to debug level [default=false]
   - daemon.group: Set group of users that can interact with LXD [default=lxd]
   - daemon.preseed: Pass a YAML configuration to `lxd init` on initial start
   - daemon.syslog: Send LXD log events to syslog [default=false]
   - lvm.external: Use the system's LVM tools [default=false]
   - lxcfs.pidfd: Start per-container process tracking [default=false]
   - lxcfs.loadavg: Start tracking per-container load average [default=false]
   - lxcfs.cfs: Consider CPU shares for CPU usage [default=false]
   - openvswitch.builtin: Run a snap-specific OVS daemon [default=false]
   - shiftfs.enable: Enable shiftfs support [default=auto]

confinement: strict

apps:
  # Main commands
  activate:
    command: commands/daemon.activate
    daemon: oneshot
    plugs:
      - lxd-support
      - system-observe

  daemon:
    command: commands/daemon.start
    reload-command: commands/daemon.reload
    stop-command: commands/daemon.stop
    stop-timeout: 600s
    restart-condition: on-failure
    daemon: simple
    slots: [lxd]
    plugs:
      - lxd-support
      - network-bind
      - system-observe
    sockets:
      unix:
        listen-stream: $SNAP_COMMON/lxd/unix.socket
        socket-mode: 0660

  lxc:
    command: commands/lxc
    completer: etc/bash_completion.d/snap.lxd.lxc
    plugs:
      - lxd-support
      - system-observe

  lxd:
    command: commands/lxd
    plugs:
      - lxd-support
      - system-observe

  # Sub-commands
  benchmark:
    command: commands/lxd-benchmark
    plugs:
      - lxd-support
      - system-observe
  buginfo:
    command: commands/buginfo
    plugs:
      - lxd-support
      - system-observe
  check-kernel:
    command: commands/lxd-check-kernel
    plugs:
      - lxd-support
      - system-observe
  lxc-to-lxd:
    command: commands/lxc-to-lxd
    plugs:
      - lxd-support
      - system-observe
  migrate:
    command: commands/lxd-migrate
    plugs:
      - lxd-support
      - system-observe

hooks:
  configure:
    plugs:
      - network
      - system-observe
  remove:
    plugs:
      - lxd-support
      - system-observe

parts:
  # Dependencies
  btrfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - btrfs-tools
    prime:
      - bin/btrfs
      - bin/btrfstune
      - bin/mkfs.btrfs

  ceph:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ceph-common
      - libdb5.3
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/ceph
      - bin/python
      - bin/python2*
      - bin/rbd
      - lib/python2.7
      - lib/*/libpython2.7.so*
      - -lib/python2.7/sitecustomize.py
      - lib/*/ceph
      - lib/*/libboost_iostreams.so.*
      - lib/*/libboost_program_options.so.*
      - lib/*/libboost_random.so.*
      - lib/*/libboost_regex.so.*
      - lib/*/libboost_system.so.*
      - lib/*/libboost_thread.so.*
      - lib/*/libcephfs*
      - lib/*/libdb-5.3.so
      - lib/*/libicudata.so.*
      - lib/*/libicui18n.so.*
      - lib/*/libicuuc.so.*
      - lib/*/libnspr4.so
      - lib/*/libnss3.so
      - lib/*/libibverbs.so*
      - lib/*/nss/libsoftokn3.so
      - lib/*/nss/libfreeblpriv3.so
      - lib/*/libnssutil3.so
      - lib/*/libplc4.so
      - lib/*/libplds4.so
      - lib/*/librados.so.*
      - lib/*/librbd.so.*
      - lib/*/libsmime3.so
      - lib/*/libsnappy*

  criu:
    source: https://github.com/checkpoint-restore/criu
    source-tag: v3.15
    source-type: git
    source-depth: 1
    plugin: nil
    build-packages:
      - asciidoc
      - libcap-dev
      - libnet1-dev
      - libnl-3-dev
      - libprotobuf-c-dev
      - libprotobuf-dev
      - protobuf-c-compiler
      - protobuf-compiler
      - python
      - xmlto
    stage-packages:
      - libnet1
      - libprotobuf-c1
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "armv7l" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      make
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/criu/"
      cp criu/criu "${SNAPCRAFT_PART_INSTALL}/criu/"
    organize:
      usr/lib/: lib/
    prime:
      - criu/*
      - lib/*/libnet*
      - lib/*/libproto*

  dqlite:
    after:
      - raft
      - sqlite
    source: https://github.com/canonical/dqlite
    source-type: git
    source-depth: 1
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libdqlite*so*
      - lib/*/libuv*

  edk2:
    source: https://github.com/tianocore/edk2
    source-type: git
    source-tag: IRRELEVANT
    source-depth: 1
    plugin: nil
    build-packages:
      - acpica-tools
      - nasm
      - uuid-dev
    override-pull: |-
      set -ex
      git clone https://github.com/tianocore/edk2 . -b edk2-stable202008

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      # Fix submodules
      sed -i "s#https://git.cryptomilk.org/projects/cmocka#https://gitlab.com/cmocka/cmocka#g" .gitmodules
      git submodule update --init --recursive

      # Apply patches
      patch -p1 < "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0001-force-DUID-LLT.patch"
      cp "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0002-logo.bmp" MdeModulePkg/Logo/Logo.bmp
      patch -p1 < "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0003-boot-delay.patch"

      ARCH="X64"
      PKG="OvmfPkg/OvmfPkgX64.dsc"
      FV_CODE="OVMF_CODE"
      FV_VARS="OVMF_VARS"
      if [ "$(uname -m)" = "aarch64" ]; then
          ARCH="AARCH64"
          PKG="ArmVirtPkg/ArmVirtQemu.dsc"
          FV_CODE="QEMU_EFI"
          FV_VARS="QEMU_VARS"
      fi

      # Run in a bash sub-shell as edksetup.sh requires it
      set -ex
      (
      cat << EOF
          . ./edksetup.sh
          make -C BaseTools ARCH=${ARCH}
          build -a ${ARCH} -t GCC49 -b RELEASE -p ${PKG} \
            -DSECURE_BOOT_ENABLE=TRUE \
            -DNETWORK_IP4_ENABLE=TRUE \
            -DNETWORK_IP6_ENABLE=TRUE \
            -DNETWORK_TLS_ENABLE=TRUE \
            -DNETWORK_HTTP_BOOT_ENABLE=TRUE \
            -DFD_SIZE_2MB \
            -DTPM2_ENABLE=TRUE
      EOF
      ) | bash -e

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      cp Build/*/*/FV/${FV_CODE}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
      cp Build/*/*/FV/${FV_VARS}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"

      if [ "$(uname -m)" = "aarch64" ]; then
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"
      fi

    prime:
      - share/qemu/*

  libmnl:
    source: https://git.netfilter.org/libmnl
    source-type: git
    source-tag: libmnl-1.0.4
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libmnl*so*

  libnftnl:
    after:
      - libmnl
    source: https://git.netfilter.org/libnftnl
    source-type: git
    source-tag: libnftnl-1.1.9
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libnftnl*so*

  libseccomp:
    source: https://github.com/seccomp/libseccomp
    source-type: git
    source-tag: v2.5.1
    source-depth: 1
    plugin: autotools
    build-packages:
      - gperf
    organize:
      usr/lib/: lib/
    prime:
      - lib/libseccomp*so*

  libtpms:
    source: https://github.com/stefanberger/libtpms
    source-type: git
    source-tag: v0.7.7
    source-depth: 1
    plugin: autotools
    configflags:
      - --with-tpm2
      - --with-openssl
    organize:
      usr/lib/: lib/
    prime:
      - lib/libtpms*so*

  libusb:
    source: https://github.com/libusb/libusb
    source-type: git
    source-tag: v1.0.24
    source-depth: 1
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libusb*so*

  logrotate:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - logrotate
      - libpopt0
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    stage:
      - bin/logrotate
    prime:
      - bin/logrotate
      - lib/*/libpopt*so*

  lvm:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - dmeventd
      - lvm2
      - thin-provisioning-tools
    organize:
      sbin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/cache_*
      - bin/dmeventd
      - bin/era_*
      - bin/lv*
      - bin/pdata_tools
      - bin/pv*
      - bin/thin_*
      - bin/vg*
      - -bin/vgimportclone
      - -bin/lvmconf
      - -bin/lvmdump
      - -bin/lvmetad
      - -bin/lvmpolld
      - etc/lvm/lvm.conf
      - lib/*/device-mapper/*
      - lib/*/libaio.so*
      - lib/*/libdevmapper*
      - lib/*/liblvm*
      - lib/*/libreadline.so*

  nano:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - nano
    organize:
      usr/bin/: bin/
    prime:
      - bin/nano
      - etc/nanorc

  nftables:
    after:
      - libmnl
      - libnftnl
    source: https://git.netfilter.org/nftables
    source-type: git
    source-tag: v0.9.8
    plugin: autotools
    configflags:
      - --with-json
    build-packages:
      - libjansson-dev
      - libreadline-dev
    stage-packages:
      - libjansson4
    organize:
      sbin/: bin/
      usr/lib/: lib/
    prime:
      - bin/nft
      - lib/*/libjansson*so*
      - lib/libnftables*so*

  nvidia-container:
    after:
      - libseccomp
    source: https://github.com/NVIDIA/libnvidia-container
    source-type: git
    source-tag: v1.3.2
    source-depth: 1
    plugin: make
    build-packages:
      - bmake
      - curl
      - lsb-release
    override-build: |-
      set -ex

      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/bin/"
      cp ${SNAPCRAFT_PROJECT_DIR}/snapcraft/wrappers/nvidia-container-cli "${SNAPCRAFT_PART_INSTALL}/bin/"

      set +ex
      snapcraftctl build
    organize:
      usr/local/bin/nvidia-container-cli: bin/nvidia-container-cli.real
      usr/local/lib: lib/
    prime:
      - bin/nvidia-container-cli*
      - lib/libnvidia-container.so*

  openvswitch:
    source: https://github.com/openvswitch/ovs
    source-type: git
    source-tag: v2.14.1
    source-depth: 1
    plugin: autotools
    stage-packages:
      - uuid-runtime
    organize:
      sbin/: bin/
      usr/bin/: bin/
    prime:
      - bin/ovs-appctl
      - bin/ovs-vsctl
      - bin/ovs-vswitchd
      - bin/ovsdb-*
      - bin/uuidgen
      - share/openvswitch/

  ovn:
    after:
      - openvswitch
    source: https://github.com/ovn-org/ovn
    source-type: git
    source-tag: v20.09.0
    source-depth: 1
    configflags:
      - --with-ovs-source=../../openvswitch/build/
    plugin: autotools
    prime:
      - bin/ovn-nbctl

  spice-protocol:
    source: https://gitlab.freedesktop.org/spice/spice-protocol
    source-type: git
    source-tag: v0.14.3
    source-depth: 1
    plugin: meson
    prime: []

  spice-server:
    after:
      - spice-protocol
    source: https://gitlab.freedesktop.org/spice/spice
    source-type: git
    source-tag: v0.14.3
    source-depth: 1
    plugin: meson
    meson-parameters:
      - --prefix=/
      - -Dgstreamer=no
      - -Dmanual=false
      - -Dlz4=false
      - -Dsasl=false
      - -Dopus=disabled
      - -Dsmartcard=disabled
      - -Dtests=false
    build-packages:
      - libjpeg-turbo8-dev
      - python3-pyparsing
      - python3-six
    stage-packages:
      - libjpeg-turbo8
      - libpixman-1-0
    organize:
      sbin/: bin/
      usr/lib: lib/
      usr/local/lib/: lib/
    prime:
      - lib/*/libjpeg*so*
      - lib/*/libspice-server*so*
      - lib/*/libpixman*so*

  swtpm:
    after:
      - libseccomp
      - libtpms
    source: https://github.com/stefanberger/swtpm
    source-type: git
    source-tag: v0.5.2
    source-depth: 1
    plugin: autotools
    build-packages:
      - expect
      - gawk
      - iproute2
      - python3-cryptography
      - python3-setuptools
      - socat
    configflags:
      - --with-seccomp
      - --with-openssl
      - --without-cuse
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      lib/swtpm/: lib/
    prime:
      - bin/swtpm
      - lib/libswtpm*so*

  qemu:
    after:
      - libseccomp
      - libusb
      - spice-protocol
      - spice-server
    source: IRRELEVANT
    source-type: git
    plugin: autotools
    install-via: prefix
    configflags:
      - --disable-bochs
      - --disable-cloop
      - --disable-dmg
      - --disable-docs
      - --disable-guest-agent
      - --disable-parallels
      - --disable-qed
      - --disable-sheepdog
      - --disable-slirp
      - --disable-user
      - --disable-vdi
      - --disable-vnc
      - --disable-xen
      - --enable-attr
      - --enable-cap-ng
      - --enable-kvm
      - --enable-libusb
      - --enable-usb-redir
      - --enable-linux-aio
      - --enable-numa
      - --enable-pie
      - --enable-rbd
      - --enable-seccomp
      - --enable-spice
      - --enable-system
      - --enable-tcg
      - --enable-tools
      - --enable-vhost-crypto
      - --enable-vhost-kernel
      - --enable-vhost-net
      - --enable-vhost-scsi
      - --enable-vhost-user
      - --enable-vhost-vsock
      - --enable-virtfs
      - --firmwarepath=/snap/lxd/current/share/qemu/
      - --localstatedir=/var/
    build-packages:
      - bison
      - flex
      - pkg-config
      - libaio-dev
      - libcap-ng-dev
      - libglib2.0-dev
      - libnuma-dev
      - libpixman-1-dev
      - librbd-dev
      - libusbredirhost-dev
    stage-packages:
      - genisoimage
      - libmagic1
      - libnuma1
      - libpixman-1-0
      - libusbredirhost1
      - libusbredirparser1
    override-pull: |-
      set -ex
      git clone https://github.com/qemu/qemu . -b v5.2.0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && [ "$(uname -m)" != "ppc64le" ] && [ "$(uname -m)" != "s390x" ] && exit 0

      set -ex
      # Mangle the configure a bit
      QEMUARCH="$(uname -m)"
      [ "${QEMUARCH}" = "ppc64le" ] && QEMUARCH="ppc64"
      sed -i "s/^unset target_list$/target_list=\"${QEMUARCH}-softmmu\"/" configure
      sed -i 's#libseccomp_minver=".*#libseccomp_minver="0.0"#g' configure
      sed -i "s#https://git.qemu.org/git#https://github.com/qemu#g" .gitmodules

      set +ex
      snapcraftctl build
    organize:
      libexec/: bin/
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/genisoimage*
      - bin/mkisofs*
      - bin/qemu-system-*
      - bin/qemu-img*
      - bin/virtfs-proxy-helper*
      - bin/virtiofsd*
      - lib/*/libmagic*so*
      - lib/*/libnuma*so*
      - lib/*/libpixman*so*
      - lib/*/libusbredir*so*
      - share/qemu/keymaps*
      - share/qemu/efi-virtio.rom*
      - share/qemu/kvmvapic.bin*
      - share/qemu/s390-*.img*
      - share/qemu/slof.bin*
      - share/qemu/vgabios-*.bin*

  qemu-ovmf-secureboot:
    after:
      - edk2
      - qemu
    source: https://github.com/puiterwijk/qemu-ovmf-secureboot
    source-type: git
    source-depth: 1
    plugin: nil
    build-packages:
      - xorriso
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      set -ex
      rm -Rf iso-root vfat-root shell.iso
      mkdir -p iso-root vfat-root/efi/boot
      cp ../../edk2/build/Build/*/*/*/Shell.efi vfat-root/efi/boot/bootx64.efi
      cp ../../edk2/build/Build/*/*/*/EnrollDefaultKeys.efi vfat-root/
      "${SNAPCRAFT_STAGE}/bin/qemu-img" convert --image-opts driver=vvfat,floppy=on,fat-type=12,label=UEFI_SHELL,dir=vfat-root iso-root/shell.img
      xorriso --as mkisofs -input-charset ASCII -J -rational-rock -e shell.img -no-emul-boot -o shell.iso iso-root/

      # Basic aarch64 support
      if [ "$(uname -m)" = "aarch64" ]; then
          sed -i ovmf-vars-generator \
              -e "s/'-machine', machinetype,/'-machine', 'virt', '-cpu', 'cortex-a57',/" \
              -e "/charserial1/d" \
              -e "s/ide-cd/scsi-cd/" \
              -e "s/'-device',$/'-device', 'virtio-scsi-pci,id=scsi', '-device',/"
      elif [ "$(uname -m)" = "x86_64" ]; then
          cp -f "${SNAPCRAFT_STAGE}/share/qemu/kvmvapic.bin" .
      fi

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      python3 ovmf-vars-generator \
        --qemu-binary "${SNAPCRAFT_STAGE}/bin/qemu-system-$(uname -m)" \
        --print-output --disable-smm --skip-testing \
        --oem-string "$(cat ${SNAPCRAFT_PROJECT_DIR}/snapcraft/etc/ubuntu-sb.crt)" \
        --ovmf-binary "${SNAPCRAFT_STAGE}/share/qemu/OVMF_CODE.fd" \
        --ovmf-template-vars "${SNAPCRAFT_STAGE}/share/qemu/OVMF_VARS.fd" \
        --uefi-shell-iso shell.iso \
        "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.ms.fd"
    prime:
      - share/qemu/*

  raft:
    source: https://github.com/canonical/raft
    source-type: git
    source-depth: 1
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libraft*so*

  sqlite:
    source: https://github.com/sqlite/sqlite
    source-type: git
    source-depth: 1
    source-tag: version-3.34.1
    plugin: autotools
    build-packages:
      - tcl
    override-build: |-
      set -ex

      git log -1 --format=format:%ci%n | sed -e 's/ [-+].*$//;s/ /T/;s/^/D /' > manifest
      git log -1 --format=format:%H > manifest.uuid
      cp /usr/share/misc/config.guess .
      cp /usr/share/misc/config.sub .
      autoreconf -f -i

      set +ex
      snapcraftctl build
    prime:
      - bin/sqlite3
      - lib/libsqlite3*so*

  squashfs-tools-ng:
    source: https://github.com/AgentD/squashfs-tools-ng
    source-type: git
    source-tag: v1.0.4
    source-depth: 1
    plugin: autotools
    build-packages:
      - liblzma-dev
    prime:
      - bin/sqfs2tar
      - bin/tar2sqfs
      - lib/libsquashfs.so*

  vim:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - vim-tiny
    organize:
      usr/bin/: bin/
      usr/share/vim/vim*/debian.vim: etc/vimrc
    prime:
      - bin/vim.tiny
      - etc/vimrc

  xfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xfsprogs
    organize:
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/xfs_admin
      - bin/xfs_db
      - bin/xfs_growfs
      - bin/xfs_repair
      - bin/mkfs.xfs

  xtables:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ebtables
      - iptables
      - xtables-addons-common
    organize:
      usr/lib/*/xtables/*: lib/xtables/
      lib/ebtables/*: lib/
      sbin/: bin/
    prime:
      - bin/ebtables
      - etc/ethertypes
      - etc/protocols
      - lib/libebt*
      - lib/xtables/*

  xz:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xz-utils
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/lzma
      - bin/xz
      - lib/*/liblzma*so*
    override-build: |
      snapcraftctl build

      # Include the lzma symlink
      ln -s xz "${SNAPCRAFT_PART_INSTALL}/usr/bin/lzma"

  zfs-0-6:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.6.5.11
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick fb963d33ee0dd350143ba1c9cd35d5f7d86910d2  # Fix endian build problem on ppc64el

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-7:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.7.13
    source-depth: 1
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-8:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.8.6
    source-depth: 1
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-2-0:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-2.0.2
    source-depth: 1
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zstd:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - zstd
    organize:
      usr/bin/: bin/
    prime:
      - bin/pzstd
      - bin/zstd

  # Core components
  lxc:
    after:
      - libseccomp
    source: https://github.com/lxc/lxc
    source-type: git
    source-tag: lxc-4.0.6
    build-packages:
      - libapparmor-dev
      - libcap-dev
      - libgnutls28-dev
      - libselinux1-dev
      - pkg-config
    plugin: autotools
    configflags:
      - --disable-api-docs
      - --disable-bash
      - --disable-doc
      - --disable-examples
      - --disable-memfd-rexec
      - --disable-tests
      - --disable-tools
      - --enable-apparmor
      - --enable-seccomp
      - --enable-selinux
      - --enable-capabilities
      - --with-rootfs-path=/var/snap/lxd/common/lxc/
      - --libexecdir=/snap/lxd/current/libexec/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/libexec: libexec
      share/lxc/hooks: lxc/hooks
    prime:
      - bin/lxc-checkconfig
      - lib/liblxc.so.1
      - lib/liblxc.so.1.*
      - lxc/config/common.conf.d
      - lxc/hooks/nvidia
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick b1710cdb0378b998055a88e9b439a9c9d1577973  # commands: fix check for seccomp notify support
      git cherry-pick 9d6a3de70086d46f7562ac689d10ca1e36b237a1  # configure: skip libseccomp tests if it is disabled
      git cherry-pick 563ec46266b8967f0ee60e0032bbe66b3b37207c  # conf: fix containers retaining CAP_NET_ADMIN
      git cherry-pick 5a13595b7bc3db36e3f0cdf6f03758591a019d93  # cgroups: fix cgroup mounting
      git cherry-pick 93ce8339d91c9684b739cd65b8b97e9d24ab1371  # lsm: remove obsolute comment about constructor
      git cherry-pick 027f9f8225874b683d70d1ebcce4ae8682522e65  # lxc_attach: include rexec conditionally
      git cherry-pick d12b5190ca8fe3966496858e8c5db508a86ad40a  # tree-wide: fix some header inclusions
      git cherry-pick db574851e6d025ee0daf4afefafa0a05297ad4b5  # initutils: fix missing includes
      git cherry-pick a8d0ef4f131a823b3f4e078f7191c4486725e303  # configure: support static binaries
      git cherry-pick 7b16be129acf38f3a1aae63e98a867df82a5d826  # autotools: enable static builds for tools
      git cherry-pick 132024c5e8b4617f4fd804a54d710651735711a8  # autotools: enable static builds for commands
      git cherry-pick 4fc3bbd45c25a995b3decbdd953a389a365bc369  # tree-wide: fix compilation with-Wstrict-prototypes -Wold-style-definition
      git cherry-pick 5fd525dfdbedf8babe469190e3cb696f01e0f353  # config: update ax_pthread.m4
      git cherry-pick 63efab747c92667a3fea097337133c82152a9ef7  # configure: add AC_SYS_LARGEFILE checking
      git cherry-pick 0564659714a5ed51883a491fd99c725192aece43  # autotools: update build
      git cherry-pick 65bd3f8b4c50ba919fe46af661698f5bb620c695  # file_utils: introduce read_file_at()
      git cherry-pick 329b11dca1312440f57a0bf87632a928e3206c4d  # string_utils: add must_make_path_relative()
      git cherry-pick f8ea20d88b6e8cc202adf4bd0d8cc10ff70cce52  # cgroups: coding style fixes
      git cherry-pick 391d314b7aa2087608b898399fb53a9dd259266c  # cgroups: rework cg_unified_init()
      git cherry-pick c825d4704266c3517288895184d9232c55e1b7f8  # cgroups: detect and record cgroup2 freezer support
      git cherry-pick 3886f4a8d9665f418c3846d16c5141753640c51f  # criu: handle cgroup2 freezer
      git cherry-pick c1c7d42cf757c46068ef3a0eeea5a8f6c88d7f5e  # mkdir -p /proc /sys on container startup
      git cherry-pick 6cec518d16b53d9416dd5a370c01c006de21e8ec  # conf: fix coding style
      git cherry-pick 4b7db20ee44ed94e948fa81da7030ad3fdf31cd8  # conf: coding style fixes
      git cherry-pick f06e80de163680ae7cd92fe8de9ae60ff3bea266  # conf: move proc and sys mountpoint creation int lxc_mount_auto_mounts()
      git cherry-pick 30d5a566e364a9e9a9f838ceee5f46c1fa5cde6c  # attach: invert child/parent handling
      git cherry-pick e95c4c2d9b3bef0073855eda11a0a9aaa7fe6879  # attach: use __do_free cleanup macro for cwd
      git cherry-pick 6e9fd7e90b8b638e7b11966653228ba0139c95a1  # attach: tweak logging
      git cherry-pick b994e6f273e2f6e9b94973a6554b02a897bb30fc  # attach: use __do_close for labelfd
      git cherry-pick 084378794a535478961aeb8cf006221043f83bb0  # attach: coding style fixes
      git cherry-pick 02c90439e65a1627e925cfdcda29ba898cca8d97  # attach: use free_disarm()
      git cherry-pick 7379954b39a312972c05971274b7848a49a0c5c6  # attach: s/attach_child_main/do_attach/g
      git cherry-pick e8a2d23cc7b3ad0f360be5c1f91e570755b06024  # attach: mark do_attach() as __noreturn
      git cherry-pick 43a6efe7b1002ed2d5770c54fa5682d68d1df1b5  # attach: make do_attach() void
      git cherry-pick c16fae6d41f6aa9f1a758f8bfc218b7bd7316a93  # attach: use close_prot_errno_disarm()
      git cherry-pick 252605bccc19a0c3d75030842aac2760ac16abd5  # attach: add some DEBUG() logging to stdfd dpulication
      git cherry-pick 8cfda4171e76c7ce3e684baea7ec9dcb859a3942  # cgroups: fix cgroup mounting
      git cherry-pick 145423e0a34baa0ca4f1a721525ac30cec3b62e4  # utils: fix mount_at()
      git cherry-pick 5b8e411ec79ac4c85e5410bc974e19b5feb0b60b  # configure: fix static builds with clang-12 and LTO
      git cherry-pick f9f1879966261923e7b106717e804cbdb597f8bf  # cgroups: bpf fixes
      git cherry-pick 8d22ec0166ee8bbf6b51596e0f93ea99026b37c4  # croups: improve __do_bpf_program_free
      git cherry-pick 5e84adf6ffb649e56c445ae4bba138654263f65b  # cgroups: coding style fixes
      git cherry-pick 9dee31e50145ccd06061f8e3277e7874696f9d36  # cgroups: don't initiliaze NULL log
      git cherry-pick 8f9cd8d0d27399c9a7301125a30942227ee694c2  # cgroups: ensure all memory is zeroed
      git cherry-pick 61eb36f89cf8079c59b7a4784448c4b3da8c7142  # cgroups: use zalloc
      git cherry-pick 1aac9f39a0587e52a83197668eee651b0e46b14c  # cgroups: tweak cgroup initialization
      git cherry-pick 17b2106bf01d7c58642458c5c622787d3760b91b  # log: remove pointless inline
      git cherry-pick 7491f5a162c26796d8baaac4e51a8e819d676073  # log: add lxc_log_get_fd()
      git cherry-pick cc486b115749a467506dee9d58bf3f03c65736a5  # seccomp: use lxc_log_get_fd()
      git cherry-pick 599086c8487dce6c68ce8807e3e6bcd3c3ef5edc  # log: rework lxc_log_get_level()
      git cherry-pick 5e651c8e7fc99e71bab74cd679da4e8365f5100f  # seccomp: use lxc_log_get_level()
      git cherry-pick 4e977ae8d026247e9126769a8161b5b0eeb4ae42  # cgroups: use bpf log when logging at trace level
      git cherry-pick b4a42b37d5381da4cc7a8ba8289ed4edab41998b  # log: add lxc_log_trace() helper
      git cherry-pick 76651de6decac24de6c17a1cdb763e4a46e4812a  # cgroups: use PTR_TO_U64()
      git cherry-pick 76746bc5fdb444824cd2d4d89a63cc2b9950fa8c  # cgroups: align methods
      git cherry-pick 55fd921789b0909da6098c8474111ffae7b8594f  # utils: use SYSTRACE() when logging stdio permission fixup failures
      git cherry-pick 971dcc4313b9eb8892fc46b23c7a18474fb6407e  # attach: log failues to dup2() with SYSDEBUG()
      git cherry-pick f235460c3cbceaa3cc411bc321ba2434ca585e99  # attach: fix logging for stdfd replacement
      git cherry-pick 1cc616fe8c84a9681af451c4e8791d152a07edc2  # attach: fix error checking for dup2()
      git cherry-pick c9186cc9271579bf4456fcd32c979a9912afa7bb  # cgroups: initialize variable
      git cherry-pick 639428eb59880a70e1e179a0c1aae53210df3148  # commands_utils: don't leak memory
      git cherry-pick eb30db661b946219c8f67b2ce1e9b1bc8063bd3a  # conf: use lxc_log_trace()
      git cherry-pick 6f86b90ddaeb67e80ca587db7dec7de5f5f36654  # confile_utils: use lxc_log_trace()
      git cherry-pick aff7ab782e168bda7a7a422fbe6a04be2cd40a64  # rexec: check lseek() return value

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/
      ln -s /var/snap/lxd/common/lxc/local.conf $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/01-local.conf
      sed -i "s#includedir=.*#includedir=$SNAPCRAFT_PART_INSTALL/include#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc
      sed -i "s#libdir=.*#libdir=$SNAPCRAFT_PART_INSTALL/lib#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc

  lxcfs:
    source: https://github.com/lxc/lxcfs
    source-type: git
    source-tag: lxcfs-4.0.7
    build-packages:
      - libfuse-dev
      - libpam0g-dev
      - pkg-config
    stage-packages:
      - fuse
    plugin: autotools
    configflags:
      - --datarootdir=/snap/lxd/current/
      - --localstatedir=/var/snap/lxd/common/var/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/lxcfs: lxcfs
      lib/lxcfs: lib
    prime:
      - bin/fusermount
      - lib/*/libfuse.so.*

      - bin/lxcfs
      - lib/liblxcfs.so

      - lxc
      - lxcfs
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick 725e90b5d67e264ee4a7ff0851c79728feab1da8  # proc_cpuview: release lock before returning

      set +ex
      snapcraftctl build
      set -ex

      sed -i "s#\${LXC_ROOTFS_MOUNT}/var/snap/lxd/common/var/lib/lxcfs/#\${LXC_ROOTFS_MOUNT}/var/lib/lxcfs/#g" $SNAPCRAFT_PART_INSTALL/snap/lxd/current/lxcfs/lxc.mount.hook

  lxd:
    source: https://github.com/lxc/lxd
    source-type: git
    source-tag: lxd-4.11
    after:
      - lxc
      - dqlite
      - sqlite
    build-packages:
      - libacl1-dev
      - libudev-dev
      - pkg-config
    stage-packages:
      - acl
      - attr
      - dnsmasq-base
      - gdisk
      - iw
      - netbase
      - pciutils
      - pigz
      - rsync
      - squashfs-tools
      - usbutils
      - xdelta3
    plugin: nogetgo
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd
    go-packages:
      - github.com/lxc/lxd/lxc
      - github.com/lxc/lxd/lxc-to-lxd
      - github.com/lxc/lxd/lxd
      - github.com/lxc/lxd/lxd-benchmark
    override-build: |
      set -ex

      # Git cherry-picks
      cd ../src
      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick 8280983e42c54903899b6683fa8037b78cb5f51b  # containers: simplify wstatus.Close() logic in Exec()
      git cherry-pick 9c7ad1a1e46a1659dfd6234a7b73b7b05299ec54  # containers: reap zombies on attach failure
      git cherry-pick f8c93c65653c3fa3633cfa4c9f7798c995a1002f  # seccomp: block openat2()
      git cherry-pick 50031c70070a161b89a2fb3c38deb120b3978888  # lxd/instance/qemu/qmp: Add SendFile, Migrate and MigrateIncoming
      git cherry-pick d51b9549624050c7afaf1cbb880c50a5b5e14825  # lxd/instance/qemu/qmp: Add ping function
      git cherry-pick 764f0a740f0da01426ef731195361581c001f741  # lxd/instance/qemu/qmp: Re-shuffle functions
      git cherry-pick 2d85949cf15accd398936deec6f2f87d66ecd2b3  # lxd/instance/qemu/qmp: Rework run() function
      git cherry-pick 81d3b52d75dd82de5d7964fd4a3760448f48faed  # lxd/instance/qemu/qmp: Update commands to use run()
      git cherry-pick 31a4fd389131fc57da91abb247092ed56e8266fb  # lxd/network/network/utils: Fixes InterfaceExists to not return true if arg is empty string
      git cherry-pick 82e0ade7db38ffbfd413320ef28e8a856ff67486  # lxd/device/nic/routed: Dont give sysctl read error when invalid value
      git cherry-pick 56362e05b271aec08c5bdf3d039454b4f8ad1afa  # lxd/device/nic/ipvlan: Dont give sysctl read error when invalid value
      git cherry-pick b344a098088e3b576c948d1e8a25635004705e50  # lxd/device/nic/ipvlan: network.InterfaceExists usage
      git cherry-pick 752e2f43f7252ef15dd26cc152838185d35de460  # lxd/device/nic/ipvlan: Detach ipvlan interface back to random host name on stop, then delete
      git cherry-pick 721836c4fede54b111e6bc9f7231bcf093338cd7  # lxd/db/instances: Adds ErrInstanceListStop that can be returned from InstanceList to stop search
      git cherry-pick 16b1c5772c79cd8e0a8e0d0b6131a0dcd28d6117  # shared/validate/validate: Adds IsNetworkRange and IsNetworkAddressCIDR functions
      git cherry-pick 29bd972b4a661efc85356673fda1b899e812cc6b  # shared/validate/validate: Adds IsNetworkPort and IsNetworkPortRange functions
      git cherry-pick 8066f899e5b61c15a8ff0539993239075e9d5880  # lxd/util/config: Adds SplitNTrimSpace function
      git cherry-pick b6aace7754b0953102307c045e7f656e0486c752  # lxd/util/config: Avoid unnecessary allocations in CopyConfig
      git cherry-pick 894dd55f6c02587c239bb6e0fd9243140f933f91  # shared/api/network/acl: Adds shared struct types for Network ACLs
      git cherry-pick 1d86e4554d5fabdbd45bc77079cb3fb44afa9610  # shared/api/network/acl: Adds rule Normalise function
      git cherry-pick 656833f4cb2c6c46efd41cfe1cc400bf4fcf7857  # client/interfaces: Adds CreateNetworkACL
      git cherry-pick bbfa13c86c02eb235faf829951f484664cae222b  # client/interfaces: Adds GetNetworkACLs
      git cherry-pick 0c1ae0e4ba7d030a33a1349b36f31976c3d8146c  # client/interfaces: Adds GetNetworkACL
      git cherry-pick 05e884d5146e03876cf6caddf8a3718adc68624a  # client/interfaces: Adds UpdateNetworkACL
      git cherry-pick 01906f3edcffb543ab7a89e0e8495280469ab058  # client/interfaces: Adds RenameNetworkACL
      git cherry-pick 3b89621db444739e741a0c520ed45244a39d3cce  # client/interfaces: Adds DeleteNetworkACL
      git cherry-pick 9e9f13cfcd8003f1ef77c8e41eb5e4a337cb2f0a  # client/interfaces: Adds GetNetworkACLNames
      git cherry-pick 484c540979148c0d203225ca9df8445bce0263bf  # client/lxd/network/acls: Implements CreateNetworkACL function
      git cherry-pick 8229b51b2f3ea276b83d9e0b6f9aa40795222da1  # client/lxd/network/acls: Implements GetNetworkACLs function
      git cherry-pick 1bb6e9d0f5ae51793034263fa21c897bf557ee85  # client/lxd/network/acls: Implements GetNetworkACL function
      git cherry-pick 06eaad40855310ae508d200559054ae363fe66e2  # client/lxd/network/acls: Implements UpdateNetworkACL function
      git cherry-pick c95dc7e8003b84a887e159ed813c1bd519b780ee  # client/lxc/network/acls: Implements RenameNetworkACL function
      git cherry-pick e5610cffe519e402b5298e4544cb9d196bca6c87  # client/lxd/network/acls: Implements DeleteNetworkACL function
      git cherry-pick ed12b23fb12ac2efc15ecdcd2efa0fb1a9e22a15  # client/lxd/network/acls: Implements GetNetworkACLNames function
      git cherry-pick c3350e90547f779a2446e2d91a75767e3f1cd280  # lxd/network/driver/ovn: Uplink loading error improvements
      git cherry-pick 82756a1d9f3dab0a41ca89093f8e592fe1a34c0d  # lxd/device/nic/sriov: network.InterfaceExists usage
      git cherry-pick f196de147ae2b74a948487ddfa6a5a12bb0db2a0  # lxd/network/network/utils: InterfaceExists usage in InterfaceBindWait
      git cherry-pick cd4317e78a75809271615bb62012d7954c2e1d95  # lxd/device/nic/sriov: Use random VF MAC if VF has no automatic MAC set
      git cherry-pick 2d013dfbeb4d10575989ab07e0a69022a6f9aa0b  # lxd/instance/qemu: Rework lxd-agent startup
      git cherry-pick 410ad0cf6a884e60bdf4d214ab695555dbe55292  # lxd/device/disk: Validate that the pool is not pending
      git cherry-pick 9f64d993dea49e6b973ea606ad11b96f034c2900  # lxd/instance/qemu: Add migration.stateful support
      git cherry-pick c104c5b3260ee5f87f81d034d70bd1f0261c5542  # lxd/device: Add migration.stateful support
      git cherry-pick 3f834dac6c6add4a93f17fe791f6244513bc84c7  # lxd/storage: Add support for size.state
      git cherry-pick d671c4462c9edb8124c577c105bae710cc68f066  # lxd/api: Port to updated SetInstanceQuota
      git cherry-pick a3ae53a7d32f5f75f09f8d2c4ca807dc53e1999d  # lxd/device/disk: Add support for size.state
      git cherry-pick 8cb0f981e9e9e01f64a521c62a0e6d70cc1bcf9c  # lxd/instance: Prevent stateful snapshots of VMs
      git cherry-pick 0ac6f95b67a72082e4fc3bca2e68a68da38c2491  # doc: Fix bad Github action link
      git cherry-pick e9666d5325900c7e163cf793e0323225d892ea5c  # lxd/instance/qemu/qmp: Switch back to upstream repo
      git cherry-pick a030accfd239f009635c1dcdcb669b427c9d29c3  # lxd/device/device/interface: Adds Type interface for accessing type specific functions of a device
      git cherry-pick 189fd348497de0147ac5bfe9f29f05ef35a04c4c  # lxd/device/device/common: UpdatableFields signature change
      git cherry-pick 2cb9b718fdedf4bce74da5d2a83b44ac9196918c  # lxd/device/nic/bridged: UpdatableFields signature change
      git cherry-pick 1efd0d7ac31f696d7204c01b8d846b2fa2dbffd9  # lxd/device/nic/p2p: UpdatableFields signature change
      git cherry-pick eedc99cc242d2788718c95c607fed885cca9fa38  # lxd/device/nic/routed: UpdatableFields signature change
      git cherry-pick fedb96f5cffb281fabb18a483ec7817f1c11ee64  # lxd/device/disk: UpdatableFields signature change
      git cherry-pick 508d78a77c88944dc85aa0b750e9a0277ec0ddb7  # lxd/device/device/load: Adds newByType and LoadByType functions
      git cherry-pick 295c56ecc7e34942f7911cac1540c2231bc29522  # lxd/instance/drivers: UpdatableFields usage
      git cherry-pick f734c772d390e6a390c05687b47feac5769399e1  # lxd/device/device/utils/network: Changes veth route functions to not depend on device specific logic
      git cherry-pick 533317a0ad5dba61bce3ff4854145e24e5b43b3c  # lxd/device/nic/bridged: Switches to use NIC type agnostic route helper functions
      git cherry-pick 24fe03faf34bfb720e78d026964cd2fe3d93354d  # lxd/device/nic/p2p: Switches to use NIC type agnostic route helper functions
      git cherry-pick 59c43b903ebc2b1ca73362a2a71b554cc31c1857  # lxd/instance/drivers/driver/common: Update comment for deviceVolatileReset to match
      git cherry-pick 61c810014bbc1f159f3b7b522c5cd00c0b3f1530  # lxd/instance/drivers/driver/lxc: Removes deviceResetVolatile provided by common
      git cherry-pick 19b5b998f40d3cbd7024c756a2f24d5c7c950781  # lxd/instance/drivers/driver/qemu: Removes deviceResetVolatile provided by common
      git cherry-pick 7804bc162912048ed2583a565985aab94dd6ed7d  # lxd/instance/drivers: d.deviceVolatileReset usage
      git cherry-pick a46f391bfadd74ede6281011d81905a35a68e3f3  # doc/preseed: LXD is pronounced lex-dee
      git cherry-pick aabbf739d7ef1891233ffa53841b676ae58be7f5  # doc/api-extensions: LXD is pronounced lex-dee
      git cherry-pick 073115b252924059ede275b325ca5ae19d297c40  # tests: Typo fix
      git cherry-pick ed10740777ff2c71bc3d2ff3d97e245dad80b273  # lxd/storage: LXD is pronounced lex-dee
      git cherry-pick c7825738cc0a796476eda044fc4c9a0424984c89  # lxd/firewall: LXD is pronounced lex-dee
      git cherry-pick 2fa3c9aa15003e99d7dd9d333e8a0788bfe3bd45  # lxd/network: LXD is pronounced lex-dee
      git cherry-pick 9f122de481479e5bfa9b42dcf7ccb7b8b7f5cf57  # lxd/api: LXD is pronounced lex-dee
      git cherry-pick 1e3583eaabbf1d5b3aa7308033c21732c3588f19  # lxd/device: LXD is pronounced lex-dee
      git cherry-pick 13ed5c8645701bf2337c6b8fcbc3cc40111166c2  # lxd/storage/utils: Updates VolumeUsedByExclusiveRemoteInstancesWithProfiles to use db.ErrInstanceListStop
      git cherry-pick 19c825234f94220a1cd3e11fd667ffbedf115f0b  # lxd/network/network/utils: Adds optimisation to UsedBy when firstOnly is true
      git cherry-pick b8e4063495d066b7675152e5d297f4e425882788  # lxd/network/network/utils: Removes whitespace trimming from SubnetParseAppend
      git cherry-pick adcdce5c63df9e2abf1a98b39f0688ea8ce82bc7  # lxd/api/project: Updates projectValidateRestrictedSubnets to use util.SplitNTrimSpace
      git cherry-pick c48b7d200ad7ef2d9b2894b5efc4acb77c9fd9fd  # lxd/network/driver/ovn: Switch to util.SplitNTrimSpace
      git cherry-pick df46d59b1573ab159e10c763c329e4c878f19c9e  # lxd/device/nic/ovn: Updates usage of network.SubnetParseAppend to use util.SplitNTrimSpace
      git cherry-pick c5a31041130be8215fdb9b05ad7e617fe838dbae  # lxd/network/driver/ovn: Adds OVNInstanceNICSetupOpts and OVNInstanceNICOpts types
      git cherry-pick 0e64a9a028a34a55cc4407490b3a6953334b2be9  # lxd/network/driver/ovn: InstanceDevicePortAdd updated arguments
      git cherry-pick 39069ebe520d6e63e6510bdb11f3b5c79b98ec45  # lxd/network/driver/ovn: InstanceDevicePortDelete updated arguments
      git cherry-pick 07340eca489cd74107337e05832801db30da083b  # lxd/network/driver/ovn: n.InstanceDevicePortAdd usage
      git cherry-pick 5fb2fd5a5fa26d34054c754a7a160607a11be8a7  # lxd/device/nic/ovn: ovnNet update of arguments
      git cherry-pick a81e1876e2168b1c2df730081bb5e38f2c2b7448  # lxd/device/nic/ovn: d.network.InstanceDevicePortAdd and d.network.InstanceDevicePortDelete usage
      git cherry-pick a74698d00ed9f5593784e96791698bea7633bda6  # lxd/network/openvswitch/ovn: Converts LogicalSwitchPortExists to LogicalSwitchPortUUID
      git cherry-pick 36f40fb9910e0dcd673ef0d9123b5d266c091afb  # lxd/network/openvswitch/ovn: Converts string UUID variables to their own dedicated types
      git cherry-pick c02e7d10040c3cdfe4b0d44493f8402186dc4694  # lxd/network/driver/ovn: Updates usage of OVN UUID types
      git cherry-pick 56a0371ce026f8bd03398af6151b27d19797d4fc  # lxd/network/driver/ovn: client.LogicalSwitchPortUUID usage
      git cherry-pick b6a43858fe72dbc435115e067d46dcec2432d653  # lxd/network/driver/ovn: Adds DNSName to OVNInstanceNICStartOpts
      git cherry-pick 603be37e9b69c6ada20f5e42f9065bd927fd2189  # lxd/network/driver/ovn: Updates InstanceDevicePortAdd with opts.DNSName field name change
      git cherry-pick a5c92e30c3d1592f353b5220d3d07b325d7ffeb9  # lxd/network/driver/ovn: Updates InstanceDevicePortAdd with opts.DNSName field name change in handleDependencyChange
      git cherry-pick e3317769b15a930a0faf156c621828fd73c77c27  # lxd/device/nic/ovn: Updates use of d.network.InstanceDevicePortAdd with DNSName
      git cherry-pick b4fa39f02be6ce4b03134ef279390c1e87beb831  # utils: trim whitespace from block device UUID
      git cherry-pick d24d7208732cd333aff3c6121d2d0aa2b8c9fc75  # lxd/storage/drivers/btrfs: Add up fs and block quota for VMs
      git cherry-pick 3aa1420e4e8cfd823e9be5dee2c8e18b4b093b1f  # lxd/storage/drivers/dir: Pass int64 size to setQuota
      git cherry-pick 7d6485fba52ff66d7ccba644f65dfb8f866a5f01  # lxd/storage/drivers/dir: Add up fs and block quota for VMs
      git cherry-pick 59b60c94ec02662f6962a7cb529e5c0acb058d40  # shared/validate/validate: Add IsCompressionAlgorithm
      git cherry-pick c332a20e30d15a6caa06eb030e6500bcde5c3610  # lxd/cluster: Update compression validation
      git cherry-pick 6d22800cbc75c233a6097f6cbb4a081b5b4aac37  # lxd/instance: Move CreateInternal
      git cherry-pick 375368a5fccbd3451013da93c213392dcb06db55  # lxd/instance/drivers: Rename restart to restartCommon
      git cherry-pick 792a1f496b71c49ddd706fdbfdf763461c3ac12c  # lxd/instance/drivers: Move snapshot creation to the driver
      git cherry-pick b1e5719c41569203aef51ed534f86a893d7c7191  # lxd/network/network/utils: Converts UsedBy to use InstanceList function
      git cherry-pick e6c789c01ae59f72177a551c29e5e035720f8885  # lxd/network/network/utils: Changes isInUseByDevices to isInUseByDevice
      git cherry-pick 7bc0450d7a4cf056d3b6bf0ca091019dbf497140  # lxd/network/network/utils: Adds usedByInstanceDevices function
      git cherry-pick b4624cbda4aeb20e3359264c6a0eae8397fefc76  # lxd/device/nic/ovn: Removes non-ovn related limit code, use network.InterfaceExist
      git cherry-pick 5ff493d3e503539a06f5cfb69b6631e93d9de88b  # lxd/network/driver/ovn: Removes unnecessary calls to CloneNative in ovnNICExternalRoutes
      git cherry-pick b2cdddf8bfbd4c4def2a6302e9f395c727993fd5  # lxd/cluster: Guarantee single hearbeat loop
      git cherry-pick 2727c4057d288a8dc700fa8ed7bebc622dbb40d0  # doc/rest-api: Fix and clarify backup API
      git cherry-pick 540fefdbb2fa0e26a4773a0dd5c28905b028b126  # lxd/cluster: Improve heartbeat logging
      git cherry-pick f74f6a2eab9d206168567c31292bb927e7b1dea1  # lxd/api: Don't use potentially nil struct
      git cherry-pick add2f92e4ed75ca38275e09b7b35b2303980e94b  # lxd/init: Better error on invalid auto-detect fan underlays
      git cherry-pick 240d3e0c9aa6cfda5b16f0bd33a0407f63a1fc58  # doc/rest-api: More fixes for backups
      git cherry-pick eb8e5ac4173d2f69a579c5ac9d2bd3e7584c6857  # lxd: Remove ReadToJSON
      git cherry-pick 0b926062e7ac2337cce2582acb9eff3b84ed5500  # lxd/db: Fix RenameCertificate
      git cherry-pick df25be4043d9f7a7789336da01dd905534d23da7  # lxd/certificate: Modernize DB handling
      git cherry-pick 310f82ca5935347b4eb424e0888889311f7241f4  # lxd/certificate: Rework cache
      git cherry-pick ea1f5114430712f1f377abd9bd1d6b1e44f07480  # doc/backup: Mention subuid/subgid
      git cherry-pick bba7466168dfdb8fd75b10e3152debf1ad16d597  # lxd/db/certificates: Fix bad error handling
      git cherry-pick 924e50a08e5caf4f0469100e15c834059a9b93f4  # shared/api: Add restricted and projects to certificate
      git cherry-pick 981afacf154d6de46f7dc4b5c44ab256ff08115f  # lxd/instance/drivers/driver/lxc: Log when skipping volume delete in a recovery import scenario
      git cherry-pick a35e595c2a99e0f4e1f43de018f88fd2d85b26d0  # lxd/api/internal: Don't create .importing file when performing a backup import in internalImport
      git cherry-pick 01150ec025e581f3f61236564b1567fdf00aa307  # lxd/api/internal: internalImport usage
      git cherry-pick 15e7d760a66bb4803b3d1f8879b5d1064a674c07  # lxd/instance/instance/utils: CreateInternal usage of revert package
      git cherry-pick 875f86f752963143452de2711325d2b866925fe5  # lxd/instances/post: internalImport usage
      git cherry-pick a00cca8e9632026fefd4d34dd241e609754076c1  # lxd/network/network/utils: Reorder UsedBy logic to do cheapest searches first
      git cherry-pick d3cb494bbfec7cbc2d52c320cf27ae9023edcdd5  # tests: Reword deadcode
      git cherry-pick 50add2650a3092dde6485205a197c8081f294c29  # shared/log15: Remove dead code
      git cherry-pick 348eff91ae5fb22aabc4cd328506b64f2e5a2623  # lxd/storage/drivers/driver/btrfs: Unset pool size setting during creation if not relevant
      git cherry-pick 674c76120e18b5f8d19fd739039d662439a1d9e9  # lxd/storage/drivers/driver/btrfs: Consisent error quoting in Create
      git cherry-pick 8262ff8dfab8ee9d11f0286a85dff1ec1f673e17  # lxd/storage/pools/config: Consistent error quoting in storagePoolValidateConfig
      git cherry-pick 06d7ed007e4f3e1d5218a3ac41e63bd7972a64b6  # driver_lxc: pass flags to shiftfs mount
      git cherry-pick c97d751f7e928a8e35a9640cf443ce87b9ec3555  # lxd/network/driver/bridge: Ensure that DHCP firewall rules are added in fan mode
      git cherry-pick f73aea50cae823ca630305b5f519a7dfa6ff85a8  # lxd/storage/drivers/utils: Comment clarify in BlockDiskSizeBytes
      git cherry-pick cc0b1d08f544ba739cedc5defb611a29f549b273  # lxd/resources/storage: Rework block size handling
      git cherry-pick 4f6a3f67c7a4d7dfd29a028bfff651e23d3b3b66  # Updated instanceLogDelete function
      git cherry-pick 6125eca0fc3dc24da20575338f4d416aa55ce2ef  # lxd/device/disk: Tweak mkisofs flags
      git cherry-pick 04caad58db7d949c83bf8e72170b75253939b98a  # lxd/instance/post: Update instancePostClusteringMigrate to respect instance's project
      git cherry-pick 4cabe49c85c03da7dd73f63acf260cf160cdef3d  # lxd/instance/backup: Makes returned containers resource conditional on instance type
      git cherry-pick 79ff1e841866db3e29e34294eac4e6aa575cb793  # lxd/instance/console: Conditional containers resources
      git cherry-pick 5e8dc27660f8967a5d2a6bd3e7b7602023a0e6a1  # lxd/instance/delete: Updates instanceDelete to use inst var and makes returned containers resources conditional on instance type
      git cherry-pick 40154221d4e8c602147401ed2ea12c9150d62cf5  # lxd/instance/exec: Makes containers resources conditional on instance type
      git cherry-pick e6ff31abf29ca26fadf9d963960d473e9a9fe339  # lxd/instance/post: Renames c to inst and makes containers resources conditional on instance type
      git cherry-pick 081ee12b75b4a875fc9dd3b65d7f330d7d2ab6b9  # lxd/instance/put: Renames c to inst and makes containers resources conditional on instance type
      git cherry-pick 3b98d319f2ecfffbc8a51c1521faf7463feba270  # lxd/instance/snapshot: Renames sc to snapInst and makes containers resources conditional on instance type
      git cherry-pick 77a5854624781c85f413498d38ff5be2bafe24c6  # lxd/instances/post: Makes containers resources conditional on instance type
      git cherry-pick d0d4472cc4dd280cb8ccd5430a8e40e109dec5df  # doc/rest-api: Updates backup endpoint docs
      git cherry-pick 58cc97105605b2488901afd31a98c6f49799e4e3  # lxd/cluster: Don't warn about pending nodes
      git cherry-pick dd593b5efde02eabaee5b78b46c58de52dbbdbc5  # lxd/instances: Fix instance copy within project
      git cherry-pick 89033692183bc5afd4b4dc2f89aa64fb306778fd  # netutils: improve file descriptor retrieval and increase robustness
      git cherry-pick e2a2684c626d960c915e5edcce2e6228dc44d281  # doc/projects: Projects aren't restricted by default
      git cherry-pick e341613be7ee5b4be0e4a0eed9334afce87ad1b7  # lxd/storage/drivers/util: Updates ensureVolumeBlockFile to add unsupportedResizeTypes argument
      git cherry-pick 305256d1d6018dd57c6aaab78f5eee2e18f85e6c  # lxd/storage/drivers/driver/btrfs/volumes: Updates CreateVolume with ensureVolumeBlockFile comments
      git cherry-pick 42c07b8b8c4cc2971b96ecfe445fb0ebe924313d  # lxd/storage/drivers/driver/btrfs/volumes: Updates SetVolumeQuota to pass VolumeTypeImage to ensureVolumeBlockFile
      git cherry-pick 5c299e487a422b0fcf822436f746e445a05ed8a3  # lxd/storage/drivers/driver/dir/volumes: Comment improvement in CreateVolume
      git cherry-pick dbb8766f1d6b920b378adefa71a49d27b4884f38  # lxd: improve unix fd retrieval infrastructure

      # Download any new dependencies
      export GOPATH=$(realpath ../go)
      go get -t -d ./...

      # Setup for our shared libraries
      sed -i "/\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/canonical/go-dqlite/internal/bindings/server.go
      sed -i "/^\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/mattn/go-sqlite3/sqlite3.go

      # Run the standard build
      set +ex
      snapcraftctl build
      set -ex

      # Build the agent (special build tags)
      CGO_ENABLED=0 go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd-agent" -tags=agent,netgo github.com/lxc/lxd/lxd-agent

      # Setup bash completion
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/
      cp scripts/bash/lxd-client ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/share/misc/: share/misc/
      var/lib/usbutils/usb.ids: share/misc/
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/dnsmasq
      - bin/getfattr
      - bin/setfattr
      - bin/iw
      - bin/pigz
      - bin/rsync
      - bin/setfacl
      - bin/sgdisk
      - bin/unsquashfs
      - bin/xdelta3

      - etc/bash_completion.d/snap.lxd.lxc

      - share/misc

      - bin/lxc
      - bin/lxc-to-lxd
      - bin/lxd
      - bin/lxd-agent
      - bin/lxd-benchmark

  lxd-migrate:
    source: lxd-migrate/
    after:
      - lxd
      - sqlite
    plugin: go
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd-pkg-snap/lxd-migrate
    override-build: |
      set -ex

      # Setup for our shared libraries
      sed -i "/^\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/mattn/go-sqlite3/sqlite3.go

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p ${SNAPCRAFT_PART_INSTALL}/bin/
      cp scripts/upgrade-bridge ${SNAPCRAFT_PART_INSTALL}/bin/upgrade-bridge
    prime:
      - bin/lxd-migrate
      - bin/upgrade-bridge

  shmounts:
    source: shmounts/
    plugin: make
    prime:
      - bin/setup-shmounts

  snap-query:
    source: snap-query/
    plugin: go
    go-importpath: github.com/lxc/lxd-pkg-snap/snap-query
    prime:
      - bin/snap-query

  strip:
    source: snapcraft/empty
    after:
      - btrfs
      - ceph
      - dqlite
      - libseccomp
      - logrotate
      - lvm
      - nano
      - nvidia-container
      - openvswitch
      - ovn
      - raft
      - sqlite
      - squashfs-tools-ng
      - vim
      - xfs
      - xtables
      - xz
      - zfs-0-6
      - zfs-0-7
      - zfs-0-8
      - lxc
      - lxcfs
      - criu
      - lxd
      - lxd-migrate
      - shmounts
      - snap-query
    plugin: nil
    override-prime: |
      set -x

      # Strip some of the heavy bits
      strip -s ${SNAPCRAFT_PRIME}/bin/lxc
      strip -s ${SNAPCRAFT_PRIME}/bin/lxd*
      strip -s ${SNAPCRAFT_PRIME}/bin/snap*
      strip -s ${SNAPCRAFT_PRIME}/lib/liblxc*
      strip -s ${SNAPCRAFT_PRIME}/lib/libdqlite*
      strip -s ${SNAPCRAFT_PRIME}/lib/libsqlite*

      for zfs in zfs-0.6 zfs-0.7 zfs-0.8 zfs-2.0; do
          [ ! -d "${SNAPCRAFT_PRIME}/${zfs}" ] && continue
          strip -s ${SNAPCRAFT_PRIME}/${zfs}/bin/* ${SNAPCRAFT_PRIME}/${zfs}/lib/*
      done

      [ -e "${SNAPCRAFT_PRIME}/criu/criu" ] && strip -s ${SNAPCRAFT_PRIME}/criu/criu

      exit 0

  wrappers:
    plugin: dump
    source: snapcraft/
    organize:
      hooks/: snap/hooks/
