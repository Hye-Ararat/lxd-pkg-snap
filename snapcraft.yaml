name: lxd
base: core18
assumes:
  - snapd2.39
version: "4.1"
grade: stable
summary: LXD - the container lightervisor
description: |-
 LXD is a container manager for system containers.

 It offers a REST API to remotely manage containers over the network,
 using an image based workflow and with support for live migration.

 Images are available for all Ubuntu releases and architectures as well
 as for a wide number of other Linux distributions.

 LXD containers are lightweight, secure by default and a great
 alternative to virtual machines.

 Supported configuration options (snap set lxd [<key>=<value>...]):
   - ceph.builtin: Use snap-specific ceph configuration [default=false]
   - criu.enable: Enable experimental live-migration support [default=false]
   - daemon.debug: Increases logging to debug level [default=false]
   - daemon.group: Group of users that can interact with LXD [default=lxd]
   - daemon.preseed: A YAML configuration to feed `lxd init` on initial start
   - lxcfs.pidfd: Start per-container process tracking [default=false]
   - lxcfs.loadavg: Start tracking per-container load average [default=false]
   - lxcfs.cfs: Consider CPU shares for CPU usage [default=false]
   - openvswitch.builtin: Run a snap-specific OVS daemon [default=false]
   - shiftfs.enable: Enable shiftfs support [default=auto]

confinement: strict

apps:
  # Main commands
  activate:
    command: commands/daemon.activate
    daemon: oneshot
    plugs:
      - lxd-support
      - system-observe

  daemon:
    command: commands/daemon.start
    reload-command: commands/daemon.reload
    stop-command: commands/daemon.stop
    stop-timeout: 600s
    restart-condition: on-failure
    daemon: simple
    slots: [lxd]
    plugs:
      - lxd-support
      - network-bind
      - system-observe
    sockets:
      unix:
        listen-stream: $SNAP_COMMON/lxd/unix.socket
        socket-mode: 0660

  lxc:
    command: commands/lxc
    completer: etc/bash_completion.d/snap.lxd.lxc
    plugs:
      - lxd-support
      - system-observe

  lxd:
    command: commands/lxd
    plugs:
      - lxd-support
      - system-observe

  # Sub-commands
  benchmark:
    command: commands/lxd-benchmark
    plugs:
      - lxd-support
      - system-observe
  buginfo:
    command: commands/buginfo
    plugs:
      - lxd-support
      - system-observe
  check-kernel:
    command: commands/lxd-check-kernel
    plugs:
      - lxd-support
      - system-observe
  lxc-to-lxd:
    command: commands/lxc-to-lxd
    plugs:
      - lxd-support
      - system-observe
  migrate:
    command: commands/lxd-migrate
    plugs:
      - lxd-support
      - system-observe

hooks:
  configure:
    plugs:
      - network
      - system-observe
  remove:
    plugs:
      - lxd-support
      - system-observe

parts:
  # Dependencies
  btrfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - btrfs-tools
    prime:
      - bin/btrfs
      - bin/btrfstune
      - bin/mkfs.btrfs

  ceph:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ceph-common
      - libdb5.3
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/ceph
      - bin/python
      - bin/python2*
      - bin/rbd
      - lib/python2.7
      - lib/*/libpython2.7.so*
      - -lib/python2.7/sitecustomize.py
      - lib/*/ceph
      - lib/*/libboost_iostreams.so.*
      - lib/*/libboost_program_options.so.*
      - lib/*/libboost_random.so.*
      - lib/*/libboost_regex.so.*
      - lib/*/libboost_system.so.*
      - lib/*/libboost_thread.so.*
      - lib/*/libcephfs*
      - lib/*/libdb-5.3.so
      - lib/*/libicudata.so.*
      - lib/*/libicui18n.so.*
      - lib/*/libicuuc.so.*
      - lib/*/libnspr4.so
      - lib/*/libnss3.so
      - lib/*/libibverbs.so*
      - lib/*/nss/libsoftokn3.so
      - lib/*/nss/libfreeblpriv3.so
      - lib/*/libnssutil3.so
      - lib/*/libplc4.so
      - lib/*/libplds4.so
      - lib/*/librados.so.*
      - lib/*/librbd.so.*
      - lib/*/libsmime3.so
      - lib/*/libsnappy*

  dqlite:
    after:
      - libco
      - raft
      - sqlite
    source: https://github.com/canonical/dqlite
    source-type: git
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libdqlite*so*
      - lib/*/libuv*

  edk2:
    after:
      - qemu
    source: https://github.com/tianocore/edk2
    source-type: git
    source-tag: edk2-stable202002
    plugin: nil
    build-packages:
      - acpica-tools
      - nasm
      - uuid-dev
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      ARCH="X64"
      PKG="OvmfPkg/OvmfPkgX64.dsc"
      FV_CODE="OVMF_CODE"
      FV_VARS="OVMF_VARS"
      if [ "$(uname -m)" = "aarch64" ]; then
          ARCH="AARCH64"
          PKG="ArmVirtPkg/ArmVirtQemu.dsc"
          FV_CODE="QEMU_EFI"
          FV_VARS="QEMU_VARS"
      fi

      # Run in a bash sub-shell as edksetup.sh requires it
      set -ex
      (
      cat << EOF
          . ./edksetup.sh
          make -C BaseTools ARCH=${ARCH}
          build -a ${ARCH} -t GCC49 -b RELEASE -p ${PKG} \
            -DNETWORK_HTTP_BOOT_ENABLE=TRUE \
            -DSECURE_BOOT_ENABLE=TRUE \
            -DFD_SIZE_2MB \
            -DTPM2_ENABLE=TRUE
      EOF
      ) | bash -e

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      cp Build/*/*/FV/${FV_CODE}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
      cp Build/*/*/FV/${FV_VARS}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"

      if [ "$(uname -m)" = "aarch64" ]; then
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"
      fi

    prime:
      - share/qemu/*

  libco:
    source: https://github.com/canonical/libco
    source-type: git
    plugin: make
    organize:
      usr/lib/: lib/
    prime:
      - lib/libco*so*

  libmnl:
    source: https://git.netfilter.org/libmnl
    source-type: git
    source-tag: libmnl-1.0.4
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libmnl*so*

  libnftnl:
    after:
      - libmnl
    source: https://git.netfilter.org/libnftnl
    source-type: git
    source-tag: libnftnl-1.1.6
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libnftnl*so*

  libseccomp:
    source: https://github.com/seccomp/libseccomp
    source-type: git
    plugin: autotools
    build-packages:
      - gperf
    organize:
      usr/lib/: lib/
    prime:
      - lib/libseccomp*so*

  logrotate:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - logrotate
      - libpopt0
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    stage:
      - bin/logrotate
    prime:
      - bin/logrotate
      - lib/*/libpopt*so*

  lvm:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - dmeventd
      - lvm2
      - thin-provisioning-tools
    organize:
      sbin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/cache_*
      - bin/dmeventd
      - bin/era_*
      - bin/lv*
      - bin/pdata_tools
      - bin/pv*
      - bin/thin_*
      - bin/vg*
      - -bin/vgimportclone
      - -bin/lvmconf
      - -bin/lvmdump
      - -bin/lvmetad
      - -bin/lvmpolld
      - etc/lvm/lvm.conf
      - lib/*/device-mapper/*
      - lib/*/libaio.so*
      - lib/*/libdevmapper*
      - lib/*/liblvm*
      - lib/*/libreadline.so*

  nano:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - nano
    organize:
      usr/bin/: bin/
    prime:
      - bin/nano
      - etc/nanorc

  nftables:
    after:
      - libmnl
      - libnftnl
    source: https://git.netfilter.org/nftables
    source-type: git
    source-tag: v0.9.4
    plugin: autotools
    configflags:
      - --with-json
    build-packages:
      - libjansson-dev
      - libreadline-dev
    stage-packages:
      - libjansson4
    organize:
      sbin/: bin/
      usr/lib/: lib/
    prime:
      - bin/nft
      - lib/*/libjansson*so*
      - lib/libnftables*so*

  nvidia-container:
    after:
      - libseccomp
    source: https://github.com/NVIDIA/libnvidia-container
    source-type: git
    source-tag: v1.1.1
    plugin: make
    build-packages:
      - bmake
      - curl
      - lsb-release
    override-build: |-
      set -ex

      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/bin/"
      cp ${SNAPCRAFT_PROJECT_DIR}/snapcraft/wrappers/nvidia-container-cli "${SNAPCRAFT_PART_INSTALL}/bin/"

      set +ex
      snapcraftctl build
    organize:
      usr/local/bin/nvidia-container-cli: bin/nvidia-container-cli.real
      usr/local/lib: lib/
    prime:
      - bin/nvidia-container-cli*
      - lib/libnvidia-container.so*

  openvswitch:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - openvswitch-switch
      - uuid-runtime
    organize:
      usr/bin/: bin/
      usr/lib/openvswitch-switch/: bin/
      usr/sbin/: bin/
      usr/share/: share/
    prime:
      - bin/ovs-appctl
      - bin/ovs-vsctl
      - bin/ovs-vswitchd
      - bin/ovsdb-*
      - bin/uuidgen
      - share/openvswitch/

  qemu:
    after:
      - libseccomp
    source: https://git.qemu.org/git/qemu.git
    source-type: git
    source-tag: v5.0.0
    plugin: autotools
    configflags:
      - --disable-docs
      - --disable-slirp
      - --disable-user
      - --enable-attr
      - --enable-cap-ng
      - --enable-kvm
      - --enable-linux-aio
      - --enable-pie
      - --enable-rbd
      - --enable-seccomp
      - --enable-system
      - --enable-tools
      - --enable-vhost-crypto
      - --enable-vhost-kernel
      - --enable-vhost-net
      - --enable-vhost-scsi
      - --enable-vhost-user
      - --enable-vhost-vsock
      - --enable-virtfs
      - --enable-vnc
      - --firmwarepath=/snap/lxd/current/share/qemu/
    build-packages:
      - bison
      - flex
      - pkg-config
      - libcap-ng-dev
      - libglib2.0-dev
      - libpixman-1-dev
      - libaio-dev
      - librbd-dev
    stage-packages:
      - genisoimage
      - libmagic1
      - libpixman-1-0
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && [ "$(uname -m)" != "ppc64le" ] && [ "$(uname -m)" != "s390x" ] && exit 0

      set -ex
      # Mangle the configure a bit
      QEMUARCH="$(uname -m)"
      [ "${QEMUARCH}" = "ppc64le" ] && QEMUARCH="ppc64"
      sed -i "s/^unset target_list$/target_list=\"${QEMUARCH}-softmmu\"/" configure
      sed -i 's#libseccomp_minver=".*#libseccomp_minver="0.0"#g' configure

      set +ex
      snapcraftctl build
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/genisoimage*
      - bin/mkisofs*
      - bin/qemu-system-*
      - bin/qemu-img*
      - bin/virtfs-proxy-helper*
      - lib/*/libmagic*so*
      - lib/*/libpixman*so*
      - share/qemu/keymaps*
      - share/qemu/efi-virtio.rom*
      - share/qemu/kvmvapic.bin*
      - share/qemu/s390-*.img*
      - share/qemu/slof.bin*
      - share/qemu/vgabios-*.bin*

  qemu-ovmf-secureboot:
    after:
      - edk2
      - qemu
    source: https://github.com/puiterwijk/qemu-ovmf-secureboot
    source-type: git
    plugin: nil
    build-packages:
      - xorriso
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      set -ex
      rm -Rf iso-root vfat-root shell.iso
      mkdir -p iso-root vfat-root/efi/boot
      cp ../../edk2/build/Build/*/*/*/Shell.efi vfat-root/efi/boot/bootx64.efi
      cp ../../edk2/build/Build/*/*/*/EnrollDefaultKeys.efi vfat-root/
      "${SNAPCRAFT_STAGE}/bin/qemu-img" convert --image-opts driver=vvfat,floppy=on,fat-type=12,label=UEFI_SHELL,dir=vfat-root iso-root/shell.img
      xorriso --as mkisofs -input-charset ASCII -J -rational-rock -e shell.img -no-emul-boot -o shell.iso iso-root/

      # Basic aarch64 support
      if [ "$(uname -m)" = "aarch64" ]; then
          sed -i ovmf-vars-generator \
              -e "s/'-machine', machinetype,/'-machine', 'virt', '-cpu', 'cortex-a57',/" \
              -e "/charserial1/d" \
              -e "s/ide-cd/scsi-cd/" \
              -e "s/'-device',$/'-device', 'virtio-scsi-pci,id=scsi', '-device',/"
      elif [ "$(uname -m)" = "x86_64" ]; then
          cp -f "${SNAPCRAFT_STAGE}/share/qemu/kvmvapic.bin" .
      fi

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      python3 ovmf-vars-generator \
        --qemu-binary "${SNAPCRAFT_STAGE}/bin/qemu-system-$(uname -m)" \
        --print-output --disable-smm --skip-testing \
        --oem-string "$(cat ${SNAPCRAFT_PROJECT_DIR}/snapcraft/etc/ubuntu-sb.crt)" \
        --ovmf-binary "${SNAPCRAFT_STAGE}/share/qemu/OVMF_CODE.fd" \
        --ovmf-template-vars "${SNAPCRAFT_STAGE}/share/qemu/OVMF_VARS.fd" \
        --uefi-shell-iso shell.iso \
        "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.ms.fd"
    prime:
      - share/qemu/*

  raft:
    source: https://github.com/canonical/raft
    source-type: git
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libraft*so*

  sqlite:
    source: https://github.com/canonical/sqlite
    source-type: git
    source-tag: version-3.30.1+replication4
    plugin: autotools
    configflags:
      - --enable-replication
    build-packages:
      - tclsh
    override-build: |-
      set -ex

      git log -1 --format=format:%ci%n | sed -e 's/ [-+].*$//;s/ /T/;s/^/D /' > manifest
      git log -1 --format=format:%H > manifest.uuid
      cp /usr/share/misc/config.guess .
      cp /usr/share/misc/config.sub .
      autoreconf -f -i

      set +ex
      snapcraftctl build
    prime:
      - bin/sqlite3
      - lib/libsqlite3*so*

  squashfs-tools-ng:
    source: https://github.com/AgentD/squashfs-tools-ng
    source-type: git
    source-tag: v0.8
    plugin: autotools
    build-packages:
      - liblzma-dev
    prime:
      - bin/sqfs2tar
      - bin/tar2sqfs
      - lib/libsquashfs.so*

  vim:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - vim-tiny
    organize:
      usr/bin/: bin/
      usr/share/vim/vim*/debian.vim: etc/vimrc
    prime:
      - bin/vim.tiny
      - etc/vimrc

  xfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xfsprogs
    organize:
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/xfs_admin
      - bin/xfs_db
      - bin/xfs_growfs
      - bin/xfs_repair
      - bin/mkfs.xfs

  xtables:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ebtables
      - iptables
      - xtables-addons-common
    organize:
      usr/lib/*/xtables/*: lib/xtables/
      lib/ebtables/*: lib/
      sbin/: bin/
    prime:
      - bin/ebtables
      - etc/ethertypes
      - etc/protocols
      - lib/libebt*
      - lib/xtables/*

  xz:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xz-utils
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/xz
      - lib/*/liblzma*so*

  zfs-0-6:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.6.5.11
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick fb963d33ee0dd350143ba1c9cd35d5f7d86910d2  # Fix endian build problem on ppc64el

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-7:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.7.13
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-8:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.8.4
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  # Core components
  lxc:
    after:
      - libseccomp
    source: https://github.com/lxc/lxc
    source-type: git
    source-tag: lxc-4.0.2
    build-packages:
      - libapparmor-dev
      - libcap-dev
      - libgnutls28-dev
      - libselinux1-dev
      - pkg-config
    plugin: autotools
    configflags:
      - --disable-selinux
      - --disable-tests
      - --disable-examples
      - --disable-doc
      - --disable-tools
      - --disable-api-docs
      - --disable-bash
      - --disable-memfd-rexec
      - --enable-apparmor
      - --enable-seccomp
      - --enable-selinux
      - --enable-capabilities
      - --with-rootfs-path=/var/snap/lxd/common/lxc/
      - --libexecdir=/snap/lxd/current/libexec/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/libexec: libexec
      share/lxc/hooks: lxc/hooks
    prime:
      - bin/lxc-checkconfig
      - lib/liblxc.so.1
      - lib/liblxc.so.1.*
      - lxc/config/common.conf.d
      - lxc/hooks/nvidia
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick d51d0df41ef0f85a127daf84468189655499a6e3  # apparmor: Allow boot_id
      git cherry-pick 3a4031f03696e339c9d6d4cc16af2e771ae7e45f  # src/lxc/network: Fixes netlink attribute type 1 has an invalid length message
      git cherry-pick ba9eab74b8e7c9bcafadb83809f5f07c21318e2d  # cgroups: ignore cgroup2 limits on non-cgroup2 layouts
      git cherry-pick 6001872d082dffce5e328049788c7f1ae0864789  # common.conf: add cgroup2 default device limits
      git cherry-pick 8cce8b5930d3718b11217561bda78dcaa84dfdee  # cgroups: premount cgroups on cgroup2-only systems
      git cherry-pick 0343423e578ef608d6a5c2518de0d7bcbac5887b  # conf: introduce userns_exec_mapped_root()
      git cherry-pick 0baff7b7f54824d8f829a8d7a82b3423db03d305  # conf: support console setup on containers without rootfs
      git cherry-pick 63910a22283059853f0c799f6dcdc369c83518a0  # terminal: remove unneeded if condition
      git cherry-pick c91e492a17a1b24bb77f8089db7c98ca6619fa40  # gcc: add -Warray-bounds, -Wrestrict, -Wreturn-local-addr, -Wstringop-overflow
      git cherry-pick 52d2862cf6965596a2c0eb6bd3c8d9a2e66e9bb2  # compiler: support new access attributes
      git cherry-pick b467fc359118eafa0df761ab55d5ebe78ba4fb75  # tree-wide: this is all rather TODO than FIXME
      git cherry-pick 1cbdec6a1b89132cda4f4c5bd329124c6076b7e5  # yum: remove unused module
      git cherry-pick ab398a1bb9fe21c1049537e20b7ed6bb5cf843a5  # tools/lxc-ls: shutup lgtm
      git cherry-pick 7821133aab5113d629f4cb25e70b124c84903142  # tools/lxc-ls: shut up lgtm more
      git cherry-pick cf52a093d1b9b3b05cde8b43360bd3991b5196de  # confile: fix order independence of network keys
      git cherry-pick ea2a67a6b0c4995fa102021602ea6db93fd4bed8  # lxccontainer: small cleanup to lxc_check_inherited() calls
      git cherry-pick dd2f1aad65c19798bbd7c3de73c60b8ba48216d4  # start: remove unused lxc_zero_handler()
      git cherry-pick 3f96727b459cf032330d42f94b892e1b8c3de707  # lxccontainer: use close_prot_errno_disarm() on state_socket_pair
      git cherry-pick 755d1e1fecca4e841a9906b4b851f8da8ca31f4f  # start: fix container reboot
      git cherry-pick e758df857049176d9c1c132cdde096ce3b554ec5  # start: cleanup file descriptor inheritance
      git cherry-pick 3f924551c9963040e8048e7c7cdb06b9f1768d3e  # log: cleanup syslog handling
      git cherry-pick de4d585ee420862b9a927f04f80d9fbe5ca71de8  # console: only create detached mount when a console is requested
      git cherry-pick 5524656d86fd78be693dbd0f2cd278ed8b8da42c  # syscall_numbers: handle ia64 syscall numbers correctly
      git cherry-pick ef301301c68ad432cfd6beb82fd2da1fdeb78983  # syscall_numbers: add clone3()
      git cherry-pick 6aefab38c133edd2d4c6721ebf6312cac544ccdc  # process_utils: introduce new process_utils.{c,h}
      git cherry-pick a62eb3aa12b57fa83a5335eb9769d37d46e7444d  # process_utils: add clone3() support
      git cherry-pick c3d189153f5534db211defe25bf3c3256e6c564f  # mainloop: add lxc_mainloop_add_handler_events
      git cherry-pick 64df0b2f366c80318910981af9c007b06f3a29f9  # cgfsng: deduplicate freeze code
      git cherry-pick 0842a4652e5788b4f82a424d0a7ee2c2b2240b81  # cgfsng: use EPOLLPRI when polling cgroup.events
      git cherry-pick 7ebcd704bee176dd2f8700c6497d8a6f60ba12a4  # process_utils: make lxc use clone3() whenever possible
      git cherry-pick df7d58b75aca3c710d62e37365a22142d2317981  # network: restore old behavior
      git cherry-pick fc0a8697b4a5a995e4863c48bda30fb6d805dc91  # network: fix {mac,ip,v}lan device creation
      git cherry-pick d7df095654693074aa3e581a78282bb0ad6b6944  # bionic: s/lxc_raw_execveat()/execveat()/g
      git cherry-pick 92a8d6e061cbe516cacd9f143506908e7ed89b6c  # network: use __instantiate_ns_common() in instantiate_ns_phys() too
      git cherry-pick 323a156937cfc9b08e2bb7a43b2600d3b9cd3960  # lxc-usernsexec: dumb down from error to warning message
      git cherry-pick b8025217f72d32cd2a02d772527761edb8a8384d  # lxc-usernsexec: don't fail on setgroups()
      git cherry-pick 0c9e185c962513661f5b26222770074946efcf25  # travis: Restrict coverity to gcc on bionic on amd64
      git cherry-pick a7974fd02d1412630502b18f472fd0f4ed67920e  # lxd/storage/lvm: Correct bad VG name in patch

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/
      ln -s /var/snap/lxd/common/lxc/local.conf $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/01-local.conf
      sed -i "s#includedir=.*#includedir=$SNAPCRAFT_PART_INSTALL/include#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc
      sed -i "s#libdir=.*#libdir=$SNAPCRAFT_PART_INSTALL/lib#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc

  lxcfs:
    source: https://github.com/lxc/lxcfs
    source-type: git
    source-tag: lxcfs-4.0.3
    build-packages:
      - libfuse-dev
      - libpam0g-dev
      - pkg-config
    stage-packages:
      - fuse
    plugin: autotools
    configflags:
      - --datarootdir=/snap/lxd/current/
      - --localstatedir=/var/snap/lxd/common/var/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/lxcfs: lxcfs
      lib/lxcfs: lib
    prime:
      - bin/fusermount
      - lib/*/libfuse.so.*

      - bin/lxcfs
      - lib/liblxcfs.so

      - lxc
      - lxcfs
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick 7dddc7f335ec5644663112d346ecbd7fe5882163  # proc_fuse: silence error when we find no memlimit
      git cherry-pick 2e7b4138eae5b1cb4c4b6d2c87b45c5425f0c693  # sysfs: cpuinfo: show cgroup cpuset value
      git cherry-pick 10f4d9fb7b28a59a0f4e1104bf2e788cf6726c5b  # sysfs_fuse: remove logically dead code
      git cherry-pick 4179492059341d56eaf39dfd9ba132015fbe2076  # Fix https://github.com/lxc/lxcfs/issues/404
      git cherry-pick 1fdb0df9d21a5073f5d6c3012763429d5bfad404  # coverity: Use build custom build script

      set +ex
      snapcraftctl build
      set -ex

      sed -i "s#\${LXC_ROOTFS_MOUNT}/var/snap/lxd/common/var/lib/lxcfs/#\${LXC_ROOTFS_MOUNT}/var/lib/lxcfs/#g" $SNAPCRAFT_PART_INSTALL/snap/lxd/current/lxcfs/lxc.mount.hook

  criu:
    source: https://github.com/checkpoint-restore/criu
    source-tag: v3.14
    source-type: git
    plugin: nil
    build-packages:
      - asciidoc
      - libcap-dev
      - libnet1-dev
      - libnl-3-dev
      - libprotobuf-c-dev
      - libprotobuf-dev
      - protobuf-c-compiler
      - protobuf-compiler
      - python
      - xmlto
    stage-packages:
      - libnet1
      - libprotobuf-c1
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "armv7l" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      make
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/criu/"
      cp criu/criu "${SNAPCRAFT_PART_INSTALL}/criu/"
    organize:
      usr/lib/: lib/
    prime:
      - criu/*
      - lib/*/libnet*
      - lib/*/libproto*

  lxd:
    source: https://github.com/lxc/lxd
    source-type: git
    source-tag: lxd-4.1
    after:
      - lxc
      - dqlite
      - sqlite
    build-packages:
      - libacl1-dev
      - libudev-dev
      - pkg-config
    stage-packages:
      - acl
      - attr
      - dnsmasq-base
      - gdisk
      - iw
      - netbase
      - pciutils
      - pigz
      - rsync
      - squashfs-tools
      - usbutils
      - xdelta3
    plugin: nogetgo
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd
    go-packages:
      - github.com/lxc/lxd/lxc
      - github.com/lxc/lxd/lxc-to-lxd
      - github.com/lxc/lxd/lxd
      - github.com/lxc/lxd/lxd-benchmark
    override-build: |
      set -ex

      # Git cherry-picks
      cd ../src
      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick 19b15efbf341d07c036fc7086a91f384dcbeca93  # shared/generate/db: Fix generation of Exists method
      git cherry-pick 5c8ceafce2996147ba1b66e7273b4e272961ca20  # lxd/db: Make generated code stable across "make update-schema" runs
      git cherry-pick 4a0452aff81e4690d57df8a6111789f0cdca3d5e  # lxd/db: Leverage code-generation for certificates
      git cherry-pick fc0d4c4158413248e940ce602a9080a6d60b256f  # shared: Rewrite OpenPty without cgo
      git cherry-pick 539b6bb5fe7cd2e2f48b4f9dabfa78f5fb7e2424  # openpty: use O_CLOEXEC directly
      git cherry-pick c11dc379f3b1a6d668ff0a84a2f81d56d2823073  # openpty: use fchown()
      git cherry-pick 5b0b96f67ae4597b24aab6f68c9b75c44857185b  # openpty: first unlock the master, then get a slave fd
      git cherry-pick 117e1b9d6d22c78ea16616559c9f0f184d40a222  # openpty: use TIOCGPTPEER if available
      git cherry-pick 2517fefd67f5cbd01bad43662246a515727f6517  # lxd/storage/drivers/driver/lvm/utils: Adds lvmSnapshotSeparator constant and updates lvmFullVolumeName to use it
      git cherry-pick 5c8f968ca54415f89fa709f30e452ab4e4b37d3e  # lxd/storage/drivers/driver/lvm/utils: Adds lvmEscapedHyphen and updates lvmFullVolumeName usage
      git cherry-pick f5ba1cc4ff67772c27c4badc8bb6f4fe2ff3deb3  # lxd/storage/drivers/driver/lvm/utils: Adds parseLogicalVolumeSnapshot function
      git cherry-pick ae6faf612e0f94c1746ccf327d584a19e5ee0404  # lxd/storage/drivers/driver/lvm/utils: Adds tests for parseLogicalVolumeSnapshot
      git cherry-pick e7208789c5b22de9d48d7a2b067d879f55a1cbfd  # lxd/storage/drivers/driver/lvm/volumes: Updates VolumeSnapshots to use parseLogicalVolumeSnapshot
      git cherry-pick 23154b0681140075628292bb0ced61b36240bef1  # test: Adds tests for snapshot naming conflicts
      git cherry-pick b1f42348373b67c8167c7ce3b37f80f331cd7dc9  # lxd/firewall/drivers: Fix nft syntax
      git cherry-pick 5799eea6a617e02f49e22bd7438d7ba0406dd5e5  # lxc/project: Fix remote handling
      git cherry-pick d853d7173979c093d4171e7b4d0519495f060cc4  # tests: Fix bad project switch call
      git cherry-pick 3709620f86bdab0ef20b18355dfa4e73e0fef0cf  # lxd/seccomp: Fix profile conflict between projects
      git cherry-pick b063df724d1a3268bfddc5c61b60e78eacd93e42  # lxd/storage/drivers/driver/lvm/utils: Adds activateVolume and deactivateVolume functions
      git cherry-pick b4e7a04489605cf3be60ec29316d9db31d61872a  # lxd/storage/drivers/driver/lvm/utils: Set --setactivationskip on in createLogicalVolume
      git cherry-pick 78e5d62d28690ce246805fde8406891b3fff0f90  # lxd/storage/drivers/driver/lvm/utils: Set --setactivationskip on in createLogicalVolumeSnapshot
      git cherry-pick 75de186ab0f7662073174b3028764eb8636ad0a3  # lxd/storage/drivers/driver/lvm/utils: Activate volume in copyThinpoolVolume when regeneration FS UUID
      git cherry-pick eac5bc7a4e798b3208cb5ed19f7c3aa10677fe12  # lxd/storage/drivers/driver/lvm: Dont activate all volumes on pool mount
      git cherry-pick dc2c52cce372e8901fa020c3228e65adbe50a054  # lxd/storage/drivers/driver/lvm/volumes: Activate volume before generic copy in CreateVolumeFromCopy
      git cherry-pick d4f423d46d600a78f932bf3b48f9cd0fc3b167f8  # lxd/storage/drivers/driver/lvm/volumes: Activate volume in SetVolumeQuota
      git cherry-pick 7ed97165c2af784f1f1c875f333ff7524c1a97c3  # lxd/storage/drivers/driver/lvm/volumes: Activate volume in MountVolume
      git cherry-pick cc902e404db4c06cae5e8b7de14ec060f4a6142d  # lxd/storage/drivers/driver/lvm/volumes: Deactivate volume in UnmountVolume
      git cherry-pick 7384a1362991a44a4563cf231a5cb42a36df85c3  # lxd/storage/drivers/driver/lvm/volumes: Acticate volume before generic migrate in MigrateVolume
      git cherry-pick a5d2259cff88e3a73c85e675453b0767bd3642d1  # lxd/storage/drivers/driver/lvm/volumes: Activate volume in MountVolumeSnapshot
      git cherry-pick 33063b7f5b0d9bb4999fe41bd80ed876569abc37  # lxd/storage/drivers/driver/lvm/volumes: Deactivate volume in UnmountVolumeSnapshot
      git cherry-pick c52848c167d053d044203e68442cbbc4555022e5  # lxd/storage/drivers/driver/lvm/volumes: Activate volume before FS UUID regen in RestoreVolume
      git cherry-pick 90d976c59862d5741f042838f9b0f39ef143a7a6  # openpty: fix TIOCGPTPEER usage
      git cherry-pick 2340417ec1e39ab48dd9917f580fa2fe00efb9e0  # Make network address bind error fatal when clustered
      git cherry-pick 6c692a0f9cf54a0937ad5de5f226ce4f49e3abf9  # lxd/storage/drivers/driver/btrfs/utils: Renames metadatHeader to restorationHeader
      git cherry-pick a99ac5ba5e6a75be4f31e7f45877cf4f312cafbf  # lxd/storage/drivers/driver/btrfs/volumes: d.restorationHeader usage
      git cherry-pick 4c1c444eeeb3cb77e70ca0e85c348ef863d94899  # lxd/storage/drivers/driver/btrfs/volumes: Clarifies comments in MigrateVolume
      git cherry-pick 811753d345ecee39d09246f01456381e540af79f  # lxd/storage/drivers/driver/btrfs/volumes: Adds safety net against failed matching of subvolumes
      git cherry-pick b03b4ae80cd7bf9ab018d39644bb4eec3e60a5bc  # lxd/storage/drivers/driver/btrfs/utils: Fix deleteSubvolume to support recursive delete with intermediate ro subvols
      git cherry-pick 2b5b51dd9823a565652fa4c32746acd529b3566e  # lxd/storage/drivers/utils: Mark BTRFSSubVolumeMakeRo and BTRFSSubVolumeMakeRw deprecated
      git cherry-pick 24daebe649d726ee20bfb1f56594acc26c90d4a2  # lxd/storage/drivers/driver/btrfs/volumes: Updates RestoreVolume to restore subvolume ro property
      git cherry-pick f83a725093dc2b36224ef5e23f3b4ec556940ff4  # test: Adds BTRFS subvolume tests
      git cherry-pick e3b384d63a4c561a4f07e2d3f1ff1e36f73a166d  # lxd/storage/memorypipe: Fixes issue with partial reads losing data
      git cherry-pick 955977fe0a2fe2d6d2418e8fd945af6fc54792fc  # lxd/storage/drivers/driver/btrfs/volumes: Restores subvolumes ro property in CreateVolumeFromCopy
      git cherry-pick 6fa2d703f11fd68a8bf261e719fdd0816b113b54  # lxd/storage/drivers/driver/btrfs/utils: Adds marshal tags to BTRFSSubVolume and BTRFSMetaDataHeader
      git cherry-pick e16274d989ccf143db92044d7702ca2b7ee23252  # lxd/device/nic/bridged: Updates github.com/mdlayher/netx/eui64
      git cherry-pick fc48ec80c7b2d06cbc92ccfc85468197b2942a9d  # fix IPVLAN docs
      git cherry-pick 7d36f347aa1eafcac096e65b084233e125a858ba  # lxd/cluster: Don't run a connection proxy when connecting with the Go dqlite client
      git cherry-pick b07eb49305191e52b16300da0f7b87bbf55fce53  # lxd/cluster: Extract dqlite network proxy logic to standalone function and support cancellation
      git cherry-pick b0ae3dbe7a778e736a8d2c3ebe79da40080284ce  # lxd/cluster: Use dqliteProxy in raftDial
      git cherry-pick 8742ad0b8397293650754d3841270333b101e628  # lxd/cluster: Use ReadClose() to gracefully stop the dqlite proxy
      git cherry-pick 53d7227ad3317e99a9255d544d00e281e73d132f  # lxd/device/device/utils/generic: Removes deviceNameEncode and deviceNameDecode
      git cherry-pick 6a808c5d3f07b8dc18ed1c80e8fc70c046a61335  # lxd/storage/drivers/utils: Adds PathNameEncode and PathNameDecode
      git cherry-pick ca6fe9a580b0e3007e7b694fcad0d630babe0cbe  # lxd/device/device: PathNameEncode and PathNameDecode usage
      git cherry-pick 523b154a94d88a23219c5d3eeac57241f0372f0c  # lxd/storage/drivers/driver/types: Adds OptimizedBackupHeader field to Info
      git cherry-pick 96b43cc75e3da8a046f628228a392e952fc59779  # lxd/backup/backup: Adds OptimizedHeader field to Info struct
      git cherry-pick 1af82b6d7107e53aac28be5a5f506f29c1b2c2bd  # lxd/backup: Updates backupWriteIndex to populate the OptimizedHeader field
      git cherry-pick c4c4bbbe4c9626ba6d7b2d19f291936f4b58e23a  # lxd/storage/drivers/driver/btrfs: Sets OptimizedBackupHeader to true in Info struct response
      git cherry-pick 027157884b8ed13c08b99a0a123622c5b14b2ff6  # lxd/storage/drivers/driver/btrfs/utils: Adds warning to BTRFSSubVolume and BTRFSMetaDataHeader about shared usage
      git cherry-pick 88244a190fdb8e26ab4ca76301199ef5a9bfe774  # lxd/storage/drivers/driver/btrfs/volumes: Updates BackupVolume to add subvolumes to optimized backup file
      git cherry-pick 11db1ab45021a33cd2de3a1c84c9411d19a339fc  # lxd/storage/drivers/interface: Update CreateVolumeFromBackup to pass srcBackup backup.Info
      git cherry-pick e7b7ff81991d83e0293ebf6d95abd8492efb3bed  # lxd/storage/backend/lxd: Pass srcBackup in CreateInstanceFromBackup
      git cherry-pick 32c36132b52c64e8f04d2e757a4d35bece875ca8  # lxd/storage/drivers: CreateVolumeFromBackup srcBackup backup.Info usage
      git cherry-pick e6617bda5c4b1db2d3618117f1637a48f5273cec  # lxd/backup/backup: Updates GetInfo to set optimizedHeaderFalse false if not present in yaml file
      git cherry-pick 84bca19eeeb307000de8f08c4e681b65c8fe4091  # lxd/storage/drivers/driver/btrfs/utils: Adds loadOptimizedBackupHeader
      git cherry-pick 9fe186bf22fc02169ab1ad9ef7f0c02b1ea7c829  # lxd/storage/drivers/driver/btrfs/volumes: Updates CreateVolumeFromBackup to restore subvolumes using optimized header file
      git cherry-pick cbdca1f26cd82715cf4da8346104e95353c79fda  # lxd/storage/drivers/driver/btrfs/volumes: Simplifies parent volume logic in BackupVolume
      git cherry-pick e45411b87ab17fa845755ad70a34805047891a06  # lxd/storage/drivers/driver/btrfs/volumes: Simplifies parent volume logic for MigrateVolume
      git cherry-pick 8698f2ac9ee77a87949ee49ce085c2c12c410e93  # test: Adds BTRFS backup subvolume tests
      git cherry-pick 6433d35b5988add90614b1e37ad86993ab2979cb  # lxd/storage/drivers/driver/btrfs/utils: Removes receiveSubvolume
      git cherry-pick 9cd32f57a619f76be686dc4f21c33f36a06f4c32  # lxd/storage/drivers/driver/btrfs/utils: Adds receiveSubVolume function
      git cherry-pick 4746e072b64fc79c1aa781ed8c07a6ffce3d76f9  # lxd/storage/drivers/driver/btrfs/volumes: Updates CreateVolumeFromMigration to use receiveSubVolume
      git cherry-pick 375ce45456e9f0789a48541704014a1695896a0f  # lxd/resources/memory: Fix memory calculation
      git cherry-pick f7d28ce46880598f85d96107546453825ae89457  # lxd: Improve logging of shutdown errors
      git cherry-pick 61ea7804fc3352f8c44929544e6c5c8ef7407ea4  # lxd/instances/post: Delete restored instance on backup post hook failure
      git cherry-pick 98ac1124b1e00cbaa4416b3bd6dd7b8a59184a41  # Fix 'how to mount home directory' shiftfs FAQ
      git cherry-pick 25e7a11c4b4daa08636dc75bff8578271fdbd342  # shared: build fs_{32,64}bit.go on mips*
      git cherry-pick 08e739fcbb6d14aca75d3b7ff3a1b8f6d47465b1  # lxd/util: build fs_{32,64}bit.go on mips*
      git cherry-pick 51b8879f617926ca57a5c543a57ee53385bce77d  # lxd/rsync: Adds optional rsync arguments to LocalCopy
      git cherry-pick 54c54b7603e3d8c66fe7e20adf98042c6dbada67  # lxd/storage/utils: Fixes ImageUnpack to not erase generated rootfs block file when doing rsync
      git cherry-pick 68ee8bd0dfd9671faefb6e95af7eb7cefbf214ef  # ethtool: don't report -1 for speed in ethtoolLink()
      git cherry-pick aebc3dbbd7f4f5fbd39827ce61b9b577f31f5989  # lxd/storage/quota/projectquota: Fixes leaking file handles in quota_set_path and quota_get_path
      git cherry-pick 6f5a4f43cd8218aab04e4d1c715f871394fdcc83  # lxd/storage/quota/projectquota: Adds inherit argument to quota_set_path
      git cherry-pick 0ee371669945f42f150f4f9b639d0084da004b3a  # lxd/storage/quota/projectquota: Updates SetProject to recursively set project and support non-directory files
      git cherry-pick e0577383e5edc10456adf62525bc343a0cb5671c  # lxd/storage/drivers/driver/dir/utils: Updates deleteQuota to use DeleteProject
      git cherry-pick e8aebb3badf3ae48e9421f3bd6c6936e1a2cbc50  # lxd/storage/drivers/driver/dir/volumes: Adds quota revert in CreateVolumeFromBackup post hook
      git cherry-pick 406821ba58e04f442b7ff79cdf1af68addcfbf15  # Always skip offline servers when rebalancing
      git cherry-pick 34b77e54a997533b9a78b51515f11ad7a542e98b  # When demoting a voter to spare, transition to stand-by first
      git cherry-pick c5f436137987837a978dd18c36b51903085de4bf  # test/clustering: Make sure that a killed voter can't dsirupt current leader
      git cherry-pick 7dec71f8d0513e6bdfcd680d825d47fc76757565  # lxd/cluster: Use a dedicated channel to stop the dqlite proxy
      git cherry-pick 73daa54bf6688d097f293d8f808b9c9c0933e18c  # lxd: Call Deamon.Kill() also when receiving signals (so db transactions won't be retried)
      git cherry-pick 258e20e656d498da14b05730efc2af37926dcf83  # lxd/db: Add Cluster.Kill() method to prevent retrying upon shutdown
      git cherry-pick 0a46bae0680a047f92ffc7e2ea055f8fb7aa7aeb  # lxd/firewall/drivers/driver/nftables/templates: Fixes proxy nat rule dynamic family
      git cherry-pick 041174437c3cfbee3855da10633f142ae0f0b2ae  # shared/util_linux.go: cast Rdev uint64 for mips
      git cherry-pick e17b282282d9a4e411efb2648c6fbce961e0d892  # lxd/storage/quota/projectquota.go: cast Rdev uint64 for mips
      git cherry-pick 43b913776738a7f8d5e8033718259d079f086dea  # lxd/device/device_utils_unix.go: cast Rdev uint64 for mips
      git cherry-pick 95d213e414aa945070072df2c6836fa99849e37c  # lxd/device/gpu.go: cast Rdev uint64 for mips
      git cherry-pick 43c3fbe7e884b7a2afc88fecf1c1d8d5e80c8de6  # shared: Reimplement GetPollRevents without cgo
      git cherry-pick 47b898e3e9600c3bca3846f2694000511051c868  # lxd-agent: Build statically
      git cherry-pick bd90123fd871988a168d44023ce366d649110993  # Drop gccgo
      git cherry-pick 2b67df761f9712172d614a5c127736ab2b03556b  # lxd-p2c: Drop cgo
      git cherry-pick 980ef31ed078f9a97383f089c50e3b9e665d066d  # shared/ucred: Cleanup package
      git cherry-pick e2dcbb6786f80643c8267d3897abaf2c4e9b77dd  # lxd/api: Don't strip double slashes
      git cherry-pick c34d180fcc791f5a37bb66f2868d4869c9ec3d13  # lxd/operations: Improve error message when database insertion fails
      git cherry-pick 7a87788cbf187f2a656a5cedf79a5620dfde0e72  # lxd/db: Change UpdateCertificate to RenameCertificate (only renaming supported)
      git cherry-pick 12cb01c706a8126fa53439f24d9dfb44ba8815ca  # lxd/db: Rename containers.go to instances.go
      git cherry-pick db98707060e9d6ce14fe9a40f7e230e33dc0d2cd  # shared/generate/db: Statement for deleting references (config and devices)
      git cherry-pick 8bdaffa9dcf6eec0d6d66f2789b1669a9201c6c6  # lxd/db: Generate delete stements for profile config and devices
      git cherry-pick e051168ac9d2f9bd95a7a1470e6f6168c1b99c19  # shared/generate/db: update statement: take ID instead of natural key
      git cherry-pick e9f37db5d724189b78723b22d6bc406d0c8d83d8  # shared/generate/db: Handle config and devices in Update method
      git cherry-pick 9a92da7252f2f8e6e00ab54c4725b745e660d30c  # lxd/db: Generate Update method for profiles
      git cherry-pick 82ab2cc0084212b9f7f749f3764ac90104e98452  # lxd: Plug new UpdateProfile() db method into doProfileUpdate
      git cherry-pick e4a907db1947d35ff9d2285194c898c2ac0985df  # lxd: Plug new UpdateProfile() db method into updatePoolPropertyForAllObjects
      git cherry-pick 71f642ec9e55b90cc4dad5cd27d9c2538e6b83f7  # lxd/db: Generate delete statements for instance config, devices and profiles
      git cherry-pick ec27de7383a25a8931e1b4c5264992dc776ed054  # lxd/db: Generate UpdateInstance method
      git cherry-pick 566fc4e39940a62ec95d33492accf395a51f192d  # lxd/instance: Plug the new UpdateInstance method and replace legacy logic
      git cherry-pick 1a43b6be4ae3a21ec2ce00f288b06217b46086a9  # lxd/db: Drop AddDevicesToEntity
      git cherry-pick d23c3ada138c2129368c0b70031d184c5aab98e7  # lxd/storage/drivers/driver/common: Logging quoting consistency
      git cherry-pick 8a09d17774103bcaa621274225bf8ff531c03f60  # lxd/storage/drivers: Adds storage_lvm_skipactivation patch
      git cherry-pick 25800c760580fc95e16184054218f339f0cb475e  # test: Drive-by fix for flaky clustering rebalance test
      git cherry-pick 208ad6f73d60d0b679e753cd0c007c75fff7e4ca  # Recommend to increase the value of aio-max-nr for production use
      git cherry-pick 33b8ecfeb4c0c2369b6866be39366aadd72a3622  # lxd/firewall/firewall/interface: Change definition of Compat() to return compat issue error
      git cherry-pick b3f3013db74bbf2fba135874bf14d66c2fd8bf0b  # lxd/firewall/drivers/driver/nftables: Updates Compat() to return compat issues as error
      git cherry-pick 964f6522faf25b8c35efdea4998f5bc2b18e99ec  # lxd/firewall/drivers/drivers/xtables: Updates Compat() to return compat issues as error
      git cherry-pick ffe56f7c1cd46c9a7a5e073baa42665c66555167  # shared/simplestreams: Support uefi1.img
      git cherry-pick fc2fdde1c84dc76c667668b8032eb798f9e9e785  # lxd/firewall/firewall/load: Updates driver detection to warn when falling back to non-compatible xtables
      git cherry-pick cf5900aec46790458d2631d0b711d74883a63faa  # lxd/storage/pools: Improves delete pool error info
      git cherry-pick ea079696a3e5974a4baef8cf69f1893ac4310b54  # instance_exec: don't panic
      git cherry-pick 928bf63bb303f872cc4b62cd9f7cadfd343747c3  # lxd/qemu: Handle quoted raw.qemu
      git cherry-pick 5007a03f285a7de7c052b777d11dc15b0ad240c6  # lxd/main_forkproxy: Reduce logging
      git cherry-pick c11bf20310f0adbb15408b5ef67da64b56caa0ee  # lxd/networks: Warn on small IPv6 subnets
      git cherry-pick b10d82bfd1f7fe7e377ea371898aa7a2aa60d77e  # lxd/network: Force DHCP custom gateway
      git cherry-pick b138b97e6e97676737d7b988035654c3c9da5ea3  # lxc/list: Add disk and memory columns
      git cherry-pick 56bbf329f997a5b5fcb79756d82027bb0f609349  # i18n: Update translation template
      git cherry-pick dc5bc5c0c219aead58fb71c30d02f293f43e3694  # lxd/storage/drivers: Make sure tar reader context is cancelled before defer
      git cherry-pick 0e810277298f25776029799150f5c004ad4228ca  # lxc/list: Fix test
      git cherry-pick 6c8d748a8f6552cff0371ab3962854914b7c3814  # shared/archive: Wraps cancelFunc to wait until unpacker process has finished in CompressedTarReader
      git cherry-pick ca21c0a0de10e6cfa692986ba9f6b386066189d0  # lxd/cluster: Transfer leadership before adjusting roles, not after
      git cherry-pick 48c7bac7f7440d7a708d344c15a6274ad9fc6fb7  # lxd/cluster: Add time skew detection
      git cherry-pick 53c56de9c7fd776db9fcbd455bbaaafb91a9c070  # test: Wait a few more seconds for the rebalance to happen
      git cherry-pick 3d708969ea142863ed4e7422c6287492926a9d0e  # lxd/daemon.go: Don't try to rebalance after shutdown sequence has started
      git cherry-pick d31d03a21843522c06b1649f73aa6d76e8257fec  # lxd/cluster: Don't try to rebalance a standalone node
      git cherry-pick 763d5248ca26cbf3414f06772300ab63aa837814  # lxc/ucred: Simplify logic
      git cherry-pick 114877d68e6fa1b2e846266314ffc7d283d0ce6b  # lxd/qemu: Cleanup arch checks
      git cherry-pick 8f4f540c60d26efcb3a6d6a1d4d3bf3419a96f1c  # lxd/qemu: Add s390x support

      # Download any new dependencies
      export GOPATH=$(realpath ../go)
      go get -t -d ./...

      # Setup for our shared libraries
      sed -i "/\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/canonical/go-dqlite/internal/bindings/server.go
      sed -i "/^\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/mattn/go-sqlite3/sqlite3.go

      # Run the standard build
      set +ex
      snapcraftctl build
      set -ex

      # Build the agent (special build tags)
      CGO_ENABLED=0 go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd-agent" -tags=agent,netgo github.com/lxc/lxd/lxd-agent

      # Setup bash completion
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/
      echo 'export PATH="${PATH}:/snap/bin:/var/lib/snapd/snap/bin"' > ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
      cat scripts/bash/lxd-client >> ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/share/misc/: share/misc/
      var/lib/usbutils/usb.ids: share/misc/
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/dnsmasq
      - bin/getfattr
      - bin/setfattr
      - bin/iw
      - bin/pigz
      - bin/rsync
      - bin/setfacl
      - bin/sgdisk
      - bin/unsquashfs
      - bin/xdelta3

      - etc/bash_completion.d/snap.lxd.lxc

      - share/misc

      - bin/lxc
      - bin/lxc-to-lxd
      - bin/lxd
      - bin/lxd-agent
      - bin/lxd-benchmark

  lxd-migrate:
    source: lxd-migrate/
    after:
      - lxd
      - sqlite
    plugin: go
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd-pkg-snap/lxd-migrate
    override-build: |
      set -ex

      # Setup for our shared libraries
      sed -i "/^\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/mattn/go-sqlite3/sqlite3.go

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p ${SNAPCRAFT_PART_INSTALL}/bin/
      cp scripts/upgrade-bridge ${SNAPCRAFT_PART_INSTALL}/bin/upgrade-bridge
    prime:
      - bin/lxd-migrate
      - bin/upgrade-bridge

  shmounts:
    source: shmounts/
    plugin: make
    prime:
      - bin/setup-shmounts

  snap-query:
    source: snap-query/
    plugin: go
    go-importpath: github.com/lxc/lxd-pkg-snap/snap-query
    prime:
      - bin/snap-query

  strip:
    source: snapcraft/empty
    after:
      - btrfs
      - ceph
      - dqlite
      - libco
      - libseccomp
      - logrotate
      - lvm
      - nano
      - nvidia-container
      - openvswitch
      - raft
      - sqlite
      - squashfs-tools-ng
      - vim
      - xfs
      - xtables
      - xz
      - zfs-0-6
      - zfs-0-7
      - zfs-0-8
      - lxc
      - lxcfs
      - criu
      - lxd
      - lxd-migrate
      - shmounts
      - snap-query
    plugin: nil
    override-prime: |
      set -x

      # Strip some of the heavy bits
      strip -s ${SNAPCRAFT_PRIME}/bin/lxc
      strip -s ${SNAPCRAFT_PRIME}/bin/lxd*
      strip -s ${SNAPCRAFT_PRIME}/bin/snap*
      strip -s ${SNAPCRAFT_PRIME}/lib/liblxc*
      strip -s ${SNAPCRAFT_PRIME}/lib/libdqlite*
      strip -s ${SNAPCRAFT_PRIME}/lib/libsqlite*

      for zfs in zfs-0.6 zfs-0.7 zfs-0.8; do
          [ ! -d "${SNAPCRAFT_PRIME}/${zfs}" ] && continue
          strip -s ${SNAPCRAFT_PRIME}/${zfs}/bin/* ${SNAPCRAFT_PRIME}/${zfs}/lib/*
      done

      [ -e "${SNAPCRAFT_PRIME}/criu/criu" ] && strip -s ${SNAPCRAFT_PRIME}/criu/criu

      exit 0

  wrappers:
    plugin: dump
    source: snapcraft/
    organize:
      hooks/: snap/hooks/
