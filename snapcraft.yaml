name: lxd
base: core18
assumes:
  - snapd2.39
version: "4.0.1"
grade: stable
summary: LXD - the container lightervisor
description: |-
 LXD is a container manager for system containers.

 It offers a REST API to remotely manage containers over the network,
 using an image based workflow and with support for live migration.

 Images are available for all Ubuntu releases and architectures as well
 as for a wide number of other Linux distributions.

 LXD containers are lightweight, secure by default and a great
 alternative to virtual machines.

 Supported configuration options (snap set lxd [<key>=<value>...]):
   - ceph.builtin: Use snap-specific ceph configuration [default=false]
   - criu.enable: Enable experimental live-migration support [default=false]
   - daemon.debug: Increases logging to debug level [default=false]
   - daemon.group: Group of users that can interact with LXD [default=lxd]
   - daemon.preseed: A YAML configuration to feed `lxd init` on initial start
   - lxcfs.pidfd: Start per-container process tracking [default=false]
   - lxcfs.loadavg: Start tracking per-container load average [default=false]
   - lxcfs.cfs: Consider CPU shares for CPU usage [default=false]
   - openvswitch.builtin: Run a snap-specific OVS daemon [default=false]
   - shiftfs.enable: Enable shiftfs support [default=auto]

confinement: strict

apps:
  # Main commands
  activate:
    command: commands/daemon.activate
    daemon: oneshot
    plugs:
      - lxd-support
      - system-observe

  daemon:
    command: commands/daemon.start
    reload-command: commands/daemon.reload
    stop-command: commands/daemon.stop
    stop-timeout: 600s
    restart-condition: on-failure
    daemon: simple
    slots: [lxd]
    plugs:
      - lxd-support
      - network-bind
      - system-observe
    sockets:
      unix:
        listen-stream: $SNAP_COMMON/lxd/unix.socket
        socket-mode: 0660

  lxc:
    command: commands/lxc
    completer: etc/bash_completion.d/snap.lxd.lxc
    plugs:
      - lxd-support
      - system-observe

  lxd:
    command: commands/lxd
    plugs:
      - lxd-support
      - system-observe

  # Sub-commands
  benchmark:
    command: commands/lxd-benchmark
    plugs:
      - lxd-support
      - system-observe
  buginfo:
    command: commands/buginfo
    plugs:
      - lxd-support
      - system-observe
  check-kernel:
    command: commands/lxd-check-kernel
    plugs:
      - lxd-support
      - system-observe
  lxc-to-lxd:
    command: commands/lxc-to-lxd
    plugs:
      - lxd-support
      - system-observe
  migrate:
    command: commands/lxd-migrate
    plugs:
      - lxd-support
      - system-observe

hooks:
  configure:
    plugs:
      - network
      - system-observe
  remove:
    plugs:
      - lxd-support
      - system-observe

parts:
  # Dependencies
  btrfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - btrfs-tools
    prime:
      - bin/btrfs
      - bin/btrfstune
      - bin/mkfs.btrfs

  ceph:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ceph-common
      - libdb5.3
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/ceph
      - bin/python
      - bin/python2*
      - bin/rbd
      - lib/python2.7
      - lib/*/libpython2.7.so*
      - -lib/python2.7/sitecustomize.py
      - lib/*/ceph
      - lib/*/libboost_iostreams.so.*
      - lib/*/libboost_program_options.so.*
      - lib/*/libboost_random.so.*
      - lib/*/libboost_regex.so.*
      - lib/*/libboost_system.so.*
      - lib/*/libboost_thread.so.*
      - lib/*/libcephfs*
      - lib/*/libdb-5.3.so
      - lib/*/libicudata.so.*
      - lib/*/libicui18n.so.*
      - lib/*/libicuuc.so.*
      - lib/*/libnspr4.so
      - lib/*/libnss3.so
      - lib/*/libibverbs.so*
      - lib/*/nss/libsoftokn3.so
      - lib/*/nss/libfreeblpriv3.so
      - lib/*/libnssutil3.so
      - lib/*/libplc4.so
      - lib/*/libplds4.so
      - lib/*/librados.so.*
      - lib/*/librbd.so.*
      - lib/*/libsmime3.so
      - lib/*/libsnappy*

  dqlite:
    after:
      - libco
      - raft
      - sqlite
    source: https://github.com/canonical/dqlite
    source-type: git
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libdqlite*so*
      - lib/*/libuv*

  edk2:
    after:
      - qemu
    source: https://github.com/tianocore/edk2
    source-type: git
    source-tag: edk2-stable202002
    plugin: nil
    build-packages:
      - acpica-tools
      - nasm
      - uuid-dev
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      ARCH="X64"
      PKG="OvmfPkg/OvmfPkgX64.dsc"
      FV_CODE="OVMF_CODE"
      FV_VARS="OVMF_VARS"
      if [ "$(uname -m)" = "aarch64" ]; then
          ARCH="AARCH64"
          PKG="ArmVirtPkg/ArmVirtQemu.dsc"
          FV_CODE="QEMU_EFI"
          FV_VARS="QEMU_VARS"
      fi

      # Run in a bash sub-shell as edksetup.sh requires it
      set -ex
      (
      cat << EOF
          . ./edksetup.sh
          make -C BaseTools ARCH=${ARCH}
          build -a ${ARCH} -t GCC49 -b RELEASE -p ${PKG} \
            -DNETWORK_HTTP_BOOT_ENABLE=TRUE \
            -DSECURE_BOOT_ENABLE=TRUE \
            -DFD_SIZE_2MB \
            -DTPM2_ENABLE=TRUE
      EOF
      ) | bash -e

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      cp Build/*/*/FV/${FV_CODE}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
      cp Build/*/*/FV/${FV_VARS}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"

      if [ "$(uname -m)" = "aarch64" ]; then
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"
      fi

    prime:
      - share/qemu/*

  libco:
    source: https://github.com/canonical/libco
    source-type: git
    plugin: make
    organize:
      usr/lib/: lib/
    prime:
      - lib/libco*so*

  libmnl:
    source: https://git.netfilter.org/libmnl
    source-type: git
    source-tag: libmnl-1.0.4
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libmnl*so*

  libnftnl:
    after:
      - libmnl
    source: https://git.netfilter.org/libnftnl
    source-type: git
    source-tag: libnftnl-1.1.6
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libnftnl*so*

  libseccomp:
    source: https://github.com/seccomp/libseccomp
    source-type: git
    plugin: autotools
    build-packages:
      - gperf
    organize:
      usr/lib/: lib/
    prime:
      - lib/libseccomp*so*

  logrotate:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - logrotate
      - libpopt0
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    stage:
      - bin/logrotate
    prime:
      - bin/logrotate
      - lib/*/libpopt*so*

  lvm:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - dmeventd
      - lvm2
      - thin-provisioning-tools
    organize:
      sbin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/cache_*
      - bin/dmeventd
      - bin/era_*
      - bin/lv*
      - bin/pdata_tools
      - bin/pv*
      - bin/thin_*
      - bin/vg*
      - -bin/vgimportclone
      - -bin/lvmconf
      - -bin/lvmdump
      - -bin/lvmetad
      - -bin/lvmpolld
      - etc/lvm/lvm.conf
      - lib/*/device-mapper/*
      - lib/*/libaio.so*
      - lib/*/libdevmapper*
      - lib/*/liblvm*
      - lib/*/libreadline.so*

  nano:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - nano
    organize:
      usr/bin/: bin/
    prime:
      - bin/nano
      - etc/nanorc

  nftables:
    after:
      - libmnl
      - libnftnl
    source: https://git.netfilter.org/nftables
    source-type: git
    source-tag: v0.9.4
    plugin: autotools
    configflags:
      - --with-json
    build-packages:
      - libjansson-dev
      - libreadline-dev
    stage-packages:
      - libjansson4
    organize:
      sbin/: bin/
      usr/lib/: lib/
    prime:
      - bin/nft
      - lib/*/libjansson*so*
      - lib/libnftables*so*

  nvidia-container:
    after:
      - libseccomp
    source: https://github.com/NVIDIA/libnvidia-container
    source-type: git
    source-tag: v1.0.6
    plugin: make
    build-packages:
      - bmake
      - curl
      - lsb-release
    override-build: |-
      set -ex

      # Supposedly supports x86_64, aarch64 and ppc64le but only x86_64 builds
      [ "$(uname -m)" != "x86_64" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/bin/"
      cp ${SNAPCRAFT_PROJECT_DIR}/snapcraft/wrappers/nvidia-container-cli "${SNAPCRAFT_PART_INSTALL}/bin/"

      set +ex
      snapcraftctl build
    organize:
      usr/local/bin/nvidia-container-cli: bin/nvidia-container-cli.real
      usr/local/lib: lib/
    prime:
      - bin/nvidia-container-cli*
      - lib/libnvidia-container.so*

  openvswitch:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - openvswitch-switch
      - uuid-runtime
    organize:
      usr/bin/: bin/
      usr/lib/openvswitch-switch/: bin/
      usr/sbin/: bin/
      usr/share/: share/
    prime:
      - bin/ovs-appctl
      - bin/ovs-vsctl
      - bin/ovs-vswitchd
      - bin/ovsdb-*
      - bin/uuidgen
      - share/openvswitch/

  qemu:
    after:
      - libseccomp
    source: https://git.qemu.org/git/qemu.git
    source-type: git
    source-tag: v5.0.0
    plugin: autotools
    configflags:
      - --disable-docs
      - --disable-slirp
      - --disable-user
      - --enable-attr
      - --enable-cap-ng
      - --enable-kvm
      - --enable-linux-aio
      - --enable-pie
      - --enable-rbd
      - --enable-seccomp
      - --enable-system
      - --enable-tools
      - --enable-vhost-crypto
      - --enable-vhost-kernel
      - --enable-vhost-net
      - --enable-vhost-scsi
      - --enable-vhost-user
      - --enable-vhost-vsock
      - --enable-virtfs
      - --enable-vnc
      - --firmwarepath=/snap/lxd/current/share/qemu/
    build-packages:
      - bison
      - flex
      - pkg-config
      - libcap-ng-dev
      - libglib2.0-dev
      - libpixman-1-dev
      - libaio-dev
      - librbd-dev
    stage-packages:
      - genisoimage
      - libmagic1
      - libpixman-1-0
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && [ "$(uname -m)" != "ppc64le" ] && [ "$(uname -m)" != "s390x" ] && exit 0

      set -ex
      # Mangle the configure a bit
      QEMUARCH="$(uname -m)"
      [ "${QEMUARCH}" = "ppc64le" ] && QEMUARCH="ppc64"
      sed -i "s/^unset target_list$/target_list=\"${QEMUARCH}-softmmu\"/" configure
      sed -i 's#libseccomp_minver=".*#libseccomp_minver="0.0"#g' configure

      set +ex
      snapcraftctl build
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/genisoimage*
      - bin/mkisofs*
      - bin/qemu-system-*
      - bin/qemu-img*
      - bin/virtfs-proxy-helper*
      - lib/*/libmagic*so*
      - lib/*/libpixman*so*
      - share/qemu/keymaps*
      - share/qemu/efi-virtio.rom*
      - share/qemu/kvmvapic.bin*
      - share/qemu/s390-*.img*
      - share/qemu/slof.bin*
      - share/qemu/vgabios-*.bin*

  qemu-ovmf-secureboot:
    after:
      - edk2
      - qemu
    source: https://github.com/puiterwijk/qemu-ovmf-secureboot
    source-type: git
    plugin: nil
    build-packages:
      - xorriso
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      set -ex
      rm -Rf iso-root vfat-root shell.iso
      mkdir -p iso-root vfat-root/efi/boot
      cp ../../edk2/build/Build/*/*/*/Shell.efi vfat-root/efi/boot/bootx64.efi
      cp ../../edk2/build/Build/*/*/*/EnrollDefaultKeys.efi vfat-root/
      "${SNAPCRAFT_STAGE}/bin/qemu-img" convert --image-opts driver=vvfat,floppy=on,fat-type=12,label=UEFI_SHELL,dir=vfat-root iso-root/shell.img
      xorriso --as mkisofs -input-charset ASCII -J -rational-rock -e shell.img -no-emul-boot -o shell.iso iso-root/

      # Basic aarch64 support
      if [ "$(uname -m)" = "aarch64" ]; then
          sed -i ovmf-vars-generator \
              -e "s/'-machine', machinetype,/'-machine', 'virt', '-cpu', 'cortex-a57',/" \
              -e "/charserial1/d" \
              -e "s/ide-cd/scsi-cd/" \
              -e "s/'-device',$/'-device', 'virtio-scsi-pci,id=scsi', '-device',/"
      elif [ "$(uname -m)" = "x86_64" ]; then
          cp -f "${SNAPCRAFT_STAGE}/share/qemu/kvmvapic.bin" .
      fi

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      python3 ovmf-vars-generator \
        --qemu-binary "${SNAPCRAFT_STAGE}/bin/qemu-system-$(uname -m)" \
        --print-output --disable-smm --skip-testing \
        --oem-string "$(cat ${SNAPCRAFT_PROJECT_DIR}/snapcraft/etc/ubuntu-sb.crt)" \
        --ovmf-binary "${SNAPCRAFT_STAGE}/share/qemu/OVMF_CODE.fd" \
        --ovmf-template-vars "${SNAPCRAFT_STAGE}/share/qemu/OVMF_VARS.fd" \
        --uefi-shell-iso shell.iso \
        "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.ms.fd"
    prime:
      - share/qemu/*

  raft:
    source: https://github.com/canonical/raft
    source-type: git
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libraft*so*

  sqlite:
    source: https://github.com/canonical/sqlite
    source-type: git
    source-tag: version-3.30.1+replication4
    plugin: autotools
    configflags:
      - --enable-replication
    build-packages:
      - tclsh
    override-build: |-
      set -ex

      git log -1 --format=format:%ci%n | sed -e 's/ [-+].*$//;s/ /T/;s/^/D /' > manifest
      git log -1 --format=format:%H > manifest.uuid
      cp /usr/share/misc/config.guess .
      cp /usr/share/misc/config.sub .
      autoreconf -f -i

      set +ex
      snapcraftctl build
    prime:
      - bin/sqlite3
      - lib/libsqlite3*so*

  squashfs-tools-ng:
    source: https://github.com/AgentD/squashfs-tools-ng
    source-type: git
    source-tag: v0.8
    plugin: autotools
    build-packages:
      - liblzma-dev
    prime:
      - bin/sqfs2tar
      - bin/tar2sqfs
      - lib/libsquashfs.so*

  vim:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - vim-tiny
    organize:
      usr/bin/: bin/
      usr/share/vim/vim*/debian.vim: etc/vimrc
    prime:
      - bin/vim.tiny
      - etc/vimrc

  xfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xfsprogs
    organize:
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/xfs_admin
      - bin/xfs_db
      - bin/xfs_growfs
      - bin/xfs_repair
      - bin/mkfs.xfs

  xtables:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ebtables
      - iptables
      - xtables-addons-common
    organize:
      usr/lib/*/xtables/*: lib/xtables/
      lib/ebtables/*: lib/
      sbin/: bin/
    prime:
      - bin/ebtables
      - etc/ethertypes
      - etc/protocols
      - lib/libebt*
      - lib/xtables/*

  xz:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xz-utils
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/xz
      - lib/*/liblzma*so*

  zfs-0-6:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.6.5.11
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick fb963d33ee0dd350143ba1c9cd35d5f7d86910d2  # Fix endian build problem on ppc64el

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-7:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.7.13
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-8:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.8.4
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  # Core components
  lxc:
    after:
      - libseccomp
    source: https://github.com/lxc/lxc
    source-type: git
    source-tag: lxc-4.0.2
    build-packages:
      - libapparmor-dev
      - libcap-dev
      - libgnutls28-dev
      - libselinux1-dev
      - pkg-config
    plugin: autotools
    configflags:
      - --disable-selinux
      - --disable-tests
      - --disable-examples
      - --disable-doc
      - --disable-tools
      - --disable-api-docs
      - --disable-bash
      - --disable-memfd-rexec
      - --enable-apparmor
      - --enable-seccomp
      - --enable-selinux
      - --enable-capabilities
      - --with-rootfs-path=/var/snap/lxd/common/lxc/
      - --libexecdir=/snap/lxd/current/libexec/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/libexec: libexec
      share/lxc/hooks: lxc/hooks
    prime:
      - bin/lxc-checkconfig
      - lib/liblxc.so.1
      - lib/liblxc.so.1.*
      - lxc/config/common.conf.d
      - lxc/hooks/nvidia
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick d51d0df41ef0f85a127daf84468189655499a6e3  # apparmor: Allow boot_id
      git cherry-pick 3a4031f03696e339c9d6d4cc16af2e771ae7e45f  # src/lxc/network: Fixes netlink attribute type 1 has an invalid length message
      git cherry-pick ba9eab74b8e7c9bcafadb83809f5f07c21318e2d  # cgroups: ignore cgroup2 limits on non-cgroup2 layouts
      git cherry-pick 6001872d082dffce5e328049788c7f1ae0864789  # common.conf: add cgroup2 default device limits
      git cherry-pick 8cce8b5930d3718b11217561bda78dcaa84dfdee  # cgroups: premount cgroups on cgroup2-only systems
      git cherry-pick 0343423e578ef608d6a5c2518de0d7bcbac5887b  # conf: introduce userns_exec_mapped_root()
      git cherry-pick 0baff7b7f54824d8f829a8d7a82b3423db03d305  # conf: support console setup on containers without rootfs
      git cherry-pick 63910a22283059853f0c799f6dcdc369c83518a0  # terminal: remove unneeded if condition
      git cherry-pick c91e492a17a1b24bb77f8089db7c98ca6619fa40  # gcc: add -Warray-bounds, -Wrestrict, -Wreturn-local-addr, -Wstringop-overflow
      git cherry-pick 52d2862cf6965596a2c0eb6bd3c8d9a2e66e9bb2  # compiler: support new access attributes
      git cherry-pick b467fc359118eafa0df761ab55d5ebe78ba4fb75  # tree-wide: this is all rather TODO than FIXME
      git cherry-pick 1cbdec6a1b89132cda4f4c5bd329124c6076b7e5  # yum: remove unused module
      git cherry-pick ab398a1bb9fe21c1049537e20b7ed6bb5cf843a5  # tools/lxc-ls: shutup lgtm
      git cherry-pick 7821133aab5113d629f4cb25e70b124c84903142  # tools/lxc-ls: shut up lgtm more
      git cherry-pick cf52a093d1b9b3b05cde8b43360bd3991b5196de  # confile: fix order independence of network keys
      git cherry-pick ea2a67a6b0c4995fa102021602ea6db93fd4bed8  # lxccontainer: small cleanup to lxc_check_inherited() calls
      git cherry-pick dd2f1aad65c19798bbd7c3de73c60b8ba48216d4  # start: remove unused lxc_zero_handler()
      git cherry-pick 3f96727b459cf032330d42f94b892e1b8c3de707  # lxccontainer: use close_prot_errno_disarm() on state_socket_pair
      git cherry-pick 755d1e1fecca4e841a9906b4b851f8da8ca31f4f  # start: fix container reboot
      git cherry-pick e758df857049176d9c1c132cdde096ce3b554ec5  # start: cleanup file descriptor inheritance
      git cherry-pick 3f924551c9963040e8048e7c7cdb06b9f1768d3e  # log: cleanup syslog handling
      git cherry-pick de4d585ee420862b9a927f04f80d9fbe5ca71de8  # console: only create detached mount when a console is requested
      git cherry-pick 5524656d86fd78be693dbd0f2cd278ed8b8da42c  # syscall_numbers: handle ia64 syscall numbers correctly
      git cherry-pick ef301301c68ad432cfd6beb82fd2da1fdeb78983  # syscall_numbers: add clone3()
      git cherry-pick 6aefab38c133edd2d4c6721ebf6312cac544ccdc  # process_utils: introduce new process_utils.{c,h}
      git cherry-pick a62eb3aa12b57fa83a5335eb9769d37d46e7444d  # process_utils: add clone3() support
      git cherry-pick c3d189153f5534db211defe25bf3c3256e6c564f  # mainloop: add lxc_mainloop_add_handler_events
      git cherry-pick 64df0b2f366c80318910981af9c007b06f3a29f9  # cgfsng: deduplicate freeze code
      git cherry-pick aabc94ba075d87dfcb593ea965803e38b850f3e1  # cgfsng: use EPOLLPRI when polling cgroup.events
      git cherry-pick 3e7477c80d48ab43421d504da01a2d2f6d7cbe62  # process_utils: make lxc use clone3() whenever possible
      git cherry-pick 4384dbb97541f3b4a134bebed7122dc3f572af43  # improve LXC_CMD_GET_CGROUP compatibility
      git cherry-pick 11bd22d1e7b65dc618d3211d2d9e9842378adb0f  # network: restore old behavior
      git cherry-pick 9ce7cbea1d4954e62be4ffe46526e30e1670d5f4  # network: fix {mac,ip,v}lan device creation
      git cherry-pick 11e7f7f41eb517196bce1995ecfbe446cd342288  # bionic: s/lxc_raw_execveat()/execveat()/g
      git cherry-pick a82035c72f46a51230194b6ca6e0acf7f48ef8a3  # network: use __instantiate_ns_common() in instantiate_ns_phys() too
      git cherry-pick 00e125db3ec97048671e7883547933c2861dfe18  # lxc-usernsexec: dumb down from error to warning message
      git cherry-pick 0ea3f2d11073ec89b5c25e338d16131dd530b848  # lxc-usernsexec: don't fail on setgroups()
      git cherry-pick 6a803ce290b87333abadc2a6e038d6f9c760cc91  # travis: Restrict coverity to gcc on bionic on amd64
      git cherry-pick b0ec3dc02a605ced446c5a02d87534cb9fdd42ee  # cgroups: be less alarming when creating cgroups

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/
      ln -s /var/snap/lxd/common/lxc/local.conf $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/01-local.conf
      sed -i "s#includedir=.*#includedir=$SNAPCRAFT_PART_INSTALL/include#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc
      sed -i "s#libdir=.*#libdir=$SNAPCRAFT_PART_INSTALL/lib#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc

  lxcfs:
    source: https://github.com/lxc/lxcfs
    source-type: git
    source-tag: lxcfs-4.0.3
    build-packages:
      - libfuse-dev
      - libpam0g-dev
      - pkg-config
    stage-packages:
      - fuse
    plugin: autotools
    configflags:
      - --datarootdir=/snap/lxd/current/
      - --localstatedir=/var/snap/lxd/common/var/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/lxcfs: lxcfs
      lib/lxcfs: lib
    prime:
      - bin/fusermount
      - lib/*/libfuse.so.*

      - bin/lxcfs
      - lib/liblxcfs.so

      - lxc
      - lxcfs
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick 7dddc7f335ec5644663112d346ecbd7fe5882163  # proc_fuse: silence error when we find no memlimit
      git cherry-pick 2e7b4138eae5b1cb4c4b6d2c87b45c5425f0c693  # sysfs: cpuinfo: show cgroup cpuset value
      git cherry-pick 10f4d9fb7b28a59a0f4e1104bf2e788cf6726c5b  # sysfs_fuse: remove logically dead code
      git cherry-pick 4179492059341d56eaf39dfd9ba132015fbe2076  # Fix https://github.com/lxc/lxcfs/issues/404

      set +ex
      snapcraftctl build
      set -ex

      sed -i "s#\${LXC_ROOTFS_MOUNT}/var/snap/lxd/common/var/lib/lxcfs/#\${LXC_ROOTFS_MOUNT}/var/lib/lxcfs/#g" $SNAPCRAFT_PART_INSTALL/snap/lxd/current/lxcfs/lxc.mount.hook

  criu:
    source: https://github.com/checkpoint-restore/criu
    source-tag: v3.14
    source-type: git
    plugin: nil
    build-packages:
      - asciidoc
      - libcap-dev
      - libnet1-dev
      - libnl-3-dev
      - libprotobuf-c-dev
      - libprotobuf-dev
      - protobuf-c-compiler
      - protobuf-compiler
      - python
      - xmlto
    stage-packages:
      - libnet1
      - libprotobuf-c1
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "armv7l" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      make
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/criu/"
      cp criu/criu "${SNAPCRAFT_PART_INSTALL}/criu/"
    organize:
      usr/lib/: lib/
    prime:
      - criu/*
      - lib/*/libnet*
      - lib/*/libproto*

  lxd:
    source: https://github.com/lxc/lxd
    source-type: git
    source-tag: lxd-4.0.1
    after:
      - lxc
      - dqlite
      - sqlite
    build-packages:
      - libacl1-dev
      - libudev-dev
      - pkg-config
    stage-packages:
      - acl
      - attr
      - dnsmasq-base
      - gdisk
      - iw
      - netbase
      - pciutils
      - pigz
      - rsync
      - squashfs-tools
      - usbutils
      - xdelta3
    plugin: nogetgo
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd
    go-packages:
      - github.com/lxc/lxd/lxc
      - github.com/lxc/lxd/lxc-to-lxd
      - github.com/lxc/lxd/lxd
      - github.com/lxc/lxd/lxd-benchmark
    override-build: |
      set -ex

      # Git cherry-picks
      cd ../src
      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick fe7e8253a2e314c6474d1378df6a7ef49c41e6b0  # lxd-agent: Support systemd-notify
      git cherry-pick 8bd0a5078aa94eb55712a47492adc48894ca13e6  # lxd/qemu: Switch default unit type to notify
      git cherry-pick b719cf6220373f8d730bdd04be456afbcfe39ccf  # lxd/storage/backend/lxd: Updates CreateInstanceFromImage to use reverter
      git cherry-pick 028e18400b8cbcbec645ac8579a29f20f7c2f8f0  # lxd/storage/drivers/errors: Adds ErrCannotBeShrunk error
      git cherry-pick 41cf2a4c8b99fbcc0df5a33299893cb765590bc3  # lxd/storage/drivers/utils: Updates to shrinkFileSystem ErrCannotBeShrunk error
      git cherry-pick 929fd6f68e2d7ed0aad3debc47c07c6c488f8179  # lxd/storage/backend/lxd: Updates CreateInstanceFromImage to detect ErrCannotBeShrunk
      git cherry-pick 9624ad69e3ba2c1c8ba14a288a0eee970484d119  # lxd/storage/drivers: Returns ErrCannotBeShrunk when block volume cannot be shrunk
      git cherry-pick f864ce5effb67f1ed9852c29291ca2a5f6a24519  # lxd/device/proxy: Dont allow proxy_protocol to be set when in nat mode
      git cherry-pick 643f1296c05473f401e2c4e4d5745eb502f8ed1c  # lxd/device/proxy: Dont wrap lines
      git cherry-pick 7f22d930ec4a8d3c60e400b098df66e692234ef9  # lxd/device/proxy: Improves validation
      git cherry-pick ba88444e7d0635f37122c7ec0dc1032d06b4afc1  # test/suites/container/devices/proxy: Updates tests with new validation rules
      git cherry-pick cdf47d40b2f684150e22bbea47a6ab91b670b4ce  # lxd: Updates snapshotProtobufToInstanceArgs to support instance type
      git cherry-pick 7f2f18e83051a88ac61151bcd4c2be082bc1ddec  # lxd/qemu: Match basic NUMA layout
      git cherry-pick 953c075d2b619deeb21fca85697a1b23de0f45d0  # lxd/storage/drivers/driver/zfs/volumes: Delete volume on error in CreateVolumeFromCopy
      git cherry-pick c209482eb7c76566fe522e439f23efafb0c0956f  # lxd-agent/main/agent: Adds comment about reason for systemd-notify usage
      git cherry-pick 0ec712d6e995ca59b9769e3f0a2ea8e2325e1100  # lxd/cgroup: Fix memory controller detection
      git cherry-pick b14ace4af2e0209efa7abdd8ed0e5444ca574be5  # lxd/migration/migrate/proto: Fix alignment
      git cherry-pick da955ef426a676fc45c1dc3851231114c3bf7dea  # lxd/migration: Adds volumeSize field to MigrationHeader
      git cherry-pick 8e00069f36e6253a4651764ca5168d83427004c8  # lxd/migrate: Adds VolumeSize to MigrationSinkArgs
      git cherry-pick 59f89a4a49f7ff3c68ca23b8b755328226918715  # lxd/migration/migration/volumes: Adds VolumeSize to VolumeTargetArgs
      git cherry-pick ace13c37405cd0e23e4cfcd43870ad63bf9cbcda  # lxd/migrate/instance: Use VolumeSize from offer header in Do()
      git cherry-pick 12468feff4d67d593a18a44263244fafe3690906  # lxd/storage/backend/lxd: Use VolumeSize from migration header in CreateInstanceFromMigration
      git cherry-pick 1511db3593ba3ad14cb74fdbc2e2fee42093c277  # lxd/storage/drivers: Exports BlockDevSizeBytes function
      git cherry-pick cbbece54ddf40b458b53c0d50fb4f44a38f52b8e  # lxd/storage/utils: Adds InstanceDiskBlockSize
      git cherry-pick 7d9d5625670d015b15099ac90de57c44e38a762c  # lxd/migrate/instance: Populate offerHeader.VolumeSize for VMs
      git cherry-pick 5237d512c91cea230e2f5c8d74384bcee306ecba  # lxd/storage/backend/lxd: Adds VM volume size hint to CreateInstanceFromCopy
      git cherry-pick 053321c6f9f078f4b4edcb3e9d7b938be43308ac  # lxd/device/utils: Do not add the Ceph mon port if already present in /etc/ceph config file
      git cherry-pick e2777010e5042d19e3c2e7a89570ca4e04d18022  # lxd/instance/qemu: Add comment on cpuTopology
      git cherry-pick 9e363b3a410779d7e0c01bbad29d6d64bfad68d0  # lxd/storage/ceph: Support port in URL
      git cherry-pick fbb6ff13313308d43444ec5e1d6deb9ca419c59e  # lxd/storage/drivers/utils: Makes minBlockBoundary available to other functions
      git cherry-pick f9983eee16735cbf4397f52d7e61d917f912ffbe  # lxd/storage/drivers/driver/zfs/utils: Updates createVolume to use minBlockBoundary
      git cherry-pick 3becb34ab08249c46754f1bede0b6ab98b19555b  # lxd/storage/drivers/driver/zfs/volumes: Updates SetVolumeQuota to use minBlockBoundary
      git cherry-pick 851fcd487056c4e28702277fbe483dd008213573  # lxd/storage/drivers/zfs/volumes: Updates CreateVolume to allow regeneration of deleted image volumes
      git cherry-pick 55a2f160de02e336ed026cd2c07868b14852ede8  # lxd/storage/drivers/driver/zfs/volumes: Dont revert on rename success
      git cherry-pick fb1b8a6136296f027a7a97f74fba444c439af729  # lxd/daemon: Remove duplicated logic
      git cherry-pick 018226a6c4183a07bc17fd0a072de615b80cd3e1  # lxd/instance/qemu: Announce LXD in SMBIOS
      git cherry-pick 6a209bae87959c8c58dbe28e3f3c0775843bc32a  # share/usbid: Don't print error when missing
      git cherry-pick 6cb0cef36e186e130baef46f40f7b65dd126b968  # lxd/init: Auto-detect and use Ubuntu ZFS setup
      git cherry-pick 0b619bebb0bdf8f5b79c7aea52d48f52a770f4ce  # lxc/config: Add --expanded to get
      git cherry-pick e89c82d9c45ae95f97f406bab6e08d11a99b22d2  # client/interfaces: Add Mode to ImageCopyArgs
      git cherry-pick 2a7a528044ec228d515b63a35ecd84447515e3ad  # shared/api/image: Add ImageExportPost
      git cherry-pick e47fea3944356914476eddc2f35f42537401c932  # client/lxd_images: Set fingerprint and secret headers
      git cherry-pick a909c0e4473a805caa9567c6e997bf33ef02bfc1  # i18n: Update translation templates
      git cherry-pick 7919869be9caf3863f4bc59e98a70846163e93c8  # client: Add relay mode for image copy
      git cherry-pick 5084a520c7bdd086788ff7ae3d9fb2c5ff929a5a  # client: Add ExportImage to ImageServer
      git cherry-pick 856e60d9ba0d8f2dd09460dd1d619a6cb206259d  # client: Add push mode for image copy
      git cherry-pick 791e5993e64da3f3112c1ca877a8a19d1c66c00c  # client: Add GetOperationWaitSecret
      git cherry-pick 3f51ef6c79c603fcd73ee816891bc2a5776d5869  # Resolve both core.https_address and cluster.https_address when comparing IPs
      git cherry-pick 24cc2554642d17485e24ebc9b9dbf4e0a865e5e9  # lxd/storage/drivers/generic/vfs: Skip missing files during export
      git cherry-pick 0b2852fb1fe9f06afbeb9a9c5280745176cd50a4  # lxd/images: Fixes hang in export when invalid --compression argument passed
      git cherry-pick ca5f8217bb5f7985cca257173d8392bf7d5c061f  # lxd/storage/drivers/driver/btrfs/volumes: CreateVolumeFromCopy only use expanded volume size when source is image
      git cherry-pick b6e6bfd6e888476d367a806d58a9d531521db41a  # lxd/storage/drivers/driver/ceph/volumes: Allow cached volume regeneration in CreateVolume
      git cherry-pick fe02656d19505d45dbe125a49ac82b6e134db816  # lxd/storage/drivers/driver/ceph/utils: Uses defaultBlockSize rather than hardcoded 10GB
      git cherry-pick 44d99824f508e66b48c44d893bc9ae2ea145346a  # lxd/storage/drivers/driver/ceph/volumes: Adds getVolumeSize function
      git cherry-pick aebd0e192e6721e1caf31898434e10943e53ce8e  # lxd/storage/drivers/driver/ceph/volumes: Removes unnecessary mount/unmount
      git cherry-pick e7e5f7a9d3f73e97db3ca523a01560c14b0a0274  # lxd/storage/drivers/driver/zfs/volumes: Clarify clone comments
      git cherry-pick 790ee77e0cb3c46eecff5e63d3ccd374b4cf9a91  # lxd/storage/drivers/driver/ceph/volumes: Dont wrap lines
      git cherry-pick 00a6c7770b01b5cd73bb79bcdc53c05922d9142c  # lxd/storage/drivers/driver/ceph/volumes: Dont use clone mode when creating volume from cached image when it is disabled
      git cherry-pick 3413284bcb0a5c9d42a8570ec2fbd8db4f0d1be2  # lxd/storage/utils: VolumeDBCreate comment formatting
      git cherry-pick 44dcac77ab507c95991d12a087b93c759eac8d5c  # lxd/storage/drivers/driver/lvm/volumes: CreateVolumeFromCopy only set volume size from expanded config when source is image
      git cherry-pick 0d5f9a324a958a481374669ab751127c17270840  # lxd/storage/drivers/driver/zfs/volumes: CreateVolumeFromCopy only set volume size from expanded config when source is image
      git cherry-pick 813a797f427121e219039aea2f1fc34f4381c030  # lxc/storage/drivers/driver/ceph/utils: Reworks parseParent to return a Volume struct
      git cherry-pick 71453ec8c58a8cf7e6317e770362e034d1089364  # lxd/storage/drivers/driver/ceph/utils: Adds tests for parseParent
      git cherry-pick a0b5406938fec12aa81148c7d7b37e52b3a38ea7  # lxd/storage/drivers/driver/ceph/utils: Adds cephVolumeTypeZombieImage constant
      git cherry-pick 5755802b5290b84606ea119122fa544913d6aaa4  # lxd/storage/drivers/driver/ceph/utils: Updates rbdCreateVolume to accept string size
      git cherry-pick d25bec8b4fc179048f98dc2ffd8d076dd7ec1647  # lxd/storage/drivers/driver/ceph/utils: Pass volume config in rbdMarkVolumeDeleted
      git cherry-pick 0b2e09873d28edfd7385434e751331d2ec51d628  # lxd/storage/drivers/driver/ceph/utils: Pass volume config in rbdRenameVolume
      git cherry-pick 26760bc9245ae479fcf6dcd912d6d5bc3bc0cc83  # lxd/storage/drivers/driver/ceph/utils: Replaces getRBDSize with volumeSize
      git cherry-pick 83b4105ba62b14a843c3585df771d2d7735f5a8c  # lxd/storage/drivers/driver/ceph/utils: Dont wrap lines
      git cherry-pick 094a858ee02c8a90eba98b4f52109cef1ef3c7b3  # lxd/storage/drivers/driver/ceph/utils: Updates usage of d.parseParent in deleteVolume
      git cherry-pick dd2148057c11136abf7a4dd0e3dadbdf76cef480  # lxd/storage/drivers/driver/ceph/utils: Updates RBD naming logic in getRBDVolumeName
      git cherry-pick e61c85c359aedfef5e2d2b57a98d8eb6578b3d6c  # lxd/storage/drivers/driver/ceph/volumes: Ensures CreateVolumeFromCopy correctly sizes new volume
      git cherry-pick 9c7f23b7f17b48629f64c2197325b785ec7d1c71  # lxd/storage/drivers/driver/ceph/volumes: If volume doesnt exist in DeleteVolume do nothing
      git cherry-pick 94ba5ce73d7fc621d6f2c8838f0b37587450c09b  # lxd/storage/drivers/driver/ceph/utils: Dont wrap lines
      git cherry-pick ff88d4f18c60348db4ff591a408b7d8ad630da5f  # lxd/db: Rename CertificatesGet to GetCertificates
      git cherry-pick cdfa8f3f3738a7c44b3498ef96d28460fa932dce  # lxd/db: Rename CertificateGet to GetCertificate
      git cherry-pick 27c1097010705d1724d3135433812ecf30d3242c  # lxd/db: Rename CertSave to CreateCertificate
      git cherry-pick 7a1842670c0aab0c0cca93b6ec5c364a539520c5  # lxd/db: Rename CertDelete to DeleteCertificate
      git cherry-pick 418ccb6b95d13ac846bfe428aefb01b7449cab37  # lxd/db: Rename CertUpdate to UpdateCertificate
      git cherry-pick 97c7d51626a9046e85fc4a8f5dac45643fb62f65  # lxd/db: Drop unused ConfigValueSet
      git cherry-pick d6e56f9327e97d85fa68d7ebd9c572de59fec5c3  # lxd/instances/post: Fix revert in createFromBackup
      git cherry-pick e92790bc480eedd3a8726da33f6e6d68e83851e7  # lxd/storage/drivers/volume: Adds allowUnsafeResize bool to Volume struct
      git cherry-pick eee1abaac859b552988f0577ddac13656b5790ee  # lxd/storage/backend/lxd: Adds cannot shrink error handling in CreateInstanceFromBackup
      git cherry-pick 50d79f98605fbfe33505c215ccb724e9eba05b93  # lxd/storage/drivers/generic/vfs: Sets block volume size to file size of volume in tarball in genericVFSBackupUnpack
      git cherry-pick e1e805880dbaaecd367fe8e876dae14a1984e79f  # lxd/storage/drivers/driver/btrfs/volumes: No need to move GPT header if no filler used in CreateVolume
      git cherry-pick a6d5a56c6e7c172ebb2439840c6ac13db0f34e65  # lxd/storage/drivers/driver/btrfs/volumes: Skip GPT header move in SetVolumeQuota when allowUnsafeResize is enabled
      git cherry-pick a1dd144e05899f98fb09d51a07da218bffa2c5d6  # lxd/storage/drivers/driver/dir/volumes: Skip GPT header move in SetVolumeQuota when allowUnsafeResize is enabled
      git cherry-pick 1744f91cb52d9ea1dc1b339d9ee29b1f97d5315d  # lxd/storage/drivers/driver/lvm/volumes: Allow unsafe shrinking when allowUnsafeResize is enabled
      git cherry-pick cedfc8b7646e994352d3c9b1f1929c94bd351960  # lxd/storage/drivers/driver/zfs/volumes: Allow unsafe shrinking when allowUnsafeResize is enabled
      git cherry-pick 19c7dadb6a04413307026a07d9f42a088a64a027  # lxd/storage/drivers/driver/ceph/volumes: Allow unsafe shrinking when allowUnsafeResize is enabled
      git cherry-pick afb9172f3af2b806a2bd5ed4951110fa885df4aa  # lxd/db: Rename InstanceNames to GetInstanceNames
      git cherry-pick 99125274126b335670e5cb55554427fada6433c6  # lxd/db: Rename ContainerNodeAddress to GetNodeAddressOfInstance
      git cherry-pick 81a83fdd13e68c4862f6926e07d4dab95c8b4c15  # lxd/db: Rename ContainersListByNodeAddress to GetInstanceNamesByNodeAddress
      git cherry-pick 31eeab8418c7a8611468110ba227370107964960  # lxd/db: Rename ContainersByNodeName to GetInstanceToNodeMap
      git cherry-pick 612f9712b0db9e0b1251011a5983260b28d0023a  # lxd/db: Rename ContainerNodeMove to UpdateInstanceNode
      git cherry-pick b36d3064ad6365e904afc7503c1b24cfbaf4c843  # lxd/db: Rename ContainerNodeProjectList to GetLocalInstancesInProject
      git cherry-pick b6025db0459dcd6ad933dd8c78995eea693bd03c  # lxd/db: Rename ContainerConfigInsert to CreateInstanceConfig
      git cherry-pick ab78f59ee65358ce7c41280794ffcfdccee6b5c3  # lxd/db: Rename ContainerConfigUpdate to UpdateInstanceConfig
      git cherry-pick 676bb32f99e81b8c7a0c91193c66f982924bcc46  # lxd/db: Rename InstanceRemove to RemoveInstance
      git cherry-pick 386d7704d3260189e95a62aebf0ae850dc43c9ca  # lxd/db: Rename ContainerProjectAndName to GetInstanceProjectAndName
      git cherry-pick 70412decda9d41e2b1d01f52f447acd492734903  # lxd/db: Rename ContainerConfigClear to DeleteInstanceConfig
      git cherry-pick 8c04295d8c2599003dee6f0a52b7e072389e3ea1  # lxd/db: Rename ContainerConfigGet to GetInstanceConfig
      git cherry-pick d58aab6e44e7e34c5e7f0351b0d38225f6addc2f  # lxd/db: Rename ContainerConfigRemove to DeleteInstanceConfigKey
      git cherry-pick 1a01b07b4f49c5f24d19be49c00f5de4d1632270  # lxd/db: Rename ContainerSetStateful to UpdateInstanceStatefulFlag
      git cherry-pick ac04592170fb79c55b1db04e2f496821fee106de  # lxd/db: Rename ContainerProfilesInsert to AddProfilesToInstance
      git cherry-pick a9807280f9f4d86b70a615f9d42a59f8eaeaf8e7  # lxd/db: Drop unused ContainerProfiles
      git cherry-pick e6055551c8845a2d50aa90327ae0ababcd6e4a55  # lxd/db: Drop unused ContainerConfig
      git cherry-pick 64cbd2619a5ef624ebb655f8d971be9829c04427  # lxd/db: Remove unused ContainersNodeList
      git cherry-pick 06cdc378ba9fd40e0a82f3f7fcf355985a06d7af  # lxd/db: Rename ContainersResetState to ResetInstancesPowerState
      git cherry-pick 26c4f8b11be08e8fddd36b99aae28adf89f440c3  # lxd/db: Rename ContainerSetState to UpdateInstancePowerState
      git cherry-pick 93ee2f3e6606c3ca1f6f5b83ed1a2487ae974a39  # lxd/db: Rename ContainerUpdate to UpdateInstance
      git cherry-pick 4c0e6b31e6a308bca4557517cf8a79a2f5d24298  # lxd/db: Rename InstanceSnapshotCreationUpdate to UpdateInstanceSnapshotCreationDate
      git cherry-pick bf68759d3602878bce7b3690d7f4e07714fb49ff  # lxd/db: Rename ContainerLastUsedUpdate to UpdateInstanceLastUsedDate
      git cherry-pick 0e234b997795ce560f084a9dd4096ec4a9685274  # lxd/db: Rename ContainerGetSnapshots to GetInstanceSnapshotsNames
      git cherry-pick 31dc9e244a11db0b1d1974a3a7edc0e3186d799b  # lxd/db: Rename ContainerNextSnapshot to GetNextInstanceSnapshotIndex
      git cherry-pick 6d9f6c377ff9b066878296cdddc83692c0c9ef61  # lxd/db: Rename InstancePool to GetInstancePool
      git cherry-pick fff7f6b7788bfe77dcf46deacb3287be9a7ebbe0  # lxd/db: Rename ContainerBackupID to getInstanceBackupID
      git cherry-pick dd4706117adee09129a546c615c34ea3094310de  # Rename ContainerGetBackup to GetInstanceBackup
      git cherry-pick 9fa3b01f22477b3f8335dd46e9dcf9046feecf21  # lxd/db: Rename InstanceCreateBackup to CreateInstanceBackup
      git cherry-pick fdb6b57e97b6f37eec7ef50dabbb3fed229c4423  # lxd/db: Rename InstanceBackupRemove to DeleteInstanceBackup
      git cherry-pick bc906acd9cb6ef730a8864a7931c7cede118810b  # lxd/db: ContainerBackupRename to RenameInstanceBackup
      git cherry-pick a272ee7c075a631d5a48c5c828e21e7035275f4e  # lxd/db: Rename ContainerBackupsGetExpired to GetExpiredInstanceBackups
      git cherry-pick 85184bd7050b70ed0022635d7c2aee90a1828b50  # lxd/storage/drivers/utils: Updates roundVolumeBlockFileSizeBytes and ensureVolumeBlockFile to take size as bytes
      git cherry-pick ed02d2b7298d59813922cb4b27650a4eb279dc5a  # lxd/storage/drivers/generic/vfs: Updates genericVFSResizeBlockFile to accept size as bytes
      git cherry-pick 2f2a62d923136d2fd720055e4cef13d5e774258b  # lxd/storage/drivers/driver/btrfs/utils: Adds volumeSize function
      git cherry-pick 173e7a0225ab1dcaeadcd3f199a1dca6f7870adc  # lxd/storage/drivers/driver/btrfs/volumes: Updates CreateVolume to use volumeSize()
      git cherry-pick 2e3c5a23b4ed3124b8ba529b65bea0a707feb919  # lxd/storage/drivers/driver/btrfs/volumes: Updates SetVolumeQuota to be byte oriented internally
      git cherry-pick 0093df46cf44d1a6ebaf0904b1cfa5f3c174ef4d  # lxd/storage/drivers/driver/ceph/utils: Updates volumeSize comment for consistency
      git cherry-pick 93357cd7225bccfd85e3f90753901f4e9a907c56  # lxd/storage/drivers/driver/ceph/volumes: Updates CreateVolumeFromCopy to use volumeSize()
      git cherry-pick 5092b76d49178dcac5b2cc14000ffa961f439d51  # lxd/storage/drivers/driver/ceph/volumes: Updates SetVolumeQuota to be byte oriented internally
      git cherry-pick 1a7887ec52592477c48c6eefedaa44671d52fef9  # lxd/storage/drivers/driver/dir/utils: Adds volumeSize function
      git cherry-pick da6bc47fc0039621bffc01c43aa419dfebe7250e  # lxd/storage/drivers/driver/dir/volumes: Updates CreateVolume to use volumeSize
      git cherry-pick b14165a3b5beca1aa7b2d65b28fe33ee292105bd  # lxd/storage/drivers/driver/dir/volumes: Updates SetVolumeQuota to be byte oriented internally
      git cherry-pick f9c06471aa4ce7e0149a1053af48e9cf77ea61c7  # lxd/storage/drivers/driver/lvm/utils: Updates copyThinpoolVolume to use volumeSize()
      git cherry-pick 3158c186620b3ce8417821a8a8b8b48f1c58e979  # lxd/storage/drivers/driver/lvm/volumes: Updates SetVolumeQuota variables and comments
      git cherry-pick 5c074fdb7a92471902b7027a51ac4866b11d290b  # lxd/storage/drivers/driver/zfs/utils: Adds volumeSize function
      git cherry-pick 9899586adad1b27c5d98de49e94524dcba6f9fd2  # lxd/storage/drivers/driver/zfs/volumes: Updates CreateVolume to use volumeSize()
      git cherry-pick 089ced64214211c4d3e0069ed218ea5d41978570  # lxd/storage/drivers/driver/zfs/volumes: Updates CreateVolumeFromCopy to use volumeSize()
      git cherry-pick 4a8dd0008ad762d3d1b4829471ea8b996ef7b427  # lxd/storage/drivers/driver/zfs/volumes: Updates SetVolumeQuota to be byte oriented internally
      git cherry-pick 02fff5f11c52b162e5add3f78f972b6bc4d0cf7d  # lxd/db: Rename DevicesAdd to AddDevicesToEntity
      git cherry-pick 2d854bd21eb30a24885dc2e3252b4817190941d8  # lxd/storage/backend/lxd: Detect cached image filesystem changes for VM images too
      git cherry-pick e6f4abcaf8704c9a02c4a8285f7916cb2c2ce0c7  # lxd/db: Remove unused Devices
      git cherry-pick 5ca738f3df65d697dcba37dfdda6cf84d9da3c2c  # lxd/db: Rename ImagesGetLocal to GetLocalImages
      git cherry-pick c205e8d28848a1a47acda29ef694188829b6b49f  # lxd/db: Rename ImagesGet to GetImages
      git cherry-pick 006cec454574f881e5d6fb50736fb7afee504aaf  # lxd/db: Rename ImagesGetExpired to GetExpiredImages
      git cherry-pick 9433020dc3bc47f5f8e1074ec74b5f651511c2a9  # lxd/db: Rename ImageSourceInsert to CreateImageSource
      git cherry-pick 630266b241b2b0c37e5004f9b6f616f2e6aa2b6d  # lxd/db: Rename ImageSourceGet to GetImageSource
      git cherry-pick 072fb7b9c41880dd2e06e615b23af4a9f1e13462  # lxd/db: Rename ImageGetFromAnyProject to GetImageFromAnyProject
      git cherry-pick e536b8d6ff3ae7e46188aeda98f9910ea9cc2b8f  # lxd/db: Rename ImageLocate to LocateImage
      git cherry-pick bd78e0587667c17e204ead1356ff095b751f0497  # lxd/db: Rename ImageDelete to DeleteImage
      git cherry-pick 97b32f828b30074d04ff1703c69d25e12280db6d  # lxd/db: Rename ImageAliasesGet GetImageAliases
      git cherry-pick 8d03d1e521e588dcae76d10ac5e0133d2f4abb4a  # lxd/db: Rename ImageAliasGet to GetImageAlaias
      git cherry-pick 23aa5bab8e1280ed1ff83f5d7920e2e39c71853a  # lxd/db: Rename ImageAliasRename to RenameImageAlias
      git cherry-pick c1cbf7e064219ccaaf8f934edce2b0c08048fc5f  # lxd/db: Rename ImageAliasDelete to DeleteImageAlias
      git cherry-pick 19ac7af2fb2c5acdd113f86b500a5da85f485adf  # lxd/db: Rename ImageAliasesMove to MoveImageAlias
      git cherry-pick dba67de2ea722f476fe20516653264b8a12271df  # lxd/db: Rename ImageAliasAdd to CreateImageAlias
      git cherry-pick f50947061640cbaf650de57acc939360c4e1f7ca  # lxd/db: Rename ImageAliasUpdate to UpdateImageAlias
      git cherry-pick af59967ef8ee1cfeb94e44a01243d1c005e11937  # lxd/db: Rename ImageCopyDefaultProfiles to CopyDefaultImageProfiles
      git cherry-pick 06f8038e67663931941ff7d68b7d7d88d6aed342  # lxd/db: Rename ImageLastAccessUpdate to UpdateImageLastUseDate
      git cherry-pick 86cefde06c49bbee7a383a8be6fc2d2352a86aeb  # lxd/db: Rename ImageLastAccessInit to InitImageLastUseDate
      git cherry-pick 87f4261f752f38b67b1758cf7d58ff07f6b322bc  # lxd/db: Rename ImageUpdate to UpdateImage
      git cherry-pick ca633a1a22bcd6237bc37a99e3e0ab673649d673  # lxd/db: Rename ImageInsert to CreateImage
      git cherry-pick 546fce76dfe3725072f7c26b9b39e24da249d966  # lxd/db: Rename ImageGetPools to GetPoolsWithImage
      git cherry-pick 0fcdf9a1a833504c951e0c0151456ac69ffa6f28  # lxd/db: Rename ImageGetPoolNamesFromIDs to GetPoolNamesFromIDs
      git cherry-pick d6a41915201f42a91904d7ce373798881504c053  # lxd/db: Rename ImageUploadedAt to UpdateImageUploadDate
      git cherry-pick 7ca2beb84c7fac245d54ccde42583fd6b9a93120  # lxd/db: Rename ImagesGetOnCurrentNode to GetImagesOnLocalNode
      git cherry-pick a06b6c1989fbf6a994e8a5d72cd2b97d740f887e  # lxd/db: Rename ImagesGetByNodeID to GetImagesOnNode
      git cherry-pick dd72ad1f519243e39fd72307a55d87b2defef43d  # lxd/db: Replace ImageGetNodesWithImage with GetNodesWithImage
      git cherry-pick c7d29c6866cee3a72e2f3ea2a9fa7125fac589af  # lxd/db: Rename ImageGetNodesWithoutImage to GetNodesWithoutImage
      git cherry-pick 8d00c8ba9ac543aaf9d79aab8c2194570b36ea88  # lxc/image: Actually refresh multiple images
      git cherry-pick 2628132ea2c536ad1bbdd5e9a349c54a9122c29c  # lxd/resources: Use permanent MAC when available
      git cherry-pick 19b3ac1df13a49e7d14318157cf8d68a5ea65df5  # lxd/qemu: Restrict NUMA layout to x86_64
      git cherry-pick 9ade049f6e2eab90b896b8bc3b142ebfafc484e0  # Consider all nodes when looking for the leader, not only voters
      git cherry-pick a585ab72234de81b432e74bc7ec57bff4d930882  # Only attempt to transfer leadership if we are not standalone
      git cherry-pick f99103978ba416cb7e24225d21c654ed6cf3e234  # lxd/db: Rename NetworksNodeConfig to GetNetworksLocalConfig
      git cherry-pick c80e52d4ec81bc7d51f66483db9ba8e91eaab4d4  # lxd/db: Rename NetworkIDsNotPending to GetNonPendingNetworkIDs
      git cherry-pick 3274b3c2d1f113ac69111658b3deedeb08b80d04  # lxd/db: Rename NetworkID to GetNetworkID
      git cherry-pick 6176be5b331cb74fcc2b88596fb282906940423e  # lxd/db: Rename NetworkConfigAdd to CreateNetworkConfig
      git cherry-pick e38269844af4b3af46774ad73bdefa14f8312eec  # lxd/db: Rename Networks to GetNetworks
      git cherry-pick 1c2cb74f2ff21294bd9638ce02449b2bd68f7b90  # lxd/db: Rename NetworksNotPending to GetNonPendingNetworks
      git cherry-pick c140027c7010a0a5f439c33915bed8137eee0512  # lxd/db: Rename NetworksNotPending to GetNonNetworks
      git cherry-pick 3213d8bf6863381d41c2d00769a1b036d9d43c53  # lxd/db: Rename NetworkGetInterface to GetNetworkWithInterface
      git cherry-pick 5a33a6331f24a6a85d86fd5d1e4f1f6bb84a1c01  # lxd/db: Rename NetworkConfig to getNetworkConfig
      git cherry-pick bc462a5d898496cd4fe3596a725eb66f024e45bc  # lxd/db: Rename NetworkCreate to CreateNetwork
      git cherry-pick 87bcda10cb23dcfe496d8819cee75eb167e87ed9  # lxd/db: Rename NetworkUpdate to UpdateNetwork
      git cherry-pick d80958c242303f836b7720a815ef9ff6db0c2be7  # lxd/db: Rename NetworkConfigClear to clearNetworkConfig
      git cherry-pick 4eb0f964dc69346884f074805e9c491d86044897  # lxd/db: Rename NetworkDelete to DeleteNetwork
      git cherry-pick 13776f1ac048299395e3acd7bc9ee3d35a33eeb5  # lxd/db: Rename NetworkRename to RenameNetwork
      git cherry-pick 7305407b6b7949bc9f7f095c87b12a9f0549ddbc  # lxd/db: Rename NetworkNodeConfigKeys to NodeSpecificNetworkNodeConfig
      git cherry-pick aeba82796b4d1f5c05bed48c9ed4c45524ad2124  # lxd/db: Rename ImageGet to GetImage
      git cherry-pick 4842c532e0cf07bc25617dc5fa8a64e5c705bdbe  # lxd/db: Rename ImageAssociateNode to AddImageToLocalNode
      git cherry-pick eacaa4c12c62c644c9fe5044e7cefc6562198495  # lxd/daemon: Detect nodev and improve errors
      git cherry-pick eb1461291cec267fce1950a2672f1d5e10f9e472  # lxd/db: Rename NodeByAddress to GetNodeByAddress
      git cherry-pick 673bbb2b7f61781c1ebef041324cb8da62115476  # lxd/db: Rename NodePendingByAddress to GetPendingNodeByAddress
      git cherry-pick c26e4297fc722ed70e6fc8a870b50309cc485ae3  # lxd/db: Rename NodeByName to GetNodeByName
      git cherry-pick 1c0618e7406b46b02683927811bb65759669a140  # lxd/db: Rename NodeName to GetLocalNodeName
      git cherry-pick 082ac40c88388b19e272aa5949b8a0d29ee9b2a6  # lxd/db: Rename NodeAddress to GetLocalNodeAddress
      git cherry-pick 5c831d3d77efe1a06d364176bad0319294ed0fc8  # lxd/db: Rename Nodes to GetNodes
      git cherry-pick 94a0ec4671e6ab3450d81523834fe9134e031c7e  # lxd/db: Rename NodesCount to GetNodesCount
      git cherry-pick 8756ab609ba06abf62ec4e18496f57eadc37c2b0  # lxd/db: Rename NodeRename to RenameNode
      git cherry-pick 77d1087a83c1c77b40532e6ee08c9ba45de4f8f6  # lxd/db: Rename NodeAdd to CreateNode
      git cherry-pick 9004af5d182ef553092df4841bee573a0982379f  # lxd/db: Rename NodeAddWithArch to CreateNodeWithArch
      git cherry-pick 213e430488c6503a30c5f10a7063583c06c1d5ad  # lxd/db: Rename NodePending to SetNodePendingFlag
      git cherry-pick ae5bce006c8e11cfef16051fe88dbe662607f12f  # lxd/db: Rename NodeUpdate to UpdateNode
      git cherry-pick 5871c17ab325a0fb9a0c1d22e5aae4ac1a4f0fcc  # lxd/db: Rename NodeAddRole to CreateNodeRole
      git cherry-pick ebd6abc3c0efa267b8dec3ab66636dd777b78be9  # lxd/db: Rename NodeRemoveRole to RemoveNodeRole
      git cherry-pick 79c952b500df51f4bfbfb5a8db5674efed46c344  # lxd/db: Rename NodeUpdateRoles to UpdateNodeRoles
      git cherry-pick dfdf87c1aa527f9a4e747da378eed82ff9339658  # lxd/db: Rename NodeRemove to RemoveNode
      git cherry-pick c16432ecb87559059f1419641441a6a984074ddd  # lxd/db: Rename NodeHeartbeat to SetNodeHeartbeat
      git cherry-pick bc1b9e5921fa2ab160387c47e2c4613119c12037  # lxd/db: Rename NodeOfflineThreshold to GetNodeOfflineThreshold
      git cherry-pick 3c4752134a02ee270054e5f37f847aea015e1c13  # lxd/db: Rename NodeClear to ClearNode
      git cherry-pick 427ac9ecd7709122a05c46f836fa420260f07248  # lxd/db: Rename NodeWithLeastContainers to GetNodeWithLeastInstances
      git cherry-pick 7771150929da15f9462d26ae33ccf82efd51b1bb  # lxd/db: Rename NodeUpdateVersion to SetNodeVersion
      git cherry-pick d6e4a5f2018819ea2c5db9f93b5db5cfdda5cfa1  # lxd/db: Rename Operations to GetLocalOperations
      git cherry-pick aac55c05ee7414e32d0b3feaf36dea0cc2e845d2  # lxd/db: Rename OperationsUUIDs to GetLocalOperationsUUIDs
      git cherry-pick f2ae1acc3e54442ab46eb0c37d9d876e9d392634  # lxd/db: Rename OperationNodes to GetNodesWithRunningOperations
      git cherry-pick b4d4108ca770923cfdb4a5fc29880d07908f2353  # lxd/db: Rename OperationByUUID to GetOperationByUUID
      git cherry-pick a4a4c8a705a568b7d2b188b9ca32e393d270fd12  # lxd/db: Rename OperationAdd to CreateOperation
      git cherry-pick 005c2715191262fd5ce0d08a9eb115a9263a7ded  # lxd/db: Rename OperationRemove to RemoveOperation
      git cherry-pick e669128cd057f51dadbeced7781d9e4873f24003  # lxd/db: Rename OperationFlush to removeNodeOperations
      git cherry-pick 97448ef145a3ee3221fc936e445443c11d290ecf  # lxd/db: Rename Patches to GetAppliedPatches
      git cherry-pick e8cf703b0743caa1af584bd32f718fcf44905357  # lxd/db: Rename PatchesMarkApplied to MarkPatchAsApplied
      git cherry-pick 4a8e810d8ee0f3a66a7b0e58238bfba33dd80936  # lxd/db: Rename Profiles to GetProfileNames
      git cherry-pick 1bc900e36b0cda90c1e78ccff2fd38b98e64f19e  # lxd/db: Rename ProfileGet to GetProfile
      git cherry-pick 28e5d258ff9207608c17e694521ee55fa495445e  # lxd/db: Rename ProfilesGet to GetProfiles
      git cherry-pick 88dd2da55a8de6f167fb9cd0670994219934a6cb  # lxd/db: Drop ProfileConfig
      git cherry-pick 2c3e9c2ab0f85a985d8ccb973096f5e46de27960  # lxd/db: Rename ProfileDescriptionUpdate to UpdateProfileDescription
      git cherry-pick 8b349148b2e0ed155c3e76d44e44432a5f1754bf  # lxd/db: Rename ProfileConfigClear to ClearProfileConfig
      git cherry-pick d474a27600b33c05f19f4452b1bb64f896f1c0d5  # lxd/db: Rename ProfileConfigAdd to CreateProfileConfig
      git cherry-pick 57044959e7c4d17ce000a9e8ed19972d6a60bd77  # lxd/db: Rename ProfileContainersGet to GetInstancesWithProfile
      git cherry-pick f58545ac039c8cca4fb7b1a267a5d96105693277  # lxd/db: Rename ProfileCleanupLeftover to RemoveUnreferencedProfiles
      git cherry-pick 94a68627ac27e15b25fc1a91f3ae3e59a853e5ec  # lxd/db: Rename ProfilesExpandConfig to ExpandInstanceConfig
      git cherry-pick 016d7ca2abcc58179d8697e96d382fa5231afa2f  # lxd/db: Rename ProfilesExpandDevices to ExpandInstanceDevices
      git cherry-pick 6ce8cc2ca34e8d1f254617acc983b47a85cc1946  # lxd/storage/drivers/generic/vfs: Dont require access to block device when excluding root image file from rsync in genericVFSMigrateVolume
      git cherry-pick c95e911885ae8fd15e4f5f7367ad61a5b1d918cb  # lxd/storage/drivers/driver/zfs/volumes: Updates MigrateVolume to avoid need to premount snapshot volume
      git cherry-pick 7e93628d0bad6058b9dbc7691e75120bbb8d0956  # test/suites/storage/volume/attach: Adds test for custom volume root perm persistence
      git cherry-pick 98e5c60726fd73af133b4d2587ca3071f9deea91  # lxd/storage/drivers: Fixes custom volume root mount perm issue for BTRFS and DIR
      git cherry-pick d5aa593094ffe15afcaad3f3a3bde5071ddbe647  # lxc/storage/drivers/volume: Removes keepDevice from Volume
      git cherry-pick a5d3bd681c77b33ca0a8969092c81c5ef41871c3  # lxd/storage/drivers/driver/ceph/volumes: Removes keepDevice usage
      git cherry-pick ed24e047b63f986bb203be89870567d69d2a96ea  # lxc/storage/drivers/driver/ceph/volumes: Mount changes
      git cherry-pick 916bda3a5bf2e17d9da0ab7e056947268690f381  # lxd/storage/drivers/driver/ceph/volumes: UnmountVolume modifications
      git cherry-pick dd5f9de1c1c8691e1baf935f8affebc82ae57dd6  # lxd/storage/drivers/driver/ceph/volumes: Esnure permission on volume root set in CreateVolume
      git cherry-pick 7a54a07eb008306556a567ce0fc03ab318fcc4e8  # lxd/resources: Skip NVME multipath entries
      git cherry-pick ad78db8ed794ac8979a473a568bd1ce96a202bd6  # lxd/db: Rename ProjectNames to GetProjectNames
      git cherry-pick a30111ef2e6b406bae264af17677ed924f99177c  # lxd/db: Rename ProjectMap to GetProjectIDsToNames
      git cherry-pick 6c6f3021b06df966e75cfa96a4e69c58fc719cbd  # lxd/db: Rename ProjectUpdate to UpdateProject
      git cherry-pick d3bee615f3b9d2119b9009a4baa02bd48c7c2c21  # lxd/db: Rename ProjectLaunchWithoutImages to InitProjectWithoutImages
      git cherry-pick e58648802173ca0c6a2600cd2d6da0207521b0b2  # lxd/db: Rename RaftNodes to GetRaftNodes
      git cherry-pick 1c6c0810437f4b570fa2b1bd00d92bb19c7369b9  # lxd/db: Rename RaftNodeAddresses to GetRaftNodeAddresses
      git cherry-pick 0d6389e7b8d5053f2ab198841b0020c5350c0ca5  # lxd/db: Rename RaftNodeAddress to GetRaftNodeAddress
      git cherry-pick 68fdc9c19df111ed3d9ca6dd93c05a51c17157d5  # lxd/db: Rename RaftNodeFirst to CreateFirstRaftNode
      git cherry-pick 852b2d9e20a279d96689b23154f1fae15dbc138f  # lxd/db: Rename RaftNodeAdd to CreateRaftNode
      git cherry-pick 3649175b7c5715bffedc070dd5bc0fe879d322f2  # lxd/db: Rename RaftNodeDelete to RemoveRaftNode
      git cherry-pick 18768e0711ed82a8403ebaa780e489329d71178f  # lxd/db: Rename RaftNodesReplace to ReplaceRaftNodes
      git cherry-pick 8d06c007f41066e5709f2970ee64605eabd15611  # lxd/db: Rename InstanceSnapshotConfigUpdate to UpdateInstanceSnapshotConfig
      git cherry-pick 69f33e9aee68944e10aa2d30f9d1683cbb4cedd9  # lxd/db: Rename InstanceSnapshotID to GetInstanceSnapshotID
      git cherry-pick a6f24ee1d724e1114ca18690cddaf248a7bbddc1  # lxd/db: Rename StoragePoolsNodeConfig to GetStoragePoolsLocalConfig
      git cherry-pick dbcece0ff6264f31bf245e0dae449eb6c420ee62  # lxd/db: Rename StoragePoolID to GetStoragePoolID
      git cherry-pick 52ad5bf4aaf774316932ffd268cace3917d20d0f  # lxd/db: Rename StoragePoolDriver to GetStoragePoolDriver
      git cherry-pick d3be8c83b8ce0380f107d3793c4b9053e011a2e8  # lxd/db: Rename StoragePoolIDsNotPending to GetNonPendingStoragePoolsNamesToIDs
      git cherry-pick 019b9e8d9c0b2c3750f472eb98ab859ef3f7e602  # lxd/db: Rename StoragePoolNodeJoin to UpdateStoragePoolAfterNodeJoin
      git cherry-pick 2b406424c4acffe733b1f24e4a114db00874dc13  # lxd/db: Rename StoragePoolConfigAdd to CreateStoragePoolConfig
      git cherry-pick f74ec9a8f9ef88973ae2532ef84017a22671fe3b  # lxd/db: Rename StoragePoolNodeConfigs to GetStoragePoolNodeConfigs
      git cherry-pick fa0ff5c0c8e392d784ba5259f22b09ce17d1aab4  # lxd/db: Rename StoragePools to GetStoragePoolNames
      git cherry-pick 4b8c393ad51fc923ebe46e4bd4d185409797b10c  # lxd/db: Rename StoragePoolsNotPending to GetNonPendingStoragePoolNames
      git cherry-pick 7ae7dc6dc648626c7c52c89ff29d2b67cf698371  # lxd/db: Rename StoragePoolsGetDrivers to GetStoragePoolDrivers
      git cherry-pick 36567ec07f13e1f37e9e9ccd678d03947a3f66e3  # lxd/db: Rename StoragePoolGetID to GetStoragePoolID
      git cherry-pick a1434a32d04dfaf55feb30bc716775a1079f4578  # lxd/db: Rename StoragePoolGet to GetStoragePool
      git cherry-pick ddfccad5540409ca1d470968aeb6ff5c1ae49753  # lxd/db: Rename StoragePoolConfigGet to getStoragePoolConfig
      git cherry-pick 511e8c1a039bdff1fd7a90f3e633e51a5bdf7e9f  # lxd/db: Rename StoragePoolCreate to CreateStoragePool
      git cherry-pick fdf77ad30ddfb0ba2d901095c5186679b8321a62  # lxd/db: Rename StoragePoolUpdate to UpdateStoragePool
      git cherry-pick 27877ca5b079e2d8d1573cd0ab103b7c8b9baa5a  # lxd/db: Rename StoragePoolConfigClear to clearStoragePoolConfig
      git cherry-pick a9b5bf7b5d90fb7bb5221af64972509e69085370  # lxd/db: Rename StoragePoolDelete to RemoveStoragePool
      git cherry-pick ef75245c32c0f91c74141bf2dd63fa0e2ee4ef58  # lxd/db: Rename StoragePoolVolumesGetNames to GetStoragePoolVolumesNames
      git cherry-pick 2a7fa91f40b7f5595e50319ef728f42018fa5683  # lxd/db: Rename StoragePoolVolumesGetAllByType to GetStoragePoolVolumesWithType
      git cherry-pick 36f9cd3fa64af6db167ed3073e46c3eaf59bfba6  # lxd/db: Rename StoragePoolVolumesGet to GetStoragePoolVolumes
      git cherry-pick 9a0277068adaa6258e15b4f4ece60af5a3d48db4  # lxd/db: Rename StoragePoolNodeVolumesGet to GetLocalStoragePoolVolumes
      git cherry-pick 90c6e4f48a1d6af3b8ffc7d3cd912e2b26855514  # lxd/db: Rename StoragePoolVolumeSnapshotsGetType to GetLocalStoragePoolVolumeSnapshotsWithType
      git cherry-pick b8ccdbc2f836d4063b7c7b6f64f8b080a1d17751  # lxd/db: Rename StoragePoolNodeVolumesGetType to GetLocalStoragePoolVolumesWithType
      git cherry-pick b3fa34d24e1011a202580c61e70efa8e747a711b  # lxd/db: Rename StoragePoolNodeVolumeGetTypeByProject to GetLocalStoragePoolVolume
      git cherry-pick fda3445616182601b15f51d4e4eb56c5ea2c1e58  # lxd/db: Rename StoragePoolVolumeUpdateByProject to UpdateStoragePoolVolume
      git cherry-pick d85eb2d9d94fcd37332855cec168a4ae4fdb0258  # lxd/db: Rename StoragePoolVolumeDelete to RemoveStoragePoolVolume
      git cherry-pick cc9ce7dd14ddbc75f73c40d39f09f0d3cc69195e  # lxd/db: Rename StoragePoolVolumeRename to RenameStoragePoolVolume
      git cherry-pick 74d71610f27ce46c65bf438402bf79bb98eb2d32  # lxd/db: Rename StoragePoolVolumeCreate to CreateStoragePoolVolume
      git cherry-pick 197bc5ba8a9a9ffe33eae18d2509b15c412fc07d  # lxd/db: Rename StoragePoolNodeVolumeGetTypeIDByProject to GetStoragePoolNodeVolumeID
      git cherry-pick 45737c89f896ea50bab92ac9a72d0df3e3666e9c  # lxd/db: Rename StoragePoolInsertZfsDriver to FillMissingStoragePoolDriver
      git cherry-pick 64673338d338f88f015ac41c94c50dcf2aec35ee  # lxd/storage/zfs: Use TryUnmount
      git cherry-pick 8b487333cd414ebdfc2e359707ca101c44360771  # ethtool: add ethtoolGset() helper
      git cherry-pick ef649866fa9fae02776b02171e9afef9dc1435a0  # Support two-phase creation of a storage pool on single-node cluster
      git cherry-pick d781ff2771fbe7331b6e56c332c5ca92b0202b52  # lxd/storage/drivers/driver/btrfs/utils: Adds setSubvolumeReadonlyProperty function
      git cherry-pick a22e324d5246ee5e45fe0060a6876be69a29ef94  # lxd/storag/drivers/driver/btrfs/volumes: Removes readonly argument from snapshotSubvolume
      git cherry-pick e09585308ddd5f35530602ec0a8622287180a281  # lxd/storage/drivers/driver/btrfs: d.setSubvolumeReadonlyProperty and d.snapshotSubvolume usage
      git cherry-pick 841a5b1e81b51f94213954d6acafb70d06891b09  # lxd/db: Rename StoragePoolVolumeGetType to GetStoragePoolVolume
      git cherry-pick aef32ccd67a0239d9a6979b174a65a1003489b2a  # lxd/db: Rename StoragePoolVolumeSnapshotCreate to CreateStorageVolumeSnapshot
      git cherry-pick 514e18bed513fbc6a615d1370cabe79bbefc9510  # lxd/db: Rename StoragePoolVolumeSnapshotUpdateByProject to UpdateStoragePoolVolumeSnapshot
      git cherry-pick 6f791fccf950b78f5e7ee5e6a8224106cbbca319  # lxd/db: Rename StorageVolumeSnapshotExpiryGet to GetStorageVolumeSnapshotExpiry
      git cherry-pick 823caa953f920ed38f15a97a9eb0fb3dcd6abb4d  # lxd/db: Rename StorageVolumeSnapshotsGetExpired to GetExpiredStorageVolumeSnapshots
      git cherry-pick 7ad732839bf2e5c8d2b0de7494ce8d7515dfcf7f  # resources/ethtool: implement ETHTOOL_GLINKSETTINGS
      git cherry-pick 88fafe88d8002a3b730526fc1404fc3bbe1fac7a  # lxd/storage/drivers/driver/btrfs/utils: Adds getSubvolumesMetaData function
      git cherry-pick 56291540e972be89054c0986cef096ea18105c91  # lxd/storage/drivers/driver/btrfs/volumes: Maintain subvolume readonly state in snapshot
      git cherry-pick 26ecd6668597649adbc18dd29af6f0ce1df3ca85  # lxd/storage/driversr/driver/btrfs/utils: Allow ro subvolumes to be deleted in deleteSubvolume
      git cherry-pick 1e89555148b5a77a90e20574093c619e1b635446  # lxd/storag/drivers/driver/btrfs/volumes: Updates MigrateVolume to send subvolumes
      git cherry-pick 4fb8206d2b330f600c6d39a4e0e7ade0d66819a9  # lxd/storage/drivers/driver/btrfs/volumes: Fail backup when cleanup fails in BackupVolume
      git cherry-pick 27362662e7efdc84d03b039aa20e02aad33cb912  # lxd/storage/drivers/driver/btrfs/volumes: Better naming of variables in unpackVolume
      git cherry-pick c8798bc3221a1de4e5ea1bd7a5d85719c5a7de27  # lxd/migration/migrate/proto: Adds BTRFS Features to offer header
      git cherry-pick 6a35d0aafbf35685e713bc9bf2dc26f21e699d9e  # lxd/migration/utils: Adds GetBtrfsFeaturesSlice function
      git cherry-pick e2a2824f7bd565160cd4d2a36d732c5a95e90534  # lxd/migration/migration/volumes: Adds BTRFS feature support to TypesToHeader
      git cherry-pick 8c716cb07d691ee286b3b1e7080bd93f97fc66d5  # lxd/migration/migration/volumes: Adds BTRFS feature support to MatchTypes
      git cherry-pick c3344c0de3b773a64f8d880c4facb7444f03493c  # lxd/storage/drivers/driver/btrfs: Adds BTRFS features to MigrationTypes
      git cherry-pick 654610c065ecd9b094e022c9774ad9c7ac2beae4  # lxd/storage/memorypipe: Dont make ioutil.ReadAll panic on cancel
      git cherry-pick ccd98296ffcac857de66cb44cd75ed4145adf177  # lxd/storage/drivers/driver/btrfs/utils: Kill btrfs send on error in sendSubvolume
      git cherry-pick e4f0b4ae6dd691362f092a98141d32af62006019  # lxd/storage/drivers/driver/btrfs/utils: Support subvolumes in receiveSubvolume
      git cherry-pick 2fe07939f48c8f9d6d750f1a52f283008f23f3c8  # lxd/storage/drivers/driver/btrfs/utils: Adds metadataHeader function
      git cherry-pick 459c25d0160935690c958c45a5780afc2df07cdf  # lxd/storage/drivers/driver/btrfs/volumes: Updates CreateVolumeFromMigration to receive subvolumes
      git cherry-pick e72b9c52010024d4fb33aa17d0852f47e1e118b4  # lxd/db: Rename StorageVolumeNodeAddresses to GetStorageVolumeNodeAddresses
      git cherry-pick 398dfdc1d3b98c3bc80913f43bd5b8b8a2881381  # lxd/db: Rename StorageVolumeDescriptionGet to GetStorageVolumeDescription
      git cherry-pick dce53695ccc9245e0a7ed26e39a2b71f677fa211  # lxd/db: Rename StorageVolumeNextSnapshot to GetNextStorageVolumeSnapshotIndex
      git cherry-pick dc6f6d346ff54ec2038282e2011d1948eda25b01  # lxd/db: Rename StorageVolumeCleanupImages to RemoveStorageVolumeImages
      git cherry-pick 40470677b7f2d613f65ef4e478b358bc78432df9  # lxd/db: Rename StorageVolumeMoveToLVMThinPoolNameKey to UpgradeStorageVolumConfigToLVMThinPoolNameKey
      git cherry-pick 0089e147759198852ca2f41e35c9df16a08cc8b3  # lxd/db: Update naming pattern for generated database code
      git cherry-pick 277dfbb639b804598f920bf6eb205d815809c8b2  # client/lxd_images: Fix backward compatibility
      git cherry-pick c723c6fc348d393cad2795afde385066fbd9eaa7  # lxd/storage/btrfs: Fix migration from snapshot
      git cherry-pick d52cc5110905d7259bca58d4aa83aa2adc8b3ad5  # shared/generate/db: Fix generation of Exists method
      git cherry-pick 9d34e90bd776594f9cac0bc39a41b76eabc8a416  # lxd/db: Make generated code stable across "make update-schema" runs
      git cherry-pick e891cc12dc4bf9c0424a586638d91e852d6e5387  # lxd/db: Leverage code-generation for certificates
      git cherry-pick 03ea36a0080dfbb49f20f2f87a3e0aa6b68c4f13  # shared: Rewrite OpenPty without cgo
      git cherry-pick 0150e8b46220f2b8b69803a4395433f819998fa1  # openpty: use O_CLOEXEC directly
      git cherry-pick 729bd8ef2148f677042c2c585867737a3b7d145d  # openpty: use fchown()
      git cherry-pick 5bf67a02296fd458c19be9562dc4ba6f1c4a8c8c  # openpty: first unlock the master, then get a slave fd
      git cherry-pick c7393244a3d15e25fd6bf585e1f4bc74aa8b0c95  # openpty: use TIOCGPTPEER if available
      git cherry-pick b6109aa632937bf6fbd4cda391384f7c7ad117d8  # lxd/storage/drivers/driver/lvm/utils: Adds lvmSnapshotSeparator constant and updates lvmFullVolumeName to use it
      git cherry-pick 7fdb1646acc95bff6909853ce3861fd50e20100f  # lxd/storage/drivers/driver/lvm/utils: Adds lvmEscapedHyphen and updates lvmFullVolumeName usage
      git cherry-pick 429929493b498939ed24b638f05a6556dba5676b  # lxd/storage/drivers/driver/lvm/utils: Adds parseLogicalVolumeSnapshot function
      git cherry-pick 900e2e78c2844b691db3fa6e38869b5c3c21b8df  # lxd/storage/drivers/driver/lvm/utils: Adds tests for parseLogicalVolumeSnapshot
      git cherry-pick 59535a4ede543fa9001246b643b1e17cf7b00727  # lxd/storage/drivers/driver/lvm/volumes: Updates VolumeSnapshots to use parseLogicalVolumeSnapshot
      git cherry-pick 6c4402317ff61231a30effa01248fa8bc1b55b90  # test: Adds tests for snapshot naming conflicts
      git cherry-pick 8589fb13ec889dcd0516e959adf0a6946ff58245  # lxd/firewall/drivers: Fix nft syntax
      git cherry-pick fbd444486e761449f2404d1a739baf4acea4b2d1  # lxc/project: Fix remote handling
      git cherry-pick 994fb65295c6c0c9474b0473b64efa5144f21514  # tests: Fix bad project switch call
      git cherry-pick 56fd8a3f19f0f58d953f6d5368cd966e51e8ea4f  # lxd/seccomp: Fix profile conflict between projects
      git cherry-pick b2a2dea6bc279110714ba6cae3b346c7713281be  # lxd/storage/drivers/driver/lvm/utils: Adds activateVolume and deactivateVolume functions
      git cherry-pick edafebb19761b0d02ebb486df5ef2dcbbe5b6c57  # lxd/storage/drivers/driver/lvm/utils: Set --setactivationskip on in createLogicalVolume
      git cherry-pick 2efc334c07c31cca21b3de9695fd1e115e4fe712  # lxd/storage/drivers/driver/lvm/utils: Set --setactivationskip on in createLogicalVolumeSnapshot
      git cherry-pick 9f558f192c6a4f87cff8f918976c2fb8156711fb  # lxd/storage/drivers/driver/lvm/utils: Activate volume in copyThinpoolVolume when regeneration FS UUID
      git cherry-pick f9531f5c1e5461d37ba7fb25ea1394fe8a180212  # lxd/storage/drivers/driver/lvm: Dont activate all volumes on pool mount
      git cherry-pick 57f6ce03895cb21d8320309bba35b3bc54e36491  # lxd/storage/drivers/driver/lvm/volumes: Activate volume before generic copy in CreateVolumeFromCopy
      git cherry-pick 6607fc014b9ffc6a5383324023b30e4a27f7e090  # lxd/storage/drivers/driver/lvm/volumes: Activate volume in SetVolumeQuota
      git cherry-pick 5fd85249976928cc5bcebb6cc611e04c1aa37c97  # lxd/storage/drivers/driver/lvm/volumes: Activate volume in MountVolume
      git cherry-pick 96baa85aba2c779b5dfefa626139a9c6afba461b  # lxd/storage/drivers/driver/lvm/volumes: Deactivate volume in UnmountVolume
      git cherry-pick 759b823424ab482f67adca72d4b955e20f731590  # lxd/storage/drivers/driver/lvm/volumes: Acticate volume before generic migrate in MigrateVolume
      git cherry-pick 9eccce0bde1567a6177298bc311a172915d2956f  # lxd/storage/drivers/driver/lvm/volumes: Activate volume in MountVolumeSnapshot
      git cherry-pick c9785396fc012d82e596c2200123070f7a727079  # lxd/storage/drivers/driver/lvm/volumes: Deactivate volume in UnmountVolumeSnapshot
      git cherry-pick 9b8ab8f6b6ae60856c9f8e1082af623ebca0c1b2  # lxd/storage/drivers/driver/lvm/volumes: Activate volume before FS UUID regen in RestoreVolume
      git cherry-pick 6d80d94702a17404d6f72d0be2025d593c07959a  # openpty: fix TIOCGPTPEER usage
      git cherry-pick 41b8ab87f338728706ed6bbd6a221630aad274c5  # Make network address bind error fatal when clustered
      git cherry-pick 6b0c296afc6b36429c2f859281b44052fb3ddaa1  # lxd/storage/drivers/driver/btrfs/utils: Renames metadatHeader to restorationHeader
      git cherry-pick 1f741421c5e80d82693e308761fac608996e65f1  # lxd/storage/drivers/driver/btrfs/volumes: d.restorationHeader usage
      git cherry-pick 175a91a1269d002d635c13791468f1f6ee564b43  # lxd/storage/drivers/driver/btrfs/volumes: Clarifies comments in MigrateVolume
      git cherry-pick 508f517560baa643e37703f28aad781d003cd802  # lxd/storage/drivers/driver/btrfs/volumes: Adds safety net against failed matching of subvolumes
      git cherry-pick 76ac4e98c07d01c77eaafbd2b53ed6689224c7d5  # lxd/storage/drivers/driver/btrfs/utils: Fix deleteSubvolume to support recursive delete with intermediate ro subvols
      git cherry-pick 1893442e198545da024e49b4ed217b7cb603b307  # lxd/storage/drivers/utils: Mark BTRFSSubVolumeMakeRo and BTRFSSubVolumeMakeRw deprecated
      git cherry-pick d65c91aff323e7f07ea0fe0d133dc3bd6f43129a  # lxd/storage/drivers/driver/btrfs/volumes: Updates RestoreVolume to restore subvolume ro property
      git cherry-pick 83f7eb10171ddf5f3e96daa7bf09ede50ff72ecc  # test: Adds BTRFS subvolume tests
      git cherry-pick 0d86d6bfc8106ef7c21e2f12a3bc412fed96845b  # lxd/storage/memorypipe: Fixes issue with partial reads losing data
      git cherry-pick a266b5e12f50ac73f8785fccad48a99298195243  # lxd/storage/drivers/driver/btrfs/volumes: Restores subvolumes ro property in CreateVolumeFromCopy
      git cherry-pick 185e451d1bfd44b35289585cbf6086ac8b0b79c1  # lxd/storage/drivers/driver/btrfs/utils: Adds marshal tags to BTRFSSubVolume and BTRFSMetaDataHeader
      git cherry-pick 22510f79f6d69dfa761c1c99487b7f67827d7065  # lxd/device/nic/bridged: Updates github.com/mdlayher/netx/eui64
      git cherry-pick 67ef19dc0b6a5451d5a7b778db0b1958204377a3  # fix IPVLAN docs
      git cherry-pick c566ce2ce63980a5068f2994b6a52a8c8c9ba96f  # lxd/cluster: Don't run a connection proxy when connecting with the Go dqlite client
      git cherry-pick d02ef4fc5ca5130b8af3c375c6c19bdd2dab9cd9  # lxd/cluster: Extract dqlite network proxy logic to standalone function and support cancellation
      git cherry-pick 2cee08c798299d7715808f717a7800eb478de61f  # lxd/cluster: Use dqliteProxy in raftDial
      git cherry-pick 1c3d66645bcbe5146d3e52d6f039472cf392e8c6  # lxd/cluster: Use ReadClose() to gracefully stop the dqlite proxy

      # Download any new dependencies
      export GOPATH=$(realpath ../go)
      go get -t -d ./...

      # Setup for our shared libraries
      sed -i "/\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/canonical/go-dqlite/internal/bindings/server.go
      sed -i "/^\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/mattn/go-sqlite3/sqlite3.go

      # Run the standard build
      set +ex
      snapcraftctl build
      set -ex

      # Build the agent (special build tags)
      go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd-agent" -tags=agent github.com/lxc/lxd/lxd-agent

      # Setup bash completion
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/
      echo 'export PATH="${PATH}:/snap/bin:/var/lib/snapd/snap/bin"' > ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
      cat scripts/bash/lxd-client >> ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/share/misc/: share/misc/
      var/lib/usbutils/usb.ids: share/misc/
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/dnsmasq
      - bin/getfattr
      - bin/setfattr
      - bin/iw
      - bin/pigz
      - bin/rsync
      - bin/setfacl
      - bin/sgdisk
      - bin/unsquashfs
      - bin/xdelta3

      - etc/bash_completion.d/snap.lxd.lxc

      - share/misc

      - bin/lxc
      - bin/lxc-to-lxd
      - bin/lxd
      - bin/lxd-agent
      - bin/lxd-benchmark

  lxd-migrate:
    source: lxd-migrate/
    after:
      - lxd
      - sqlite
    plugin: go
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd-pkg-snap/lxd-migrate
    override-build: |
      set -ex

      # Setup for our shared libraries
      sed -i "/^\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/mattn/go-sqlite3/sqlite3.go

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p ${SNAPCRAFT_PART_INSTALL}/bin/
      cp scripts/upgrade-bridge ${SNAPCRAFT_PART_INSTALL}/bin/upgrade-bridge
    prime:
      - bin/lxd-migrate
      - bin/upgrade-bridge

  shmounts:
    source: shmounts/
    plugin: make
    prime:
      - bin/setup-shmounts

  snap-query:
    source: snap-query/
    plugin: go
    go-importpath: github.com/lxc/lxd-pkg-snap/snap-query
    prime:
      - bin/snap-query

  strip:
    source: snapcraft/empty
    after:
      - btrfs
      - ceph
      - dqlite
      - libco
      - libseccomp
      - logrotate
      - lvm
      - nano
      - nvidia-container
      - openvswitch
      - raft
      - sqlite
      - squashfs-tools-ng
      - vim
      - xfs
      - xtables
      - xz
      - zfs-0-6
      - zfs-0-7
      - zfs-0-8
      - lxc
      - lxcfs
      - criu
      - lxd
      - lxd-migrate
      - shmounts
      - snap-query
    plugin: nil
    override-prime: |
      set -x

      # Strip some of the heavy bits
      strip -s ${SNAPCRAFT_PRIME}/bin/lxc
      strip -s ${SNAPCRAFT_PRIME}/bin/lxd*
      strip -s ${SNAPCRAFT_PRIME}/bin/snap*
      strip -s ${SNAPCRAFT_PRIME}/lib/liblxc*
      strip -s ${SNAPCRAFT_PRIME}/lib/libdqlite*
      strip -s ${SNAPCRAFT_PRIME}/lib/libsqlite*

      for zfs in zfs-0.6 zfs-0.7 zfs-0.8; do
          [ ! -d "${SNAPCRAFT_PRIME}/${zfs}" ] && continue
          strip -s ${SNAPCRAFT_PRIME}/${zfs}/bin/* ${SNAPCRAFT_PRIME}/${zfs}/lib/*
      done

      [ -e "${SNAPCRAFT_PRIME}/criu/criu" ] && strip -s ${SNAPCRAFT_PRIME}/criu/criu

      exit 0

  wrappers:
    plugin: dump
    source: snapcraft/
    organize:
      hooks/: snap/hooks/
