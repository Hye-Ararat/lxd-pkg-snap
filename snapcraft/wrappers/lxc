#!/bin/sh
set -eu

# Re-exec outside of apparmor confinement
if [ -d /sys/kernel/security/apparmor ] && [ "$(cat /proc/self/attr/current)" != "unconfined" ]; then
    exec aa-exec -p unconfined -- "$0" "$@"
fi

if [ -z "${LXD_HOSTFS:-""}" ]; then
    # Re-exec in the host namespace
    if chroot /var/lib/snapd/hostfs true >/dev/null 2>&1; then
        PWD=$(pwd)
        if [ "${PWD}" = "/var/lib/snapd/void" ]; then
            PWD="$(readlink -f "/proc/${PPID}/cwd")"
        fi

        export LXD_HOSTFS="${PWD}"
        exec chroot /var/lib/snapd/hostfs "$0" "$@"
    fi
else
    # Move to the expected directory
    cd "${LXD_HOSTFS}"
    unset LXD_HOSTFS
fi

# Set the environment
export LXD_DIR=${SNAP_COMMON}/lxd/
export EDITOR=vim.tiny
export VISUAL=${EDITOR}
export VIMINIT="source ${SNAP}/etc/vimrc"

# Run lxc itself
exec "${SNAP}/bin/lxc" "$@"
