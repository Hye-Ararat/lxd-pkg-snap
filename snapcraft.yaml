name: lxd
base: core20
assumes:
  - snapd2.39
version: "4.19"
grade: stable
summary: LXD - container and VM manager
description: |-
 LXD is a system container and virtual machine manager.

 It offers a simple CLI and REST API to manage local or remote instances,
 uses an image based workflow and support for a variety of advanced features.

 Images are available for all Ubuntu releases and architectures as well
 as for a wide number of other Linux distributions. Existing
 integrations with many deployment and operation tools, makes it work
 just like a public cloud, except everything is under your control.

 LXD containers are lightweight, secure by default and a great
 alternative to virtual machines when running Linux on Linux.

 LXD virtual machines are modern and secure, using UEFI and secure-boot
 by default and a great choice when a different kernel or operating
 system is needed.

 With clustering, up to 50 LXD servers can be easily joined and managed
 together with the same tools and APIs and without needing any external
 dependencies.


 Supported configuration options for the snap (snap set lxd [<key>=<value>...]):

   - ceph.builtin: Use snap-specific Ceph configuration [default=false]
   - ceph.external: Use the system's ceph tools (ignores ceph.builtin) [default=false]
   - criu.enable: Enable experimental live-migration support [default=false]
   - daemon.debug: Increase logging to debug level [default=false]
   - daemon.group: Set group of users that can interact with LXD [default=lxd]
   - daemon.preseed: Pass a YAML configuration to `lxd init` on initial start
   - daemon.syslog: Send LXD log events to syslog [default=false]
   - lvm.external: Use the system's LVM tools [default=false]
   - lxcfs.pidfd: Start per-container process tracking [default=false]
   - lxcfs.loadavg: Start tracking per-container load average [default=false]
   - lxcfs.cfs: Consider CPU shares for CPU usage [default=false]
   - openvswitch.builtin: Run a snap-specific OVS daemon [default=false]
   - shiftfs.enable: Enable shiftfs support [default=auto]

 For system-wide configuration of the CLI, place your configuration in
 /var/snap/lxd/common/global-conf/ (config.yml and servercerts)

confinement: strict

apps:
  # Main commands
  activate:
    command: commands/daemon.activate
    daemon: oneshot
    plugs:
      - lxd-support
      - system-observe

  daemon:
    command: commands/daemon.start
    reload-command: commands/daemon.reload
    stop-command: commands/daemon.stop
    stop-timeout: 600s
    restart-condition: on-failure
    daemon: simple
    slots:
      - lxd
    plugs:
      - lxd-support
      - network-bind
      - system-observe
    sockets:
      unix:
        listen-stream: $SNAP_COMMON/lxd/unix.socket
        socket-mode: 0660

  lxc:
    command: commands/lxc
    completer: etc/bash_completion.d/snap.lxd.lxc
    plugs:
      - lxd-support
      - system-observe

  lxd:
    command: commands/lxd
    plugs:
      - lxd-support
      - system-observe

  # Sub-commands
  benchmark:
    command: commands/lxd-benchmark
    plugs:
      - lxd-support
      - system-observe
  buginfo:
    command: commands/buginfo
    plugs:
      - lxd-support
      - system-observe
  check-kernel:
    command: commands/lxd-check-kernel
    plugs:
      - lxd-support
      - system-observe
  lxc-to-lxd:
    command: commands/lxc-to-lxd
    plugs:
      - lxd-support
      - system-observe
  migrate:
    command: commands/lxd-migrate
    plugs:
      - lxd-support
      - system-observe

hooks:
  configure:
    plugs:
      - network
      - system-observe
  remove:
    plugs:
      - lxd-support
      - system-observe

parts:
  # Dependencies
  btrfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - btrfs-progs
    organize:
      sbin/: bin/
    prime:
      - bin/btrfs
      - bin/btrfstune
      - bin/mkfs.btrfs

  ceph:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ceph-common
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/ceph
      - bin/rbd
      - lib/*/ceph
      - lib/*/libatomic.so*
      - lib/*/libboost_iostreams.so*
      - lib/*/libboost_program_options.so*
      - lib/*/libboost_thread.so*
      - lib/*/libcephfs*
      - lib/*/libibverbs.so*
      - lib/*/librados.so*
      - lib/*/librbd.so*
      - lib/*/librdmacm.so*
      - lib/*/libsnappy.so*
      - lib/python3

  criu:
    source: https://github.com/checkpoint-restore/criu
    source-tag: v3.16.1
    source-type: git
    source-depth: 1
    plugin: nil
    build-packages:
      - asciidoc
      - libcap-dev
      - libnet1-dev
      - libnl-3-dev
      - libprotobuf-c-dev
      - libprotobuf-dev
      - protobuf-c-compiler
      - protobuf-compiler
      - xmlto
    stage-packages:
      - libnet1
      - libprotobuf-c1
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "armv7l" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      make
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/criu/"
      cp criu/criu "${SNAPCRAFT_PART_INSTALL}/criu/"
    organize:
      usr/lib/: lib/
    prime:
      - criu/*
      - lib/*/libnet*
      - lib/*/libproto*

  dqlite:
    after:
      - raft
      - sqlite
    source: https://github.com/canonical/dqlite
    source-type: git
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libdqlite*so*
      - lib/*/libuv*

  edk2:
    source: https://github.com/tianocore/edk2
    source-type: git
    source-tag: IRRELEVANT
    source-depth: 1
    plugin: nil
    build-packages:
      - on amd64:
        - acpica-tools
        - nasm
        - uuid-dev
      - on arm64:
        - acpica-tools
        - nasm
        - uuid-dev
    override-pull: |-
      set -ex
      git clone https://github.com/tianocore/edk2 . -b edk2-stable202108

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      # Fix submodules
      sed -i "s#https://git.cryptomilk.org/projects/cmocka#https://gitlab.com/cmocka/cmocka#g" .gitmodules
      git submodule update --init --recursive

      # Apply patches
      patch -p1 < "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0001-force-DUID-LLT.patch"
      cp "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0002-logo.bmp" MdeModulePkg/Logo/Logo.bmp
      patch -p1 < "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0003-boot-delay.patch"
      patch -p1 < "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0004-gcc-errors.patch"

      ARCH="X64"
      PKG="OvmfPkg/OvmfPkgX64.dsc"
      FV_CODE="OVMF_CODE"
      FV_VARS="OVMF_VARS"
      if [ "$(uname -m)" = "aarch64" ]; then
          ARCH="AARCH64"
          PKG="ArmVirtPkg/ArmVirtQemu.dsc"
          FV_CODE="QEMU_EFI"
          FV_VARS="QEMU_VARS"
      fi

      # Run in a bash sub-shell as edksetup.sh requires it
      set -ex
      (
      cat << EOF
          . ./edksetup.sh
          make -C BaseTools ARCH=${ARCH}
          build -a ${ARCH} -t GCC49 -b RELEASE -p ${PKG} \
            -DSECURE_BOOT_ENABLE=TRUE \
            -DNETWORK_IP4_ENABLE=TRUE \
            -DNETWORK_IP6_ENABLE=TRUE \
            -DNETWORK_TLS_ENABLE=TRUE \
            -DNETWORK_HTTP_BOOT_ENABLE=TRUE \
            -DFD_SIZE_2MB \
            -DTPM_ENABLE=TRUE \
            -DTPM_CONFIG_ENABLE=TRUE \
            -DTPM2_ENABLE=TRUE \
            -DTPM2_CONFIG_ENABLE=TRUE
      EOF
      ) | bash -e

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      cp Build/*/*/FV/${FV_CODE}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
      cp Build/*/*/FV/${FV_VARS}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"

      if [ "$(uname -m)" = "aarch64" ]; then
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"
      fi

    prime:
      - share/qemu/*

  libmnl:
    source: https://git.netfilter.org/libmnl
    source-type: git
    source-tag: libmnl-1.0.4
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    organize:
      usr/lib/: lib/
    prime:
      - lib/libmnl*so*

  libnftnl:
    after:
      - libmnl
    source: https://git.netfilter.org/libnftnl
    source-type: git
    source-tag: libnftnl-1.2.0
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    organize:
      usr/lib/: lib/
    prime:
      - lib/libnftnl*so*
    override-build: |
      snapcraftctl build

      sed -i "s# /lib/libmnl.la# ${SNAPCRAFT_STAGE}/lib/libmnl.la#g" "${SNAPCRAFT_PART_INSTALL}/lib/libnftnl.la"

  libseccomp:
    source: https://github.com/seccomp/libseccomp
    source-type: git
    source-tag: v2.5.2
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    build-packages:
      - gperf
    organize:
      usr/lib/: lib/
    prime:
      - lib/libseccomp*so*

  libtpms:
    source: https://github.com/stefanberger/libtpms
    source-type: git
    source-tag: v0.9.0
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
      - --with-tpm2
      - --with-openssl
    organize:
      usr/lib/: lib/
    prime:
      - lib/libtpms*so*

  libusb:
    source: https://github.com/libusb/libusb
    source-type: git
    source-tag: v1.0.24
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    organize:
      usr/lib/: lib/
    prime:
      - lib/libusb*so*

  logrotate:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - logrotate
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    stage:
      - bin/logrotate
    prime:
      - bin/logrotate

  lvm:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - dmeventd
      - lvm2
      - thin-provisioning-tools
    organize:
      sbin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/cache_*
      - bin/dmeventd
      - bin/era_*
      - bin/lv*
      - bin/pdata_tools
      - bin/pv*
      - bin/thin_*
      - bin/vg*
      - -bin/vgimportclone
      - -bin/lvmconf
      - -bin/lvmdump
      - -bin/lvmetad
      - -bin/lvmpolld
      - etc/lvm/lvm.conf
      - lib/*/device-mapper/*
      - lib/*/libaio.so*
      - lib/*/libdevmapper*
      - lib/*/liblvm*
      - lib/*/libreadline.so*

  nano:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - nano
    organize:
      usr/bin/: bin/
    prime:
      - bin/nano
      - etc/nanorc

  nftables:
    after:
      - libmnl
      - libnftnl
    source: https://git.netfilter.org/nftables
    source-type: git
    source-tag: v1.0.0
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
      - --with-json
    build-packages:
      - libjansson-dev
      - libreadline-dev
    stage-packages:
      - libjansson4
    organize:
      sbin/: bin/
      usr/lib/: lib/
    prime:
      - bin/nft
      - lib/*/libjansson*so*
      - lib/libnftables*so*

  nvidia-container:
    after:
      - libseccomp
    source: https://github.com/NVIDIA/libnvidia-container
    source-type: git
    source-tag: v1.5.1
    source-depth: 1
    plugin: make
    build-packages:
      - bmake
      - curl
      - lsb-release
    override-build: |-
      set -ex

      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/bin/"
      cp ${SNAPCRAFT_PROJECT_DIR}/snapcraft/wrappers/nvidia-container-cli "${SNAPCRAFT_PART_INSTALL}/bin/"

      set +ex
      snapcraftctl build
    organize:
      usr/local/bin/nvidia-container-cli: bin/nvidia-container-cli.real
      usr/local/lib: lib/
    prime:
      - bin/nvidia-container-cli*
      - lib/libnvidia-container.so*

  openvswitch:
    source: https://github.com/openvswitch/ovs
    source-type: git
    source-tag: v2.16.0
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    stage-packages:
      - uuid-runtime
    organize:
      sbin/: bin/
      usr/bin/: bin/
    prime:
      - bin/ovs-appctl
      - bin/ovs-vsctl
      - bin/ovs-vswitchd
      - bin/ovsdb-*
      - bin/uuidgen
      - share/openvswitch/

  ovn:
    after:
      - openvswitch
    source: https://github.com/ovn-org/ovn
    source-type: git
    source-tag: v21.06.0
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
      - --with-ovs-source=../../openvswitch/build/
    prime:
      - bin/ovn-nbctl

  spice-protocol:
    source: https://gitlab.freedesktop.org/spice/spice-protocol
    source-type: git
    source-tag: v0.14.3
    source-depth: 1
    plugin: meson
    prime: []

  spice-server:
    after:
      - spice-protocol
    source: https://gitlab.freedesktop.org/spice/spice
    source-type: git
    source-tag: v0.15.0
    source-depth: 1
    plugin: meson
    meson-parameters:
      - --prefix=/
      - -Dgstreamer=no
      - -Dmanual=false
      - -Dlz4=false
      - -Dsasl=false
      - -Dopus=disabled
      - -Dsmartcard=disabled
      - -Dtests=false
    build-packages:
      - libjpeg-turbo8-dev
      - python3-pyparsing
      - python3-six
    stage-packages:
      - libjpeg-turbo8
      - libpixman-1-0
    organize:
      sbin/: bin/
      usr/lib: lib/
      usr/local/lib/: lib/
    prime:
      - lib/*/libjpeg*so*
      - lib/*/libspice-server*so*
      - lib/*/libpixman*so*

  swtpm:
    after:
      - libseccomp
      - libtpms
    source: https://github.com/stefanberger/swtpm
    source-type: git
    source-tag: v0.6.1
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
      - --with-seccomp
      - --with-openssl
      - --without-cuse
    build-packages:
      - expect
      - gawk
      - iproute2
      - libjson-glib-dev
      - python3-cryptography
      - python3-setuptools
      - socat
    stage-packages:
      - libjson-glib-1.0-0
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      lib/swtpm/: lib/
    prime:
      - bin/swtpm
      - lib/libswtpm*so*
      - lib/*/libjson-glib-1.0.so*

  qemu:
    after:
      - libseccomp
      - libusb
      - spice-protocol
      - spice-server
    source: IRRELEVANT
    source-type: git
    source-tag: IRRELEVANT
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --disable-bochs
      - --disable-cloop
      - --disable-dmg
      - --disable-docs
      - --disable-guest-agent
      - --disable-parallels
      - --disable-qed
      - --disable-slirp
      - --disable-user
      - --disable-vdi
      - --disable-vnc
      - --disable-xen
      - --enable-attr
      - --enable-cap-ng
      - --enable-kvm
      - --enable-libusb
      - --enable-usb-redir
      - --enable-linux-aio
      - --enable-numa
      - --enable-pie
      - --enable-rbd
      - --enable-seccomp
      - --enable-spice
      - --enable-system
      - --enable-tcg
      - --enable-tools
      - --enable-vhost-crypto
      - --enable-vhost-kernel
      - --enable-vhost-net
      - --enable-vhost-scsi
      - --enable-vhost-user
      - --enable-vhost-vsock
      - --enable-virtfs
      - --firmwarepath=/snap/lxd/current/share/qemu/
      - --localstatedir=/var/
    build-packages:
      - bison
      - flex
      - pkg-config
      - libaio-dev
      - libcap-ng-dev
      - libglib2.0-dev
      - libnuma-dev
      - libpixman-1-dev
      - librbd-dev
      - libusbredirhost-dev
    stage-packages:
      - genisoimage
      - libmagic1
      - libnuma1
      - libpixman-1-0
      - libusbredirhost1
      - libusbredirparser1
    override-pull: |-
      set -ex
      git clone https://gitlab.com/qemu/qemu . -b v6.1.0
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && [ "$(uname -m)" != "ppc64le" ] && [ "$(uname -m)" != "s390x" ] && exit 0

      set -ex
      # Mangle the configure a bit
      QEMUARCH="$(uname -m)"
      [ "${QEMUARCH}" = "ppc64le" ] && QEMUARCH="ppc64"
      sed -i "s/^unset target_list$/target_list=\"${QEMUARCH}-softmmu\"/" configure
      sed -i 's#libseccomp_minver=".*#libseccomp_minver="0.0"#g' configure

      set +ex
      snapcraftctl build
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/local/bin/: bin/
      usr/local/lib/: lib/
      usr/local/libexec/: bin/
      usr/local/share/: share/
    prime:
      - bin/genisoimage*
      - bin/mkisofs*
      - bin/qemu-system-*
      - bin/qemu-img*
      - bin/virtfs-proxy-helper*
      - bin/virtiofsd*
      - lib/*/libatomic.so*
      - lib/*/libmagic*so*
      - lib/*/libnuma*so*
      - lib/*/libpixman*so*
      - lib/*/libusbredir*so*
      - share/qemu/keymaps*
      - share/qemu/efi-virtio.rom*
      - share/qemu/kvmvapic.bin*
      - share/qemu/s390-*.img*
      - share/qemu/slof.bin*
      - share/qemu/vgabios-*.bin*

  qemu-ovmf-secureboot:
    after:
      - edk2
      - qemu
    source: https://github.com/puiterwijk/qemu-ovmf-secureboot
    source-type: git
    source-depth: 1
    plugin: nil
    build-packages:
      - xorriso
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      export ARCH="$(basename $(readlink -f ${SNAPCRAFT_STAGE}/lib/*-linux-gnu*/))"
      export LD_LIBRARY_PATH="${SNAPCRAFT_STAGE}/lib:${SNAPCRAFT_STAGE}/lib/${ARCH}"

      set -ex
      rm -Rf iso-root vfat-root shell.iso
      mkdir -p iso-root vfat-root/efi/boot
      cp ../../edk2/build/Build/*/*/*/Shell.efi vfat-root/efi/boot/bootx64.efi
      cp ../../edk2/build/Build/*/*/*/EnrollDefaultKeys.efi vfat-root/
      "${SNAPCRAFT_STAGE}/bin/qemu-img" convert --image-opts driver=vvfat,floppy=on,fat-type=12,label=UEFI_SHELL,dir=vfat-root iso-root/shell.img
      xorriso --as mkisofs -input-charset ASCII -J -rational-rock -e shell.img -no-emul-boot -o shell.iso iso-root/

      # Basic aarch64 support
      if [ "$(uname -m)" = "aarch64" ]; then
          sed -i ovmf-vars-generator \
              -e "s/'-machine', machinetype,/'-machine', 'virt', '-cpu', 'cortex-a57',/" \
              -e "/charserial1/d" \
              -e "s/ide-cd/scsi-cd/" \
              -e "s/'-device',$/'-device', 'virtio-scsi-pci,id=scsi', '-device',/"
      elif [ "$(uname -m)" = "x86_64" ]; then
          cp -f "${SNAPCRAFT_STAGE}/share/qemu/kvmvapic.bin" .
      fi

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      python3 ovmf-vars-generator \
        --qemu-binary "${SNAPCRAFT_STAGE}/bin/qemu-system-$(uname -m)" \
        --print-output --disable-smm --skip-testing \
        --oem-string "$(cat ${SNAPCRAFT_PROJECT_DIR}/snapcraft/etc/ubuntu-sb.crt)" \
        --ovmf-binary "${SNAPCRAFT_STAGE}/share/qemu/OVMF_CODE.fd" \
        --ovmf-template-vars "${SNAPCRAFT_STAGE}/share/qemu/OVMF_VARS.fd" \
        --uefi-shell-iso shell.iso \
        "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.ms.fd"
    prime:
      - share/qemu/*

  raft:
    source: https://github.com/canonical/raft
    source-type: git
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    stage-packages:
      - libuv1
      - liblz4-1
    build-packages:
      - libuv1-dev
      - liblz4-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libraft*so*
      - lib/*/libuv.so*

  sqlite:
    source: https://github.com/sqlite/sqlite
    source-type: git
    source-depth: 1
    source-tag: version-3.36.0
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    build-packages:
      - tcl
    override-build: |-
      set -ex

      git log -1 --format=format:%ci%n | sed -e 's/ [-+].*$//;s/ /T/;s/^/D /' > manifest
      git log -1 --format=format:%H > manifest.uuid
      cp /usr/share/misc/config.guess .
      cp /usr/share/misc/config.sub .
      autoreconf -f -i

      set +ex
      snapcraftctl build
    prime:
      - bin/sqlite3
      - lib/libsqlite3*so*

  squashfs-tools-ng:
    source: https://github.com/AgentD/squashfs-tools-ng
    source-type: git
    source-tag: v1.1.3
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    build-packages:
      - liblzma-dev
    prime:
      - bin/sqfs2tar
      - bin/tar2sqfs
      - lib/libsquashfs.so*

  vim:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - vim-common
      - vim-tiny
    organize:
      usr/bin/: bin/
      usr/share/vim/vim*/debian.vim: etc/vimrc
    prime:
      - bin/vim.tiny
      - etc/vimrc

  xfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xfsprogs
    organize:
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/xfs_admin
      - bin/xfs_db
      - bin/xfs_growfs
      - bin/xfs_repair
      - bin/mkfs.xfs

  xtables:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - arptables
      - ebtables
    organize:
      usr/lib/ebtables/: lib/
      usr/sbin/: bin/
    prime:
      - bin/arptables-legacy
      - bin/ebtables-legacy
      - etc/ethertypes
      - etc/protocols
      - lib/libebtc.so.*

  xz:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xz-utils
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/lzma
      - bin/xz
      - lib/*/liblzma*so*
    override-build: |
      snapcraftctl build

      # Include the lzma symlink
      ln -s xz "${SNAPCRAFT_PART_INSTALL}/usr/bin/lzma"

  zfs-0-6:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.6.5.11
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=/
      - --with-config=user
    build-packages:
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick fb963d33ee0dd350143ba1c9cd35d5f7d86910d2  # Fix endian build problem on ppc64el

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-7:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.7.13
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=/
      - --with-config=user
    build-packages:
      - libblkid-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-8:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.8.6
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=/
      - --with-config=user
    build-packages:
      - libblkid-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-2-0:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-2.0.6
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=/
      - --with-config=user
    build-packages:
      - libblkid-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-2-1:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-2.1.1
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=/
      - --with-config=user
    build-packages:
      - libblkid-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-2.1/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-2.1/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-2.1/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-2.1/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-2.1/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-2.1/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"


  zstd:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - zstd
    organize:
      usr/bin/: bin/
    prime:
      - bin/pzstd
      - bin/zstd

  # Core components
  lxc:
    after:
      - libseccomp
    source: https://github.com/lxc/lxc
    source-type: git
    source-tag: lxc-4.0.11
    build-packages:
      - libapparmor-dev
      - libcap-dev
      - libgnutls28-dev
      - libselinux1-dev
      - pkg-config
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
      - --disable-api-docs
      - --disable-bash
      - --disable-doc
      - --disable-examples
      - --disable-memfd-rexec
      - --disable-tests
      - --disable-tools
      - --enable-apparmor
      - --enable-seccomp
      - --enable-selinux
      - --enable-capabilities
      - --with-rootfs-path=/var/snap/lxd/common/lxc/
      - --libexecdir=/snap/lxd/current/libexec/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/libexec: libexec
      share/lxc/hooks: lxc/hooks
    prime:
      - bin/lxc-checkconfig
      - lib/liblxc.so.1
      - lib/liblxc.so.1.*
      - lxc/config/common.conf.d
      - lxc/hooks/nvidia
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/
      ln -s /var/snap/lxd/common/lxc/local.conf $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/01-local.conf
      sed -i "s#includedir=.*#includedir=$SNAPCRAFT_PART_INSTALL/include#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc
      sed -i "s#libdir=.*#libdir=$SNAPCRAFT_PART_INSTALL/lib#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc

  lxcfs:
    source: https://github.com/lxc/lxcfs
    source-type: git
    source-tag: lxcfs-4.0.11
    build-packages:
      - libfuse-dev
      - libpam0g-dev
      - pkg-config
    stage-packages:
      - fuse
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
      - --datarootdir=/snap/lxd/current/
      - --localstatedir=/var/snap/lxd/common/var/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/lxcfs: lxcfs
      lib/lxcfs: lib
    prime:
      - bin/fusermount
      - lib/*/libfuse.so.*

      - bin/lxcfs
      - lib/liblxcfs.so

      - lxc
      - lxcfs
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      set +ex
      snapcraftctl build
      set -ex

      sed -i "s#\${LXC_ROOTFS_MOUNT}/var/snap/lxd/common/var/lib/lxcfs/#\${LXC_ROOTFS_MOUNT}/var/lib/lxcfs/#g" $SNAPCRAFT_PART_INSTALL/snap/lxd/current/lxcfs/lxc.mount.hook

  lxd:
    source: https://github.com/lxc/lxd
    source-type: git
    source-tag: lxd-4.19
    after:
      - lxc
      - dqlite
      - sqlite
    build-packages:
      - libacl1-dev
      - libudev-dev
      - pkg-config
    build-snaps:
      - go
    stage-packages:
      - acl
      - attr
      - dnsmasq-base
      - gdisk
      - iw
      - netbase
      - pciutils
      - pigz
      - rsync
      - squashfs-tools
      - usbutils
      - xdelta3
    plugin: nil
    override-build: |
      set -ex

      # Git cherry-picks
      cd ../src
      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick 69fcd148ea22ff9ba50ad9321f1df1c244eb8360  # lxd/certificates: remove explicit calls to UpdateCertificateProjects
      git cherry-pick 7f23433471e97e82242bb10ce9341dfa8d8582c2  # lxd/db/certificates: remove Cluster.UpdateCertificateProjects
      git cherry-pick 54ec4bd7e96b9196a36d9f0bf907b072e17a2ac7  # lxd/db/generate/db/method: fill entity id association tables on create/update
      git cherry-pick 12a2d5bebf6b3d68cb43489129b80c7d7e41a56a  # lxd/db/certificates.mapper: update generated code
      git cherry-pick ba6be1043714458b29c4b37687d4f624ee421943  # lxd/checkfeature: check whether the kernel supports core scheduling
      git cherry-pick b019c9e6ca4e8f6f362138ed98665eb278c2eb7a  # lxd/daemon: Fix crash on lxd start when another lxd already running
      git cherry-pick 30dab2aae3590a7e4ea1620ba0353a60db1b3aa7  # lxd/daemon: Don't fail shutdown if fail to close cluster DB
      git cherry-pick 913bd4dfcff04cbca3947782d75317e5b32c3b25  # lxd/daemon: Don't use Infof and Errorf
      git cherry-pick 9cd3895702548f48849495b436956d2a6bbeef3d  # lxd/metrics: Change ProcsTotal to gauge
      git cherry-pick 1ac47b83982ee3267fcee7e7ad70b71889135db8  # lxd/instance/drivers: Log metrics failures
      git cherry-pick 30b510aa6fa7202328f9836cb9d86aeb1e6bbaa6  # lxd-agent: Log metrics failures
      git cherry-pick 51cea9f3a0b7228831c6a497cca6b805abe1986f  # lxd/instance/operationalock: Change lock from using instance ID to use project and instace name
      git cherry-pick 15032a67950a219658ce87d345ba4b8b1bb6d350  # lxd/instance/operationalock: Use %q for error quoting
      git cherry-pick b63b501dc4c82ff1a51654e33d0ef39e58f14fa8  # lxd/instance/operationlock: Get lock after checking for non-nil operation
      git cherry-pick 4d704e2fb7c9149d0da7b29826eee440a1153fec  # lxd/instance/drivers/driver/common: operationlock usage
      git cherry-pick 84b7a8c969a22d477d68dd939dd1b3d841ddeb36  # lxd/instance/drivers/driver/lxc: operationlock usage
      git cherry-pick 627cf5822ca63e8204acd28eca13c84b91cb6685  # lxd/instance/drivers/driver/qemu: operationlock usage
      git cherry-pick a8e5fee1271b204afd12bd54c4d2b9f17a1ca043  # lxd/instance/instance/utils: operationlock usage
      git cherry-pick 8d71e2dcc25184e739c938e44b1cedc35e88a7dc  # lxd-agent: Drop aggregated cpu stats in metrics
      git cherry-pick fbb0fee5c35f7519b00b2946b7ec0d5d88f30530  # test: Kill LXD process if doesn't start in time
      git cherry-pick 2df26a25b7861fd9750689a5cab4bfd852c912a0  # lxd/main/shutdown: Fix shutdown regression when running in snap
      git cherry-pick f8ee085dc7deb8fb88e2b60fb4cbcb414272ec8d  # lxc: suggest 20.04 as the first container to launch instead of 18.04
      git cherry-pick d8e06cb3ae9cd52ab59720c2ed4791b73ca84a66  # lxc: switch from 18.04 to 20.04 for examples of Ubuntu instances
      git cherry-pick aa76a9c4b53677730067b39d01089ac23a4b8784  # i18n: Update translation templates
      git cherry-pick 460c882fd5d08387bb8b5f1e872678f9c8bc9bcb  # lxc: update wording when a cert is successfully trusted by a remote
      git cherry-pick 116e09eec300a5e9474df7a6e79cf180a482e828  # i18n: Update translation templates
      git cherry-pick 309be10a6c923a4a9c9ed39d52cf452a16ec8606  # lxd/backup/backup/config: Adds ToInstanceDBArgs function
      git cherry-pick a56a3ecdd8b6b0987b766982ecb4997966c07cdc  # lxd/instance/instance/utils: Adds LoadFromBackup function
      git cherry-pick 31d58ac74ad6853cdd83088408f7362b278016eb  # lxd/project/project: Update comment of InstanceParts
      git cherry-pick b44e4af8eb7b0b4661bb783bf85ca421df6bc9b6  # lxd/instances: Reworks instancesOnDisk to return slice of instance.Instance
      git cherry-pick 6ed60144dd3e051a9e99fb43aeac8885e878bfe8  # lxd/instances: Updates instancesShutdown to use instancesOnDisk
      git cherry-pick ca4de7b61c8146292cd479fb4f6e377138222d74  # lxd/patches: Updates patchUpdateFromV11 and patchUpdateFromV15 to use instancesOnDisk
      git cherry-pick a3081ba75148d30d646e84546fc2e525dc03a6bb  # lxd/api/internal: Use backupConf.ToInstanceDBArgs in internalImportFromBackup
      git cherry-pick ff6a9f6d12dd5ad4817f4b310cffbe4c6c21127c  # lxd/api/internal/recover: Updates internalRecoverImportInstance to use backupConf.ToInstanceDBArgs
      git cherry-pick a12c8209d429060861133bf49e5798b52c47b16a  # lxd/instances: Don't clear last power state of all instances in a cluster in instancesShutdown
      git cherry-pick 0926dadb6012f34607b97fe5dc8b44b5c9ff8bb0  # lxd/db/instances: Removes ResetInstancesPowerState function
      git cherry-pick 5093e44cabea3ddec1c17ff0ee1213c3d2792e93  # lxd/instances: Move shutdown timeout logic into per-instance go routine in instancesShutdown
      git cherry-pick ee42d57b98e4d5ac2d5d9133da46bbae90a32172  # lxd/instances: Reworks instancesShutdown to handle and log shutdown failures by forcefully stopping
      git cherry-pick 731af380c978831fa57c4cf350ec7148bf687d47  # lxd/instances: Updates instancesShutdown to accept a slice of instances
      git cherry-pick 03832e7125d2afdbbbeb3c1fbbb2e126243413cd  # lxd/instances: Renames containerAutostartList to instanceAutostartList
      git cherry-pick 1980fc4d619872aaa905d1fac46612b5de864310  # lxd/instances: Renames instancesRestart to instancesStart
      git cherry-pick 6bf0136deb841dd056a976b167142e8601894088  # lxd/daemon: Updates init to use instancesStop and instancesStart with preloaded container list
      git cherry-pick ca33599990a7fde967d6dd610e1124f5b7c765ce  # lxd/daemon: Updates Ready to use updated instancesStart
      git cherry-pick 8afb9001d2b0c8bf2505806728c1415371ff56b5  # lxd/daemon: Updates Stop to load instances once
      git cherry-pick 9626109f6e1779388b1185605c98441dc53e4c4d  # lxd/daemon: Updates numRunningInstances to accept a list of instances to check
      git cherry-pick bd27b5c7e6ae2d9dcec3f36ecc0685d733111aea  # shared/osarch/architectures: Use ARCH_UNKNOWN rather than 0 in ArchitectureId
      git cherry-pick 18b482069ca131b0501e43f35a8e077d7b018bbd  # lxd/db/instances: Removes UpdateInstancePowerState function
      git cherry-pick 6eaf0acd23ecaa7736fac89fad1a3e1e5bf64167  # lxd/instance/drivers/driver/common: Adds recordLastState function
      git cherry-pick c06445557296a5a8460ece32660fd3fe86df4922  # lxd/instance/drivers: Use d.VolatileSet in onStop hook to record last power state
      git cherry-pick c004986a4b06ee3a1dac87f906a225dad3b5f135  # lxd/instance/drivers: d.recordLastState usage
      git cherry-pick 2c1d95205fcd073dde3a73903f31a5c62ea3acad  # lxd/instances/drivers: Call d.UpdateBackupFile just before starting instance process
      git cherry-pick 057e4812f17ef745d15bda1367f626fda06d3e82  # lxd/daemon: Close global database after query failure in Stop
      git cherry-pick 588751a413d70abb8b407f6166d5f27ea2418108  # lxd/daemon: Use consistent terminology of global rather than remote database in Stop
      git cherry-pick d3f4a55f3eeedee5805741f754b35dc1418adc3e  # lxd/api/internal: Update internalContainerHookLoadFromReference to try and load instance from backup if DB not available
      git cherry-pick c8f42cad3ddf243b72cddea0377ae42d367cbbcb  # lxd/instance/drivers/driver/qemu: Update getMonitorEventHandler to try and load instance from backup if DB not available
      git cherry-pick 8cd833fdec4f2f30d2854dc05ad4177d4a0498f0  # lxd/storage/drivers/driver/zfs/volumes: Log dev path in UnmountVolume
      git cherry-pick d57ae4d6724a44935ebc8197994426b2625ba90d  # lxd/migration: Update protobuf config
      git cherry-pick 4efd15cf6a98bc4f59a55cc3bab4ef4f0a536c0a  # lxd/migration: Update generated protobuf
      git cherry-pick 06e95e64ec201933ff37ff34fdf8343ef5cff4c9  # gomod: Update dependencies
      git cherry-pick 80637669b64b6d77d5279db0b46202757dd438b0  # doc/network: Avoid referring to releases by name
      git cherry-pick 935ee20b951e067c61360fef5d706dae17603652  # lxd/apparmor: Allow remount using noatime
      git cherry-pick e7a661c98592be86cc9bb7f4a1dd4b7a9fb8a353  # lxd/apparmor: remove mount options alternations
      git cherry-pick 892743d200adbb3c7907ed2582abd7da9e75315d  # lxd/apparmor: remove another mount options alternations
      git cherry-pick 41f86fc0a3d0b8ec0b04c6f9c5c882d6c032871b  # lxd/apparmor: remove spaces between mount options for consistency
      git cherry-pick d54197f09e0f0308c073f9ca57627ad09f8a5f56  # lxd/apparmor: remove duplicated mount rules (ro,remount,bind)
      git cherry-pick c8bebb840ad7a6d51e6824a880048391cdfd17ae  # lxd/api/cluster: Fail on no leader in internalClusterPostHandover
      git cherry-pick a1a0f7ec667be66b833af90ffec0c83a87a1bf10  # lxd/instance: Fix image download race condition in instanceCreateFromImage
      git cherry-pick 92e2eeb156679097dcf46f03e66ff8b99f1e74e5  # lxd/networks: Report uplink networks in leases
      git cherry-pick f3ba51e153ac08b3774db0f2613aff14c6b59912  # lxd/api/cluster: Fail on no leader in handoverMemberRole
      git cherry-pick 597c42b089ee8df18acb615ea0ef61274a1a23fe  # lxd/cluster/gateway: Log partial and initial heartbeat as info
      git cherry-pick 675bd8b81effb8364056c400e0c293414fa382f8  # test: Adds better logging and removes handover sleeps in test_clustering_handover
      git cherry-pick ab419140d1b10a1d4e37d7b5c0d24d197de5d975  # lxd/cluster/heartbeat: No need to log heartbeat restart
      git cherry-pick 46e0183d4871b941f05db6bc60f66e427f3c9533  # test: Don't use pid files in test_clustering_shutdown_nodes
      git cherry-pick f3e88a67c8e1068e04fa5e4ba5330941b0829542  # test: Actually ensure cluster DB isn't reachable after its lost quorum in test_clustering_shutdown_nodes
      git cherry-pick 25ae2761dfdac856f5828f5444938813b1daa413  # test: Use timeouts in kill_lxd
      git cherry-pick 9517ebc0084daa35f0b6e2249a1af0606aefc253  # lxd/storage/drivers/driver/zfs/volumes: Use normal mount rather than zfs mount
      git cherry-pick 477ab8d4c2bb0b2b8442ce3050b168710869ca29  # tests: Unify how the instance's PID is looked up
      git cherry-pick 322df3a62384ee80664e4c141ce1d0eb9679bd4c  # tests: add missing --force-local to `lxc stop`
      git cherry-pick 3f2b4710707c9ca94acd66cc4efac84ee718bac2  # tests: use CSV format and column filtering where applicable
      git cherry-pick 89d66c7a4781b9a06d026acd4cb67ea1db3fa103  # tests: use CSV format and column filtering to find the name of the newly created instance
      git cherry-pick 3263c37317ec5dd20dbe5ead571d8ec7386c8bf7  # tests: use grep -F when the match pattern contains regex/wildcard
      git cherry-pick 69630e56307c2026ad41b4d90b71646dfa1fa3ae  # tests: replace `grep | cut` by awk
      git cherry-pick a14fbab886134f5a052909a9d2c75da43127b8f1  # lxd/instance/operationlock: Adds TimeoutSeconds constant
      git cherry-pick f4fc4a749c07af6b110444aa6371d9c8d6ba6ee7  # lxd/instance/drivers/driver/common: Error quoting in onStopOperationSetup
      git cherry-pick a7ab8831229d63ebad35f1a6c02a81eae5649b4b  # lxd/instance/drivers/driver/qemu: Updates onStop to be more like lxc driver
      git cherry-pick f6c148e55b3ee690baa3a79f76f3714b4f9fff5e  # test/suites: Always provide project arg in volume test
      git cherry-pick e367aef1a724b2bdcf750fb846af366d7bc49441  # lxd/sys/os: reorder kernel features
      git cherry-pick 3e232c54cc9cf2a9bf9e1aa099c7b790bab5fbc9  # os: add separate entries for pure core scheduling kernel feature and container support
      git cherry-pick 9b3ebef85d4c5d13bbbc0f12f80492eb0ed16960  # lxd: support core scheduling for virtual machines
      git cherry-pick 0ba1adc54d8c7e3131874f909cdbc4cead5011b9  # test/suites: Fix cephfs backup test
      git cherry-pick fc28c1026b5332b9ed581ce0f53c825547d847e1  # lxd/instance/drivers/driver/qemu: Improve comments in Shutdown
      git cherry-pick fc2ccea8a5549ea162a46dc8b0064be9d68e0e8a  # lxd/instance/operationlock: Add ErrNonReusuableSucceeded error and Action type and action constants
      git cherry-pick 10a4d82b60dad1e243c13ef42f92f1ee0559dd08  # lxd/instance/operationlock: Reworks Create to use Action type
      git cherry-pick 0fcf52b98628723f9fac8b738da2128f1b027ac2  # lxd/instance/operationlock: Reworks CreateWaitGet
      git cherry-pick 2e91ac6d7f8670c2035332d6477a8212fae935de  # lxd/instance/drivers/driver/common: operationlock.Action usage
      git cherry-pick 4bb0d0df56a4374e9d701894b568d7e870490a41  # lxd/instance/drivers/driver/lxc: operationlock.CreateWaitGet and operationlock.Create usage
      git cherry-pick e9cce699ca859094bc21d5ed7db4505266f905e0  # lxd/instance/drivers/driver/qemu: operationlock.CreateWaitGet and operationlock.Create usage
      git cherry-pick c157cd908a496d3ee18e3df8ded191d2f05b4282  # lxd/instance/drivers/driver/qemu: Add comment in Stop about operation lock
      git cherry-pick 6133da2d8e9d75bf9f15d2e9e45770d43fa40c63  # lxd/instance/drivers/driver/qemu: Keep operation alive in Shutdown
      git cherry-pick 4283fef53f68085564484e8c8fcb08769d80a020  # lxd/instance/drivers/driver/lxc: Keep operation alive in Shutdown
      git cherry-pick 3ba27654ea493fa0f6595e74753568658c5a7c21  # lxd/network: Move Leases to network package
      git cherry-pick 7ca2b76e01a04787c2c5f308dea830937957dc20  # lxd: support core scheduling for container even without LXC library support
      git cherry-pick fc2f88f7773da610f589a92e8fd61fc4811c462a  # lxd/instance/lxc: Properly report mapped memory
      git cherry-pick db19256a3ab01992719104c2c5bbfcc287d74dc8  # lxd/daemon: Updates NodeRefreshTask to accept an isLeader and unavailableMembers argument
      git cherry-pick 6312c38fe40f1b864b9060df17dec3a9d764e088  # lxd/api/cluster: Improves logging in internalClusterPostHandover
      git cherry-pick 51121de5e84fff8f95e08109e2b40488a684164c  # lxd/cluster/gateway: Adds shutdownCtx to NewGateway and return 503 in heartbeat if shutting down
      git cherry-pick 557f42a3243e4e648fd6e3c6c9d113cbb5cdbccb  # lxd/storage/drivers/driver/zfs/volumes: Set mountpoint=none for filesystem volumes
      git cherry-pick 50f9a123d8397ab44f7d74ec2e4be95746a73358  # lxd/storage/drivers/driver/zfs/patches: Update patches to set mountpoint=none
      git cherry-pick 59fd1cf3a729228f4e09807edf95658848c9163f  # lxd/cluster/gateway: Adds HeartbeatHook type
      git cherry-pick 831d995c0211135a6005f3ae94e7779f865ab422  # lxd/cluster/gateway: Reject heartbeat if shutting down
      git cherry-pick 9461225a46ef91c60366dc67cd3108693d643910  # lxd/cluster/gateway: Rework HandlerFuncs heartbeat handling
      git cherry-pick f2b3a25bdf3f153bc9bd8adaf23a80cc6a4b110c  # lxd/cluster/heartbeat: Update heartbeatRestart to return bool if heartbeat restarted
      git cherry-pick 58cc813dcfa7549a2cec51cb8b48d8eb66088091  # lxd/cluster/heartbeat: Pass non-updated heartbeat members as unavailable to heartbeat refresh task in heartbeat
      git cherry-pick 0ca5ad01eaa25d8663798b5ed59e30247360b845  # lxd/cluster/membership: Add logging to notifyNodesUpdate
      git cherry-pick 72217868184d2ce6f067aaf02bde6e6418ba9570  # lxd/cluster/membership: Improve logging in Assign
      git cherry-pick d5964df6826558144b91dd4a159305cb07495766  # lxd/cluster/membership: Adds unavailableMembers support to Rebalance and newRolesChanges
      git cherry-pick e3f805ce2af33b8e76f28c738702f6d363a36d19  # lxd/api/cluster: Adds unavailableMembers support to rebalanceMemberRoles
      git cherry-pick 26ba5c60912b4982a272f0f0b0069089ddc493f5  # lxd/api/cluster: Improve logging in rebalanceMemberRoles
      git cherry-pick c103cf33249275654e7b4701083a92b8e5d253d0  # lxd/cluster/gateway/test: cluster.NewGateway usage
      git cherry-pick 694b55da5c55cff872c1e5d294789991926ce8ab  # lxd/cluster/gateway: Remove unnecessary logging
      git cherry-pick 4647ece296eda779e541a1ffd8163b3d681912a3  # lxd/cluster/gateway: Don't stop enrichhing raft nodes if one member name not found in currentRaftNodes
      git cherry-pick de5b31820949249856fa960865db39292a13b97f  # test: Reduce sleeps and offline threshold in clustering tests to speed them up
      git cherry-pick 314575c723b900117ffd1422f07773b85a6ec600  # lxd/db/networks: Reworks GetNetworkInAnyState and its ilk to split the functionality out into separate functions
      git cherry-pick 8a9861328675b49df54fb2e43c2b073313a7100b  # shared/api/error: Improve argument name in StatusErrorMatch
      git cherry-pick b5cf08b2dc1666842a314b25c5028a028b3f1466  # shared/api/error: Adds StatusErrorCheck helper function
      git cherry-pick ef0b86f305bde10c76d2b86883e9cd041229b527  # lxd/networks: Use api.StatusErrorCheck to check for not found error from d.cluster.GetNetworkInAnyState
      git cherry-pick 755c32eac2bcdb2f13a0da3cd5e85b9bff75c5d4  # lxd/instance/drivers/driver/lxc: Fix restart locking
      git cherry-pick 9ce3dd4fe6ed3728c179b2b8015b428a08db5e7b  # lxd/network/driver/ovn: Fix comment on getLoadBalancerName
      git cherry-pick b807ce8710dcaca490d3bcae4aa33b31ec4b920e  # lxd/cluster/heartbeat: Use api.StatusErrorf in error returned from HeartbeatNode
      git cherry-pick eb90c80313650732a7feacb48a99e7b31e2782c2  # test: Improve test_clustering_remove_raft_node reliability
      git cherry-pick 6784f3530e8a60be70e2f7a745cfca8a7ac509c8  # lxd/network/ovn: Add support for leases
      git cherry-pick c1c9348f30cb7f33bdbffb3c0dd80aa764703dc8  # api: Add image_source_project extension
      git cherry-pick 40db7161aff47f102b2c5177c7cb27d84c02d890  # shared/api: Add Project to ImagesPostSource
      git cherry-pick 37e3a38f96cc680e00189a0f6a9eb2026aa41fe3  # lxd/storage/drivers/volume: Adds IsCustomBlock function
      git cherry-pick 0b6a9d2dbf19e24251112e3d962d99dfd48c9f8b  # lxd/storage/drivers/generic/vfs: Fixes regression in genericVFSBackupUnpack for VM config volume import
      git cherry-pick c9590b2497841c28fe184949519d68cdb6eddf2a  # lxd/network/openvswitch/ovn: Adds OVNRouterRoute type
      git cherry-pick bff6998e86089726ee21d518edcfd5e9b7b9d379  # lxd/network/openvswitch/ovn: Updates LogicalRouterRouteAdd to accept multiple OVNRouterRoute args
      git cherry-pick 88416d31d3774bc2b72803603a6b07863b15d3e7  # lxd/network/openvswitch/ovn: Harmonise naming conventions in LogicalRouterRouteDelete with OVNRouterRoute type
      git cherry-pick 4612e52aaea862f38a5e8bffb99f0a2c044a58bf  # lxd/network/network/utils: Removes unnecessary DB lookup via NICType function in isInUseByDevice
      git cherry-pick 94565f4c51b315783c17267464dada20b7092684  # lxd/network/network/utils: Updates UsedBy to use usedByInstanceDevices
      git cherry-pick 3cdca5022f2a42b7ee07f52cb707e6ed7157b501  # lxd/network/network/utils: Updates usedByInstanceDevices to use updated isInUseByDevice
      git cherry-pick 45b482f75edd79917f2dc74ca8eed797a2c06011  # lxd/network/network/utils: Updates isInUseByProfile to use updated isInUseByDevice
      git cherry-pick dfd55eb325dd18b6373eeaf9d474489fc3476c3d  # lxd/network/network/utils: Renames isInUseByProfile to usedByProfileDevices
      git cherry-pick 688591eea81e7075cd06556315b19d548a17555b  # lxd/network/openvswitch/ovn: Update LogicalRouterRouteDelete to accept net.IPNet rather than pointer
      git cherry-pick 1fd5bbce76b3660c59ad803d390386a7acb5fc15  # lxd/network/driver/ovn: Remove default routes and re-add as needed in setup
      git cherry-pick 07277d15bbff7d1e09261f39e0587a2b9dd7df20  # lxd/network/driver/ovn: Update InstanceDevicePortSetup to use static route port hints
      git cherry-pick 8b81a73675431b3634ecf3b0ea7ce81a9fc7c0f3  # lxd/network/driver/ovn: InstanceDevicePortDelete updated to handle non-pointer IPNets
      git cherry-pick e9bdbdc4019d3071116a50426a092eabb2a9d89e  # client: Support source project in image copies
      git cherry-pick e74b32b9b3acf4ba7702720bef1c4c5ae3a69f45  # lxd/images: properly return project name in error
      git cherry-pick 7ebc9f8c361c2e714ac0b2bee6ac289213a6fcf7  # lxd: Support source project in image copies
      git cherry-pick 9ee5abc1551201729b0d74245b7e3c704049efa6  # lxc/image: Support source project in image copies
      git cherry-pick f940a32022e9447a5cf71eac07807cef313e6cdd  # doc/rest-api: Refresh swagger YAML
      git cherry-pick 378a7a101db53ecf667a9fde997c72f2c1313ce3  # lxd/db/config: rename UpdateConfig to UpdateClusterConfig
      git cherry-pick 167c483a6e7fcec2dcdb28dbdc68fddb81cd160d  # lxd/db/generate/lex/form: smarter pluralize function
      git cherry-pick eec1eba2f9ae55e166284a80c2a297f4738b0a47  # lxd/db/generate/db/method: fix stmt type for generating URIs
      git cherry-pick 4ba07e45a79deb3d5dca0841cb673fa6b447be70  # lxd/db/generate/db/parse: check stmt and method for omitting fields
      git cherry-pick 39f4671ad5d70494d5444c9e23a0bf69a623d1a5  # lxd/db/generate/db/mapping: pass table name to FieldColumnName
      git cherry-pick a78ef9d2cd9ce5271f6a5396ef6ac6be6282cad0  # lxd/db/generate/db/stmt: pass variable name to register function
      git cherry-pick e66864e849d40093a44ec6bf3ad83c49c44b6a5e  # lxd/db/operations.mapper: remove ProjectID omission from operations
      git cherry-pick f6407be833710b067211e0200df5c6de4c57ba9a  # lxd/instance/drivers/qmp/monitor: Update run to accept an interace{} for args and JSON encode internally
      git cherry-pick 9067b6bd1d933e70687c29c3375b1bc4ec5a8b31  # lxd/instance/drivers/qmp/monitor: m.run usage
      git cherry-pick 30db7a998b61a8567f92c706ea318e65098239eb  # lxd/instance/drivers/qmp/commands: m.run usage
      git cherry-pick 36ce28980524fded86cf12bd82a7246f135c5bcd  # lxd/instance/drivers/qemu: Adds workaround for QEMU 6.x regression in handling memory object host-nodes setting
      git cherry-pick 1afc875d3f5b46b498b2e7f3dda4ddddd6940133  # lxd/device: Make sure vfio-pci is loaded
      git cherry-pick 5638801b646f57d540a28ca877c5f76f5bea61d5  # lxc/cluster: Add --yes to remove
      git cherry-pick f6ecb9860b9d00bd94cbf06e798727a0c9084e6a  # tests: Update for change to cluster remove
      git cherry-pick 8c2350ae2fe810135289ba33b470ecec9cca43aa  # lxd: Add fsmonitor package
      git cherry-pick 36954af8ef0fc9659fc797820f7b2d6ab0fa6a7e  # lxd/state: Add DevMonitor to state
      git cherry-pick 9cb57a9544f04f0e6ab5faf57ea8acf571761833  # lxd: Initialize DevMonitor in daemon
      git cherry-pick bfd0ae70f075bedb26ac23fbada0c777189b8a64  # lxd/device: Switch to DevMonitor
      git cherry-pick ba49f94dbbd762114c0de696e7ac29cba2108665  # lxd/device: Check prefix path in source
      git cherry-pick 6dfd7da93ecbac49b40bf9401ccef807cefac30a  # lxd/device: Remove old inotify code
      git cherry-pick a818450b7400c34610cca4b6524b8fcbe0423bb6  # test/suites: Add fsmonitor to static analysis
      git cherry-pick dd01a97ea9476f8eeee80bf22f75608003718d88  # lxd/db/networks: Fixes getStoragePool to support NULL description fields
      git cherry-pick d85db330a3736cb6aac9cc5432ffb7395f06b69d  # lxd/api/cluster: fix comment on clusterGet clusterPut
      git cherry-pick 5930ff07c174e93cf77a96c8d4ca67d669cd3779  # lxd/device/nic/ovn: Improve error in Start
      git cherry-pick c06d7c0c8938503102f27718907d73ed0432294f  # lxd/network/acl/acl/ovn: Adds OVNIntSwitchPortGroupAddressSetPrefix function
      git cherry-pick 9d3fdb4e9949577ac87b5167c7f75ee8ac545e04  # lxd/network/openvswitch/ovn: Adds address management functions
      git cherry-pick 698c244eda454c129685daf1ae3bbfb88b9956c7  # lxd/network/openvswitch/ovn: Adds router policy management function
      git cherry-pick 07f5b8944e44b1703a541e1e00e46cbfd57af9ab  # lxd/network/driver/ovn: Move logical switch creation after internal network IP validation
      git cherry-pick 2e34e84bcdf02af7ac4f72a9c35283d8b4ed4c98  # lxd/network/driver/ovn: Add address set that represents internal switch subnets and NIC routes
      git cherry-pick cee7b2f17b6e2e2cc3783f82a481e4659309ff65  # lxd/network/driver/ovn: Adds instanceNICGetRoutes function
      git cherry-pick d4c074f0883ccf2787b86db6b7bc4dcbb8804b30  # test: Set LXD_DEVMONITOR_DIR
      git cherry-pick aaa0451d038cbde86b55d97f004795c30d0f3226  # doc/environment: Add LXD_DEVMONITOR_DIR
      git cherry-pick 6610476491019cc1a2318507029ca2c8b02822a4  # lxd/network/driver/ovn: Reworks Update to populate active NIC routes into internal switch's address set
      git cherry-pick 64469c7a9508fb61f2e0a46e982de2bacb9a637b  # lxd/network/driver/bridge: Fix leases

      # Setup build environment
      export GOPATH=$(realpath ./.go)
      export CGO_CFLAGS="-I${SNAPCRAFT_STAGE}/include/ -I${SNAPCRAFT_STAGE}/usr/local/include/"
      export CGO_LDFLAGS="-L${SNAPCRAFT_STAGE}/lib/ -L${SNAPCRAFT_STAGE}/usr/local/lib/"
      export CGO_LDFLAGS_ALLOW="(-Wl,-wrap,pthread_create)|(-Wl,-z,now)"

      # Setup the GOPATH
      rm -Rf "${GOPATH}"
      mkdir -p "${GOPATH}/src/github.com/lxc"
      ln -s "$(pwd)" "${GOPATH}/src/github.com/lxc/lxd"

      # Download the dependencies
      go get -d -v ./...

      # Build the binaries
      go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxc" github.com/lxc/lxd/lxc
      go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxc-to-lxd" github.com/lxc/lxd/lxc-to-lxd
      go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd" -tags=libsqlite3 github.com/lxc/lxd/lxd
      CGO_ENABLED=0 go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd-agent" -tags=agent,netgo github.com/lxc/lxd/lxd-agent
      go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd-benchmark" github.com/lxc/lxd/lxd-benchmark

      # Setup bash completion
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/
      cp scripts/bash/lxd-client ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/share/misc/: share/misc/
      var/lib/usbutils/usb.ids: share/misc/
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/dnsmasq
      - bin/getfattr
      - bin/setfattr
      - bin/iw
      - bin/pigz
      - bin/rsync
      - bin/setfacl
      - bin/sgdisk
      - bin/unsquashfs
      - bin/xdelta3

      - lib/*/libidn.so.*

      - etc/bash_completion.d/snap.lxd.lxc

      - share/misc

      - bin/lxc
      - bin/lxc-to-lxd
      - bin/lxd
      - bin/lxd-agent
      - bin/lxd-benchmark

  lxd-migrate:
    source: lxd-migrate/
    after:
      - lxd
      - sqlite
    build-snaps:
      - go
    plugin: nil
    override-build: |
      set -ex

      # Setup build environment
      export GOPATH=$(realpath ./.go)
      export CGO_CFLAGS="-I${SNAPCRAFT_STAGE}/include/ -I${SNAPCRAFT_STAGE}/usr/local/include/"
      export CGO_LDFLAGS="-L${SNAPCRAFT_STAGE}/lib/ -L${SNAPCRAFT_STAGE}/usr/local/lib/"

      # Download the dependencies
      go get -d -v ./...

      # Build the binaries
      go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd-migrate" -tags=libsqlite3 ./

      # Install bridge script
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/bin/
      cp scripts/upgrade-bridge ${SNAPCRAFT_PART_INSTALL}/bin/upgrade-bridge
    prime:
      - bin/lxd-migrate
      - bin/upgrade-bridge

  shmounts:
    source: shmounts/
    plugin: make
    prime:
      - bin/setup-shmounts

  snap-query:
    source: snap-query/
    build-snaps:
      - go
    plugin: nil
    override-build: |
      set -ex

      # Setup build environment
      export GOPATH=$(realpath ./.go)

      # Build the binaries
      go build -o "${SNAPCRAFT_PART_INSTALL}/bin/snap-query" snap-query.go
    prime:
      - bin/snap-query

  strip:
    source: snapcraft/empty
    after:
      - btrfs
      - ceph
      - dqlite
      - libseccomp
      - logrotate
      - lvm
      - nano
      - nvidia-container
      - openvswitch
      - ovn
      - raft
      - sqlite
      - squashfs-tools-ng
      - vim
      - xfs
      - xz
      - zfs-0-6
      - zfs-0-7
      - zfs-0-8
      - lxc
      - lxcfs
      - criu
      - lxd
      - lxd-migrate
      - shmounts
      - snap-query
    plugin: nil
    override-prime: |
      set -x

      # Strip some of the heavy bits
      strip -s ${SNAPCRAFT_PRIME}/bin/lxc
      strip -s ${SNAPCRAFT_PRIME}/bin/lxd*
      strip -s ${SNAPCRAFT_PRIME}/bin/snap*
      strip -s ${SNAPCRAFT_PRIME}/lib/liblxc*
      strip -s ${SNAPCRAFT_PRIME}/lib/libdqlite*
      strip -s ${SNAPCRAFT_PRIME}/lib/libsqlite*

      for zfs in zfs-0.6 zfs-0.7 zfs-0.8 zfs-2.0 zfs-2.1; do
          [ ! -d "${SNAPCRAFT_PRIME}/${zfs}" ] && continue
          strip -s ${SNAPCRAFT_PRIME}/${zfs}/bin/* ${SNAPCRAFT_PRIME}/${zfs}/lib/*
      done

      [ -e "${SNAPCRAFT_PRIME}/criu/criu" ] && strip -s ${SNAPCRAFT_PRIME}/criu/criu

      exit 0

  wrappers:
    plugin: dump
    source: snapcraft/
    organize:
      hooks/: snap/hooks/
      wrappers/editor: bin/
      wrappers/remote-viewer: bin/
