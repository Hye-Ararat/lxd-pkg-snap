name: lxd
base: core18
assumes:
  - snapd2.39
version: "4.7"
grade: stable
summary: LXD - the container lightervisor
description: |-
 LXD is a container manager for system containers.

 It offers a REST API to remotely manage containers over the network,
 using an image based workflow and with support for live migration.

 Images are available for all Ubuntu releases and architectures as well
 as for a wide number of other Linux distributions.

 LXD containers are lightweight, secure by default and a great
 alternative to virtual machines.


 Supported configuration options (snap set lxd [<key>=<value>...]):

   - ceph.builtin: Use snap-specific Ceph configuration [default=false]
   - ceph.external: Use the system's ceph tools (ignores ceph.builtin) [default=false]
   - criu.enable: Enable experimental live-migration support [default=false]
   - daemon.debug: Increase logging to debug level [default=false]
   - daemon.group: Set group of users that can interact with LXD [default=lxd]
   - daemon.preseed: Pass a YAML configuration to `lxd init` on initial start
   - daemon.syslog: Send LXD log events to syslog [default=false]
   - lvm.external: Use the system's LVM tools [default=false]
   - lxcfs.pidfd: Start per-container process tracking [default=false]
   - lxcfs.loadavg: Start tracking per-container load average [default=false]
   - lxcfs.cfs: Consider CPU shares for CPU usage [default=false]
   - openvswitch.builtin: Run a snap-specific OVS daemon [default=false]
   - shiftfs.enable: Enable shiftfs support [default=auto]

confinement: strict

apps:
  # Main commands
  activate:
    command: commands/daemon.activate
    daemon: oneshot
    plugs:
      - lxd-support
      - system-observe

  daemon:
    command: commands/daemon.start
    reload-command: commands/daemon.reload
    stop-command: commands/daemon.stop
    stop-timeout: 600s
    restart-condition: on-failure
    daemon: simple
    slots: [lxd]
    plugs:
      - lxd-support
      - network-bind
      - system-observe
    sockets:
      unix:
        listen-stream: $SNAP_COMMON/lxd/unix.socket
        socket-mode: 0660

  lxc:
    command: commands/lxc
    completer: etc/bash_completion.d/snap.lxd.lxc
    plugs:
      - lxd-support
      - system-observe

  lxd:
    command: commands/lxd
    plugs:
      - lxd-support
      - system-observe

  # Sub-commands
  benchmark:
    command: commands/lxd-benchmark
    plugs:
      - lxd-support
      - system-observe
  buginfo:
    command: commands/buginfo
    plugs:
      - lxd-support
      - system-observe
  check-kernel:
    command: commands/lxd-check-kernel
    plugs:
      - lxd-support
      - system-observe
  lxc-to-lxd:
    command: commands/lxc-to-lxd
    plugs:
      - lxd-support
      - system-observe
  migrate:
    command: commands/lxd-migrate
    plugs:
      - lxd-support
      - system-observe

hooks:
  configure:
    plugs:
      - network
      - system-observe
  remove:
    plugs:
      - lxd-support
      - system-observe

parts:
  # Dependencies
  btrfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - btrfs-tools
    prime:
      - bin/btrfs
      - bin/btrfstune
      - bin/mkfs.btrfs

  ceph:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ceph-common
      - libdb5.3
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/ceph
      - bin/python
      - bin/python2*
      - bin/rbd
      - lib/python2.7
      - lib/*/libpython2.7.so*
      - -lib/python2.7/sitecustomize.py
      - lib/*/ceph
      - lib/*/libboost_iostreams.so.*
      - lib/*/libboost_program_options.so.*
      - lib/*/libboost_random.so.*
      - lib/*/libboost_regex.so.*
      - lib/*/libboost_system.so.*
      - lib/*/libboost_thread.so.*
      - lib/*/libcephfs*
      - lib/*/libdb-5.3.so
      - lib/*/libicudata.so.*
      - lib/*/libicui18n.so.*
      - lib/*/libicuuc.so.*
      - lib/*/libnspr4.so
      - lib/*/libnss3.so
      - lib/*/libibverbs.so*
      - lib/*/nss/libsoftokn3.so
      - lib/*/nss/libfreeblpriv3.so
      - lib/*/libnssutil3.so
      - lib/*/libplc4.so
      - lib/*/libplds4.so
      - lib/*/librados.so.*
      - lib/*/librbd.so.*
      - lib/*/libsmime3.so
      - lib/*/libsnappy*

  criu:
    source: https://github.com/checkpoint-restore/criu
    source-tag: v3.14
    source-type: git
    source-depth: 1
    plugin: nil
    build-packages:
      - asciidoc
      - libcap-dev
      - libnet1-dev
      - libnl-3-dev
      - libprotobuf-c-dev
      - libprotobuf-dev
      - protobuf-c-compiler
      - protobuf-compiler
      - python
      - xmlto
    stage-packages:
      - libnet1
      - libprotobuf-c1
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "armv7l" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      make
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/criu/"
      cp criu/criu "${SNAPCRAFT_PART_INSTALL}/criu/"
    organize:
      usr/lib/: lib/
    prime:
      - criu/*
      - lib/*/libnet*
      - lib/*/libproto*

  dqlite:
    after:
      - raft
      - sqlite
    source: https://github.com/canonical/dqlite
    source-type: git
    source-depth: 1
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libdqlite*so*
      - lib/*/libuv*

  edk2:
    source: https://github.com/tianocore/edk2
    source-type: git
    source-tag: edk2-stable202008
    source-depth: 1
    plugin: nil
    build-packages:
      - acpica-tools
      - nasm
      - uuid-dev
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      # Apply patches
      patch -p1 < "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0001-force-DUID-LLT.patch"
      cp "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0002-logo.bmp" MdeModulePkg/Logo/Logo.bmp
      patch -p1 < "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0003-boot-delay.patch"

      ARCH="X64"
      PKG="OvmfPkg/OvmfPkgX64.dsc"
      FV_CODE="OVMF_CODE"
      FV_VARS="OVMF_VARS"
      if [ "$(uname -m)" = "aarch64" ]; then
          ARCH="AARCH64"
          PKG="ArmVirtPkg/ArmVirtQemu.dsc"
          FV_CODE="QEMU_EFI"
          FV_VARS="QEMU_VARS"
      fi

      # Run in a bash sub-shell as edksetup.sh requires it
      set -ex
      (
      cat << EOF
          . ./edksetup.sh
          make -C BaseTools ARCH=${ARCH}
          build -a ${ARCH} -t GCC49 -b RELEASE -p ${PKG} \
            -DSECURE_BOOT_ENABLE=TRUE \
            -DNETWORK_IP4_ENABLE=TRUE \
            -DNETWORK_IP6_ENABLE=TRUE \
            -DNETWORK_TLS_ENABLE=TRUE \
            -DNETWORK_HTTP_BOOT_ENABLE=TRUE \
            -DFD_SIZE_2MB \
            -DTPM2_ENABLE=TRUE
      EOF
      ) | bash -e

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      cp Build/*/*/FV/${FV_CODE}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
      cp Build/*/*/FV/${FV_VARS}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"

      if [ "$(uname -m)" = "aarch64" ]; then
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"
      fi

    prime:
      - share/qemu/*

  libmnl:
    source: https://git.netfilter.org/libmnl
    source-type: git
    source-tag: libmnl-1.0.4
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libmnl*so*

  libnftnl:
    after:
      - libmnl
    source: https://git.netfilter.org/libnftnl
    source-type: git
    source-tag: libnftnl-1.1.7
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libnftnl*so*

  libseccomp:
    source: https://github.com/seccomp/libseccomp
    source-type: git
    source-tag: v2.5.0
    source-depth: 1
    plugin: autotools
    build-packages:
      - gperf
    organize:
      usr/lib/: lib/
    prime:
      - lib/libseccomp*so*

  libtpms:
    source: https://github.com/stefanberger/libtpms
    source-type: git
    source-tag: v0.7.3
    source-depth: 1
    plugin: autotools
    configflags:
      - --with-tpm2
      - --with-openssl
    organize:
      usr/lib/: lib/
    prime:
      - lib/libtpms*so*

  libusb:
    source: https://github.com/libusb/libusb
    source-type: git
    source-tag: v1.0.23
    source-depth: 1
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libusb*so*

  logrotate:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - logrotate
      - libpopt0
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    stage:
      - bin/logrotate
    prime:
      - bin/logrotate
      - lib/*/libpopt*so*

  lvm:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - dmeventd
      - lvm2
      - thin-provisioning-tools
    organize:
      sbin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/cache_*
      - bin/dmeventd
      - bin/era_*
      - bin/lv*
      - bin/pdata_tools
      - bin/pv*
      - bin/thin_*
      - bin/vg*
      - -bin/vgimportclone
      - -bin/lvmconf
      - -bin/lvmdump
      - -bin/lvmetad
      - -bin/lvmpolld
      - etc/lvm/lvm.conf
      - lib/*/device-mapper/*
      - lib/*/libaio.so*
      - lib/*/libdevmapper*
      - lib/*/liblvm*
      - lib/*/libreadline.so*

  nano:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - nano
    organize:
      usr/bin/: bin/
    prime:
      - bin/nano
      - etc/nanorc

  nftables:
    after:
      - libmnl
      - libnftnl
    source: https://git.netfilter.org/nftables
    source-type: git
    source-tag: v0.9.6
    plugin: autotools
    configflags:
      - --with-json
    build-packages:
      - libjansson-dev
      - libreadline-dev
    stage-packages:
      - libjansson4
    organize:
      sbin/: bin/
      usr/lib/: lib/
    prime:
      - bin/nft
      - lib/*/libjansson*so*
      - lib/libnftables*so*

  nvidia-container:
    after:
      - libseccomp
    source: https://github.com/NVIDIA/libnvidia-container
    source-type: git
    source-tag: v1.3.0
    source-depth: 1
    plugin: make
    build-packages:
      - bmake
      - curl
      - lsb-release
    override-build: |-
      set -ex

      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/bin/"
      cp ${SNAPCRAFT_PROJECT_DIR}/snapcraft/wrappers/nvidia-container-cli "${SNAPCRAFT_PART_INSTALL}/bin/"

      set +ex
      snapcraftctl build
    organize:
      usr/local/bin/nvidia-container-cli: bin/nvidia-container-cli.real
      usr/local/lib: lib/
    prime:
      - bin/nvidia-container-cli*
      - lib/libnvidia-container.so*

  openvswitch:
    source: https://github.com/openvswitch/ovs
    source-type: git
    source-tag: v2.14.0
    source-depth: 1
    plugin: autotools
    stage-packages:
      - uuid-runtime
    organize:
      sbin/: bin/
      usr/bin/: bin/
    prime:
      - bin/ovs-appctl
      - bin/ovs-vsctl
      - bin/ovs-vswitchd
      - bin/ovsdb-*
      - bin/uuidgen
      - share/openvswitch/

  ovn:
    after:
      - openvswitch
    source: https://github.com/ovn-org/ovn
    source-type: git
    source-tag: v20.06.2
    source-depth: 1
    configflags:
      - --with-ovs-source=../../openvswitch/build/
    plugin: autotools
    prime:
      - bin/ovn-nbctl

  spice-protocol:
    source: https://gitlab.freedesktop.org/spice/spice-protocol
    source-type: git
    source-tag: v0.14.2
    source-depth: 1
    plugin: meson
    prime: []

  spice-server:
    after:
      - spice-protocol
    source: https://gitlab.freedesktop.org/spice/spice
    source-type: git
    source-tag: v0.14.3
    source-depth: 1
    plugin: meson
    meson-parameters:
      - --prefix=/
      - -Dgstreamer=no
      - -Dmanual=false
      - -Dlz4=false
      - -Dsasl=false
      - -Dopus=disabled
      - -Dsmartcard=disabled
      - -Dtests=false
    build-packages:
      - libjpeg-turbo8-dev
      - python3-pyparsing
      - python3-six
    stage-packages:
      - libjpeg-turbo8
      - libpixman-1-0
    organize:
      sbin/: bin/
      usr/lib: lib/
      usr/local/lib/: lib/
    prime:
      - lib/*/libjpeg*so*
      - lib/*/libspice-server*so*
      - lib/*/libpixman*so*

  swtpm:
    after:
      - libseccomp
      - libtpms
    source: https://github.com/stefanberger/swtpm
    source-type: git
    source-tag: v0.5.0
    source-depth: 1
    plugin: autotools
    build-packages:
      - expect
      - gawk
      - iproute2
      - python3-cryptography
      - python3-setuptools
      - socat
    configflags:
      - --with-seccomp
      - --with-openssl
      - --without-cuse
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      lib/swtpm/: lib/
    prime:
      - bin/swtpm
      - lib/libswtpm*so*

  qemu:
    after:
      - libseccomp
      - libusb
      - spice-protocol
      - spice-server
    source: IRRELEVANT
    source-type: git
    plugin: autotools
    configflags:
      - --disable-bochs
      - --disable-cloop
      - --disable-dmg
      - --disable-docs
      - --disable-guest-agent
      - --disable-parallels
      - --disable-qed
      - --disable-sheepdog
      - --disable-slirp
      - --disable-user
      - --disable-vdi
      - --disable-vnc
      - --disable-xen
      - --enable-attr
      - --enable-cap-ng
      - --enable-kvm
      - --enable-libusb
      - --enable-usb-redir
      - --enable-linux-aio
      - --enable-numa
      - --enable-pie
      - --enable-rbd
      - --enable-seccomp
      - --enable-spice
      - --enable-system
      - --enable-tcg
      - --enable-tools
      - --enable-vhost-crypto
      - --enable-vhost-kernel
      - --enable-vhost-net
      - --enable-vhost-scsi
      - --enable-vhost-user
      - --enable-vhost-vsock
      - --enable-virtfs
      - --firmwarepath=/snap/lxd/current/share/qemu/
    build-packages:
      - bison
      - flex
      - pkg-config
      - libaio-dev
      - libcap-ng-dev
      - libglib2.0-dev
      - libnuma-dev
      - libpixman-1-dev
      - librbd-dev
      - libusbredirhost-dev
    stage-packages:
      - genisoimage
      - libmagic1
      - libnuma1
      - libpixman-1-0
      - libusbredirhost1
      - libusbredirparser1
    override-pull: |-
      set -ex
      git clone https://github.com/qemu/qemu . -b v5.1.0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick 202d69a715a4b1824dcd7ec1683d027ed2bae6d3  # usb-host: workaround libusb bug
      git cherry-pick 4969e697c15ac536d5c0700381d5d026ef7f0588  # usb-host: restrict workaround to new libusb versions
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && [ "$(uname -m)" != "ppc64le" ] && [ "$(uname -m)" != "s390x" ] && exit 0

      set -ex
      # Mangle the configure a bit
      QEMUARCH="$(uname -m)"
      [ "${QEMUARCH}" = "ppc64le" ] && QEMUARCH="ppc64"
      sed -i "s/^unset target_list$/target_list=\"${QEMUARCH}-softmmu\"/" configure
      sed -i 's#libseccomp_minver=".*#libseccomp_minver="0.0"#g' configure

      set +ex
      snapcraftctl build
    organize:
      libexec/: bin/
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/genisoimage*
      - bin/mkisofs*
      - bin/qemu-system-*
      - bin/qemu-img*
      - bin/virtfs-proxy-helper*
      - lib/*/libmagic*so*
      - lib/*/libnuma*so*
      - lib/*/libpixman*so*
      - lib/*/libusbredir*so*
      - share/qemu/keymaps*
      - share/qemu/efi-virtio.rom*
      - share/qemu/kvmvapic.bin*
      - share/qemu/s390-*.img*
      - share/qemu/slof.bin*
      - share/qemu/vgabios-*.bin*

  qemu-ovmf-secureboot:
    after:
      - edk2
      - qemu
    source: https://github.com/puiterwijk/qemu-ovmf-secureboot
    source-type: git
    source-depth: 1
    plugin: nil
    build-packages:
      - xorriso
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      set -ex
      rm -Rf iso-root vfat-root shell.iso
      mkdir -p iso-root vfat-root/efi/boot
      cp ../../edk2/build/Build/*/*/*/Shell.efi vfat-root/efi/boot/bootx64.efi
      cp ../../edk2/build/Build/*/*/*/EnrollDefaultKeys.efi vfat-root/
      "${SNAPCRAFT_STAGE}/bin/qemu-img" convert --image-opts driver=vvfat,floppy=on,fat-type=12,label=UEFI_SHELL,dir=vfat-root iso-root/shell.img
      xorriso --as mkisofs -input-charset ASCII -J -rational-rock -e shell.img -no-emul-boot -o shell.iso iso-root/

      # Basic aarch64 support
      if [ "$(uname -m)" = "aarch64" ]; then
          sed -i ovmf-vars-generator \
              -e "s/'-machine', machinetype,/'-machine', 'virt', '-cpu', 'cortex-a57',/" \
              -e "/charserial1/d" \
              -e "s/ide-cd/scsi-cd/" \
              -e "s/'-device',$/'-device', 'virtio-scsi-pci,id=scsi', '-device',/"
      elif [ "$(uname -m)" = "x86_64" ]; then
          cp -f "${SNAPCRAFT_STAGE}/share/qemu/kvmvapic.bin" .
      fi

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      python3 ovmf-vars-generator \
        --qemu-binary "${SNAPCRAFT_STAGE}/bin/qemu-system-$(uname -m)" \
        --print-output --disable-smm --skip-testing \
        --oem-string "$(cat ${SNAPCRAFT_PROJECT_DIR}/snapcraft/etc/ubuntu-sb.crt)" \
        --ovmf-binary "${SNAPCRAFT_STAGE}/share/qemu/OVMF_CODE.fd" \
        --ovmf-template-vars "${SNAPCRAFT_STAGE}/share/qemu/OVMF_VARS.fd" \
        --uefi-shell-iso shell.iso \
        "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.ms.fd"
    prime:
      - share/qemu/*

  raft:
    source: https://github.com/canonical/raft
    source-type: git
    source-depth: 1
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libraft*so*

  sqlite:
    source: https://github.com/sqlite/sqlite
    source-type: git
    source-depth: 1
    source-tag: version-3.33.0
    plugin: autotools
    build-packages:
      - tcl
    override-build: |-
      set -ex

      git log -1 --format=format:%ci%n | sed -e 's/ [-+].*$//;s/ /T/;s/^/D /' > manifest
      git log -1 --format=format:%H > manifest.uuid
      cp /usr/share/misc/config.guess .
      cp /usr/share/misc/config.sub .
      autoreconf -f -i

      set +ex
      snapcraftctl build
    prime:
      - bin/sqlite3
      - lib/libsqlite3*so*

  squashfs-tools-ng:
    source: https://github.com/AgentD/squashfs-tools-ng
    source-type: git
    source-tag: v1.0.2
    source-depth: 1
    plugin: autotools
    build-packages:
      - liblzma-dev
    prime:
      - bin/sqfs2tar
      - bin/tar2sqfs
      - lib/libsquashfs.so*

  vim:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - vim-tiny
    organize:
      usr/bin/: bin/
      usr/share/vim/vim*/debian.vim: etc/vimrc
    prime:
      - bin/vim.tiny
      - etc/vimrc

  xfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xfsprogs
    organize:
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/xfs_admin
      - bin/xfs_db
      - bin/xfs_growfs
      - bin/xfs_repair
      - bin/mkfs.xfs

  xtables:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ebtables
      - iptables
      - xtables-addons-common
    organize:
      usr/lib/*/xtables/*: lib/xtables/
      lib/ebtables/*: lib/
      sbin/: bin/
    prime:
      - bin/ebtables
      - etc/ethertypes
      - etc/protocols
      - lib/libebt*
      - lib/xtables/*

  xz:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xz-utils
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/lzma
      - bin/xz
      - lib/*/liblzma*so*
    override-build: |
      snapcraftctl build

      # Include the lzma symlink
      ln -s xz "${SNAPCRAFT_PART_INSTALL}/usr/bin/lzma"

  zfs-0-6:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.6.5.11
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick fb963d33ee0dd350143ba1c9cd35d5f7d86910d2  # Fix endian build problem on ppc64el

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-7:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.7.13
    source-depth: 1
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-8:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.8.5
    source-depth: 1
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  # Core components
  lxc:
    after:
      - libseccomp
    source: https://github.com/lxc/lxc
    source-type: git
    source-tag: lxc-4.0.5
    build-packages:
      - libapparmor-dev
      - libcap-dev
      - libgnutls28-dev
      - libselinux1-dev
      - pkg-config
    plugin: autotools
    configflags:
      - --disable-api-docs
      - --disable-bash
      - --disable-doc
      - --disable-examples
      - --disable-memfd-rexec
      - --disable-tests
      - --disable-tools
      - --enable-apparmor
      - --enable-seccomp
      - --enable-selinux
      - --enable-capabilities
      - --with-rootfs-path=/var/snap/lxd/common/lxc/
      - --libexecdir=/snap/lxd/current/libexec/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/libexec: libexec
      share/lxc/hooks: lxc/hooks
    prime:
      - bin/lxc-checkconfig
      - lib/liblxc.so.1
      - lib/liblxc.so.1.*
      - lxc/config/common.conf.d
      - lxc/hooks/nvidia
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/
      ln -s /var/snap/lxd/common/lxc/local.conf $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/01-local.conf
      sed -i "s#includedir=.*#includedir=$SNAPCRAFT_PART_INSTALL/include#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc
      sed -i "s#libdir=.*#libdir=$SNAPCRAFT_PART_INSTALL/lib#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc

  lxcfs:
    source: https://github.com/lxc/lxcfs
    source-type: git
    source-tag: lxcfs-4.0.6
    build-packages:
      - libfuse-dev
      - libpam0g-dev
      - pkg-config
    stage-packages:
      - fuse
    plugin: autotools
    configflags:
      - --datarootdir=/snap/lxd/current/
      - --localstatedir=/var/snap/lxd/common/var/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/lxcfs: lxcfs
      lib/lxcfs: lib
    prime:
      - bin/fusermount
      - lib/*/libfuse.so.*

      - bin/lxcfs
      - lib/liblxcfs.so

      - lxc
      - lxcfs
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      set +ex
      snapcraftctl build
      set -ex

      sed -i "s#\${LXC_ROOTFS_MOUNT}/var/snap/lxd/common/var/lib/lxcfs/#\${LXC_ROOTFS_MOUNT}/var/lib/lxcfs/#g" $SNAPCRAFT_PART_INSTALL/snap/lxd/current/lxcfs/lxc.mount.hook

  lxd:
    source: https://github.com/lxc/lxd
    source-type: git
    source-tag: lxd-4.7
    after:
      - lxc
      - dqlite
      - sqlite
    build-packages:
      - libacl1-dev
      - libudev-dev
      - pkg-config
    stage-packages:
      - acl
      - attr
      - dnsmasq-base
      - gdisk
      - iw
      - netbase
      - pciutils
      - pigz
      - rsync
      - squashfs-tools
      - usbutils
      - xdelta3
    plugin: nogetgo
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd
    go-packages:
      - github.com/lxc/lxd/lxc
      - github.com/lxc/lxd/lxc-to-lxd
      - github.com/lxc/lxd/lxd
      - github.com/lxc/lxd/lxd-benchmark
    override-build: |
      set -ex

      # Git cherry-picks
      cd ../src
      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick f7fd7215344bb0d5d31d04307a0ba5d17e9bf0fc  # lxd/device/usb: Fix check for required USB device
      git cherry-pick b76ffcd374cf5577892fff39a13fa56e33ee117f  # seccomp: switch back to pread()
      git cherry-pick 1dd4a0b1705fcf55f581ff0dcfceb5ec24979098  # nsexec: simplify userns attach
      git cherry-pick d57813b900c4a9ae3b55b22fb87baf18e1780f2b  # forksyscall: preserve root and cwd fds for shifted mount emulation
      git cherry-pick 709d0de3c5810761fe11e8374e7cdf04ba150ab6  # lxc/init.go: remove for-loop in create()
      git cherry-pick c470380fd10673ee00dd9bf1e28371bf4e3fb2bb  # lxd/device/nic/ovn: Improved error messages
      git cherry-pick 1666e7465339f83f126960324849268e495a4c71  # lxd/network/driver/ovn: Generates static EUI64 IPv6 address for instance switch ports in instanceDevicePortAdd
      git cherry-pick 85e45368bd5b530fb2277e19101ae1c8165bfa15  # lxd/network/openvswitch/ovn: Adds LogicalSwitchPortGetDNS to return switch port DNS info
      git cherry-pick e8446e9a378c47580d8d22f43675fda8ddd4f248  # lxd/network/openvswitch/ovn: Updates LogicalSwitchPortDeleteDNS to only accept DNS UUID rather than port name
      git cherry-pick f5e3e45b66b1e96430017c586ab70b47b7798e66  # lxd/network/openvswitch/ovn: Updates LogicalSwitchPortSetDNS to return the DNS UUID record ID
      git cherry-pick d4fa12705775b6eeb9e06482f5d9b6eb36c5c192  # lxc/network/driver/ovn: Adds validateExternalSubnet function
      git cherry-pick 9a1db6c4a79565dc5f592ac86b3b5b207521ba67  # lxd/network/driver/ovn: Updates Validate to ensure ipv4.address and ipv6.address are allowed external subnets
      git cherry-pick 3cef49a5091b65c2c7a7b169eec014c2452abaa1  # lxd/network/driver/ovn: Adds support for publishing instance port IPs to uplink network
      git cherry-pick 1323904e2648e55bc2fc69b4622be536ac9a6a90  # revert/revert.go: remove a for-loop from Clone()
      git cherry-pick 686ecb7b357184e1b05db0c96a9417f0714435de  # doc/networks: Adds ipv4.nat and ipv6.nat to ovn network
      git cherry-pick 4d4fb034f61025b41845e191073ada05bf5ac856  # lxc/copy.go: Remove unneeded for-loop in c.Run()
      git cherry-pick 9ba0b5a029cbf659553ff5be801afe542a97e645  # lxd/db/networks: Fix NULL description
      git cherry-pick 0e5c2730002452dbc53a11c3dab6e681cd19d3df  # lxd/network/driver/ovn: Allows "none" as value for ipv4.address and ipv6.address
      git cherry-pick 9d4ceec468a1fc0d1a81597cddba19793f97951b  # lxd/network/driver/ovn: Re-run validation of auto generated address used in FillConfig
      git cherry-pick f3da8b57c47423616e6490c89fb820be6c5dd651  # lxd/network/driver/ovn: Modify setup() to support optional IP addresses
      git cherry-pick 78f3c3e7973932ae216bdb7d90ef0267021ed2a8  # lxd/network/driver/ovn: Updates instanceDevicePortAdd to support optional IP addresses
      git cherry-pick 71caae866af04c142dbb48cc19a4d7a126e3657a  # lxd/network/driver/ovn: Only call Validate in FillConfig if state is set
      git cherry-pick f6add9084341a88c0847398eb4db5610e7e5f1bd  # lxd/db/projects: Adds GetProject function
      git cherry-pick fa2da560919d515ecd24a2aebc40b4a213c34fea  # lxd/network/driver/ovn: Converts instance port functions to exported
      git cherry-pick d5351219834cbb9bb12faba3cf653f0751765898  # lxd/network/driver/ovn: Removes ipv4.routes.external and ipv6.routes.external
      git cherry-pick e1668b6f4f92365854ad48eb4ee243186c87fa15  # lxc/network/driver/ovn: Adds projectRestrictedSubnets and uplinkRoutes functions
      git cherry-pick bbfce066807e2491abe1bd281cccc0ac6c8f7b26  # lxd/network/driver/ovn: Simplifies Validate by using separate data loader functions
      git cherry-pick d84254815bcb4e822fad4ef67f6a2c84a4c5a76e  # lxd/network/driver/ovn: Passes project into allowedUplinkNetworks
      git cherry-pick bfd7ac77861bdc804e742948aa0c7c12b38946c2  # lxd/network/driver/ovn: Passes project into validateUplinkNetwork
      git cherry-pick 44e6104b2a3acccb81bbc4a6c2c8f5eca43da058  # lxd/network/driver/ovn: Load project in setup() to pass to n.validateUplinkNetwork()
      git cherry-pick 3efb1adc6d469353639768c632549ca846b65d38  # lxd/network/driver/ovn: Adds InstanceDevicePortValidateExternalRoutes function
      git cherry-pick 131a644a8507295a9c25882e88a48ba952e125bf  # lxd/network/network/utils/ovn: Remvoes unused functions
      git cherry-pick 08415e9d128c15abf020089325ba5c090ceb0e7d  # lxd/device/nic/ovn: Adds ovnNet interface and use OVN instance port functions directly from network
      git cherry-pick b9b1964381a0851d00c552fac3519dd02daf28ad  # lxd/device/nic/ovn: Removes validation of external routes against network's external routes
      git cherry-pick 78d4ec8e820ad4f41f42887565b2f112442f3fff  # lxd/device/nic/ovn: Validate NICs external routes using d.network.InstanceDevicePortValidateExternalRoutes
      git cherry-pick 4a2a968c0e4e330d00d2c65d434bf9101f883c43  # doc/networks: Removes ipv4.routes.external and ipv6.routes.external from ovn network
      git cherry-pick 3ee8867b4053a187e587939a11dad878c60be1b4  # lxd/patches: Adds patch for removing ipv4.routes.external and ipv6.routes.external from ovn networks
      git cherry-pick c046d94b22d37c6ba35422be759abf218d2ba33f  # api: Adds network_ovn_external_routes_remove extension
      git cherry-pick 913bdb4fe654fc2c566eea11855fe96ebd6b95f1  # lxd/network/driver/ovn: Fix project restricted subnets check in validateExternalSubnet
      git cherry-pick ef2dfa8748815befa7f6705798c23d7445cb4691  # lxd/images: Fixes ineffectual assign warning
      git cherry-pick a4e89992943eb88dd8d1d1c010b332f626738170  # lxd/resources/usb: Fixes ineffectual assign warning
      git cherry-pick 9aa5cfd3840415368d71064868391a570976c8fb  # lxd/storage/drivers/driver/lvm/volumes: Fixes ineffectual assign warning
      git cherry-pick 0364002a9db6bfa9707710b7b64a5ca0a93514a5  # lxd/instance: Use project aware inst.LogPath() function when clearing log dir in instanceCreateInternal
      git cherry-pick c029aab2ca63ea6a83f6f73be8d0e8b7a827a525  # lxd/instance/drivers/driver/lxc: Project aware rename of log path in Rename()
      git cherry-pick feb558885cbedfbbf55911a5cba96d0890720b74  # lxd/instance/drivers/driver/qemu: Project aware rename of log path in Rename()
      git cherry-pick fa7f5e39b6ad4cd27b6e0dd38a3d79d9c147c293  # lxd/instance/drivers/driver/lxc: Makes collectCRIULogFile project log path aware
      git cherry-pick 645ce23fa728eb3922df5466361e6ae0b344c5c4  # lxd/instance/logs: Makes containerLogsGet project aware
      git cherry-pick 78afd4d6cc3922df13570f863ed7056eb8b71953  # lxd/main/init/interactive: Clarifies question about using an existing empty disk
      git cherry-pick 0c905fa7ee62fc4c6a4fdf0bfa64449d9445cb7c  # lxd/network/driver/bridge: Sets ipv4.nat=true when adding a new fan network with fan.underlay_subnet=auto
      git cherry-pick 1ab08b9de91ede69ae939bacb97d7eb24fb48c7c  # lxd/patches: Adds patchNetworkFANEnableNAT to set ipv4.nat=true for fan networks missing the setting
      git cherry-pick da33768610bbf27d4369806b4fdcad34336a152c  # doc/networks: Clarifies comment defaults for bridge ipv4.nat when not specified during creation
      git cherry-pick 524c519eefe8a87b6152e152f04e1755fc0d1fcf  # lxd/seccomp: Fix go vet
      git cherry-pick a4f287312fb03f3b3d58201fa9e7ec568d5e7176  # lxd/instance: Add Architecture to common
      git cherry-pick fce5ee2821b109a013c91fe8b2a64c6b89c92d72  # lxd/devices: Disable USB on s390x
      git cherry-pick 95d2afa5f5ba37e635a8236f5f8775c438fd6da8  # add new "restarted" event to reboot section of onStop in both lxc and qemu
      git cherry-pick 027ed7dbad97446eec5c9d93c6754bd8635f7c2c  # tests: Fix missing clustering cleanup
      git cherry-pick 39e66f7095c313d45cde5c770304f23ec7e034ed  # lxd/storage/zfs: Properly recurse delete volumes
      git cherry-pick a4bc53da158f25e442f6c165c78ca3bf77494ef8  # tests: Fix cleanup in backup
      git cherry-pick 6b3d569c493e7cc5e0367fb45d4f6a54c60fe636  # lxd/storage/backend/lxd: b.driver.UnmountVolume usage
      git cherry-pick 4c1aa33f61f9a4bb6bc757629d6f99c3eea61b92  # lxd/instance/drivers/driver/lxc: Moves log rotate and mount before devices start in startCommon
      git cherry-pick 65ee12cf2442b95f998e32b3221bee15706cb6b1  # lxd/storage/drivers/interface: Adds keepBlockDev arg to UnmountVolume
      git cherry-pick 9eb284da66d53e7a73188a6c9c3d66b314df94cb  # lxf/storage/drivers/volume: v.driver.UnmountVolume usage
      git cherry-pick ab34fe525fd394e4b3934970b8f949aedfafd863  # lxd/storage/drivers/volume: Adds keepBlockDev arg to UnmountTask
      git cherry-pick 54472ad66be90990d8a23dfe07c3256ec873dd98  # lxd/storage/drivers/utils: Passes true for keepBlockDev arg to UnmounTask in shrinkFileSystem
      git cherry-pick d1144f577bd22587693ebf1c1c6754c15882d863  # lxd/storage/drivers/generic/vfs: d.UnmountVolume usage
      git cherry-pick ed358c62fc7cdcfa6cbb6ed03f1858cfe6553a48  # lxd/storage/drivers/drivers/mock: Adds keepBlockDev arg to UnmountVolume
      git cherry-pick 0abd8e94fbc22b5a1d5f9a2e899960da90d8ec81  # lxd/storage/drivers/driver/btrfs/volumes: Adds keepBlockDev arg to UnmountVolume
      git cherry-pick 7d150e4898b4137af5d49776b653d15db8322f4a  # lxd/storage/drivers/driver/dir/volumes: Adds keepBlockDev arg to UnmountVolume
      git cherry-pick 0049a9745be5ad1b72e6bd24bc3aeb8c1218c451  # lxd/storage/drivers/driver/cephfs/volumes: Adds keepBlockDev arg to UnmountVolume
      git cherry-pick 010ec64e97dd9e3d60d99cbe2f21d34277c624a3  # lxd/storage/drivers/driver/lvm/volumes: UnmountVolume usage
      git cherry-pick 530655d6eb70a61fc6914e84b1431d819f1bebd6  # lxd/storage/drivers/driver/lvm/volumes: Adds keepBlockDev arg to UnmountVolume
      git cherry-pick 8ce875a18270d485c04c834009adb137094c02ab  # lxd/storage/drivers/driver/lvm/volumes: UnmountTask usage
      git cherry-pick a351f11164005d251914628d1439ec60ab08a8fe  # lxd/storage/drivers/driver/ceph/volumes: d.UnmountVolume usage
      git cherry-pick d6d0f9bf1faa4776b561c36779f3289d43c028b1  # lxd/storage/drivers/driver/ceph/volumes: Adds keepBlockDev arg to UnmountVolume
      git cherry-pick 7ef06a6ca186224f8b8b80ec27f1947c40cccf67  # lxd/storage/drivers/driver/zfs/volumes: Adds keepBlockDev arg to UnmountVolume
      git cherry-pick f74fd527955beb54259d7f5657af687fc4dc29c4  # lxd/storage/drivers/driver/zfs/volumes: d.UnmountVolume usage
      git cherry-pick 4ceaec7ff5af56fc55cbe1da22933135de87b4f7  # lxd/device/config/devices/sort: Sort disks between nics and other types of devices
      git cherry-pick 609f06fd717f1e95e8ebab48d566b37afd89c169  # lxd/device/config/devices/sort: Comment improvement
      git cherry-pick dd2481399200358fb5df64bfa2ed520fc0ee8cba  # lxd/instance/drivers: Device lifecycle logging improvements
      git cherry-pick d6f5532fd5265a364573b7ffe8ecda3751364fb5  # lxd/instance/drivers: Stop devices in reverse order to how they were started
      git cherry-pick adad7b2a415b0487deb5604745caaed12343fbd1  # lxd/instance/drivers/driver/lxc: Only use postStartHooks var where actually needed
      git cherry-pick ed7c6ce40c21cdf8dcb37a697a986c50fecbfcdf  # lxd/instance/drivers/driver/qemu: Adds log rotation to Start
      git cherry-pick da09d9fec580938778af2daaa199e88cec0303ee  # lxd/storage/zfs: Fix argument ordering
      git cherry-pick d520357207a0bb535f78212b25372aaf6478c9c5  # lxd/cluster/connect: Renames project arg to projectName in ConnectIfInstanceIsRemote
      git cherry-pick a5a1f424b9cdba09d91fd86532cdde51d896b253  # lxd/cluster/connect: Adds projectName arg to ConnectIfVolumeIsRemote
      git cherry-pick 845d371084edd548435fb26bc8cfa293b8b06705  # lxd/response: Adds projectName argument to forwardedResponseIfVolumeIsRemote
      git cherry-pick ca3badc5dc32930ab754615b4eae6763b2f6149b  # lxd/storage/volumes: forwardedResponseIfVolumeIsRemote projectName argument usage
      git cherry-pick d1b92fe24513fef9698c2c25d8a1459d2b658e88  # lxd/db/storage/volumes: Corrects mispelled argument name in GetStorageVolumeNodeAddresses
      git cherry-pick 20d1f8c00596b8aa84bfc50a00757be78807718f  # lxc/move: Bypass security.protection.delete
      git cherry-pick ea00225c7a415ecded801bd6a4cd9e68dd29f72e  # lxd/device: Fix typo
      git cherry-pick 914c3d86d7a5266ac726f3ddd2ea8860af449572  # doc/instances: usb and gpu are available in VMs
      git cherry-pick c415a8f533390a595369687fbedf4b27a555cc4d  # doc/instances: Add missing header in usb device
      git cherry-pick 11239b22efea6000b56396335373ca94a0f2db83  # extract restart logic to new instance interface function of lxc and qemu
      git cherry-pick 156dc7b463a88fdbb952a4e46e11a74dc5a563b5  # scripts/bash: Fix snap handling
      git cherry-pick 75dc684814f9c741b98d69f16400dd0618e6b6c9  # extract common restart code to driver_common.go
      git cherry-pick d5fe43aa567c9684bedffc051478f17ee8b11d5d  # lxd/storage: Rename RunningSnapshotFreeze to RunningCopyFreeze
      git cherry-pick 1cb7475c22a02f5317641c746c87430b0d561551  # lxd/storage: Ensure source is frozen during copy
      git cherry-pick 74c1e881df63a4d211e674e790459925a321ac5e  # lxd/instance/drivers: Write out updated backup.yaml after rename
      git cherry-pick 7bad0cbaecdefef16e2c636a5d1a77aa49e54924  # lxd: Switch to new candid URL
      git cherry-pick 7b5aae3986c7e364e62e12064c73ba439503ddd9  # lxd/storage/zfs: No need to remove dashes from UUID
      git cherry-pick f3c4805b2267aa6e8af890499ee8c72673522b77  # shared: Drop GroupId and UserId
      git cherry-pick 30e814b42b0a19355c2bad3a2e971c7bf44c5f5b  # lxd: Port to os/user
      git cherry-pick a38f4092d40c68c77a704353776bf7edce98edd2  # lxd/daemon: Log protocol
      git cherry-pick 1694cfd678f4eadeddda4831f3103a1d3aaed439  # lxd/daemon: Pass writer to Authenticate
      git cherry-pick e5a01555ba6d1e25ce859be84a5b9b9d4a88b8ff  # lxd/daemon: Record username on unix queries
      git cherry-pick 6b4533a92cfe6eacabe6a1393270b7d7949d2b2c  # lxd/storage: Lock during the whole image replace
      git cherry-pick e2ed4b00072118b13f4ab2dc9673ac69c18af2c1  # lxd/db/errors: Adds ErrNoClusterMember var used to indicate no cluster member has been found for a resource
      git cherry-pick 25eb7e726d94121abad60e90d7dfa42fc76b8e48  # lxd/db/storage/volumes: Modifies GetStorageVolumeNodeAddresses to detect volumes that are not bound to a single node
      git cherry-pick ac9d65a3f1eb93024530e8c710a2450003000973  # lxd/db/storage/volumes: Removes StorageVolumeIsAvailable
      git cherry-pick fff00ee9d867d7c388f4aec9d74cf8136b466192  # lxd/response: Updates forwardedResponseIfVolumeIsRemote to accept poolName rather than poolID
      git cherry-pick fe04a209bbdecf590f94d491c37f6614006cc212  # lxd/storage/volumes: forwardedResponseIfVolumeIsRemote usage
      git cherry-pick 607630cf470aff60ee95b78d3b22d7383873550d  # lxd/storage/volumes/backup: forwardedResponseIfVolumeIsRemote usage
      git cherry-pick 0d94c859885e53c1b03058a9b2d7ded87aef80bb  # lxd/storage/volumes/snapshot: forwardedResponseIfVolumeIsRemote usage
      git cherry-pick f606b247d9144d19e4a16c5ad2ec7014767cb863  # lxd: Replace use of tx.GetProject with cluster.GetProject
      git cherry-pick 9c4d339af73fd45b79a0c594a3b41177a441c69a  # lxd/project/project: Adds StorageVolumeProjectFromRecord function
      git cherry-pick fbf1a0c1aca7d080172812733a08befaccc31e54  # lxd/db/instances: Renames and reworks instanceListExpanded to InstanceList
      git cherry-pick 4c729d0f88acbd742e7f9c14f7f9a72f9fab6a66  # lxd/db/instances/export/test: Removes unused file
      git cherry-pick 9dce81cbd89512143ccb83deeb3922f5005c3f41  # lxd/db/instances/test: Renames TestInstanceListExpanded to TestInstanceList
      git cherry-pick dc7f2cfb50b558da72f2ba759dd23c8355f175cf  # lxd/patches: driver.VolumeTypeNameToDBType usage
      git cherry-pick 6e3e9b14edf59a125f3889514c67df1d30b94e88  # lxd/profiles/utils: Comment on doProfileUpdateContainer for clarity
      git cherry-pick 2920b69f391b4a193e7d0c8d4ea33ee2ab1d305e  # lxd/response: cluster.ConnectIfVolumeIsRemote usage
      git cherry-pick b3284ca34542837847463df0070591186c3d9d74  # lxd/storage/drivers/driver/types: Adds VolumeMultiNode field to Info
      git cherry-pick 61ac546ee2abe5bbfe6d0069f5fe41f18a9deb09  # lxd/storage/drivers/driver/cephfs: Adds VolumeMultiNode=true to Info struct
      git cherry-pick 33f34cdc55698c90c69f1d94aa18ae064499f667  # lxd/storage/utils: Renames VolumeTypeNameToType to VolumeTypeNameToDBType
      git cherry-pick fc7bc96c2bfd2e1de6eaa91a6542d7b858ef15de  # lxd/storage: VolumeTypeNameToDBType usage
      git cherry-pick 7315b50e0b2502798d851ff9899962f33ff816b4  # lxd/storage/utils: Adds VolumeDBTypeToTypeName function
      git cherry-pick 7d5a1aff5a1ee5cf63b9b0000f2258c6f678bba4  # lxd/storage/utils: Comment consistency
      git cherry-pick 349aabda6a432c7c08ff744c037fab6092214837  # lxd/storage/utils: Renames and reworks VolumeUsedByRunningInstancesWithProfilesGet to VolumeUsedByInstances
      git cherry-pick 5b6b84b908a27de748bd802d8365e2d881301863  # lxd/storage/utils: Adds VolumeUsedByExclusiveRemoteInstancesWithProfiles function
      git cherry-pick ad47be2d19aff0236b8abae510397731d7eb3b4e  # lxd/cluster/connect: Reworks ConnectIfVolumeIsRemote to use storagePools.VolumeUsedByExclusiveRemoteInstancesWithProfiles
      git cherry-pick 3131dcf05b8bfa137c0b93e8402866e7767b2bfb  # lxd/device/disk: storagePools.VolumeUsedByExclusiveRemoteInstancesWithProfiles usage
      git cherry-pick 0330cfdfc7622411257d2956bb7ec0acaf0f6639  # lxd/storage/volumes: storagePools.VolumeTypeNameToDBType usage
      git cherry-pick 36807f0daec9bbccf85537e46ef640bb25fb7e38  # lxd/storage/volumes: Updates storagePoolVolumeTypePost to use updated storagePools.VolumeUsedByInstances
      git cherry-pick a08291abaddfa475676fc07dc4723b9dab121e34  # lxd/storage/backend/lxd: Updates UpdateCustomVolume to check for online resize support when resizing
      git cherry-pick 605a5ef44934e031a3ca7491de1103d20aed30a6  # lxd/storage/backend/lxd: Updates RestoreCustomVolume with VolumeUsedByInstances
      git cherry-pick c96d60cb8cdae1375c88158b0b402b7822965aa7  # lxd/storage/utils: Removes VolumeUsedByInstancesGet function as not properly project compliant
      git cherry-pick 25c858090be9eb0d243b398de7d4bf32e793abd1  # lxd/storage/volumes/utils: Replaces storagePools.VolumeUsedByInstancesGet usage with storagePools.VolumeUsedByInstances in storagePoolVolumeUsedByGet
      git cherry-pick 2cb2667ba968aa39d02e270bbd2b21f6af9ee4dc  # lxd/device/disk: Replace storagePools.VolumeUsedByInstancesGet usage with storagePools.VolumeUsedByInstances in storagePoolVolumeAttachShift
      git cherry-pick e9d1f56acc02b8e363a83ec29c9390a82b64e20b  # lxd/endpoints: Update error string in test
      git cherry-pick 8fb15e5905c30f8f32339e4867b61a4a77a6dc18  # shared/simplestreams: Record variant
      git cherry-pick 01b5156e9f1b5c60987d144933ae3546b71d0f4c  # shared/simplestreams: Fix sorting of images
      git cherry-pick 4c1e883f9dbb88e9e4850ae9c98e5a23839d3f74  # lxd/project/project: Updates StorageVolumeProjectFromRecord to not return error (as never populated)
      git cherry-pick 94a12db197d93e724177c6e883aa2c8c4d77d66b  # lxd/project/project: Adds NetworkProjectFromRecord function
      git cherry-pick 6377d807ae68da75ea446040b03eabd3bae9419e  # lxd/storage/utils: project.StorageVolumeProjectFromRecord usage
      git cherry-pick 7b5459b6b2e27efec8c2db41dc9323bfcdabcd5c  # lxd/network/driver/ovn: Adds NIC external route overlap validation of other OVN external network subnets and OVN NIC external routes
      git cherry-pick 915e8f4e3790f581a87cfb9eed9d6556be26c1bb  # lxd/device/nic/ovn: Updates ovnNet interface's InstanceDevicePortValidateExternalRoutes to add instance argument
      git cherry-pick adf25c88f888242b9e4b5f0b63da8ffde1dbba74  # lxd/device/nic/ovn: d.network.InstanceDevicePortValidateExternalRoutes usage
      git cherry-pick d735de0a151eda78d7f73b157f91789ad38d396e  # lxd/instance/qmp: Merge Go routines
      git cherry-pick 365d4e97556e10d7997502dbaeb5de78bc4a4d90  # shared/cancel: Close chDone on failure
      git cherry-pick 5dbef17cb415de8e3ef5acb3349ae4b77e61ceb9  # lxd: Only close doneCh on success
      git cherry-pick cfedcd1035cfc272bee1f099ad1ed6b420ff6e9b  # i18n: Update translations from weblate
      git cherry-pick f899806b77a562de10764e8f52afb0ac1d6d52fd  # lxd/network/driver/ovn: Adds ovnProjectNetworksWithUplink function
      git cherry-pick c6d6045b8f43cf749666eefe99e6c4fa0d36d2e9  # lxd/network/driver/ovn: Updates ovnNetworkExternalSubnets to allow optional filtering of our own network's subnets
      git cherry-pick 7872cdf100bfb56814b20357c8d869da194d6db3  # lxd/network/driver/ovn: Updates ovnNICExternalRoutes to optionally filter our own NIC's external routes
      git cherry-pick f412f79828a7f4eda4a2644695d06d2ffdf6ee44  # lxd/network/driver/ovn: Updates InstanceDevicePortValidateExternalRoutes to use new functions and signatures
      git cherry-pick 32caf54ea296696580b2f43e50a9c76a1b94356f  # lxd/network/driver/ovn: Updates Validate to check external subnets dont overlap with other OVN networks or NICs sharing our uplink
      git cherry-pick e73ed20b8d9640347332a81ade7387a149204004  # lxd/network/openvswitch/ovn: Return ErrOVNNoPortIPs in LogicalSwitchPortSetDNS when no port IPs found
      git cherry-pick 30943207705f4424c01106cad890d2d7656e208f  # lxd/network/driver/ovn: Retry LogicalSwitchPortSetDNS up to 5 times to avoid missing dynamic IP allocation by OVN
      git cherry-pick 0814fd4d1145147f09314b64bd9b9740acb3be79  # exec: make sure to only use TIOCGPTPEER if available

      # Download any new dependencies
      export GOPATH=$(realpath ../go)
      go get -t -d ./...

      # Setup for our shared libraries
      sed -i "/\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/canonical/go-dqlite/internal/bindings/server.go
      sed -i "/^\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/mattn/go-sqlite3/sqlite3.go

      # Run the standard build
      set +ex
      snapcraftctl build
      set -ex

      # Build the agent (special build tags)
      CGO_ENABLED=0 go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd-agent" -tags=agent,netgo github.com/lxc/lxd/lxd-agent

      # Setup bash completion
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/
      cp scripts/bash/lxd-client ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/share/misc/: share/misc/
      var/lib/usbutils/usb.ids: share/misc/
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/dnsmasq
      - bin/getfattr
      - bin/setfattr
      - bin/iw
      - bin/pigz
      - bin/rsync
      - bin/setfacl
      - bin/sgdisk
      - bin/unsquashfs
      - bin/xdelta3

      - etc/bash_completion.d/snap.lxd.lxc

      - share/misc

      - bin/lxc
      - bin/lxc-to-lxd
      - bin/lxd
      - bin/lxd-agent
      - bin/lxd-benchmark

  lxd-migrate:
    source: lxd-migrate/
    after:
      - lxd
      - sqlite
    plugin: go
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd-pkg-snap/lxd-migrate
    override-build: |
      set -ex

      # Setup for our shared libraries
      sed -i "/^\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/mattn/go-sqlite3/sqlite3.go

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p ${SNAPCRAFT_PART_INSTALL}/bin/
      cp scripts/upgrade-bridge ${SNAPCRAFT_PART_INSTALL}/bin/upgrade-bridge
    prime:
      - bin/lxd-migrate
      - bin/upgrade-bridge

  shmounts:
    source: shmounts/
    plugin: make
    prime:
      - bin/setup-shmounts

  snap-query:
    source: snap-query/
    plugin: go
    go-importpath: github.com/lxc/lxd-pkg-snap/snap-query
    prime:
      - bin/snap-query

  strip:
    source: snapcraft/empty
    after:
      - btrfs
      - ceph
      - dqlite
      - libseccomp
      - logrotate
      - lvm
      - nano
      - nvidia-container
      - openvswitch
      - ovn
      - raft
      - sqlite
      - squashfs-tools-ng
      - vim
      - xfs
      - xtables
      - xz
      - zfs-0-6
      - zfs-0-7
      - zfs-0-8
      - lxc
      - lxcfs
      - criu
      - lxd
      - lxd-migrate
      - shmounts
      - snap-query
    plugin: nil
    override-prime: |
      set -x

      # Strip some of the heavy bits
      strip -s ${SNAPCRAFT_PRIME}/bin/lxc
      strip -s ${SNAPCRAFT_PRIME}/bin/lxd*
      strip -s ${SNAPCRAFT_PRIME}/bin/snap*
      strip -s ${SNAPCRAFT_PRIME}/lib/liblxc*
      strip -s ${SNAPCRAFT_PRIME}/lib/libdqlite*
      strip -s ${SNAPCRAFT_PRIME}/lib/libsqlite*

      for zfs in zfs-0.6 zfs-0.7 zfs-0.8; do
          [ ! -d "${SNAPCRAFT_PRIME}/${zfs}" ] && continue
          strip -s ${SNAPCRAFT_PRIME}/${zfs}/bin/* ${SNAPCRAFT_PRIME}/${zfs}/lib/*
      done

      [ -e "${SNAPCRAFT_PRIME}/criu/criu" ] && strip -s ${SNAPCRAFT_PRIME}/criu/criu

      exit 0

  wrappers:
    plugin: dump
    source: snapcraft/
    organize:
      hooks/: snap/hooks/
