name: lxd
base: core18
assumes:
  - snapd2.39
version: "4.6"
grade: stable
summary: LXD - the container lightervisor
description: |-
 LXD is a container manager for system containers.

 It offers a REST API to remotely manage containers over the network,
 using an image based workflow and with support for live migration.

 Images are available for all Ubuntu releases and architectures as well
 as for a wide number of other Linux distributions.

 LXD containers are lightweight, secure by default and a great
 alternative to virtual machines.


 Supported configuration options (snap set lxd [<key>=<value>...]):

   - ceph.builtin: Use snap-specific Ceph configuration [default=false]
   - ceph.external: Use the system's ceph tools (ignores ceph.builtin) [default=false]
   - criu.enable: Enable experimental live-migration support [default=false]
   - daemon.debug: Increase logging to debug level [default=false]
   - daemon.group: Set group of users that can interact with LXD [default=lxd]
   - daemon.preseed: Pass a YAML configuration to `lxd init` on initial start
   - daemon.syslog: Send LXD log events to syslog [default=false]
   - lvm.external: Use the system's LVM tools [default=false]
   - lxcfs.pidfd: Start per-container process tracking [default=false]
   - lxcfs.loadavg: Start tracking per-container load average [default=false]
   - lxcfs.cfs: Consider CPU shares for CPU usage [default=false]
   - openvswitch.builtin: Run a snap-specific OVS daemon [default=false]
   - shiftfs.enable: Enable shiftfs support [default=auto]

confinement: strict

apps:
  # Main commands
  activate:
    command: commands/daemon.activate
    daemon: oneshot
    plugs:
      - lxd-support
      - system-observe

  daemon:
    command: commands/daemon.start
    reload-command: commands/daemon.reload
    stop-command: commands/daemon.stop
    stop-timeout: 600s
    restart-condition: on-failure
    daemon: simple
    slots: [lxd]
    plugs:
      - lxd-support
      - network-bind
      - system-observe
    sockets:
      unix:
        listen-stream: $SNAP_COMMON/lxd/unix.socket
        socket-mode: 0660

  lxc:
    command: commands/lxc
    completer: etc/bash_completion.d/snap.lxd.lxc
    plugs:
      - lxd-support
      - system-observe

  lxd:
    command: commands/lxd
    plugs:
      - lxd-support
      - system-observe

  # Sub-commands
  benchmark:
    command: commands/lxd-benchmark
    plugs:
      - lxd-support
      - system-observe
  buginfo:
    command: commands/buginfo
    plugs:
      - lxd-support
      - system-observe
  check-kernel:
    command: commands/lxd-check-kernel
    plugs:
      - lxd-support
      - system-observe
  lxc-to-lxd:
    command: commands/lxc-to-lxd
    plugs:
      - lxd-support
      - system-observe
  migrate:
    command: commands/lxd-migrate
    plugs:
      - lxd-support
      - system-observe

hooks:
  configure:
    plugs:
      - network
      - system-observe
  remove:
    plugs:
      - lxd-support
      - system-observe

parts:
  # Dependencies
  btrfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - btrfs-tools
    prime:
      - bin/btrfs
      - bin/btrfstune
      - bin/mkfs.btrfs

  ceph:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ceph-common
      - libdb5.3
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/ceph
      - bin/python
      - bin/python2*
      - bin/rbd
      - lib/python2.7
      - lib/*/libpython2.7.so*
      - -lib/python2.7/sitecustomize.py
      - lib/*/ceph
      - lib/*/libboost_iostreams.so.*
      - lib/*/libboost_program_options.so.*
      - lib/*/libboost_random.so.*
      - lib/*/libboost_regex.so.*
      - lib/*/libboost_system.so.*
      - lib/*/libboost_thread.so.*
      - lib/*/libcephfs*
      - lib/*/libdb-5.3.so
      - lib/*/libicudata.so.*
      - lib/*/libicui18n.so.*
      - lib/*/libicuuc.so.*
      - lib/*/libnspr4.so
      - lib/*/libnss3.so
      - lib/*/libibverbs.so*
      - lib/*/nss/libsoftokn3.so
      - lib/*/nss/libfreeblpriv3.so
      - lib/*/libnssutil3.so
      - lib/*/libplc4.so
      - lib/*/libplds4.so
      - lib/*/librados.so.*
      - lib/*/librbd.so.*
      - lib/*/libsmime3.so
      - lib/*/libsnappy*

  criu:
    source: https://github.com/checkpoint-restore/criu
    source-tag: v3.14
    source-type: git
    source-depth: 1
    plugin: nil
    build-packages:
      - asciidoc
      - libcap-dev
      - libnet1-dev
      - libnl-3-dev
      - libprotobuf-c-dev
      - libprotobuf-dev
      - protobuf-c-compiler
      - protobuf-compiler
      - python
      - xmlto
    stage-packages:
      - libnet1
      - libprotobuf-c1
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "armv7l" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      make
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/criu/"
      cp criu/criu "${SNAPCRAFT_PART_INSTALL}/criu/"
    organize:
      usr/lib/: lib/
    prime:
      - criu/*
      - lib/*/libnet*
      - lib/*/libproto*

  dqlite:
    after:
      - raft
      - sqlite
    source: https://github.com/canonical/dqlite
    source-type: git
    source-depth: 1
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libdqlite*so*
      - lib/*/libuv*

  edk2:
    source: https://github.com/tianocore/edk2
    source-type: git
    source-tag: edk2-stable202008
    source-depth: 1
    plugin: nil
    build-packages:
      - acpica-tools
      - nasm
      - uuid-dev
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      # Apply patches
      patch -p1 < "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0001-force-DUID-LLT.patch"
      cp "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0002-logo.bmp" MdeModulePkg/Logo/Logo.bmp
      patch -p1 < "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0003-boot-delay.patch"

      ARCH="X64"
      PKG="OvmfPkg/OvmfPkgX64.dsc"
      FV_CODE="OVMF_CODE"
      FV_VARS="OVMF_VARS"
      if [ "$(uname -m)" = "aarch64" ]; then
          ARCH="AARCH64"
          PKG="ArmVirtPkg/ArmVirtQemu.dsc"
          FV_CODE="QEMU_EFI"
          FV_VARS="QEMU_VARS"
      fi

      # Run in a bash sub-shell as edksetup.sh requires it
      set -ex
      (
      cat << EOF
          . ./edksetup.sh
          make -C BaseTools ARCH=${ARCH}
          build -a ${ARCH} -t GCC49 -b RELEASE -p ${PKG} \
            -DSECURE_BOOT_ENABLE=TRUE \
            -DNETWORK_IP4_ENABLE=TRUE \
            -DNETWORK_IP6_ENABLE=TRUE \
            -DNETWORK_TLS_ENABLE=TRUE \
            -DNETWORK_HTTP_BOOT_ENABLE=TRUE \
            -DFD_SIZE_2MB \
            -DTPM2_ENABLE=TRUE
      EOF
      ) | bash -e

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      cp Build/*/*/FV/${FV_CODE}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
      cp Build/*/*/FV/${FV_VARS}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"

      if [ "$(uname -m)" = "aarch64" ]; then
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"
      fi

    prime:
      - share/qemu/*

  libmnl:
    source: https://git.netfilter.org/libmnl
    source-type: git
    source-tag: libmnl-1.0.4
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libmnl*so*

  libnftnl:
    after:
      - libmnl
    source: https://git.netfilter.org/libnftnl
    source-type: git
    source-tag: libnftnl-1.1.7
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libnftnl*so*

  libseccomp:
    source: https://github.com/seccomp/libseccomp
    source-type: git
    source-tag: v2.5.0
    source-depth: 1
    plugin: autotools
    build-packages:
      - gperf
    organize:
      usr/lib/: lib/
    prime:
      - lib/libseccomp*so*

  logrotate:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - logrotate
      - libpopt0
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    stage:
      - bin/logrotate
    prime:
      - bin/logrotate
      - lib/*/libpopt*so*

  lvm:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - dmeventd
      - lvm2
      - thin-provisioning-tools
    organize:
      sbin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/cache_*
      - bin/dmeventd
      - bin/era_*
      - bin/lv*
      - bin/pdata_tools
      - bin/pv*
      - bin/thin_*
      - bin/vg*
      - -bin/vgimportclone
      - -bin/lvmconf
      - -bin/lvmdump
      - -bin/lvmetad
      - -bin/lvmpolld
      - etc/lvm/lvm.conf
      - lib/*/device-mapper/*
      - lib/*/libaio.so*
      - lib/*/libdevmapper*
      - lib/*/liblvm*
      - lib/*/libreadline.so*

  nano:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - nano
    organize:
      usr/bin/: bin/
    prime:
      - bin/nano
      - etc/nanorc

  nftables:
    after:
      - libmnl
      - libnftnl
    source: https://git.netfilter.org/nftables
    source-type: git
    source-tag: v0.9.6
    plugin: autotools
    configflags:
      - --with-json
    build-packages:
      - libjansson-dev
      - libreadline-dev
    stage-packages:
      - libjansson4
    organize:
      sbin/: bin/
      usr/lib/: lib/
    prime:
      - bin/nft
      - lib/*/libjansson*so*
      - lib/libnftables*so*

  nvidia-container:
    after:
      - libseccomp
    source: https://github.com/NVIDIA/libnvidia-container
    source-type: git
    source-tag: v1.2.0
    source-depth: 1
    plugin: make
    build-packages:
      - bmake
      - curl
      - lsb-release
    override-build: |-
      set -ex

      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/bin/"
      cp ${SNAPCRAFT_PROJECT_DIR}/snapcraft/wrappers/nvidia-container-cli "${SNAPCRAFT_PART_INSTALL}/bin/"

      set +ex
      snapcraftctl build
    organize:
      usr/local/bin/nvidia-container-cli: bin/nvidia-container-cli.real
      usr/local/lib: lib/
    prime:
      - bin/nvidia-container-cli*
      - lib/libnvidia-container.so*

  openvswitch:
    source: https://github.com/openvswitch/ovs
    source-type: git
    source-tag: v2.14.0
    source-depth: 1
    plugin: autotools
    stage-packages:
      - uuid-runtime
    organize:
      sbin/: bin/
      usr/bin/: bin/
    prime:
      - bin/ovs-appctl
      - bin/ovs-vsctl
      - bin/ovs-vswitchd
      - bin/ovsdb-*
      - bin/uuidgen
      - share/openvswitch/

  ovn:
    after:
      - openvswitch
    source: https://github.com/ovn-org/ovn
    source-type: git
    source-tag: v20.06.2
    source-depth: 1
    configflags:
      - --with-ovs-source=../../openvswitch/build/
    plugin: autotools
    prime:
      - bin/ovn-nbctl

  spice-protocol:
    source: https://gitlab.freedesktop.org/spice/spice-protocol
    source-type: git
    source-tag: v0.14.2
    source-depth: 1
    plugin: meson
    prime: []

  spice-server:
    after:
      - spice-protocol
    source: https://gitlab.freedesktop.org/spice/spice
    source-type: git
    source-tag: v0.14.3
    source-depth: 1
    plugin: meson
    meson-parameters:
      - --prefix=/
      - -Dgstreamer=no
      - -Dmanual=false
      - -Dlz4=false
      - -Dsasl=false
      - -Dopus=disabled
      - -Dsmartcard=disabled
      - -Dtests=false
    build-packages:
      - libjpeg-turbo8-dev
      - python3-pyparsing
      - python3-six
    stage-packages:
      - libjpeg-turbo8
      - libpixman-1-0
    organize:
      sbin/: bin/
      usr/lib: lib/
      usr/local/lib/: lib/
    prime:
      - lib/*/libjpeg*so*
      - lib/*/libspice-server*so*
      - lib/*/libpixman*so*

  qemu:
    after:
      - libseccomp
      - spice-protocol
      - spice-server
    source: IRRELEVANT
    source-type: git
    plugin: autotools
    configflags:
      - --disable-bochs
      - --disable-cloop
      - --disable-dmg
      - --disable-docs
      - --disable-guest-agent
      - --disable-parallels
      - --disable-qed
      - --disable-sheepdog
      - --disable-slirp
      - --disable-user
      - --disable-vdi
      - --disable-vnc
      - --disable-xen
      - --enable-attr
      - --enable-cap-ng
      - --enable-kvm
      - --enable-linux-aio
      - --enable-numa
      - --enable-pie
      - --enable-rbd
      - --enable-seccomp
      - --enable-spice
      - --enable-system
      - --enable-tcg
      - --enable-tools
      - --enable-vhost-crypto
      - --enable-vhost-kernel
      - --enable-vhost-net
      - --enable-vhost-scsi
      - --enable-vhost-user
      - --enable-vhost-vsock
      - --enable-virtfs
      - --firmwarepath=/snap/lxd/current/share/qemu/
    build-packages:
      - bison
      - flex
      - pkg-config
      - libaio-dev
      - libcap-ng-dev
      - libglib2.0-dev
      - libnuma-dev
      - libpixman-1-dev
      - librbd-dev
    stage-packages:
      - genisoimage
      - libmagic1
      - libnuma1
      - libpixman-1-0
    override-pull: |-
      set -ex
      git clone https://git.qemu.org/git/qemu.git . -b v5.1.0 --depth 1
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && [ "$(uname -m)" != "ppc64le" ] && [ "$(uname -m)" != "s390x" ] && exit 0

      set -ex
      # Mangle the configure a bit
      QEMUARCH="$(uname -m)"
      [ "${QEMUARCH}" = "ppc64le" ] && QEMUARCH="ppc64"
      sed -i "s/^unset target_list$/target_list=\"${QEMUARCH}-softmmu\"/" configure
      sed -i 's#libseccomp_minver=".*#libseccomp_minver="0.0"#g' configure

      set +ex
      snapcraftctl build
    organize:
      libexec/: bin/
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/genisoimage*
      - bin/mkisofs*
      - bin/qemu-system-*
      - bin/qemu-img*
      - bin/virtfs-proxy-helper*
      - lib/*/libmagic*so*
      - lib/*/libnuma*so*
      - lib/*/libpixman*so*
      - share/qemu/keymaps*
      - share/qemu/efi-virtio.rom*
      - share/qemu/kvmvapic.bin*
      - share/qemu/s390-*.img*
      - share/qemu/slof.bin*
      - share/qemu/vgabios-*.bin*

  qemu-ovmf-secureboot:
    after:
      - edk2
      - qemu
    source: https://github.com/puiterwijk/qemu-ovmf-secureboot
    source-type: git
    source-depth: 1
    plugin: nil
    build-packages:
      - xorriso
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      set -ex
      rm -Rf iso-root vfat-root shell.iso
      mkdir -p iso-root vfat-root/efi/boot
      cp ../../edk2/build/Build/*/*/*/Shell.efi vfat-root/efi/boot/bootx64.efi
      cp ../../edk2/build/Build/*/*/*/EnrollDefaultKeys.efi vfat-root/
      "${SNAPCRAFT_STAGE}/bin/qemu-img" convert --image-opts driver=vvfat,floppy=on,fat-type=12,label=UEFI_SHELL,dir=vfat-root iso-root/shell.img
      xorriso --as mkisofs -input-charset ASCII -J -rational-rock -e shell.img -no-emul-boot -o shell.iso iso-root/

      # Basic aarch64 support
      if [ "$(uname -m)" = "aarch64" ]; then
          sed -i ovmf-vars-generator \
              -e "s/'-machine', machinetype,/'-machine', 'virt', '-cpu', 'cortex-a57',/" \
              -e "/charserial1/d" \
              -e "s/ide-cd/scsi-cd/" \
              -e "s/'-device',$/'-device', 'virtio-scsi-pci,id=scsi', '-device',/"
      elif [ "$(uname -m)" = "x86_64" ]; then
          cp -f "${SNAPCRAFT_STAGE}/share/qemu/kvmvapic.bin" .
      fi

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      python3 ovmf-vars-generator \
        --qemu-binary "${SNAPCRAFT_STAGE}/bin/qemu-system-$(uname -m)" \
        --print-output --disable-smm --skip-testing \
        --oem-string "$(cat ${SNAPCRAFT_PROJECT_DIR}/snapcraft/etc/ubuntu-sb.crt)" \
        --ovmf-binary "${SNAPCRAFT_STAGE}/share/qemu/OVMF_CODE.fd" \
        --ovmf-template-vars "${SNAPCRAFT_STAGE}/share/qemu/OVMF_VARS.fd" \
        --uefi-shell-iso shell.iso \
        "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.ms.fd"
    prime:
      - share/qemu/*

  raft:
    source: https://github.com/canonical/raft
    source-type: git
    source-depth: 1
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libraft*so*

  sqlite:
    source: https://github.com/sqlite/sqlite
    source-type: git
    source-depth: 1
    source-tag: version-3.33.0
    plugin: autotools
    build-packages:
      - tcl
    override-build: |-
      set -ex

      git log -1 --format=format:%ci%n | sed -e 's/ [-+].*$//;s/ /T/;s/^/D /' > manifest
      git log -1 --format=format:%H > manifest.uuid
      cp /usr/share/misc/config.guess .
      cp /usr/share/misc/config.sub .
      autoreconf -f -i

      set +ex
      snapcraftctl build
    prime:
      - bin/sqlite3
      - lib/libsqlite3*so*

  squashfs-tools-ng:
    source: https://github.com/AgentD/squashfs-tools-ng
    source-type: git
    source-tag: v1.0.2
    source-depth: 1
    plugin: autotools
    build-packages:
      - liblzma-dev
    prime:
      - bin/sqfs2tar
      - bin/tar2sqfs
      - lib/libsquashfs.so*

  vim:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - vim-tiny
    organize:
      usr/bin/: bin/
      usr/share/vim/vim*/debian.vim: etc/vimrc
    prime:
      - bin/vim.tiny
      - etc/vimrc

  xfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xfsprogs
    organize:
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/xfs_admin
      - bin/xfs_db
      - bin/xfs_growfs
      - bin/xfs_repair
      - bin/mkfs.xfs

  xtables:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ebtables
      - iptables
      - xtables-addons-common
    organize:
      usr/lib/*/xtables/*: lib/xtables/
      lib/ebtables/*: lib/
      sbin/: bin/
    prime:
      - bin/ebtables
      - etc/ethertypes
      - etc/protocols
      - lib/libebt*
      - lib/xtables/*

  xz:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xz-utils
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/lzma
      - bin/xz
      - lib/*/liblzma*so*
    override-build: |
      snapcraftctl build

      # Include the lzma symlink
      ln -s xz "${SNAPCRAFT_PART_INSTALL}/usr/bin/lzma"

  zfs-0-6:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.6.5.11
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick fb963d33ee0dd350143ba1c9cd35d5f7d86910d2  # Fix endian build problem on ppc64el

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-7:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.7.13
    source-depth: 1
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-8:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.8.4
    source-depth: 1
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  # Core components
  lxc:
    after:
      - libseccomp
    source: https://github.com/lxc/lxc
    source-type: git
    source-tag: lxc-4.0.4
    build-packages:
      - libapparmor-dev
      - libcap-dev
      - libgnutls28-dev
      - libselinux1-dev
      - pkg-config
    plugin: autotools
    configflags:
      - --disable-api-docs
      - --disable-bash
      - --disable-doc
      - --disable-examples
      - --disable-memfd-rexec
      - --disable-tests
      - --disable-tools
      - --enable-apparmor
      - --enable-seccomp
      - --enable-selinux
      - --enable-capabilities
      - --with-rootfs-path=/var/snap/lxd/common/lxc/
      - --libexecdir=/snap/lxd/current/libexec/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/libexec: libexec
      share/lxc/hooks: lxc/hooks
    prime:
      - bin/lxc-checkconfig
      - lib/liblxc.so.1
      - lib/liblxc.so.1.*
      - lxc/config/common.conf.d
      - lxc/hooks/nvidia
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/
      ln -s /var/snap/lxd/common/lxc/local.conf $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/01-local.conf
      sed -i "s#includedir=.*#includedir=$SNAPCRAFT_PART_INSTALL/include#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc
      sed -i "s#libdir=.*#libdir=$SNAPCRAFT_PART_INSTALL/lib#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc

  lxcfs:
    source: https://github.com/lxc/lxcfs
    source-type: git
    source-tag: lxcfs-4.0.5
    build-packages:
      - libfuse-dev
      - libpam0g-dev
      - pkg-config
    stage-packages:
      - fuse
    plugin: autotools
    configflags:
      - --datarootdir=/snap/lxd/current/
      - --localstatedir=/var/snap/lxd/common/var/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/lxcfs: lxcfs
      lib/lxcfs: lib
    prime:
      - bin/fusermount
      - lib/*/libfuse.so.*

      - bin/lxcfs
      - lib/liblxcfs.so

      - lxc
      - lxcfs
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      set +ex
      snapcraftctl build
      set -ex

      sed -i "s#\${LXC_ROOTFS_MOUNT}/var/snap/lxd/common/var/lib/lxcfs/#\${LXC_ROOTFS_MOUNT}/var/lib/lxcfs/#g" $SNAPCRAFT_PART_INSTALL/snap/lxd/current/lxcfs/lxc.mount.hook

  lxd:
    source: https://github.com/lxc/lxd
    source-type: git
    source-tag: lxd-4.6
    after:
      - lxc
      - dqlite
      - sqlite
    build-packages:
      - libacl1-dev
      - libudev-dev
      - pkg-config
    stage-packages:
      - acl
      - attr
      - dnsmasq-base
      - gdisk
      - iw
      - netbase
      - pciutils
      - pigz
      - rsync
      - squashfs-tools
      - usbutils
      - xdelta3
    plugin: nogetgo
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd
    go-packages:
      - github.com/lxc/lxd/lxc
      - github.com/lxc/lxd/lxc-to-lxd
      - github.com/lxc/lxd/lxd
      - github.com/lxc/lxd/lxd-benchmark
    override-build: |
      set -ex

      # Git cherry-picks
      cd ../src
      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick e3b3aa1a51857af55eafa4f4ca091a2c009deaff  # lxd/apparmor: Allow unix sockets binding
      git cherry-pick f2f4cc35348c285248b561c735ddb044ea2d6fc3  # doc/server: Fix escaping
      git cherry-pick 4279a2c1e7e70f55b94da9cdff8604233402aca2  # doc/server: Sort config keys
      git cherry-pick e036ffc0f0da58b431905ab85d0b36b7de42c050  # lxd/network/driver/ovn: Improve error message when parent 'network' option not specified
      git cherry-pick cbcd0da2fa9b5fdc43d114c97138d45e7f8a91c5  # lxd/network/network/interface: Adds Type interface and moves non-DB depedent functions into it
      git cherry-pick 4454e4c9a3fd5c9b04dacfdad6b4d2b6fa811410  # lxd/network/network/load: Adds LoadByType function and removes ValidateNameAndProject function
      git cherry-pick 335ba9bdb20c22f0b278a2b3a05bfa15772bc652  # lxd/main/init/interactive: netType.ValidateName usage
      git cherry-pick ceb500dd55671f4ec71fdb5cbdae82f5b3daa03d  # lxd/networks: Switch to network type validation in networksPost
      git cherry-pick e5f92170652d5e9349732da43b5a4be23997e190  # lxd/networks: Use ValidateName function on loaded DB network in networkPost
      git cherry-pick 77b5b0bded45befed01c10891a81c50e9498e1a3  # lxd/network/network/interface: Exports FillConfig
      git cherry-pick 2b77135298ef1f7cd6938171b24af452a473a040  # lxd/network/network/load: Removes FillConfig function
      git cherry-pick b7e848b5b22851f05c0a405858bfa5636fefb65e  # lxd/networks: netType.FillConfig usage
      git cherry-pick e3e07697081285cf4350a03012231071aad95483  # lxd/network/driver/common: Exports FillConfig
      git cherry-pick 2f642388b57522921a7317d36b671e69b98e3ea0  # lxd/network/driver/bridge: FillConfig usage
      git cherry-pick 7f3b012ba2e67be527e890a64814f5a25f064c84  # lxd/network/driver/ovn: FillConfig usage
      git cherry-pick a1a80fd6e884fc1fe2a629932745ec1ed68a74e6  # lxd/network/driver/common: Removes common Type() and netType
      git cherry-pick adadc6640b27bc7c0947b5435307f430d7487d01  # lxd/network: Adds Type() to each driver
      git cherry-pick 861ae0d937cb927b0a1a2911a837a228583485dd  # lxd/db/errors: Updates ErrAlreadyDefined text to be generic
      git cherry-pick 7a06fbc31b0a7a226a6fcf6c32c734a9b4891c07  # lxd/network/network/interface: Adds DBType function
      git cherry-pick cb5a4da6a6bd2ab19ce3369aeca8c2c75be0c8a1  # lxd/network/driver: Implements DBType()
      git cherry-pick a8c46bcfb5690b4b147290fda2e7e4bd690d3261  # lxd/network/driver: Adds NodeSpecificConfig Info var
      git cherry-pick d0ae93e802f66b9e7df9c53cd2a87f562b6d95a9  # lxd/networks: netType.DBType usage in networksPost
      git cherry-pick c1da0f64ee2bfa0e1b921ee86b6c4e5973e14e52  # lxd/networks: Create pending network node entries when network driver doesn't support per node config in networksPost
      git cherry-pick 23f7b060e67e6ff36d2f078aeb664d4df6fcb54c  # lxd/networks: Comments in networksPostCluster
      git cherry-pick ea611ba00aefe90264aecf9a165e956d6a625b71  # lxd/networks: Comments in networkGet
      git cherry-pick df23ec594d2c743657b702634b8f3f63a935f96a  # lxd/networks: Start parent networks before dependents in networkStartup
      git cherry-pick 042d779d41f51423e07e7189c3ba56aa136a7b52  # lxd: Ensure all use of db.InstanceFilter defines instance type
      git cherry-pick 22c0a441c199d2605a50cdb4f9e7cdda9bd694af  # lxd/project/permissions: Fixes AllowInstanceCreation tests
      git cherry-pick a20bd59a851374262598d8f35678895484b8ce68  # lxd/project/permissions: Error quoting
      git cherry-pick f96a2cd91a908df865c9a6546e7c97cc7307aab3  # api: Add projects_networks
      git cherry-pick 79d6534ce4e95ef29bce11b5888dbb21246ebf09  # doc/storage: no need to escape underscore in bash examples
      git cherry-pick cbad2635672f8d91e0f09a2ae7c000e7c3c0bb27  # seccomp: fix bpf support detection
      git cherry-pick d387805be00fc51b03478e9a35948c029945ffaf  # seccomp: improve bpf support detection
      git cherry-pick 6a43c6dcc11ed81d42a91f352ff70cc1d8216206  # shared/validate: Use ParseUint in IsNetworkMTU
      git cherry-pick cefdfacababb21e9a4768b58103a4c3684685091  # lxd/device/device/utils/network: Change argument for NetworkSetDevMTU to uint32
      git cherry-pick b61d96bf5ca63e8699dad37747b889c90e85cbc4  # lxd/device/device/utils/network: NetworkSetDevMTU usage
      git cherry-pick 13cda6c28fcdfa075937cbd30f6518f594b3101c  # lxd/network/network/utils: Changes GetDevMTU to return uint32
      git cherry-pick 7376a8b6158877b9c74ae35aadabe067031b4bf1  # lxd/network/openvswitch/ovs: Adds OVNEncapIP function
      git cherry-pick 2f43a2aa00c15f4af7ada85be3a29d21a42db635  # lxd/network/driver/ovn: Removes ovnGeneveTunnelMTU constant
      git cherry-pick b477c2ad2f469e5b924b280a214eca137f32f6e1  # lxd/network/network/utils/ovn: Removes OVNInstanceDeviceMTU function
      git cherry-pick fb736aa95fda2ed776214fa246b61f6925a6027e  # lxd/network/driver/ovn: Updates getBridgeMTU() to not depend on ovnGeneveTunnelMTU
      git cherry-pick 92ece4e18217153b0fc6916ce84ad8b310947541  # lxd/network/driver/ovn: Adds getOptimalBridgeMTU and getUnderlayInfo functions
      git cherry-pick 06e202eebb81507929ec4db9cc6f11e2f84b3d33  # lxd/network/driver/ovn: Updates setup to generate an optimal bridge.mtu setting if not specified manually
      git cherry-pick 61d1746d413cea4407390aa1a7ef16a6ee7cc6e1  # lxd/device/nic/ovn: Read mtu directly from parent network config bridge.mtu setting
      git cherry-pick 602317cfa68ffc3c9ad0dd8153632c7b9c5e56bd  # doc/projects: Sort config keys
      git cherry-pick 4d80efb2f88ce568e93091259131b083c675eb95  # lxd/networks: Enforces manage-networks RBAC permission for managing networks
      git cherry-pick 8db55cde37fa40df1b8dfb04329615a60018fd19  # lxd/network: Only adding pseudo pending node records when in cluster in networksPost
      git cherry-pick 2f303a439a951f5486045cf8fddfd890d2ebce33  # lxd/project/permissions: Typo
      git cherry-pick df1a8dd966d4908066442d2d097c102556f1c42f  # lxd/db/cluster/open: Adds features.networks to default project on new database
      git cherry-pick bd1ea0d78544fd9bf75bebefea8a5149e74fea67  # lxd/storage/cephfs: Fix quota on new volumes
      git cherry-pick f14f82f79f89c26000e95a6af9027e6c707ba9d7  # lxd/networks: Allow network deletion in projects
      git cherry-pick 6dff7c78a8cde9e3540d01cbf560b935c60419f8  # lxc/remote: Add project selection logic
      git cherry-pick f003ec836f340df2a96e203c03cb5971177cafa2  # i18n: Update translation templates
      git cherry-pick 8ca190120f9461048bb38537a7ba1f1883e11a41  # lxd/network: Removes client side default network type when creating network
      git cherry-pick c896c22ae8c97cfb93ebf4112b6e6ecaa291bd48  # lxd/networks: Default to ovn network type when creating non-default network project
      git cherry-pick 48e033f6de2045dbf215e86d4faf187330d5d70e  # api: Adds projects_networks_restricted_uplinks extension
      git cherry-pick 42d501a30b97e77ee25e8387a7ca9760f6dff6f4  # doc/projects: Adds restricted.networks.uplinks
      git cherry-pick add26556ad9db02195bb715ade62e9abba9db837  # lxd/networks: Updates doNetworkUpdate to use n.Validate so that project is available to validator
      git cherry-pick 52a22db7d5b61e2474c69680dc2b1119ec0f064e  # lxd/network/network/load: Removes unused Validate
      git cherry-pick ef5ca1af5dc14c21d1df3af384542024fc99705f  # lxd/network/network/load: Renames project arg to projectName for clarity
      git cherry-pick 0b488101c87434b136e632d2d93c9ed2a7db49bf  # lxd/api/project: Adds restricted.networks.uplinks to validation
      git cherry-pick 6a618fa0e47989284f7ae7e569810821865d5576  # lxd/network/driver/ovn: Adds allowedUplinkNetworks function
      git cherry-pick cf73098ffb397fddf971eb38a957ed5066c6176f  # lxd/network/driver/ovn: Enforce project restricted.networks.uplinks setting
      git cherry-pick 1eb7e98b1d1a78c51b608bf787df70f9a2c7d1a8  # lxd/instances: Fix ceph cluster target move
      git cherry-pick 0e3c4e47b12e7b6f6be27dd7c0fd56c9a879a1f3  # lxd/cgroup: Fix memory.swappiness detection
      git cherry-pick d0e58fa8cc9cea7c7e1f6b2119ef607d72e3d83f  # lxd/db: Adds boolean support to doDbQueryScan
      git cherry-pick 3d2cc67697b656a544800b08a604fa6e60d3f127  # lxd/rbac: Avoid tight retry loop
      git cherry-pick 228860dc44aeb45ab6c66e7c5e2d77db2639938e  # lxd/rbac: Directly handle re-tries on 504
      git cherry-pick 42164f6dce4c5ee8da0c886257ebc131e97d28f9  # lxd/cluster: Changing "no heartbeat" language in membership.go "no heartbeat since <countup>" changed to "no heartbeat for <countup>"
      git cherry-pick f84333e000a695e0049825dff95e247e3b04db03  # lxc: Always use HostPathFollow
      git cherry-pick 1d2c94e8243400f399cdfec8d513264d55948c90  # lxd/api: Restrict access to daemon config
      git cherry-pick d44832f3aee87c28ba2fb777300d05bd90942d00  # lxd/storage: Allow ceph/cephfs for images/backups
      git cherry-pick ae4618cf9461a9e1def2fdf9196cc55f8cb3e841  # lxd/instance/drivers/qmp/monitor: Adds GetBalloonSizeBytes and SetBalloonSizeBytes
      git cherry-pick ce1351754831492749d31fb382c0f4e7f7bdff40  # lxd/instance/drivers/driver/qemu: Adds live shrinking of memory
      git cherry-pick 0b51318323d9dd230985bdb8487db38150de059b  # lxd/devices/config/devices/utils: Adds doc block for deviceEquals and deviceEqualsDiffKeys
      git cherry-pick 34005f4ff208b3bf3ae6a09652b71f89db47cfc4  # lxd/device/config/devices: Comment clean up
      git cherry-pick b95615216eb2fb8f700d1adb8a23c53c926fb4cc  # lxd/device/config/devices: Improves comments and variable naming in Update
      git cherry-pick 829ba4388584383f6a7f5371ac9b508b1f35245c  # lxd/device/config/devices: Fixes bug in Update where allChangedKeys only contains changed keys from last device
      git cherry-pick 26e5c27f1f116bcf75f5ac44d1218aa08d21e685  # lxd/instance/drivers/driver/lxc: Whitespace
      git cherry-pick b56bc946fc61d99a20a8c139b51ca6e3983e3c34  # lxd/device/config/devices: Handles nil updateFields function in Update
      git cherry-pick 6697599975c1199c226c00b68c7e3e278ea49c66  # lxd/instance/drivers/driver/qemu: Removes logic duplication in live update
      git cherry-pick 0bf336b3ecdafa531ee3c25c1018fe7dcfb6d4e5  # doc/networks: Simplifies OVN single node setup instructions
      git cherry-pick de431347e046b65c443d8bff35d9e87e808f9cfd  # lxd/device/nic/ovn: Improves error message in Start
      git cherry-pick a46531236c841f9fd01ca3161e1adc6f0763b887  # lxd/network/driver/ovn: Implements DHCPv4Subnet and DHCPv6Subnet to allow static IPs to be set
      git cherry-pick 0766ad84953fba91decadf04dbcfe96b1f4ad4b3  # lxd/network/openvswitch/ovn: Fix spelling of OVNIPv6AddressModeDHCPStateful and OVNIPv6AddressModeDHCPStateless values
      git cherry-pick 6aa321fb73571d9e2e43cfa345e6fa368b454a57  # lxd/network/driver/ovn: Adds support for ipv6.dhcp.stateful
      git cherry-pick 0d2cf135a5d60c5fa6623baa8b080197d0bb552e  # doc/networks: Documents ipv6.dhcp.stateful option for OVN networks
      git cherry-pick 7d4c992dcb0dc5a20268bf57c13c88dc8e9e4df0  # shared/api: Not all disks have a device path
      git cherry-pick b8e81ae1080fed777f8c64bc3a0de740da1dd70e  # lxd/resources: Ignore rbd devices
      git cherry-pick 1582df0ba263b46e951a17658e54aa3e116a1eb5  # lxd/device/device/interface: Adds NICState interface for getting NIC state
      git cherry-pick d20e4d219057ca357b56257061de3e1cc6046a81  # lxd/device/nic/bridged: Implements NICState interface by adding State function
      git cherry-pick 6b8e0926e4b0f54d0bb03ffb4e89961fd3ac5abd  # lxd/instance/drivers/driver/qemu: Refactors RenderState to support multiple NIC types in the future
      git cherry-pick 12e8ea647ff42d71960ba60e37dc59c8cdbddb09  # lxd/network/openvswitch/ovn: Adds LogicalSwitchPortDynamicIPs function
      git cherry-pick fd4135f6c6b9a5bd2e339f8d41c35f55469e082f  # lxd/network/openvswitch/ovn: Updates LogicalSwitchPortSetDNS to use LogicalSwitchPortDynamicIPs
      git cherry-pick e0e4ea8a1326b0746b6085742b38e15e923e5219  # lxd/network/driver/ovn: Adds instanceDevicePortDynamicIPs function
      git cherry-pick 3c02b3e001c90996562eda94f6dccc5f02054f72  # lxd/network/network/utils/ovn: Adds OVNInstanceDevicePortDynamicIPs function
      git cherry-pick d87da1a87b4d41b0ddad1b9b0b85b7b5793c84b7  # lxd/device/nic/ovn: Implements NICState interface by adding State function
      git cherry-pick 124aad5233ee89720edd6c137500d8c81a300508  # lxd/instance/drivers/qmp/monitor: Renames GetMemoryBalloonSizeBytes
      git cherry-pick 6f9663cc9d33bd27376c28155830eca3707b3072  # lxd/instance/drivers/qmp/monitor: Renames SetMemoryBalloonSizeBytes
      git cherry-pick 6ced837edcae82aee518f31af32c13fd06d36d88  # lxd/instance/drivers/qmp/monitor: Adds GetMemorySizeBytes function
      git cherry-pick 6c6cd366eeb1f5e0c3a6106f15975f8de6408f14  # lxd/instance/drivers/driver/qemu: Adds qemuDefaultMemSize constant
      git cherry-pick 0fff52b0db79b385b0ecfceb4cab9dd1110a30b5  # lxd/instance/drivers/driver/qemu: Updates updateMemoryLimit to allow memory resize back to boot time size
      git cherry-pick c2ea7cef7d6cee39ad87acec8024f408f172202f  # lxd/instance/drivers/driver/qemu: Updates IsRunning to not check for BROKEN state
      git cherry-pick 5ad910fcdfcb63e2daab337d1fefa0ede0a6f6ff  # lxd/instance/drivers/driver/qemu: Updates statusCode() to detect if monitor failure with running VM
      git cherry-pick 4950044cd42f5425c746da494b7e59bfd32833b8  # lxd/apparmor: Allow access to zoneinfo files
      git cherry-pick e821b245948d6257515a586390de3b1e9c0ec603  # lxd/apparmor: Add /etc/localtime to the list
      git cherry-pick 426a43f47025b9205ec36c1bf3931d09d40a681f  # lxd/project: Always allow cloud-init:config drives

      # Download any new dependencies
      export GOPATH=$(realpath ../go)
      go get -t -d ./...

      # Setup for our shared libraries
      sed -i "/\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/canonical/go-dqlite/internal/bindings/server.go
      sed -i "/^\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/mattn/go-sqlite3/sqlite3.go

      # Run the standard build
      set +ex
      snapcraftctl build
      set -ex

      # Build the agent (special build tags)
      CGO_ENABLED=0 go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd-agent" -tags=agent,netgo github.com/lxc/lxd/lxd-agent

      # Setup bash completion
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/
      echo 'export PATH="${PATH}:/snap/bin:/var/lib/snapd/snap/bin"' > ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
      cat scripts/bash/lxd-client >> ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/share/misc/: share/misc/
      var/lib/usbutils/usb.ids: share/misc/
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/dnsmasq
      - bin/getfattr
      - bin/setfattr
      - bin/iw
      - bin/pigz
      - bin/rsync
      - bin/setfacl
      - bin/sgdisk
      - bin/unsquashfs
      - bin/xdelta3

      - etc/bash_completion.d/snap.lxd.lxc

      - share/misc

      - bin/lxc
      - bin/lxc-to-lxd
      - bin/lxd
      - bin/lxd-agent
      - bin/lxd-benchmark

  lxd-migrate:
    source: lxd-migrate/
    after:
      - lxd
      - sqlite
    plugin: go
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd-pkg-snap/lxd-migrate
    override-build: |
      set -ex

      # Setup for our shared libraries
      sed -i "/^\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/mattn/go-sqlite3/sqlite3.go

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p ${SNAPCRAFT_PART_INSTALL}/bin/
      cp scripts/upgrade-bridge ${SNAPCRAFT_PART_INSTALL}/bin/upgrade-bridge
    prime:
      - bin/lxd-migrate
      - bin/upgrade-bridge

  shmounts:
    source: shmounts/
    plugin: make
    prime:
      - bin/setup-shmounts

  snap-query:
    source: snap-query/
    plugin: go
    go-importpath: github.com/lxc/lxd-pkg-snap/snap-query
    prime:
      - bin/snap-query

  strip:
    source: snapcraft/empty
    after:
      - btrfs
      - ceph
      - dqlite
      - libseccomp
      - logrotate
      - lvm
      - nano
      - nvidia-container
      - openvswitch
      - ovn
      - raft
      - sqlite
      - squashfs-tools-ng
      - vim
      - xfs
      - xtables
      - xz
      - zfs-0-6
      - zfs-0-7
      - zfs-0-8
      - lxc
      - lxcfs
      - criu
      - lxd
      - lxd-migrate
      - shmounts
      - snap-query
    plugin: nil
    override-prime: |
      set -x

      # Strip some of the heavy bits
      strip -s ${SNAPCRAFT_PRIME}/bin/lxc
      strip -s ${SNAPCRAFT_PRIME}/bin/lxd*
      strip -s ${SNAPCRAFT_PRIME}/bin/snap*
      strip -s ${SNAPCRAFT_PRIME}/lib/liblxc*
      strip -s ${SNAPCRAFT_PRIME}/lib/libdqlite*
      strip -s ${SNAPCRAFT_PRIME}/lib/libsqlite*

      for zfs in zfs-0.6 zfs-0.7 zfs-0.8; do
          [ ! -d "${SNAPCRAFT_PRIME}/${zfs}" ] && continue
          strip -s ${SNAPCRAFT_PRIME}/${zfs}/bin/* ${SNAPCRAFT_PRIME}/${zfs}/lib/*
      done

      [ -e "${SNAPCRAFT_PRIME}/criu/criu" ] && strip -s ${SNAPCRAFT_PRIME}/criu/criu

      exit 0

  wrappers:
    plugin: dump
    source: snapcraft/
    organize:
      hooks/: snap/hooks/
