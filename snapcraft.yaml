name: lxd
base: core18
assumes:
  - snapd2.39
version: "4.8"
grade: stable
summary: LXD - the container lightervisor
description: |-
 LXD is a container manager for system containers.

 It offers a REST API to remotely manage containers over the network,
 using an image based workflow and with support for live migration.

 Images are available for all Ubuntu releases and architectures as well
 as for a wide number of other Linux distributions.

 LXD containers are lightweight, secure by default and a great
 alternative to virtual machines.


 Supported configuration options (snap set lxd [<key>=<value>...]):

   - ceph.builtin: Use snap-specific Ceph configuration [default=false]
   - ceph.external: Use the system's ceph tools (ignores ceph.builtin) [default=false]
   - criu.enable: Enable experimental live-migration support [default=false]
   - daemon.debug: Increase logging to debug level [default=false]
   - daemon.group: Set group of users that can interact with LXD [default=lxd]
   - daemon.preseed: Pass a YAML configuration to `lxd init` on initial start
   - daemon.syslog: Send LXD log events to syslog [default=false]
   - lvm.external: Use the system's LVM tools [default=false]
   - lxcfs.pidfd: Start per-container process tracking [default=false]
   - lxcfs.loadavg: Start tracking per-container load average [default=false]
   - lxcfs.cfs: Consider CPU shares for CPU usage [default=false]
   - openvswitch.builtin: Run a snap-specific OVS daemon [default=false]
   - shiftfs.enable: Enable shiftfs support [default=auto]

confinement: strict

apps:
  # Main commands
  activate:
    command: commands/daemon.activate
    daemon: oneshot
    plugs:
      - lxd-support
      - system-observe

  daemon:
    command: commands/daemon.start
    reload-command: commands/daemon.reload
    stop-command: commands/daemon.stop
    stop-timeout: 600s
    restart-condition: on-failure
    daemon: simple
    slots: [lxd]
    plugs:
      - lxd-support
      - network-bind
      - system-observe
    sockets:
      unix:
        listen-stream: $SNAP_COMMON/lxd/unix.socket
        socket-mode: 0660

  lxc:
    command: commands/lxc
    completer: etc/bash_completion.d/snap.lxd.lxc
    plugs:
      - lxd-support
      - system-observe

  lxd:
    command: commands/lxd
    plugs:
      - lxd-support
      - system-observe

  # Sub-commands
  benchmark:
    command: commands/lxd-benchmark
    plugs:
      - lxd-support
      - system-observe
  buginfo:
    command: commands/buginfo
    plugs:
      - lxd-support
      - system-observe
  check-kernel:
    command: commands/lxd-check-kernel
    plugs:
      - lxd-support
      - system-observe
  lxc-to-lxd:
    command: commands/lxc-to-lxd
    plugs:
      - lxd-support
      - system-observe
  migrate:
    command: commands/lxd-migrate
    plugs:
      - lxd-support
      - system-observe

hooks:
  configure:
    plugs:
      - network
      - system-observe
  remove:
    plugs:
      - lxd-support
      - system-observe

parts:
  # Dependencies
  btrfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - btrfs-tools
    prime:
      - bin/btrfs
      - bin/btrfstune
      - bin/mkfs.btrfs

  ceph:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ceph-common
      - libdb5.3
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/ceph
      - bin/python
      - bin/python2*
      - bin/rbd
      - lib/python2.7
      - lib/*/libpython2.7.so*
      - -lib/python2.7/sitecustomize.py
      - lib/*/ceph
      - lib/*/libboost_iostreams.so.*
      - lib/*/libboost_program_options.so.*
      - lib/*/libboost_random.so.*
      - lib/*/libboost_regex.so.*
      - lib/*/libboost_system.so.*
      - lib/*/libboost_thread.so.*
      - lib/*/libcephfs*
      - lib/*/libdb-5.3.so
      - lib/*/libicudata.so.*
      - lib/*/libicui18n.so.*
      - lib/*/libicuuc.so.*
      - lib/*/libnspr4.so
      - lib/*/libnss3.so
      - lib/*/libibverbs.so*
      - lib/*/nss/libsoftokn3.so
      - lib/*/nss/libfreeblpriv3.so
      - lib/*/libnssutil3.so
      - lib/*/libplc4.so
      - lib/*/libplds4.so
      - lib/*/librados.so.*
      - lib/*/librbd.so.*
      - lib/*/libsmime3.so
      - lib/*/libsnappy*

  criu:
    source: https://github.com/checkpoint-restore/criu
    source-tag: v3.15
    source-type: git
    source-depth: 1
    plugin: nil
    build-packages:
      - asciidoc
      - libcap-dev
      - libnet1-dev
      - libnl-3-dev
      - libprotobuf-c-dev
      - libprotobuf-dev
      - protobuf-c-compiler
      - protobuf-compiler
      - python
      - xmlto
    stage-packages:
      - libnet1
      - libprotobuf-c1
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "armv7l" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      make
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/criu/"
      cp criu/criu "${SNAPCRAFT_PART_INSTALL}/criu/"
    organize:
      usr/lib/: lib/
    prime:
      - criu/*
      - lib/*/libnet*
      - lib/*/libproto*

  dqlite:
    after:
      - raft
      - sqlite
    source: https://github.com/canonical/dqlite
    source-type: git
    source-depth: 1
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libdqlite*so*
      - lib/*/libuv*

  edk2:
    source: https://github.com/tianocore/edk2
    source-type: git
    source-tag: edk2-stable202008
    source-depth: 1
    plugin: nil
    build-packages:
      - acpica-tools
      - nasm
      - uuid-dev
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      # Apply patches
      patch -p1 < "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0001-force-DUID-LLT.patch"
      cp "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0002-logo.bmp" MdeModulePkg/Logo/Logo.bmp
      patch -p1 < "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0003-boot-delay.patch"

      ARCH="X64"
      PKG="OvmfPkg/OvmfPkgX64.dsc"
      FV_CODE="OVMF_CODE"
      FV_VARS="OVMF_VARS"
      if [ "$(uname -m)" = "aarch64" ]; then
          ARCH="AARCH64"
          PKG="ArmVirtPkg/ArmVirtQemu.dsc"
          FV_CODE="QEMU_EFI"
          FV_VARS="QEMU_VARS"
      fi

      # Run in a bash sub-shell as edksetup.sh requires it
      set -ex
      (
      cat << EOF
          . ./edksetup.sh
          make -C BaseTools ARCH=${ARCH}
          build -a ${ARCH} -t GCC49 -b RELEASE -p ${PKG} \
            -DSECURE_BOOT_ENABLE=TRUE \
            -DNETWORK_IP4_ENABLE=TRUE \
            -DNETWORK_IP6_ENABLE=TRUE \
            -DNETWORK_TLS_ENABLE=TRUE \
            -DNETWORK_HTTP_BOOT_ENABLE=TRUE \
            -DFD_SIZE_2MB \
            -DTPM2_ENABLE=TRUE
      EOF
      ) | bash -e

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      cp Build/*/*/FV/${FV_CODE}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
      cp Build/*/*/FV/${FV_VARS}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"

      if [ "$(uname -m)" = "aarch64" ]; then
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"
      fi

    prime:
      - share/qemu/*

  libmnl:
    source: https://git.netfilter.org/libmnl
    source-type: git
    source-tag: libmnl-1.0.4
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libmnl*so*

  libnftnl:
    after:
      - libmnl
    source: https://git.netfilter.org/libnftnl
    source-type: git
    source-tag: libnftnl-1.1.8
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libnftnl*so*

  libseccomp:
    source: https://github.com/seccomp/libseccomp
    source-type: git
    source-tag: v2.5.1
    source-depth: 1
    plugin: autotools
    build-packages:
      - gperf
    organize:
      usr/lib/: lib/
    prime:
      - lib/libseccomp*so*

  libtpms:
    source: https://github.com/stefanberger/libtpms
    source-type: git
    source-tag: v0.7.4
    source-depth: 1
    plugin: autotools
    configflags:
      - --with-tpm2
      - --with-openssl
    organize:
      usr/lib/: lib/
    prime:
      - lib/libtpms*so*

  libusb:
    source: https://github.com/libusb/libusb
    source-type: git
    source-tag: v1.0.23
    source-depth: 1
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libusb*so*

  logrotate:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - logrotate
      - libpopt0
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    stage:
      - bin/logrotate
    prime:
      - bin/logrotate
      - lib/*/libpopt*so*

  lvm:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - dmeventd
      - lvm2
      - thin-provisioning-tools
    organize:
      sbin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/cache_*
      - bin/dmeventd
      - bin/era_*
      - bin/lv*
      - bin/pdata_tools
      - bin/pv*
      - bin/thin_*
      - bin/vg*
      - -bin/vgimportclone
      - -bin/lvmconf
      - -bin/lvmdump
      - -bin/lvmetad
      - -bin/lvmpolld
      - etc/lvm/lvm.conf
      - lib/*/device-mapper/*
      - lib/*/libaio.so*
      - lib/*/libdevmapper*
      - lib/*/liblvm*
      - lib/*/libreadline.so*

  nano:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - nano
    organize:
      usr/bin/: bin/
    prime:
      - bin/nano
      - etc/nanorc

  nftables:
    after:
      - libmnl
      - libnftnl
    source: https://git.netfilter.org/nftables
    source-type: git
    source-tag: v0.9.7
    plugin: autotools
    configflags:
      - --with-json
    build-packages:
      - libjansson-dev
      - libreadline-dev
    stage-packages:
      - libjansson4
    organize:
      sbin/: bin/
      usr/lib/: lib/
    prime:
      - bin/nft
      - lib/*/libjansson*so*
      - lib/libnftables*so*

  nvidia-container:
    after:
      - libseccomp
    source: https://github.com/NVIDIA/libnvidia-container
    source-type: git
    source-tag: v1.3.0
    source-depth: 1
    plugin: make
    build-packages:
      - bmake
      - curl
      - lsb-release
    override-build: |-
      set -ex

      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/bin/"
      cp ${SNAPCRAFT_PROJECT_DIR}/snapcraft/wrappers/nvidia-container-cli "${SNAPCRAFT_PART_INSTALL}/bin/"

      set +ex
      snapcraftctl build
    organize:
      usr/local/bin/nvidia-container-cli: bin/nvidia-container-cli.real
      usr/local/lib: lib/
    prime:
      - bin/nvidia-container-cli*
      - lib/libnvidia-container.so*

  openvswitch:
    source: https://github.com/openvswitch/ovs
    source-type: git
    source-tag: v2.14.0
    source-depth: 1
    plugin: autotools
    stage-packages:
      - uuid-runtime
    organize:
      sbin/: bin/
      usr/bin/: bin/
    prime:
      - bin/ovs-appctl
      - bin/ovs-vsctl
      - bin/ovs-vswitchd
      - bin/ovsdb-*
      - bin/uuidgen
      - share/openvswitch/

  ovn:
    after:
      - openvswitch
    source: https://github.com/ovn-org/ovn
    source-type: git
    source-tag: v20.09.0
    source-depth: 1
    configflags:
      - --with-ovs-source=../../openvswitch/build/
    plugin: autotools
    prime:
      - bin/ovn-nbctl

  spice-protocol:
    source: https://gitlab.freedesktop.org/spice/spice-protocol
    source-type: git
    source-tag: v0.14.3
    source-depth: 1
    plugin: meson
    prime: []

  spice-server:
    after:
      - spice-protocol
    source: https://gitlab.freedesktop.org/spice/spice
    source-type: git
    source-tag: v0.14.3
    source-depth: 1
    plugin: meson
    meson-parameters:
      - --prefix=/
      - -Dgstreamer=no
      - -Dmanual=false
      - -Dlz4=false
      - -Dsasl=false
      - -Dopus=disabled
      - -Dsmartcard=disabled
      - -Dtests=false
    build-packages:
      - libjpeg-turbo8-dev
      - python3-pyparsing
      - python3-six
    stage-packages:
      - libjpeg-turbo8
      - libpixman-1-0
    organize:
      sbin/: bin/
      usr/lib: lib/
      usr/local/lib/: lib/
    prime:
      - lib/*/libjpeg*so*
      - lib/*/libspice-server*so*
      - lib/*/libpixman*so*

  swtpm:
    after:
      - libseccomp
      - libtpms
    source: https://github.com/stefanberger/swtpm
    source-type: git
    source-tag: v0.5.1
    source-depth: 1
    plugin: autotools
    build-packages:
      - expect
      - gawk
      - iproute2
      - python3-cryptography
      - python3-setuptools
      - socat
    configflags:
      - --with-seccomp
      - --with-openssl
      - --without-cuse
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      lib/swtpm/: lib/
    prime:
      - bin/swtpm
      - lib/libswtpm*so*

  qemu:
    after:
      - libseccomp
      - libusb
      - spice-protocol
      - spice-server
    source: IRRELEVANT
    source-type: git
    plugin: autotools
    configflags:
      - --disable-bochs
      - --disable-cloop
      - --disable-dmg
      - --disable-docs
      - --disable-guest-agent
      - --disable-parallels
      - --disable-qed
      - --disable-sheepdog
      - --disable-slirp
      - --disable-user
      - --disable-vdi
      - --disable-vnc
      - --disable-xen
      - --enable-attr
      - --enable-cap-ng
      - --enable-kvm
      - --enable-libusb
      - --enable-usb-redir
      - --enable-linux-aio
      - --enable-numa
      - --enable-pie
      - --enable-rbd
      - --enable-seccomp
      - --enable-spice
      - --enable-system
      - --enable-tcg
      - --enable-tools
      - --enable-vhost-crypto
      - --enable-vhost-kernel
      - --enable-vhost-net
      - --enable-vhost-scsi
      - --enable-vhost-user
      - --enable-vhost-vsock
      - --enable-virtfs
      - --firmwarepath=/snap/lxd/current/share/qemu/
    build-packages:
      - bison
      - flex
      - pkg-config
      - libaio-dev
      - libcap-ng-dev
      - libglib2.0-dev
      - libnuma-dev
      - libpixman-1-dev
      - librbd-dev
      - libusbredirhost-dev
    stage-packages:
      - genisoimage
      - libmagic1
      - libnuma1
      - libpixman-1-0
      - libusbredirhost1
      - libusbredirparser1
    override-pull: |-
      set -ex
      git clone https://github.com/qemu/qemu . -b v5.1.0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick 202d69a715a4b1824dcd7ec1683d027ed2bae6d3  # usb-host: workaround libusb bug
      git cherry-pick 4969e697c15ac536d5c0700381d5d026ef7f0588  # usb-host: restrict workaround to new libusb versions
      git cherry-pick ebf101955ce8f8d72fba103b5151115a4335de2c  # virtiofsd: avoid /proc/self/fd tempdir
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && [ "$(uname -m)" != "ppc64le" ] && [ "$(uname -m)" != "s390x" ] && exit 0

      set -ex
      # Mangle the configure a bit
      QEMUARCH="$(uname -m)"
      [ "${QEMUARCH}" = "ppc64le" ] && QEMUARCH="ppc64"
      sed -i "s/^unset target_list$/target_list=\"${QEMUARCH}-softmmu\"/" configure
      sed -i 's#libseccomp_minver=".*#libseccomp_minver="0.0"#g' configure
      sed -i "s#https://git.qemu.org/git#https://github.com/qemu#g" .gitmodules

      set +ex
      snapcraftctl build
    organize:
      libexec/: bin/
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/genisoimage*
      - bin/mkisofs*
      - bin/qemu-system-*
      - bin/qemu-img*
      - bin/virtfs-proxy-helper*
      - bin/virtiofsd*
      - lib/*/libmagic*so*
      - lib/*/libnuma*so*
      - lib/*/libpixman*so*
      - lib/*/libusbredir*so*
      - share/qemu/keymaps*
      - share/qemu/efi-virtio.rom*
      - share/qemu/kvmvapic.bin*
      - share/qemu/s390-*.img*
      - share/qemu/slof.bin*
      - share/qemu/vgabios-*.bin*

  qemu-ovmf-secureboot:
    after:
      - edk2
      - qemu
    source: https://github.com/puiterwijk/qemu-ovmf-secureboot
    source-type: git
    source-depth: 1
    plugin: nil
    build-packages:
      - xorriso
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      set -ex
      rm -Rf iso-root vfat-root shell.iso
      mkdir -p iso-root vfat-root/efi/boot
      cp ../../edk2/build/Build/*/*/*/Shell.efi vfat-root/efi/boot/bootx64.efi
      cp ../../edk2/build/Build/*/*/*/EnrollDefaultKeys.efi vfat-root/
      "${SNAPCRAFT_STAGE}/bin/qemu-img" convert --image-opts driver=vvfat,floppy=on,fat-type=12,label=UEFI_SHELL,dir=vfat-root iso-root/shell.img
      xorriso --as mkisofs -input-charset ASCII -J -rational-rock -e shell.img -no-emul-boot -o shell.iso iso-root/

      # Basic aarch64 support
      if [ "$(uname -m)" = "aarch64" ]; then
          sed -i ovmf-vars-generator \
              -e "s/'-machine', machinetype,/'-machine', 'virt', '-cpu', 'cortex-a57',/" \
              -e "/charserial1/d" \
              -e "s/ide-cd/scsi-cd/" \
              -e "s/'-device',$/'-device', 'virtio-scsi-pci,id=scsi', '-device',/"
      elif [ "$(uname -m)" = "x86_64" ]; then
          cp -f "${SNAPCRAFT_STAGE}/share/qemu/kvmvapic.bin" .
      fi

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      python3 ovmf-vars-generator \
        --qemu-binary "${SNAPCRAFT_STAGE}/bin/qemu-system-$(uname -m)" \
        --print-output --disable-smm --skip-testing \
        --oem-string "$(cat ${SNAPCRAFT_PROJECT_DIR}/snapcraft/etc/ubuntu-sb.crt)" \
        --ovmf-binary "${SNAPCRAFT_STAGE}/share/qemu/OVMF_CODE.fd" \
        --ovmf-template-vars "${SNAPCRAFT_STAGE}/share/qemu/OVMF_VARS.fd" \
        --uefi-shell-iso shell.iso \
        "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.ms.fd"
    prime:
      - share/qemu/*

  raft:
    source: https://github.com/canonical/raft
    source-type: git
    source-depth: 1
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libraft*so*

  sqlite:
    source: https://github.com/sqlite/sqlite
    source-type: git
    source-depth: 1
    source-tag: version-3.33.0
    plugin: autotools
    build-packages:
      - tcl
    override-build: |-
      set -ex

      git log -1 --format=format:%ci%n | sed -e 's/ [-+].*$//;s/ /T/;s/^/D /' > manifest
      git log -1 --format=format:%H > manifest.uuid
      cp /usr/share/misc/config.guess .
      cp /usr/share/misc/config.sub .
      autoreconf -f -i

      set +ex
      snapcraftctl build
    prime:
      - bin/sqlite3
      - lib/libsqlite3*so*

  squashfs-tools-ng:
    source: https://github.com/AgentD/squashfs-tools-ng
    source-type: git
    source-tag: v1.0.3
    source-depth: 1
    plugin: autotools
    build-packages:
      - liblzma-dev
    prime:
      - bin/sqfs2tar
      - bin/tar2sqfs
      - lib/libsquashfs.so*

  vim:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - vim-tiny
    organize:
      usr/bin/: bin/
      usr/share/vim/vim*/debian.vim: etc/vimrc
    prime:
      - bin/vim.tiny
      - etc/vimrc

  xfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xfsprogs
    organize:
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/xfs_admin
      - bin/xfs_db
      - bin/xfs_growfs
      - bin/xfs_repair
      - bin/mkfs.xfs

  xtables:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ebtables
      - iptables
      - xtables-addons-common
    organize:
      usr/lib/*/xtables/*: lib/xtables/
      lib/ebtables/*: lib/
      sbin/: bin/
    prime:
      - bin/ebtables
      - etc/ethertypes
      - etc/protocols
      - lib/libebt*
      - lib/xtables/*

  xz:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xz-utils
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/lzma
      - bin/xz
      - lib/*/liblzma*so*
    override-build: |
      snapcraftctl build

      # Include the lzma symlink
      ln -s xz "${SNAPCRAFT_PART_INSTALL}/usr/bin/lzma"

  zfs-0-6:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.6.5.11
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick fb963d33ee0dd350143ba1c9cd35d5f7d86910d2  # Fix endian build problem on ppc64el

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-7:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.7.13
    source-depth: 1
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-8:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.8.5
    source-depth: 1
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-2-0:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-2.0.0
    source-depth: 1
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zstd:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - zstd
    organize:
      usr/bin/: bin/
    prime:
      - bin/pzstd
      - bin/zstd

  # Core components
  lxc:
    after:
      - libseccomp
    source: https://github.com/lxc/lxc
    source-type: git
    source-tag: lxc-4.0.5
    build-packages:
      - libapparmor-dev
      - libcap-dev
      - libgnutls28-dev
      - libselinux1-dev
      - pkg-config
    plugin: autotools
    configflags:
      - --disable-api-docs
      - --disable-bash
      - --disable-doc
      - --disable-examples
      - --disable-memfd-rexec
      - --disable-tests
      - --disable-tools
      - --enable-apparmor
      - --enable-seccomp
      - --enable-selinux
      - --enable-capabilities
      - --with-rootfs-path=/var/snap/lxd/common/lxc/
      - --libexecdir=/snap/lxd/current/libexec/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/libexec: libexec
      share/lxc/hooks: lxc/hooks
    prime:
      - bin/lxc-checkconfig
      - lib/liblxc.so.1
      - lib/liblxc.so.1.*
      - lxc/config/common.conf.d
      - lxc/hooks/nvidia
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/
      ln -s /var/snap/lxd/common/lxc/local.conf $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/01-local.conf
      sed -i "s#includedir=.*#includedir=$SNAPCRAFT_PART_INSTALL/include#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc
      sed -i "s#libdir=.*#libdir=$SNAPCRAFT_PART_INSTALL/lib#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc

  lxcfs:
    source: https://github.com/lxc/lxcfs
    source-type: git
    source-tag: lxcfs-4.0.6
    build-packages:
      - libfuse-dev
      - libpam0g-dev
      - pkg-config
    stage-packages:
      - fuse
    plugin: autotools
    configflags:
      - --datarootdir=/snap/lxd/current/
      - --localstatedir=/var/snap/lxd/common/var/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/lxcfs: lxcfs
      lib/lxcfs: lib
    prime:
      - bin/fusermount
      - lib/*/libfuse.so.*

      - bin/lxcfs
      - lib/liblxcfs.so

      - lxc
      - lxcfs
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick 8a0e1fd9d0c8866af5947ab2acee0c28e8827573  # meminfo: show host swap values when no limit or equal limits are set
      git cherry-pick 22ba5818484aa5ffaa26967d5d2ab228b2789205  # README: clarify SWAP
      git cherry-pick 5fb18e7b8ab9ee0b1af375aa13135cf0dfe30874  # cgroups: Add get_memory_swappiness
      git cherry-pick 205df44462530825ded3ffe3e2d6d68cb716287d  # swap: Fix usage reporting
      git cherry-pick 4538af183c2f48563681f303c54cef0430741b83  # swap: Only report usage when swappiness is 0
      git cherry-pick 1e92c18e409f37f79a24f61623b9d9c4d84e3280  # swap: Tweak meminfo logic
      git cherry-pick a46b7b6978867101e79db1e1a51d30f2a02176ec  # swap: Make /proc/swaps match /proc/meminfo
      git cherry-pick 1d3a4a0dd7411d34f10e47c1d850213a63a3581e  # swap: Remove now unused variable

      set +ex
      snapcraftctl build
      set -ex

      sed -i "s#\${LXC_ROOTFS_MOUNT}/var/snap/lxd/common/var/lib/lxcfs/#\${LXC_ROOTFS_MOUNT}/var/lib/lxcfs/#g" $SNAPCRAFT_PART_INSTALL/snap/lxd/current/lxcfs/lxc.mount.hook

  lxd:
    source: https://github.com/lxc/lxd
    source-type: git
    source-tag: lxd-4.8
    after:
      - lxc
      - dqlite
      - sqlite
    build-packages:
      - libacl1-dev
      - libudev-dev
      - pkg-config
    stage-packages:
      - acl
      - attr
      - dnsmasq-base
      - gdisk
      - iw
      - netbase
      - pciutils
      - pigz
      - rsync
      - squashfs-tools
      - usbutils
      - xdelta3
    plugin: nogetgo
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd
    go-packages:
      - github.com/lxc/lxd/lxc
      - github.com/lxc/lxd/lxc-to-lxd
      - github.com/lxc/lxd/lxd
      - github.com/lxc/lxd/lxd-benchmark
    override-build: |
      set -ex

      # Git cherry-picks
      cd ../src
      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick 4288422d191c7b47e268464f383903c7f4c953e5  # lxd/api/project: Reject quotes in project names
      git cherry-pick d9d2a053653613b8ad593fbcbacd93dbecb3ec19  # lxd/instance/drivers/driver/lxc: Updates initLXC to use project and instance name in callhook hook commands
      git cherry-pick 25bf93b31a892f662de892f6c4b4c0ef86e8f468  # lxd/instance/drivers/driver/lxc: Updates startCommon to quote hook command arguments
      git cherry-pick 63351b856b3ddefc4b7bb12631731b19cfb0c2f5  # lxd/main/callhook: Updates cmdCallhook to support using project name and instance name in arguments
      git cherry-pick 67b7c35ac82086b304945f3b3c663d5b953e4067  # lxd/api/internal: Adds support for using instance name and project name in container hook routes
      git cherry-pick 62ddd106c7c439f1da44846a175363e91ee10cd7  # lxd/storage: Apply rename template
      git cherry-pick 62a6d400960cb1df43867fc75141f1e70c607e60  # lxd/patches: Adds patchVMRenameUUIDKey patch to rename config key from volatile.vm.uuid to volatile.uuid
      git cherry-pick 77f2287655c65e823ee0c6dca4b5b7fc758aaa4f  # shared/validate: Adds IsUUID function
      git cherry-pick 85e644a03d158bad5dc5d2edab3a4ae389ef830d  # shared/instance: Adds volatile.uuid key to instance validation
      git cherry-pick fed8ee82b70c26d60d502be2d0337110fbcf9253  # shared/instance: Removes vm.uuid from instance validation in ConfigKeyChecker
      git cherry-pick ff8cfdbe6f61d109c528929a3386cf78c02cb530  # doc/instances: Replaces volatile.vm.uuid with volatile.uuid
      git cherry-pick 5dae4e615f90811decc2666e178370ac737842e7  # lxd/instance/drivers/driver/qemu: Updates Start to use and populate volatile.uuid instead of volatile.vm.uuid
      git cherry-pick f3993756c0f11452dee5ff084d14d28e325877ce  # lxd/instance/drivers/driver/lxc: Generate instance UUID if not set in startCommon
      git cherry-pick 05efc37a696c99392c47b9325d0fa81c6f98ce96  # lxd/instance/drivers/driver/qemu: Makes UUID generation terminology consistent with container
      git cherry-pick 7f3741d8c6d6dcf5a9536e7845824799d4b65a6f  # lxc/list: Fix typo in help
      git cherry-pick 65c94d1fe79c6ac6e4cd17ace78d284251c07512  # i18n: Update translation templates
      git cherry-pick abf2acf1b3a83dc71f928da695b62380b081bc43  # lxc/list: Add two new columns (memory % and CPU)
      git cherry-pick fa1c0a21741cebb5ae7d6e4cd45fec6b0abc92e5  # i18n: Update translation templates
      git cherry-pick 0ba9d6475fe5961906f6ff0ac16085a1a6fba037  # doc: fix typos in instances.md
      git cherry-pick 48c9b4494b9f5cb17baeae73f79123f62b5426d4  # lxd/storage/drivers/driver/zfs/volumes: Remove workarounds for snapshot volume mounting
      git cherry-pick 304be29ce45565064c4ea410dafec195e089d428  # lxd/refcount: Adds ref counting package
      git cherry-pick 6640b807c5ffce0097934af2e02f6a04e52f9d9d  # lxd/storage/drivers/volume: Adds ref counting functions
      git cherry-pick 5bf7ef13a4d27be71bf55f4f132db445570e3edf  # lxd/storage/drivers/volume: Updates MountTask to use new MountVolume signature
      git cherry-pick a7affe7f326adaabc0dc8e1797aaf41d4743dba8  # lxd/storage/pool/interface: Removes OurMount from MountInfo struct
      git cherry-pick 7b1a23b7bcead297859ae3d2d3b5f49db2ca0ef4  # lxd/storage/pool/interface: Removes "our mount" bool return value from MountCustomVolume
      git cherry-pick 2197e1676d415391a08d7e466622050451ecd058  # lxd/storage/drivers/interface: Removes "our mount" bool return value from MountVolume
      git cherry-pick e789685b16c37ed91dc713f92399734d23363e07  # lxd/storage/drivers/errors: Adds ErrInUse error
      git cherry-pick b8c2df31a847785c149844f07b20d635dcdf8c21  # lxd/storage/drivers/drivers/mock: Updates MountVolume signature
      git cherry-pick 45dad559924607e7e2bdcf2c26ca2a3e2adfe186  # lxd/storage/drivers/utils: Error quoting in shrinkFileSystem
      git cherry-pick c949e3395b50cf14b5d550f0423808671b090e82  # lxd/storage/drivers/driver/btrfs/volumes: Updates MountVolume signature
      git cherry-pick 16d0446c21cc859312e569bb12744c54107f6ed5  # lxd/storage/drivers/driver/ceph/volumes: Adds ref counting to MountVolume and UnmountVolume
      git cherry-pick b1b023183c888b7d77ac3e52bb69122188058d70  # lxd/storage/drivers/driver/cephfs/volumes: Updates MountVolume signature
      git cherry-pick cfd0839c8c5135323cf50aab4505a35fc5fa3678  # lxd/storage/drivers/driver/dir/volumes: Updates MountVolume signature
      git cherry-pick 000cc0872af530cd899956a43618bc8355969d9f  # lxd/storage/drivers/driver/lvm/volumes: Adds ref counting to MountVolume and UnmountVolume
      git cherry-pick 96d0ca63612bc65ea01dc6183d4b21b600f6f0b1  # lxd/storage/drivers/driver/zfs/volumes: Adds ref counting to MountVolume and UnmountVolume
      git cherry-pick 0a386b52fecbe3e37c688f44eb907b5d9c985607  # lxd/storage/drivers/generic/vfs: Updates genericVFSBackupUnpack to use new MountVolume signature
      git cherry-pick e2124c6826d3fd3f3d3809309b1abbd498cbee79  # lxd/storage/utils: Adds InstanceMount and InstanceUnmount and updates InstanceDiskBlockSize to use them
      git cherry-pick 51c26df4e72491bedabfbbbc38eeeb61e8530274  # lxd/storage/backend/mock: Removes OurMount
      git cherry-pick 634b3134b40a7d3ba3a34dc04729633a3876c354  # lxd/storage/backend/mock: Removes "our mount" bool return value from MountCustomVolume
      git cherry-pick 8fbc1a60d28eb0734c2cef44c647a61a8565cfd1  # lxd/storage/backend/lxd: Updates mount functions to remove OurMount and use new MountVolume signature
      git cherry-pick 94f1b074c772d52f4b0f81aa62e6db59a3c50d8a  # lxd/storage/backend/lxd/patches: b.driver.MountVolume usage
      git cherry-pick d78458163276576ca48e9adbd5ee716d4bec5bd2  # lxd/instance/drivers/driver: Unexports common restart function
      git cherry-pick 49de5ae2a5186dc72cd2c5e47faef370f2a0bb42  # lxd/instance/instance/interface: Removes deprecated StorageStart and StorageStop functions
      git cherry-pick 823390c7c97dad6da92290bb3cb75cd91b0b1339  # lxd/instance/drivers/driver/common: Import ordering
      git cherry-pick 7301e098178f56000361f1f4f0321f6d71adcc08  # lxd/instance/drivers/driver/lxc: Updates mount usage with ref counting in mind
      git cherry-pick 17610adb64e76067371c47ff3eb011c9c80fe02a  # lxd/instance/drivers/driver/lxc: Removes deprecated StorageStart and StorageStop
      git cherry-pick bca3c915d04feb67164a421792ef70822147a8fa  # lxd/instance/drivers/driver/qemu: Updates mount usage with ref counting in mind
      git cherry-pick 6e86bfdbfe3e57b037900642be1617a324f00249  # lxd/instance/drivers/driver/qemu: Implements RegisterDevices
      git cherry-pick 1aecb558f744d95746e348a9ff402a1621b03609  # lxd/instance/drivers/driver/qemu: Removes deprecated StorageStart and StorageStop
      git cherry-pick d13fac945217d9fe5b9508d2a3dda6321d673cec  # lxd/patches: Updates instance mount usage
      git cherry-pick 62a24c71042462af2679dee1348bb3ee7d3630cc  # lxd/instance/metadata: Removes use of c.StorageStart and c.StorageStop
      git cherry-pick 532700ee2bcafb1af4c52703c51e165a330cbeac  # lxd/instance/test: Removes use of StorageStart
      git cherry-pick c94af814bee2ec01ad66f2dba419ad0774582e25  # lxd/instance: Updates instanceCreateAsSnapshot to use updated mount functions
      git cherry-pick 4e1ed5e00e740656021d979b05d523b80743efc1  # lxd/devices: Register devices on all instance types
      git cherry-pick 1194dd933ed190186f8300c02dfb31f7a065be40  # lxd/device/disk: Implements Register function
      git cherry-pick f8bfc5065ff106fa8f4f2f01c535d6b504e9fc23  # lxd/device/disk: Updates mount function usage in mountPoolVolume
      git cherry-pick c98ec2a732c1769c43851e884a00f1369583985f  # lxd/instance/drivers/driver/qemu: mount fixes
      git cherry-pick 0d439f26bb2b175aa2406bc16213bafbb310fd94  # lxd/storage/backend/lxd: Adds revert to MountInstance
      git cherry-pick 11e84ac991645142644625d0050cbcba720054ee  # lxd/storage/drivers/driver/ceph/volumes: Adds revert to MountVolume
      git cherry-pick 4627522c01b68c46ee5147bcbf23c7faa9d05887  # lxd/storage/drivers/driver/lvm/volumes: Adds revert to MountVolume
      git cherry-pick a1ae412f2659d576a98e1c54855c9df815ff0d0d  # lxd/storage/drivers/driver/zfs/volumes: Adds revert to CreateVolumeFromBackup
      git cherry-pick 74691dcfcf1a654430a4124a8d22ab420ea4e4b3  # lxd/storage/drivers/driver/zfs/volumes: Adds revert to MountVolume
      git cherry-pick 4addc080a367b9d566063857eb5236fbf7107924  # lxd/storage/drivers/driver/zfs/volumes: Simplifies MountVolumeSnapshot and adds revert for parent volume mount
      git cherry-pick e3fed1db9e5377591b43f822fed7975e36e9c230  # lxd/storage/drivers/generic/vfs: Adds revert to genericVFSBackupUnpack
      git cherry-pick 0902f8aca876b2ac922d61454e31985b9a8aee67  # lxd/api/internal: Adds internalImportFromRecovery function for instance recovery import
      git cherry-pick bdfbf3f00f668f8b0dd52507b337aaaca595d43d  # lxd/instances/post: Updates createFromBackup to use updated internalImport signature
      git cherry-pick 756533a8f510d4c0099ed0d9a3bb797491c55068  # lxd/device/disk comments
      git cherry-pick 7ec05d4104d23e506742d735aeb600e670c50159  # test/suites/backup: Updates lxd import tests to expect instance to be unmounted after import
      git cherry-pick c10d380845854ed585f7781a1fc1e05263398155  # lxd/instance/drivers/driver/lxc: Moves instance mount before idmap related var loading
      git cherry-pick 7d672f7ae4882ba8011dfbcdb10ab5ff0b4ad716  # lxd/instance/drivers/driver/lxc: Rotate log file same stage as VM for consistency
      git cherry-pick 86af25ea44af152c5acf2fe37b2ab105fe914e50  # lxd/instance/drivers/driver/qemu: Use instance.LoadByProjectAndName in getMonitorEventHandler
      git cherry-pick fb8193b541a97c77e7044ed5b3320fe336a8bf09  # test: Updates container_import tests to remove lxd import followed by kill and start test
      git cherry-pick 1efa5d803b8c8865ee2962322ac26b68694cad9a  # lxd/storage/backend/lxd: Detect unsupported live copy of VMs and fail with clear message
      git cherry-pick 8358159f533e3a83b0c72ce3e18757370df281d3  # lxd/instance/lxc: Add extra check for devpts_fd
      git cherry-pick 02249b25f207f647f1d63c7e60d919607ea81f0e  # lxd/device/nic/ovn: Removes unused Add function
      git cherry-pick 86cf7529e400d342ef41e42eb967ac17d232f036  # lxd/device/nic/bridged: Clarifies when device's Add function is called
      git cherry-pick 656de3fac283129b9ee5a4d2927be6dafa375490  # lxd/migrate/instance: Improves comments when instantiating migration.VolumeTargetArgs
      git cherry-pick 14ae58156cea7864c36880cb5356ac36b73b0577  # lxd/storage/backend/lxd: Improves comments when instantiating migration.VolumeTargetArgs
      git cherry-pick 46671869a3191f6fc55daf1cfaf550e60656abec  # lxd/storage/backend/lxd: Reject custom volume config if supplied in CreateInstanceFromMigration
      git cherry-pick 40a5c7521051e3d4ff8b95cd1618e3a40214df23  # lxd/storage/drivers/driver/zfs/volumes: Use srcVol.NewVMBlockFilesystemVolume in CreateVolumeFromCopy
      git cherry-pick 59f92e958736f266e7a4977bca2f3d820fee7bb4  # lxd/storage/drivers/driver/zfs/volumes: Apply filesystem quota in CreateVolumeFromMigration
      git cherry-pick 3476b3a29150d1b7a10647afbbbf648fef1d9955  # lxd/storage/drivers/driver/btrfs/volumes: Apply quota in CreateVolumeFromMigration
      git cherry-pick b106094c22f61a0e8e27d0de4867a9c3c649f9d1  # lxd/storage/drivers/driver: Makes size update consistent with other drivers in UpdateVolume
      git cherry-pick 90945e8d05f69db806ad9d9c4aa4629af879b56f  # lxd/storage/drivers/driver/cephfs/volumes: Use vol.ConfigSize() rather than vol.ExpandedConfig("size") for consistency with other drivers
      git cherry-pick 9e33b63fb5f1b9fea2312ece9080fba3758ce49c  # lxd/storage/drivers/driver/cephfs/volumes: Makes CreateVolumeFromMigration volume quota setting consistent with other non-block-backed drivers
      git cherry-pick d6222c6bf88e9280d4ba790bfeb3dcbfcff899e8  # lxd/ap/internal: Improved error messages from instanceCreateInternal
      git cherry-pick 1ae0cd723c31195045e2ffed67a5bbfca02aa771  # lxd/instance: Improved error messages from instanceCreateInternal
      git cherry-pick d79a4980747ff660cfdf8a37d4fb0a80959e4ada  # lxd/instances/post: Improved error messages from instanceCreateInternal
      git cherry-pick 0f9f97541408c5e12cd084d27f1307fad091f113  # lxd/migrate/instance: Improved error messages from instanceCreateInternal
      git cherry-pick 2143e55233402c26b6385596bdd77791c0a78e89  # lxd/device/disk: Only validate external disk source paths when real instance is loaded
      git cherry-pick 3635b73cb5f71856e56d663179186f7a2dd73767  # lxd/instance/drivers/driver/lxc: Remove user facing reference to "common start logic" in error
      git cherry-pick 80b93cfec3b40d6a6aa7e1b6bb2aa54fb2283d7e  # lxd/instance/drivers/driver: Just log device add failures when adding device in non-user requested context
      git cherry-pick 448bd4cbfe368198fa94c64860fd2868781bfdf5  # lxd/instance/drivers/driver/lxc: Pass existing isRunning to c.updateDevices to avoid extra call to IsRunning()
      git cherry-pick 0b98ef3c6b448dce3da7db2e20c78a087361d637  # shared: Allow volatile uuid config keys
      git cherry-pick c3acec5a5b029d718b8a06f395c6b5d1149f7b6b  # lxd/instance/drivers: Support vgpu in qemu template
      git cherry-pick 518d5c94b8614b8e153774bf0812da0081db2389  # lxd/instance/drivers: Support vgpu in VMs
      git cherry-pick 8454215f61b27fe267b1130f92e1d58f4302f3e4  # lxd/device/nic/sriov: Don't fail when resetting VF MAC to 00:00:00:00:00:00
      git cherry-pick 8271798f17d17e38289925b1a88505f05d517945  # lxd/device/config: Allow gputype property
      git cherry-pick 8ec86bb325ba6090e48edeb28f6c73fa2442077a  # lxd/device: Support mdev GPUs
      git cherry-pick 97c731034ef94e7912ba50939b9c3c9f80b20f33  # doc: Document mdev config key
      git cherry-pick 7e8adecfb1646698cdd491f1cf76b37661e0a576  # api: Add gpu_mdev
      git cherry-pick c3cc47f8e7d98ed024241c2753ff428ec985cbca  # lxc/info: Show mdev profiles
      git cherry-pick e1f019f1e55e9a5f0371ef529978a1541e70ac73  # po: Update translation
      git cherry-pick b4c78b5d33277516a41b17fb7e0cb97c8708bbc9  # lxd/images: Replace fp with fingerprint in logs
      git cherry-pick 22c7a416d0b6a2b1d7131e1d54000f83ce01c06f  # lxd/daemon/images: Add contextual logging and use "fingerprint" rather than "image" for consistency with other code areas
      git cherry-pick 4d01104d53d2e7a9cbe53bfd6e0e0c0bf59e714e  # lxd/profiles/utils: Remove container references, improve comments
      git cherry-pick 1cd1015a8a12ab6dc79d7dc5b84553914c52b78a  # lxd/db/profiles: Updates GetInstancesWithProfile to return all instance types, not just containers
      git cherry-pick 544e75f8adf3ebedb40e8e7cd8daaf2bd3d5c4f9  # shared/instance: Improves comments
      git cherry-pick 64fbbb577b79ec559a2896e187713691cea4aba6  # lxd/project/project: Adds ProfileProject and ProfileProjectFromRecord functions
      git cherry-pick 6a266676dbe7af4485f3e5602db4ecf148424453  # lxd/profiles: Use project.ProfileProject instead of tx.ProjectHasProfiles
      git cherry-pick 2ec969de6e3561ade36fef217394716785375c18  # test/suites/projects: Fix bug in test that assumed project wasnt checked for existance
      git cherry-pick a891a3112afd45b833e913e469ecef4ad3a3f71a  # lxd/profiles/utils: Updates doProfileUpdate and doProfileUpdateCluster to return project and instance name in error
      git cherry-pick e2f7f0bf7a7d5398da09028bdcba224ece4293b3  # lxd/device/device/interface: Moves updatable fields from CanHotPlug() into UpdatableFields()
      git cherry-pick 423afe7f71d777e5727ad28a0083180113a8cd87  # lxd/device/errors: Adds ErrCannotUpdate error
      git cherry-pick 502d46e312d4383743c45ddd1116d9d431c5eeb9  # lxd/device/device/common: Updates common implementation of CanHotPlug() and UpdatableFields()
      git cherry-pick cfc50b161e4ffccdf86762a8538a10f6e45c6b7f  # lxd/device/disk: Adds UpdatableFields function based on instance type
      git cherry-pick 387fb96628023980fdbf6a0ddb6f6fe3b0e84b4d  # lxd/device/disk: Only apply running IO limits to containers in Update
      git cherry-pick 940b29b680c6b0c7d6936761d27e16268006b718  # lxd/device/nic/bridged: Adds UpdatableFields function and removes custom CanHotPlug function
      git cherry-pick 93d47c5ec3ea85a3fe4df54eb97471501cd8ad9f  # lxd/device/nic/ipvlan: Updates CanHotPlug function
      git cherry-pick 134e5336b33aaa0b936d8a3c69796b4f2003b829  # lxd/device/nic/ovn: Removes custom CanHotPlug function
      git cherry-pick 20610d617c0ce6b36fd5e8f4a478493a4b4a471a  # lxd/device/nic/p2p: Removes custom CanHotPlug function and adds UpdatableFields function
      git cherry-pick 6b0c1bfb57a36d5c25feb849701f4f1b5877bad2  # lxd/device/nic/routed: Splits CanHotPlug function into new CanHotPlug and UpdatableFields functions
      git cherry-pick 161003b8e2274d7933cf3d771ab81063f493c8e0  # lxd/instance/drivers/driver/lxc: Updates device management functions to use new CanHotPlug and UpdatableFields functions
      git cherry-pick eefdf1adf9bc814b9a71defe9d8fd9ac370d9686  # lxd/instance/drivers/driver/qemu: Updates device management functions to use new CanHotPlug and UpdatableFields functions
      git cherry-pick e8915c6422916bd04332557912aa97610665d948  # lxd/device/config/devices/sort: Improves comments in Less
      git cherry-pick 84f60593970a2c6b8c6580968571e29d11c941cd  # lxd/device/disk: Removes use of global logger and use device contextual logger
      git cherry-pick 559ada483ac1bd02c3755ef60d548a55495b130a  # lxd/device/disk: Rework volatile apply_quota key handling to support virtual machines
      git cherry-pick 068fa62bb629266ab34c5f012f1d023e84b44ed5  # lxd/refcount: Adds Get function
      git cherry-pick ff80fcbf3e7d19aba8551e6baccf45a1d5d31357  # lxd/storage/backend/lxd: Removes dependence on RunningQuotaResize in SetInstanceQuota
      git cherry-pick 8f70fb1e4f4e77ca656ad4d2fdae78695a4d16b0  # lxd/storage/backend/lxd: Removes dependence on RunningQuotaResize in UpdateCustomVolume
      git cherry-pick e723df633f19c744d97d2908688852910dc4a106  # lxd/storage/errors: Removes ErrRunningQuotaResizeNotSupported
      git cherry-pick 5fc24c35e538000b24690b34a79dca9cc2943a54  # lxd/storage/drivers/volume: Adds MountInUse function
      git cherry-pick 2118ec287aafc630860b8092f773579a4a57fab8  # lxd/storage/drivers/utils: Adds vol.MountInUse usage to ensureVolumeBlockFile
      git cherry-pick bc3ac33f8e47698510ca61510eb18a81a6479887  # lxd/storage/drivers/utils: Adds filesystemTypeCanBeShrunk and updates shrinkFileSystem to use it
      git cherry-pick 59685477d127c9bc1ce32430ca38061b5a8e7e8b  # lxd/storage/drivers/utils: Updates growFileSystem to use DefaultFilesystem
      git cherry-pick 32ecb3d1cd3cec54a59fb86f1fd707f26589b040  # lxd/storage/drivers/driver/types: Removes RunningQuotaResize
      git cherry-pick 8152fe501e03c028ccd8d92070a3f3aca5ba7b03  # lxd/storage/drivers: Renames drivers_mock.go to driver_mock.go to align with other driver naming
      git cherry-pick 25b589fcac83c75f87fcd0b4c3868c80772cc961  # lxd/storage/drivers/driver/mock: Removes RunningQuotaResize
      git cherry-pick 8c30c61430cfe1dbdfb29c5f3d9b6a62cb86646f  # lxd/storage/drivers/driver/btrfs: Updates BTRFS to use ensureVolumeBlockFile's in-use detection
      git cherry-pick f8ba1ec0fb93ca709cf092f73d5a9a857afbe1ad  # lxd/storage/drivers/driver/dir: Updates to use ensureVolumeBlockFile's in-use detection
      git cherry-pick 3c0d4e8bc14cd06d956b5270713395f52b5ee6ce  # lxd/storage/drivers/driver/ceph/utils: Adds resizeVolume function
      git cherry-pick b67af5d03804d2664ad756cc319eac38cb7f73b7  # lxd/storage/drivers/driver/ceph: Removes RunningQuotaResize
      git cherry-pick 0ba74ca44deb2e9320be3e70f1523ccd11e7e25a  # lxd/storage/drivers/driver/ceph/volumes: Reworks SetVolumeQuota to be more aligned with LVM driver structure
      git cherry-pick 7cb70422bf227dc27e85f2a233a3832cb8dc55f9  # lxd/storage/drivers/driver/cephfs: Removes RunningQuotaResize
      git cherry-pick 6b21d76189b7be4e464bd72dbe25547876a1abf4  # lxd/storage/drivers/driver/lvm: Removes RunningQuotaResize
      git cherry-pick 10cadacae8d2d51cb41f886e05c2efd62b349e9b  # lxd/storage/drivers/driver/lvm/volumes: Updates SetVolumeQuota to use Volume's in-use detection
      git cherry-pick 4410a53e0f55a38ac78278567583e158f51008ad  # lxd/storage/drivers/driver/zfs: Removes RunningQuotaResize
      git cherry-pick 96e0c8e1600ae6739f6bcae53b3b5ee6812c8448  # lxd/storage/drivers/driver/zfs/volumes: Updates SetVolumeQuota to use Volume's in-use detection
      git cherry-pick c94fc49dd064f7385df740fe418ced3f8a205e0b  # lxd/storage/utils: Updates validatePoolCommonRules to differentiate VM volumes and filesystem volumes
      git cherry-pick da6719c783ec1f9f14e1b78d297789f48825387b  # lxd/instance: Error quoting and logging improvements in instanceCreateInternal
      git cherry-pick f836a49fb901efdcfa06ae52d8081250ee334756  # lxd/instance/drivers/driver/lxc: Adds revert to lxcCreate
      git cherry-pick 6db2ede9dead73ceadb9f151b7ceea2c44d61c6b  # lxd/instance/drivers/driver/qemu: Adds revert to qemuCreate
      git cherry-pick 351d684527cd029c9be9476bbacf3053cd7bfdab  # lxd/storage/backend/lxd: Set the correct volume content type for custom volumes
      git cherry-pick e39ec398f7dd94173cd02d3ddd4464370366997c  # lxc/info: Extend mdev details
      git cherry-pick 6c8c8d5b0fc9ce660bbff1221ea75a0218177b30  # i18n: Update translation templates
      git cherry-pick c91e2679b2c04544c20d82bec6942ffb31b17495  # lxd/device/disk: Ignore ErrNotRunning for virtfs-proxy-helper
      git cherry-pick 432633b96f40a2efce03dfb36bdf02228fdf386c  # lxd/patches/utils: Adds legacy volumeFillDefault function for patches
      git cherry-pick f0daf911c1f8ca9cf322a1184bb506eb6e1c529a  # lxd/patches: Updates patches to switch from driver.VolumeFillDefault to volumeFillDefault
      git cherry-pick c54218714cd930771a1a9f33a544048fe8e448b2  # lxd/storage/drivers/interface: Adds FillVolumeConfig
      git cherry-pick 940cdb499856182c99087c0f5f9597188b31220f  # lxd/storage/drivers/driver/common: Adds FillVolumeConfig no-op for common drivers
      git cherry-pick bcd4898f938f6fdc0e6e843aa33b2b90fe12a737  # lxd/storage/drivers/driver/{ceph,lvm}: Adds FillVolumeConfig function to populate default filesystem settings
      git cherry-pick aeee0a8d5b2a057f70166952afcc6964102be4cf  # lxd/storage/utils: Updates VolumeDBCreate to accept a Pool and call driver.FillVolumeConfig
      git cherry-pick b78d3f2c19a171dd32ae746e3e397ead685d04ff  # lxd/storage/backend/lxd: VolumeDBCreate usage
      git cherry-pick 478f74f076e3d5537e6dce7161b6f39da339c4e8  # lxd/storage/utils: Removes VolumeFillDefault and VolumeValidateConfig
      git cherry-pick 89765ec19228101408d5116036b2cefda947c734  # lxd/storage/pool/interface: Adds FillInstanceConfig
      git cherry-pick 97194874c4089ef337d9b23d184562f35e6ea31e  # lxd/storage/backend/lxd: Implements FillInstanceConfig
      git cherry-pick c21b90025e5a66949e0ab6de818354a19c9dec21  # lxd/storage/backend/mock: Adds FillInstanceConfig
      git cherry-pick 0ba1df4f34d46a26f157ed453394cb0f11ccc53d  # lxd/instance/drivers/driver/lxc: Updates lxcCreate to use storagePool.FillInstanceConfig
      git cherry-pick 28bf8ac84bcb40351ab832c90c8dc75bd49fb03e  # lxd/instance/drivers/driver/qemu: Updates qemuCreate to use storagePool.FillInstanceConfig
      git cherry-pick 1eac64b4e340203f18ba3478b981ddf9b13c497a  # lxd/instance/drivers: Better errors in instance create functions
      git cherry-pick 40e04c01999cd36deec223634d9832517ccbb25c  # lxd/storage/backend/mock: Return storage pool ID 1 rather than -1 to allow tests to run
      git cherry-pick b730e82e3cba90255cc78987d5d615a6f0a1857e  # lxd/network/openvswitch/ovs: Adds InterfaceAssociatedOVNSwitchPort function
      git cherry-pick 0e05f658031a0e447a1f5467f7d9435e6fbce74d  # lxd/network/driver/ovn: Updates Instance port functions to use instance UUID rather than instance ID
      git cherry-pick c4b940b413307a714b99f6e471739008125c98c3  # lxd/network/driver/ovn: Updates InstanceDevicePortDelete to accept an instance UUID and a ovsExternalOVNPort hint
      git cherry-pick a82843c04e0b2e0733b31e954c576db6d53cbe41  # lxd/device/nic/ovn: Update ovnNet interface to use instance UUIDs.
      git cherry-pick 347475e2f37ff2a382f61aadd93aefccb4acea33  # lxd/device/nic/ovn: Use volatile.uuid instance UUID rather than instance ID for OVN switch port name
      git cherry-pick 9cfdd8f33ca2a52a9956e3cdd891dc2b3e3185e0  # lxd/device/nic/ovn: No need for intermediate v variable
      git cherry-pick 0e6bbdfca3717af559f7cefe8e381a0e341d0532  # lxd/device/nic/ovn: Updates Stop to pass instance UUID and an OVS external OVN switch port hint to InstanceDevicePortDelete
      git cherry-pick a422fb7306b1bafb71d5d543de32755b77e8b33b  # lxd/instance/qemu: Always render disk
      git cherry-pick 3dba6a9639755279f56850f8126324dc8c6eb3cd  # Support zstd compression.
      git cherry-pick 57f2d3f8c342636a5ef59502d92475dbffc99158  # lxd-agent: Don't rely on systemd for rebooting
      git cherry-pick dd693f4706f7cfe045bf6f0ddf77420b6be2d71e  # lxd/instance: Move id field to common
      git cherry-pick 3ef71d41b5b12aa863a26c35d340b54585d51f4b  # lxd/instance/common: Use 'd' as main variable
      git cherry-pick b51ad28ee0501b99085f6d1e592d43a4ecff9e14  # lxd/instance/qemu: Rename d to dev
      git cherry-pick 89f2886ce4ffc80a2e4be3d3c3f63180fbf8232c  # lxd/instance/qemu: Replace vm with d
      git cherry-pick 8a8ff1c560f5af674392290b13acab1e0b3e1ef4  # lxd/instance/lxc: Rename d to dev
      git cherry-pick 234fb8f75b60d607c37939712ff5d3d918b9984b  # lxd/instance/lxc: Replace c with d
      git cherry-pick 963bbd935940b5545b86b87804f27c451ef9ef30  # lxd/isntance: Move most properties to common
      git cherry-pick fbfc6ce6a72c635b280c38dbc807df337467dbba  # lxd/instance: Move common functions to drive_common
      git cherry-pick 2c9fdc5afd27c2d90dd9dfa176e2ebab8295c7e0  # shared/instance: golint fixes
      git cherry-pick 79941f59a92d0734d4273c75fb197c85a964163c  # shared/instance: Adds ConfigVolatilePrefix constant
      git cherry-pick 1e7d93cc87128b919c2d6dbe5ae280bb9d5d5476  # shared/instance: ConfigVolatilePrefix usage
      git cherry-pick 91277c1649fdf97fd888d3fc9465330226292280  # shared/instance: Adds InstanceIncludeWhenCopying function
      git cherry-pick 76dcd882dd1bef3bb9713bd223f76630b24a2ba1  # lxd/copy: shared.InstanceIncludeWhenCopying usage in copyInstance
      git cherry-pick fd15eb80b127ccc6ba6308872e7931eab98bcf49  # lxc: shared.ConfigVolatilePrefix usage
      git cherry-pick ecbb32591a01af930bf93fa85011a65d6cb8b469  # lxd: shared.ConfigVolatilePrefix usage
      git cherry-pick f98ed83b30211bce54ebcc23f233c406e4c1b115  # lxd/instances/post: shared.InstanceIncludeWhenCopying usage in createFromCopy
      git cherry-pick 3d8cdcf1a83a098b351a32cb6d2b5a2a5bc30414  # lxd/storage: Add volatile idmap setting debug log to resetContainerDiskIdmap
      git cherry-pick 610d38f21c2eeff3c1f31f3edb30860d559bd2dc  # lxd/device/disk: Include network-config in cidata
      git cherry-pick de67bd53f68176aff23fe3aeeca08fc2176f6654  # lxd/resources: Add GetNetworkState and GetNetworkCounters
      git cherry-pick da8998ac19b85d0d2d97635c993d05cfee7df469  # lxd/storage/pools/utils: Updates comment and error for storagePoolCreateLocal
      git cherry-pick 88a713e521f04ad95598cc46f2d1514a47782467  # lxd/storage/pools: Error quoting
      git cherry-pick 5100d11c0694b767f938eca1673bc1f71bbd6bf9  # lxd/instance: Use revert package in instanceCreateFromImage
      git cherry-pick dc9de71602879cc4b137f36bac8952a11417102a  # lxd/storage/backend/lxd: Remove revert from CreateInstanceFromImage
      git cherry-pick 8edbfff9d88caa82615ef5545135d67805658ae0  # lxd/storage/drivers/driver/common: Enable unsafe resize mode in runFiller when unpacking into image volumes
      git cherry-pick 922aca2f0426ce34f146c05a869e7f6afa8bbcb0  # lxd/storage/drivers/driver/ceph/volume: Allow image resize when in unsafe mode in SetVolumeQuota
      git cherry-pick 82586e064b400a6fab43e72aed446839cb6f003a  # lxd/storage/drivers/driver/zfs/volume: Allow image resize when in unsafe mode in SetVolumeQuota
      git cherry-pick 71ce592260ae05081f3b687ee5ffc94325f22e3c  # lxd/storage/backend/lxd: Log new volume size in CreateInstanceFromImage
      git cherry-pick 4ae8fa38c7bdca69b80662e97ca199de38324bf4  # lxd/instance/qemu: Follow symlink to lxd-agent
      git cherry-pick 91221d7533f30ee6b585cb4fa4c16888ad8cb205  # lxd/instance/qemu: Fix GPU passthrough
      git cherry-pick ab85b3dcc245dfbcfc326bbf88fb9a13061133b1  # lxd/instance/operations: Allow Wait/Done on nil struct
      git cherry-pick 5084fb9f6165af18c32777fedd13df01900cd8ef  # lxd/instance/lxc: Improve use of operations
      git cherry-pick 80763eba205580b8dc9dc989611121227f72926f  # lxd/instance/lxc: Improve locking on file ops
      git cherry-pick 9a6f8f6d6f772149e1a72fb3a790065eab2fb047  # lxd/instance/operations: Introduce CreateWaitGet
      git cherry-pick c001bbb6e71d61f802599448edec71214e6d258d  # lxd/instance: Introduce restart tracking
      git cherry-pick 619f8b327a170eb466ed710b76c3e53ea7b2042a  # Makefile: Fix golint URL
      git cherry-pick fae25f761d4e63d93350aee761fa5f47800a464f  # lxd/network/driver/bridge: Don't fill default config on update
      git cherry-pick 6d3139e0d6f54541ef7e3319945ca7005a724aed  # lxd/network/driver/ovn: Improve IP parsing errors
      git cherry-pick 474a49584a6da7a336998214e76482dad86883d3  # lxd/network/driver/ovn: Don't fill default config on update
      git cherry-pick 6665ebe9faed2f05fd0110935192f099dc58e540  # lxd/network/driver/bridge: Regenerate auto values on update
      git cherry-pick 4338899144beb466e063e171f9aca69f7ee50c2f  # lxd/network/driver/ovn: Regenerate auto values on update
      git cherry-pick f8a236dfe836d6bf66612f13203e57d744cb47fb  # test/suites/network: Adds test for unsetting ipv4.address and ipv6.address
      git cherry-pick 0c368a61d610e545bbde256eb12ac5c363ad6160  # test/suites/network: Adds test for regeneration of auto values
      git cherry-pick 1bf42210df92dbeff240ff68f5f743700c006020  # doc/networks: Clarify bridge default auto values
      git cherry-pick 0f2cdb383a0392f99589d7d429860ab2a18c2dd9  # doc/networks: Clarifies default values for ovn ranges settings
      git cherry-pick 75cbff964c375a5521675d276628d6e4698e925e  # doc/networks: Clarify ovn default auto values
      git cherry-pick 3b3590cfab36b727ec2d63e72308c8295d7254f2  # lxd/device/disk: Only validate disk source pool when an actual instance is set
      git cherry-pick de1a496c6ba1dcef90b540259ba8fb63b5a9edc4  # test/suites/migration: Adds tests for copying instance with snapshots containing invalid disk devices
      git cherry-pick e93904bdb54f595d3df438663a9f70b7d652f2d8  # lxc-to-lxd: Fix handling on snap
      git cherry-pick e0a6c6cf130857e2476c8cd1ff98c8090af3bc36  # lxd/instance: Bypass delete protection for internal calls
      git cherry-pick 3c7a64033e488983de01d29456fe2253caf6b5a0  # lxd/instance/qemu: Improve state handling
      git cherry-pick 2a5bbc2ff89c3074eafd0003e8b4f846d4aa23be  # lxd/instance/operationlock: Allow Reset
      git cherry-pick 969e31ade47149a1ce7f50c1eaa27431490e3370  # lxd/instance/qemu: Stretch start/stop timeout
      git cherry-pick 1a63ba03658cc813ac25fd47a714f39543a9912b  # lxd/instance/qemu: Increase virtiofsd timeout to 10s
      git cherry-pick b75ec4fa807438980a89cebe751d6b0a5d1f68b1  # lxd/instance/qemu: Move more logic into qemuArchConfig
      git cherry-pick 8fd26220735f8b639b0ef3fae3f91b87784b92ad  # lxd/instance: Add Info function
      git cherry-pick 237d56e5d637b38d00aafbc26e1ff72159ed3d08  # lxd/instance: Add SupportedInstanceDrivers
      git cherry-pick e816bef928dfeaeb7f97893e39341d2be8b96b32  # lxd/instance: Add driver cache
      git cherry-pick 7b8272d0c6d396998318810c9333d300808a67ed  # lxd/api: Show all instance drivers
      git cherry-pick d6b2707b1b04dc2c3256d743a20d492c40d078d8  # lxd/qemu: Don't stop processing events on shutdown
      git cherry-pick 53127c9b827cac52cc235d3f6b61348ad91f5761  # lxd/apparmor/qemu: Allow some more files

      # Download any new dependencies
      export GOPATH=$(realpath ../go)
      go get -t -d ./...

      # Setup for our shared libraries
      sed -i "/\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/canonical/go-dqlite/internal/bindings/server.go
      sed -i "/^\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/mattn/go-sqlite3/sqlite3.go

      # Run the standard build
      set +ex
      snapcraftctl build
      set -ex

      # Build the agent (special build tags)
      CGO_ENABLED=0 go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd-agent" -tags=agent,netgo github.com/lxc/lxd/lxd-agent

      # Setup bash completion
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/
      cp scripts/bash/lxd-client ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/share/misc/: share/misc/
      var/lib/usbutils/usb.ids: share/misc/
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/dnsmasq
      - bin/getfattr
      - bin/setfattr
      - bin/iw
      - bin/pigz
      - bin/rsync
      - bin/setfacl
      - bin/sgdisk
      - bin/unsquashfs
      - bin/xdelta3

      - etc/bash_completion.d/snap.lxd.lxc

      - share/misc

      - bin/lxc
      - bin/lxc-to-lxd
      - bin/lxd
      - bin/lxd-agent
      - bin/lxd-benchmark

  lxd-migrate:
    source: lxd-migrate/
    after:
      - lxd
      - sqlite
    plugin: go
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd-pkg-snap/lxd-migrate
    override-build: |
      set -ex

      # Setup for our shared libraries
      sed -i "/^\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/mattn/go-sqlite3/sqlite3.go

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p ${SNAPCRAFT_PART_INSTALL}/bin/
      cp scripts/upgrade-bridge ${SNAPCRAFT_PART_INSTALL}/bin/upgrade-bridge
    prime:
      - bin/lxd-migrate
      - bin/upgrade-bridge

  shmounts:
    source: shmounts/
    plugin: make
    prime:
      - bin/setup-shmounts

  snap-query:
    source: snap-query/
    plugin: go
    go-importpath: github.com/lxc/lxd-pkg-snap/snap-query
    prime:
      - bin/snap-query

  strip:
    source: snapcraft/empty
    after:
      - btrfs
      - ceph
      - dqlite
      - libseccomp
      - logrotate
      - lvm
      - nano
      - nvidia-container
      - openvswitch
      - ovn
      - raft
      - sqlite
      - squashfs-tools-ng
      - vim
      - xfs
      - xtables
      - xz
      - zfs-0-6
      - zfs-0-7
      - zfs-0-8
      - lxc
      - lxcfs
      - criu
      - lxd
      - lxd-migrate
      - shmounts
      - snap-query
    plugin: nil
    override-prime: |
      set -x

      # Strip some of the heavy bits
      strip -s ${SNAPCRAFT_PRIME}/bin/lxc
      strip -s ${SNAPCRAFT_PRIME}/bin/lxd*
      strip -s ${SNAPCRAFT_PRIME}/bin/snap*
      strip -s ${SNAPCRAFT_PRIME}/lib/liblxc*
      strip -s ${SNAPCRAFT_PRIME}/lib/libdqlite*
      strip -s ${SNAPCRAFT_PRIME}/lib/libsqlite*

      for zfs in zfs-0.6 zfs-0.7 zfs-0.8 zfs-2.0; do
          [ ! -d "${SNAPCRAFT_PRIME}/${zfs}" ] && continue
          strip -s ${SNAPCRAFT_PRIME}/${zfs}/bin/* ${SNAPCRAFT_PRIME}/${zfs}/lib/*
      done

      [ -e "${SNAPCRAFT_PRIME}/criu/criu" ] && strip -s ${SNAPCRAFT_PRIME}/criu/criu

      exit 0

  wrappers:
    plugin: dump
    source: snapcraft/
    organize:
      hooks/: snap/hooks/
