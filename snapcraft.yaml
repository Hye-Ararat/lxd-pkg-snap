name: lxd
base: core18
assumes:
  - snapd2.39
version: "4.2"
grade: stable
summary: LXD - the container lightervisor
description: |-
 LXD is a container manager for system containers.

 It offers a REST API to remotely manage containers over the network,
 using an image based workflow and with support for live migration.

 Images are available for all Ubuntu releases and architectures as well
 as for a wide number of other Linux distributions.

 LXD containers are lightweight, secure by default and a great
 alternative to virtual machines.

 Supported configuration options (snap set lxd [<key>=<value>...]):
   - ceph.builtin: Use snap-specific ceph configuration [default=false]
   - criu.enable: Enable experimental live-migration support [default=false]
   - daemon.debug: Increases logging to debug level [default=false]
   - daemon.group: Group of users that can interact with LXD [default=lxd]
   - daemon.preseed: A YAML configuration to feed `lxd init` on initial start
   - lxcfs.pidfd: Start per-container process tracking [default=false]
   - lxcfs.loadavg: Start tracking per-container load average [default=false]
   - lxcfs.cfs: Consider CPU shares for CPU usage [default=false]
   - openvswitch.builtin: Run a snap-specific OVS daemon [default=false]
   - shiftfs.enable: Enable shiftfs support [default=auto]

confinement: strict

apps:
  # Main commands
  activate:
    command: commands/daemon.activate
    daemon: oneshot
    plugs:
      - lxd-support
      - system-observe

  daemon:
    command: commands/daemon.start
    reload-command: commands/daemon.reload
    stop-command: commands/daemon.stop
    stop-timeout: 600s
    restart-condition: on-failure
    daemon: simple
    slots: [lxd]
    plugs:
      - lxd-support
      - network-bind
      - system-observe
    sockets:
      unix:
        listen-stream: $SNAP_COMMON/lxd/unix.socket
        socket-mode: 0660

  lxc:
    command: commands/lxc
    completer: etc/bash_completion.d/snap.lxd.lxc
    plugs:
      - lxd-support
      - system-observe

  lxd:
    command: commands/lxd
    plugs:
      - lxd-support
      - system-observe

  # Sub-commands
  benchmark:
    command: commands/lxd-benchmark
    plugs:
      - lxd-support
      - system-observe
  buginfo:
    command: commands/buginfo
    plugs:
      - lxd-support
      - system-observe
  check-kernel:
    command: commands/lxd-check-kernel
    plugs:
      - lxd-support
      - system-observe
  lxc-to-lxd:
    command: commands/lxc-to-lxd
    plugs:
      - lxd-support
      - system-observe
  migrate:
    command: commands/lxd-migrate
    plugs:
      - lxd-support
      - system-observe

hooks:
  configure:
    plugs:
      - network
      - system-observe
  remove:
    plugs:
      - lxd-support
      - system-observe

parts:
  # Dependencies
  btrfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - btrfs-tools
    prime:
      - bin/btrfs
      - bin/btrfstune
      - bin/mkfs.btrfs

  ceph:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ceph-common
      - libdb5.3
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/ceph
      - bin/python
      - bin/python2*
      - bin/rbd
      - lib/python2.7
      - lib/*/libpython2.7.so*
      - -lib/python2.7/sitecustomize.py
      - lib/*/ceph
      - lib/*/libboost_iostreams.so.*
      - lib/*/libboost_program_options.so.*
      - lib/*/libboost_random.so.*
      - lib/*/libboost_regex.so.*
      - lib/*/libboost_system.so.*
      - lib/*/libboost_thread.so.*
      - lib/*/libcephfs*
      - lib/*/libdb-5.3.so
      - lib/*/libicudata.so.*
      - lib/*/libicui18n.so.*
      - lib/*/libicuuc.so.*
      - lib/*/libnspr4.so
      - lib/*/libnss3.so
      - lib/*/libibverbs.so*
      - lib/*/nss/libsoftokn3.so
      - lib/*/nss/libfreeblpriv3.so
      - lib/*/libnssutil3.so
      - lib/*/libplc4.so
      - lib/*/libplds4.so
      - lib/*/librados.so.*
      - lib/*/librbd.so.*
      - lib/*/libsmime3.so
      - lib/*/libsnappy*

  dqlite:
    after:
      - libco
      - raft
      - sqlite
    source: https://github.com/canonical/dqlite
    source-type: git
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libdqlite*so*
      - lib/*/libuv*

  edk2:
    after:
      - qemu
    source: https://github.com/tianocore/edk2
    source-type: git
    source-tag: edk2-stable202005
    plugin: nil
    build-packages:
      - acpica-tools
      - nasm
      - uuid-dev
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      # Apply patches
      patch -p1 < ../../../patches/edk2-0001-force-DUID-LLT.patch
      cp ../../../patches/edk2-0002-logo.bmp MdeModulePkg/Logo/Logo.bmp

      ARCH="X64"
      PKG="OvmfPkg/OvmfPkgX64.dsc"
      FV_CODE="OVMF_CODE"
      FV_VARS="OVMF_VARS"
      if [ "$(uname -m)" = "aarch64" ]; then
          ARCH="AARCH64"
          PKG="ArmVirtPkg/ArmVirtQemu.dsc"
          FV_CODE="QEMU_EFI"
          FV_VARS="QEMU_VARS"
      fi

      # Run in a bash sub-shell as edksetup.sh requires it
      set -ex
      (
      cat << EOF
          . ./edksetup.sh
          make -C BaseTools ARCH=${ARCH}
          build -a ${ARCH} -t GCC49 -b RELEASE -p ${PKG} \
            -DSECURE_BOOT_ENABLE=TRUE \
            -DNETWORK_IP4_ENABLE=TRUE \
            -DNETWORK_IP6_ENABLE=TRUE \
            -DNETWORK_TLS_ENABLE=TRUE \
            -DNETWORK_HTTP_BOOT_ENABLE=TRUE \
            -DFD_SIZE_2MB \
            -DTPM2_ENABLE=TRUE
      EOF
      ) | bash -e

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      cp Build/*/*/FV/${FV_CODE}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
      cp Build/*/*/FV/${FV_VARS}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"

      if [ "$(uname -m)" = "aarch64" ]; then
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"
      fi

    prime:
      - share/qemu/*

  libco:
    source: https://github.com/canonical/libco
    source-type: git
    plugin: make
    organize:
      usr/lib/: lib/
    prime:
      - lib/libco*so*

  libmnl:
    source: https://git.netfilter.org/libmnl
    source-type: git
    source-tag: libmnl-1.0.4
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libmnl*so*

  libnftnl:
    after:
      - libmnl
    source: https://git.netfilter.org/libnftnl
    source-type: git
    source-tag: libnftnl-1.1.7
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libnftnl*so*

  libseccomp:
    source: https://github.com/seccomp/libseccomp
    source-type: git
    plugin: autotools
    build-packages:
      - gperf
    organize:
      usr/lib/: lib/
    prime:
      - lib/libseccomp*so*

  logrotate:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - logrotate
      - libpopt0
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    stage:
      - bin/logrotate
    prime:
      - bin/logrotate
      - lib/*/libpopt*so*

  lvm:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - dmeventd
      - lvm2
      - thin-provisioning-tools
    organize:
      sbin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/cache_*
      - bin/dmeventd
      - bin/era_*
      - bin/lv*
      - bin/pdata_tools
      - bin/pv*
      - bin/thin_*
      - bin/vg*
      - -bin/vgimportclone
      - -bin/lvmconf
      - -bin/lvmdump
      - -bin/lvmetad
      - -bin/lvmpolld
      - etc/lvm/lvm.conf
      - lib/*/device-mapper/*
      - lib/*/libaio.so*
      - lib/*/libdevmapper*
      - lib/*/liblvm*
      - lib/*/libreadline.so*

  nano:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - nano
    organize:
      usr/bin/: bin/
    prime:
      - bin/nano
      - etc/nanorc

  nftables:
    after:
      - libmnl
      - libnftnl
    source: https://git.netfilter.org/nftables
    source-type: git
    source-tag: v0.9.5
    plugin: autotools
    configflags:
      - --with-json
    build-packages:
      - libjansson-dev
      - libreadline-dev
    stage-packages:
      - libjansson4
    organize:
      sbin/: bin/
      usr/lib/: lib/
    prime:
      - bin/nft
      - lib/*/libjansson*so*
      - lib/libnftables*so*

  nvidia-container:
    after:
      - libseccomp
    source: https://github.com/NVIDIA/libnvidia-container
    source-type: git
    source-tag: v1.1.1
    plugin: make
    build-packages:
      - bmake
      - curl
      - lsb-release
    override-build: |-
      set -ex

      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/bin/"
      cp ${SNAPCRAFT_PROJECT_DIR}/snapcraft/wrappers/nvidia-container-cli "${SNAPCRAFT_PART_INSTALL}/bin/"

      set +ex
      snapcraftctl build
    organize:
      usr/local/bin/nvidia-container-cli: bin/nvidia-container-cli.real
      usr/local/lib: lib/
    prime:
      - bin/nvidia-container-cli*
      - lib/libnvidia-container.so*

  openvswitch:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - openvswitch-switch
      - uuid-runtime
    organize:
      usr/bin/: bin/
      usr/lib/openvswitch-switch/: bin/
      usr/sbin/: bin/
      usr/share/: share/
    prime:
      - bin/ovs-appctl
      - bin/ovs-vsctl
      - bin/ovs-vswitchd
      - bin/ovsdb-*
      - bin/uuidgen
      - share/openvswitch/

  qemu:
    after:
      - libseccomp
    source: https://git.qemu.org/git/qemu.git
    source-type: git
    source-tag: v5.0.0
    plugin: autotools
    configflags:
      - --disable-docs
      - --disable-slirp
      - --disable-user
      - --enable-attr
      - --enable-cap-ng
      - --enable-kvm
      - --enable-linux-aio
      - --enable-pie
      - --enable-rbd
      - --enable-seccomp
      - --enable-system
      - --enable-tools
      - --enable-vhost-crypto
      - --enable-vhost-kernel
      - --enable-vhost-net
      - --enable-vhost-scsi
      - --enable-vhost-user
      - --enable-vhost-vsock
      - --enable-virtfs
      - --enable-vnc
      - --firmwarepath=/snap/lxd/current/share/qemu/
    build-packages:
      - bison
      - flex
      - pkg-config
      - libcap-ng-dev
      - libglib2.0-dev
      - libpixman-1-dev
      - libaio-dev
      - librbd-dev
    stage-packages:
      - genisoimage
      - libmagic1
      - libpixman-1-0
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && [ "$(uname -m)" != "ppc64le" ] && [ "$(uname -m)" != "s390x" ] && exit 0

      set -ex
      # Mangle the configure a bit
      QEMUARCH="$(uname -m)"
      [ "${QEMUARCH}" = "ppc64le" ] && QEMUARCH="ppc64"
      sed -i "s/^unset target_list$/target_list=\"${QEMUARCH}-softmmu\"/" configure
      sed -i 's#libseccomp_minver=".*#libseccomp_minver="0.0"#g' configure

      set +ex
      snapcraftctl build
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/genisoimage*
      - bin/mkisofs*
      - bin/qemu-system-*
      - bin/qemu-img*
      - bin/virtfs-proxy-helper*
      - lib/*/libmagic*so*
      - lib/*/libpixman*so*
      - share/qemu/keymaps*
      - share/qemu/efi-virtio.rom*
      - share/qemu/kvmvapic.bin*
      - share/qemu/s390-*.img*
      - share/qemu/slof.bin*
      - share/qemu/vgabios-*.bin*

  qemu-ovmf-secureboot:
    after:
      - edk2
      - qemu
    source: https://github.com/puiterwijk/qemu-ovmf-secureboot
    source-type: git
    plugin: nil
    build-packages:
      - xorriso
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      set -ex
      rm -Rf iso-root vfat-root shell.iso
      mkdir -p iso-root vfat-root/efi/boot
      cp ../../edk2/build/Build/*/*/*/Shell.efi vfat-root/efi/boot/bootx64.efi
      cp ../../edk2/build/Build/*/*/*/EnrollDefaultKeys.efi vfat-root/
      "${SNAPCRAFT_STAGE}/bin/qemu-img" convert --image-opts driver=vvfat,floppy=on,fat-type=12,label=UEFI_SHELL,dir=vfat-root iso-root/shell.img
      xorriso --as mkisofs -input-charset ASCII -J -rational-rock -e shell.img -no-emul-boot -o shell.iso iso-root/

      # Basic aarch64 support
      if [ "$(uname -m)" = "aarch64" ]; then
          sed -i ovmf-vars-generator \
              -e "s/'-machine', machinetype,/'-machine', 'virt', '-cpu', 'cortex-a57',/" \
              -e "/charserial1/d" \
              -e "s/ide-cd/scsi-cd/" \
              -e "s/'-device',$/'-device', 'virtio-scsi-pci,id=scsi', '-device',/"
      elif [ "$(uname -m)" = "x86_64" ]; then
          cp -f "${SNAPCRAFT_STAGE}/share/qemu/kvmvapic.bin" .
      fi

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      python3 ovmf-vars-generator \
        --qemu-binary "${SNAPCRAFT_STAGE}/bin/qemu-system-$(uname -m)" \
        --print-output --disable-smm --skip-testing \
        --oem-string "$(cat ${SNAPCRAFT_PROJECT_DIR}/snapcraft/etc/ubuntu-sb.crt)" \
        --ovmf-binary "${SNAPCRAFT_STAGE}/share/qemu/OVMF_CODE.fd" \
        --ovmf-template-vars "${SNAPCRAFT_STAGE}/share/qemu/OVMF_VARS.fd" \
        --uefi-shell-iso shell.iso \
        "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.ms.fd"
    prime:
      - share/qemu/*

  raft:
    source: https://github.com/canonical/raft
    source-type: git
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libraft*so*

  sqlite:
    source: https://github.com/canonical/sqlite
    source-type: git
    plugin: autotools
    configflags:
      - --enable-replication
    build-packages:
      - tclsh
    override-build: |-
      set -ex

      git log -1 --format=format:%ci%n | sed -e 's/ [-+].*$//;s/ /T/;s/^/D /' > manifest
      git log -1 --format=format:%H > manifest.uuid
      cp /usr/share/misc/config.guess .
      cp /usr/share/misc/config.sub .
      autoreconf -f -i

      set +ex
      snapcraftctl build
    prime:
      - bin/sqlite3
      - lib/libsqlite3*so*

  squashfs-tools-ng:
    source: https://github.com/AgentD/squashfs-tools-ng
    source-type: git
    source-tag: v0.8
    plugin: autotools
    build-packages:
      - liblzma-dev
    prime:
      - bin/sqfs2tar
      - bin/tar2sqfs
      - lib/libsquashfs.so*

  vim:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - vim-tiny
    organize:
      usr/bin/: bin/
      usr/share/vim/vim*/debian.vim: etc/vimrc
    prime:
      - bin/vim.tiny
      - etc/vimrc

  xfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xfsprogs
    organize:
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/xfs_admin
      - bin/xfs_db
      - bin/xfs_growfs
      - bin/xfs_repair
      - bin/mkfs.xfs

  xtables:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ebtables
      - iptables
      - xtables-addons-common
    organize:
      usr/lib/*/xtables/*: lib/xtables/
      lib/ebtables/*: lib/
      sbin/: bin/
    prime:
      - bin/ebtables
      - etc/ethertypes
      - etc/protocols
      - lib/libebt*
      - lib/xtables/*

  xz:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xz-utils
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/xz
      - lib/*/liblzma*so*

  zfs-0-6:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.6.5.11
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick fb963d33ee0dd350143ba1c9cd35d5f7d86910d2  # Fix endian build problem on ppc64el

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-7:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.7.13
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-8:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.8.4
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  # Core components
  lxc:
    after:
      - libseccomp
    source: https://github.com/lxc/lxc
    source-type: git
    source-tag: lxc-4.0.2
    build-packages:
      - libapparmor-dev
      - libcap-dev
      - libgnutls28-dev
      - libselinux1-dev
      - pkg-config
    plugin: autotools
    configflags:
      - --disable-selinux
      - --disable-tests
      - --disable-examples
      - --disable-doc
      - --disable-tools
      - --disable-api-docs
      - --disable-bash
      - --disable-memfd-rexec
      - --enable-apparmor
      - --enable-seccomp
      - --enable-selinux
      - --enable-capabilities
      - --with-rootfs-path=/var/snap/lxd/common/lxc/
      - --libexecdir=/snap/lxd/current/libexec/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/libexec: libexec
      share/lxc/hooks: lxc/hooks
    prime:
      - bin/lxc-checkconfig
      - lib/liblxc.so.1
      - lib/liblxc.so.1.*
      - lxc/config/common.conf.d
      - lxc/hooks/nvidia
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick d51d0df41ef0f85a127daf84468189655499a6e3  # apparmor: Allow boot_id
      git cherry-pick 3a4031f03696e339c9d6d4cc16af2e771ae7e45f  # src/lxc/network: Fixes netlink attribute type 1 has an invalid length message
      git cherry-pick ba9eab74b8e7c9bcafadb83809f5f07c21318e2d  # cgroups: ignore cgroup2 limits on non-cgroup2 layouts
      git cherry-pick 6001872d082dffce5e328049788c7f1ae0864789  # common.conf: add cgroup2 default device limits
      git cherry-pick 8cce8b5930d3718b11217561bda78dcaa84dfdee  # cgroups: premount cgroups on cgroup2-only systems
      git cherry-pick 0343423e578ef608d6a5c2518de0d7bcbac5887b  # conf: introduce userns_exec_mapped_root()
      git cherry-pick 0baff7b7f54824d8f829a8d7a82b3423db03d305  # conf: support console setup on containers without rootfs
      git cherry-pick 63910a22283059853f0c799f6dcdc369c83518a0  # terminal: remove unneeded if condition
      git cherry-pick c91e492a17a1b24bb77f8089db7c98ca6619fa40  # gcc: add -Warray-bounds, -Wrestrict, -Wreturn-local-addr, -Wstringop-overflow
      git cherry-pick 52d2862cf6965596a2c0eb6bd3c8d9a2e66e9bb2  # compiler: support new access attributes
      git cherry-pick b467fc359118eafa0df761ab55d5ebe78ba4fb75  # tree-wide: this is all rather TODO than FIXME
      git cherry-pick 1cbdec6a1b89132cda4f4c5bd329124c6076b7e5  # yum: remove unused module
      git cherry-pick ab398a1bb9fe21c1049537e20b7ed6bb5cf843a5  # tools/lxc-ls: shutup lgtm
      git cherry-pick 7821133aab5113d629f4cb25e70b124c84903142  # tools/lxc-ls: shut up lgtm more
      git cherry-pick cf52a093d1b9b3b05cde8b43360bd3991b5196de  # confile: fix order independence of network keys
      git cherry-pick ea2a67a6b0c4995fa102021602ea6db93fd4bed8  # lxccontainer: small cleanup to lxc_check_inherited() calls
      git cherry-pick dd2f1aad65c19798bbd7c3de73c60b8ba48216d4  # start: remove unused lxc_zero_handler()
      git cherry-pick 3f96727b459cf032330d42f94b892e1b8c3de707  # lxccontainer: use close_prot_errno_disarm() on state_socket_pair
      git cherry-pick 755d1e1fecca4e841a9906b4b851f8da8ca31f4f  # start: fix container reboot
      git cherry-pick e758df857049176d9c1c132cdde096ce3b554ec5  # start: cleanup file descriptor inheritance
      git cherry-pick 3f924551c9963040e8048e7c7cdb06b9f1768d3e  # log: cleanup syslog handling
      git cherry-pick de4d585ee420862b9a927f04f80d9fbe5ca71de8  # console: only create detached mount when a console is requested
      git cherry-pick 5524656d86fd78be693dbd0f2cd278ed8b8da42c  # syscall_numbers: handle ia64 syscall numbers correctly
      git cherry-pick ef301301c68ad432cfd6beb82fd2da1fdeb78983  # syscall_numbers: add clone3()
      git cherry-pick 6aefab38c133edd2d4c6721ebf6312cac544ccdc  # process_utils: introduce new process_utils.{c,h}
      git cherry-pick a62eb3aa12b57fa83a5335eb9769d37d46e7444d  # process_utils: add clone3() support
      git cherry-pick c3d189153f5534db211defe25bf3c3256e6c564f  # mainloop: add lxc_mainloop_add_handler_events
      git cherry-pick 64df0b2f366c80318910981af9c007b06f3a29f9  # cgfsng: deduplicate freeze code
      git cherry-pick 0842a4652e5788b4f82a424d0a7ee2c2b2240b81  # cgfsng: use EPOLLPRI when polling cgroup.events
      git cherry-pick 7ebcd704bee176dd2f8700c6497d8a6f60ba12a4  # process_utils: make lxc use clone3() whenever possible
      git cherry-pick df7d58b75aca3c710d62e37365a22142d2317981  # network: restore old behavior
      git cherry-pick fc0a8697b4a5a995e4863c48bda30fb6d805dc91  # network: fix {mac,ip,v}lan device creation
      git cherry-pick d7df095654693074aa3e581a78282bb0ad6b6944  # bionic: s/lxc_raw_execveat()/execveat()/g
      git cherry-pick 92a8d6e061cbe516cacd9f143506908e7ed89b6c  # network: use __instantiate_ns_common() in instantiate_ns_phys() too
      git cherry-pick 323a156937cfc9b08e2bb7a43b2600d3b9cd3960  # lxc-usernsexec: dumb down from error to warning message
      git cherry-pick b8025217f72d32cd2a02d772527761edb8a8384d  # lxc-usernsexec: don't fail on setgroups()
      git cherry-pick 0c9e185c962513661f5b26222770074946efcf25  # travis: Restrict coverity to gcc on bionic on amd64
      git cherry-pick dc89b0d7954c85981056407b0305621b598007c9  # introduce lxc.cgroup.dir.{monitor,container,container.inner}
      git cherry-pick bba910b2ff2cca6fbca41c53e39581169e0278de  # cgroups: remove unused variable
      git cherry-pick 3537c31640caf42185608cf93524e2f04a4727d9  # cgroup isolation: handle devices cgroup early
      git cherry-pick 8bbfacd2b488d6d681dbf59a2df7256b137e0f6e  # improve LXC_CMD_GET_CGROUP compatibility
      git cherry-pick 202e017e59cf395d88da37544ee2ef5e3d84c3a0  # cgroups: be less alarming when creating cgroups
      git cherry-pick 53fbc128f3b4758173d1aa63ead91e3e85bd68cd  # commands: make limiting cgroup callbacks unreachable
      git cherry-pick c5acbe98bc4f35599dd27db753e8c73cca21906c  # api_extensions: add "pidfd"
      git cherry-pick bfbd606e6f1cf33bb04ae10bbfadfa10907b9284  # Add test of lxc-usernsexec
      git cherry-pick e0344cfa43b3ae96e2ce029de2819561fb9a6313  # lxc-test-usernsexec: If user is root, then create and use non-root user.
      git cherry-pick 9d81b99a14cb95f649cdf39986f7bf74ef313f11  # .gitignore: Ignores COPYING file created by make
      git cherry-pick b4c9fc149e14090cb47da21a97095e34837018ee  # macro: Adds UINT_TO_PTR and PTR_TO_USHORT helpers
      git cherry-pick f36a519af927f5bf381e1a32a4698b16a0aba722  # network: Adds check for bridge link interface existence in instantiate_veth
      git cherry-pick ebd26a19721482631e57cc985c5fec0ccee50185  # network: Updates netlink_open handling in lxc_ipvlan_create
      git cherry-pick 5d2ce0b6dbe9642fb80553550ca942c73fd0307e  # network: Removes unused ip_proxy_args
      git cherry-pick 1bb0804961b7bf1bd23ee6aec1c295a19805f12c  # cgroups: initialize lxc.pivot cpuset
      git cherry-pick 18adfa20e072556a3df252da92ac5fd1ecb42347  # conf: remove faulty flags
      git cherry-pick d3d1c6e112691440bf0cd9c3c0d8acdd92840540  # conf: always use target_fd in userns_exec_mapped_root()
      git cherry-pick dd6ed3b07b22a36c3ab8834a4d151800b8def8d1  # conf: add some more logging to userns_exec_mapped_root()
      git cherry-pick a993d4f1ad0469f174a56598dad1b8c9a05e4e62  # conf: kill old chown_mapped_root()
      git cherry-pick 2989eb15e8984da912826d47d6bcb81f1c18358d  # lxccontainer: remove pointless string duplication
      git cherry-pick e84f3ab7f70e0ca712ea3e537a81488531dee2f7  # containertests: fix null pointer defereference

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/
      ln -s /var/snap/lxd/common/lxc/local.conf $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/01-local.conf
      sed -i "s#includedir=.*#includedir=$SNAPCRAFT_PART_INSTALL/include#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc
      sed -i "s#libdir=.*#libdir=$SNAPCRAFT_PART_INSTALL/lib#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc

  lxcfs:
    source: https://github.com/lxc/lxcfs
    source-type: git
    source-tag: lxcfs-4.0.3
    build-packages:
      - libfuse-dev
      - libpam0g-dev
      - pkg-config
    stage-packages:
      - fuse
    plugin: autotools
    configflags:
      - --datarootdir=/snap/lxd/current/
      - --localstatedir=/var/snap/lxd/common/var/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/lxcfs: lxcfs
      lib/lxcfs: lib
    prime:
      - bin/fusermount
      - lib/*/libfuse.so.*

      - bin/lxcfs
      - lib/liblxcfs.so

      - lxc
      - lxcfs
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick 7dddc7f335ec5644663112d346ecbd7fe5882163  # proc_fuse: silence error when we find no memlimit
      git cherry-pick 2e7b4138eae5b1cb4c4b6d2c87b45c5425f0c693  # sysfs: cpuinfo: show cgroup cpuset value
      git cherry-pick 10f4d9fb7b28a59a0f4e1104bf2e788cf6726c5b  # sysfs_fuse: remove logically dead code
      git cherry-pick 4179492059341d56eaf39dfd9ba132015fbe2076  # Fix https://github.com/lxc/lxcfs/issues/404
      git cherry-pick 1fdb0df9d21a5073f5d6c3012763429d5bfad404  # coverity: Use build custom build script
      git cherry-pick d1ecd2ea9ffead09852621f689af99499ac69de9  # bindings: fix init pid hashing
      git cherry-pick fde6b415e6015118ad74c772f53612df9dbae05e  # bindings: make opts pointer const
      git cherry-pick a506a056ca643dd0aab6c0b1037f19dc762b528e  # bindings: use brackets to make logic clearer
      git cherry-pick 1c8082f22c671ec8eefad097c4530356416eaf7c  # bindings: cleanup cache locking
      git cherry-pick 6146b6d4025e460ee6c62d537555696256a72399  # bindings: cleanup init pid verification
      git cherry-pick 19f42b8b2fa97da4c8fa2fd76f296d1edb4edfb5  # cpuview: fix /proc/stat virtualization
      git cherry-pick c88c43045fa3fc8a731469c246376d5eafdeb6c8  # bindings: s/get_init_pid_for_task()/scm_init_pid()/g
      git cherry-pick df1e90eac5590ac096687da0fb8ae588f90e6bdc  # proc_loadavg: don't leak getline() memory in calc_pid()
      git cherry-pick fd24d322de4221080e11360b45364bfda893c232  # proc_loadavg: ensure pointer is NULL when passing to calc_pid()
      git cherry-pick 75cc86c8f1eab1a8a8d422a08457def58c546830  # proc_loadavg: don't leak getline() memory
      git cherry-pick d5953e5a759af8761b67c55b8be317f4768cbf60  # proc_loadavg: replace malloc() with asprintf() in calc_pid()
      git cherry-pick d3e56c513245b3ecc801a2d8844af1b7bc86c7b8  # macro: use ISO C compatible __typeof__
      git cherry-pick 1b2133070933aa4c652844f8a9420b929898ccc0  # proc_loadavg(): use strdup() in calc_pid()
      git cherry-pick d3d394ee3ac8ad66cea9b24f38ccc14f3f387d51  # proc_loadavg: simplify calc_pid()
      git cherry-pick bd4ce4fe4281e9fed7dd4c2c5f017cecc0992391  # bindings: wipe initpid cache on library reload
      git cherry-pick 0c525b491572fa5b7123a4142722cf89b93b91b1  # bindings: avoid dynamic stack allocations in clone()
      git cherry-pick e1aca77d7e01ff33c09bbfb5c725da24c249a941  # lxcfs: free opts on lxcfs binary exit
      git cherry-pick 92cd86392dc40620d2e712d66d7f9de007d357ce  # proc_fuse: use zalloc()
      git cherry-pick 96c6a953f38db97f4eb14b41a908693ba6423b65  # proc_loadavg: use must_* alloc helpers
      git cherry-pick bff5ce333f1d9610d9301a3100601307e64a2775  # proc_loadavg: remove dummy variable
      git cherry-pick cbe164f428cb07a03dd0508b68947f18c9a8a243  # proc_loadavg: avoid needless memory allocation
      git cherry-pick a7ec61a422951c9784032aa4481424bb4c2ec8e8  # proc_fuse: move get_reaper_busy() down
      git cherry-pick 03a51c6341df69e1c00088714a902d7a26f4a03f  # proc_fuse: cleanup proc_uptime_read() a little
      git cherry-pick a30d91ccf9bba1e2f4e0d528c7fa2c7cf41330f1  # utils: don't leak fds in in_same_namespace()
      git cherry-pick 5e3ca4d305c70607f6018b0ea75626a03377dfda  # proc_fuse: improve swap calculation a little
      git cherry-pick 4b754ca6b770f7e74e9993cb24e03c735396aa6f  # proc_fuse: don't cause invalid swap values
      git cherry-pick 8fe0082efc24b651b8ccfee9f3a8b9c2e23d0518  # proc_fuse: cap swap to global values
      git cherry-pick 8d609d80a6ae80a3a9b90ffc4a6f1911d9a0e3dd  # proc_cpuview: tweak cpuacct.percpu_usage fallback
      git cherry-pick 37f75e5775669eb73ece706d4c85d5bec43eafb1  # proc_fuse: more swap tweaks
      git cherry-pick 7f3c85f75c518230f600bb2452c9d0e45be8c104  # proc_cpuview: cleanup new_proc_stat_node()
      git cherry-pick 2820f6a135ab3711737b4c57e650659992cd5f1d  # proc_cpuview: use more descriptive labels in add_proc_stat_node()
      git cherry-pick 73be370813e95863972a987b20f8e915afbf25d0  # proc_cpuview: reduce variable scope in cpuview_free_head()
      git cherry-pick d582b91a1c10f57e6ffacee8d2ffea9d4400da2a  # proc_cpuview: cleanup add_proc_stat_node()
      git cherry-pick 39243bb92d14c24b48e1215c287a272e28fcf984  # proc_cpuview: use correct comment style
      git cherry-pick e76740ef34ff35d9b60e37c8e842d56022cb77a9  # proc_cpuview: clean up expand_proc_stat_node()
      git cherry-pick a25bf140a76b882a1f819a934b2d9939e167511d  # proc_cpuview: clean up prune_proc_stat_list()
      git cherry-pick d3a4e743edf6008027fe0311ac22eddcc931fb41  # proc_cpuview: clean up find_or_create_proc_stat_node()
      git cherry-pick 6e48e6792802066ee326d8d30f30e4a0e508d952  # proc_cpuview: cleanup add_cpu_usage()
      git cherry-pick a407f7976ec5b18f745cc8ea2506696b671557d9  # proc_cpuview: cleanup read_cpu_cfs_param()
      git cherry-pick 7128a36e0ad7a4d253ca47db12e993fc528a7545  # proc_cpuview: fix exact_cpu_count()
      git cherry-pick 8935c30ed176f1e38751dbd3af5528b0bee2162d  # proc_cpuview: fix max_cpu_count()
      git cherry-pick f2adcbe9fa0d75b80777c95078bdb82d4118f317  # proc_cpuview: cleanup cpuview_proc_stat()
      git cherry-pick 5f44974ac86f738b99a52de064fc69448498ac41  # proc_cpuview: cleanup cpuview_init_head()

      set +ex
      snapcraftctl build
      set -ex

      sed -i "s#\${LXC_ROOTFS_MOUNT}/var/snap/lxd/common/var/lib/lxcfs/#\${LXC_ROOTFS_MOUNT}/var/lib/lxcfs/#g" $SNAPCRAFT_PART_INSTALL/snap/lxd/current/lxcfs/lxc.mount.hook

  criu:
    source: https://github.com/checkpoint-restore/criu
    source-tag: v3.14
    source-type: git
    plugin: nil
    build-packages:
      - asciidoc
      - libcap-dev
      - libnet1-dev
      - libnl-3-dev
      - libprotobuf-c-dev
      - libprotobuf-dev
      - protobuf-c-compiler
      - protobuf-compiler
      - python
      - xmlto
    stage-packages:
      - libnet1
      - libprotobuf-c1
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "armv7l" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      make
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/criu/"
      cp criu/criu "${SNAPCRAFT_PART_INSTALL}/criu/"
    organize:
      usr/lib/: lib/
    prime:
      - criu/*
      - lib/*/libnet*
      - lib/*/libproto*

  lxd:
    source: https://github.com/lxc/lxd
    source-type: git
    source-tag: lxd-4.2
    after:
      - lxc
      - dqlite
      - sqlite
    build-packages:
      - libacl1-dev
      - libudev-dev
      - pkg-config
    stage-packages:
      - acl
      - attr
      - dnsmasq-base
      - gdisk
      - iw
      - netbase
      - pciutils
      - pigz
      - rsync
      - squashfs-tools
      - usbutils
      - xdelta3
    plugin: nogetgo
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd
    go-packages:
      - github.com/lxc/lxd/lxc
      - github.com/lxc/lxd/lxc-to-lxd
      - github.com/lxc/lxd/lxd
      - github.com/lxc/lxd/lxd-benchmark
    override-build: |
      set -ex

      # Git cherry-picks
      cd ../src
      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick fb9e4c3fc573107278bad724aaf8f168ef843fdb  # lxd/instance/drivers/driver/lxc: Adds debug logging to deviceStop
      git cherry-pick b0407c961fe6ef5b1a04139e6658fcf8dc80b470  # lxd/instance/drivers/driver/lxc: Adds driver revert on failed start in startCommon
      git cherry-pick f72c68444e584f4595a74b9fe68ba170b3f2ad9f  # lxd/instance/drivers/driver/qemu: Adds debug logging to deviceStop
      git cherry-pick a21768c3bfed2de2059172d213ab3485a9cb453d  # lxd/instance/drivers/driver/qemu: Simplifies failed start device cleanup in Start
      git cherry-pick 5b0d31def1f58548d9f9132a68f3873607e72e45  # lxd/storage/drivers/driver/ceph/utils: Removes getRBDFilesystem
      git cherry-pick ab27482230a78e22eafc50430c4e2b4842c07985  # lxd/storage/drivers/driver/ceph: Replaces use of d.getRBDFilesystem with vol.ConfigBlockFilesystem
      git cherry-pick 1feb5a4425deb56d7412a266991207b06255cef4  # lxd/storage/drivers/volume: Adds ConfigBlockMountOptions function
      git cherry-pick a62e37a42dbca378a1d2006157f753828318157f  # lxd/storage/drivers/driver/ceph/utils: Removes getRBDMountOptions in place of vol.ConfigBlockMountOptions()
      git cherry-pick 50d504dac969eb089efddce9c659961b399b5e84  # lxd/storage/drivers/driver/lvm/utils: Removes volumeMountOptions in place of vol.ConfigBlockMountOptions()
      git cherry-pick e94d5c7ab8a1921a0e1161891cd7d5149298bd29  # lxd/storage/drivers: Replaces driver specific mount options resolution with vol.ConfigBlockMountOptions()
      git cherry-pick 0491202b4b02d16cc336d9495e07f79375d1a528  # lxd/rbac: Don't close body when missing
      git cherry-pick 5139e3ca54d1a880ecc8fbebd090665c3835e1b3  # doc/storage: Cover host/disk/loop setups
      git cherry-pick 8a891692007848771d54b865e63978541a9b9718  # lxd/init: Tweak default loop sizing
      git cherry-pick 02cf2eee9267cbdfe60a720c46f08316657e1a01  # lxd/vm: Rename some functions
      git cherry-pick 0c606c071072ff706fd886bb9761198677e803bc  # client: Expand snap path in ConnectLXDUnix
      git cherry-pick 0fb2ee4ed5fc11637bcb667b375ab624d1d939c5  # lxd/vm: Add virtio-vga card
      git cherry-pick 2253e7c26bd7848f7cbe4c9187a215f88c1c61a5  # lxd/vm: Add spice channel
      git cherry-pick af09a3f77da9fb611610acbbc03b38688eb1a5ba  # client: Fix ConnectLXDUnix regression
      git cherry-pick beaf493c71f3df6f1a22dadebb3a0b19b0c33e17  # lxd/vm: Fix PCIe slot for physical/sriov nic
      git cherry-pick 6f459040405e9936fad49f33669284f98c034c43  # lxd/network: Make setting bridge VLAN filtering & default PVID optional
      git cherry-pick 1c7efa58ce2cea0f13ac5f0dabbd2ce46a1559fa  # lxd/instance/drivers/driver/qemu: Integrates built in GPU device PCI range with future passthrough GPU devices
      git cherry-pick aa38c3d8385b45e5120a6d5196d643e10843c55a  # lxd/instance/drivers/driver/qemu/templates: Updates built in GPU device to use GPU address range prefix
      git cherry-pick 135cdf1e71cb7a085392443fe7a700273bb9598b  # lxd/vm: Move to separate devices
      git cherry-pick 8bca065126076e3fddae7b8d025ab1f9bd60d787  # lxd/vm: Remove tiny wrapper functions
      git cherry-pick 3f3dcd9e6563d4efa2970b8f73cebb4e4e876305  # lxd/vm: Per-architecture bus type
      git cherry-pick b3463f939cbfe5aba4d040548a95e8a9219728ed  # add type to specify the instance type on creation Signed-off-by: Salem Yaslem <s@sy.sa>
      git cherry-pick ed31c029fa9ba1c77dbc1de66cb5fa4ebf3e5366  # lxd/vm: Centralize port generation
      git cherry-pick 8207481c9aa79f4ec4468048e4f7163c9d227d76  # lxd/device: Sort nic devices ahead of others
      git cherry-pick e2f1766f420d942286c8cf2553a1672c1a16f04a  # lxd/device/device/utils/generic: Adds PCI management functions for overriding driver
      git cherry-pick 8a3e1a9242770ea4348c14932b8f19d678a42028  # lxd/device/device/utils/network: Removes network specific PCI bind/unbind functions
      git cherry-pick 4e85cb657eadc649b228bd70a2aa2aac2a0a4a16  # lxd/device/nic/physical: Updates to use generic PCI management functions
      git cherry-pick dea3e8fe77fdd11410b9a9968e3bc2882e5ce13e  # lxd/device/nic/sriov: Updates to use generic PCI management functions
      git cherry-pick f8de3180632a1e8de675b1ba943de017881882b8  # lxd/vm: Separate template keys in global/local
      git cherry-pick 3d1dca4c57363666ba53ce758d550390f125b528  # lxd/vm: Use virtio-gpu-pci on non-x86
      git cherry-pick e209429bbf852678fb95fad4b02a022db54a6817  # lxd/vm: Rename qemuVGA to qemuGPU
      git cherry-pick b9b023d4aef75a878d4935ca076ec256738b538a  # lxd/vm: Add virtio-input keyboard/mouse
      git cherry-pick 69598929e8eac6447019dd5087ec38534fec72b3  # lxd/vm: Move bus allocator to own file
      git cherry-pick 2f0b55d697a165d44498e3b419b2bb1bc6f3eaaa  # lxc/volume: Fix typo in help message
      git cherry-pick a148c525a797565ce4b88f78a448b1092a1ecf68  # i18n: Update translation templates
      git cherry-pick 00c0343ed4c1a3c98672f3ddd175befa81bf1257  # lxc/snapshot: Allow using snapshot delimiter
      git cherry-pick a5e51e82b0e7f335a501d7166abab4bf603515a5  # i18n: Update translation templates
      git cherry-pick d74e2b3510496399a4db64efbcdd1bbc3c0eea00  # doc/instances: Updates GPU device docs to show VM support
      git cherry-pick 30952ac99f238fb60eca066c0e630c6ae8aa5f85  # lxd/device/gpu: Updates validation for VM support
      git cherry-pick 0b20126bc957d47bae93c20b3fbf3e1857277857  # lxd/device/config/device/runconfig: Adds GPU field to RunConfig
      git cherry-pick b66850e46600d4d2381d886af580cd42940ff74e  # lxd/device/device/utils/generic: pciDeviceDriverOverride only check for driver binding if specified
      git cherry-pick 9fa30807fb688040a69b5a1f971b030183571419  # lxd/device/gpu: Adds VM GPU passthrough support
      git cherry-pick 377596671c14b7ddcc2076c023ec451bdb86a759  # lxd/instance/drivers/driver/qemu/templates: Consistent naming and casing for net dev templates
      git cherry-pick 74156abf23cf0571a9205b4f525c1c468abe7f44  # lxd/instance/drivers/driver/qemu: Consistent net dev naming usage
      git cherry-pick b96fd97b49c9bd06255e549d673f5eeabcd0ff96  # lxd/instance/drivers/driver/qemu/templates: Adds qemuGPUDevPhysical template
      git cherry-pick c44ad58feb55ccfdf67f48bb3a46569a0967ff1a  # lxd/instance/drivers/driver/qemu: Adds GPU passthrough support
      git cherry-pick 2043fe471ba865fedee74e0ebd7b1ca5246a7ccd  # lxd/instance/drivers/driver/qemu/bus: Adds comments, clarifies var names, and constants for defined multi-function groups
      git cherry-pick c9f7c54776c3f8487797f2beb73bbd8e6a29efb5  # lxd/instance/drivers/driver/qemu: Switches to multi-function group constants and adds comments
      git cherry-pick 21167c4e12ec4f1c1b87f413f6f8224a0ad83be5  # lxd/instance/drivers/qmp/monitor: Allow serial char device name to be passed in
      git cherry-pick e595037ac88ec82b188f5e5d5c9c8511799007fe  # lxd/instance/drivers/driver/qemu: Defines qemuSerialChardevName to share with qemu and qmp
      git cherry-pick de2572425018d023bd40410db8f6e59f6bde65a4  # lxd/instance/drivers/driver/qemu: qemuSerialChardevName usage
      git cherry-pick 973c9dd96436bd4d05bc97f66c5105b942187bde  # lxd/instance/drivers/driver/qemu/templates: Add serial chardev name injection
      git cherry-pick f00520c31f6797f1ed9b2bdb3be000148ce250ca  # lxd/storage/quota/projectquota: Only set quota on directories and regular files
      git cherry-pick 9c07af7e7685ccebb90187c3140be8d6c0a12a60  # lxd/db: Automatically strip ?project=default
      git cherry-pick f6f18a6c6966de1318a643cfde829ebcc6b2cc93  # lxc/action: Properly handle --all with remotes
      git cherry-pick 33eb77f92810df43126359773d97a5b082690e17  # lxd/projects: Properly clear empty keys
      git cherry-pick 698c63a0434a40251fb0d0ff5bca49d1fdcdd1bc  # lxd/db: Add missing feature to default project
      git cherry-pick e03b568c88b96247325c65b57fbe5368debfc5b6  # lxd/instance/drivers/driver/qemu: Pass-through GPU VGA mode status from host

      # Download any new dependencies
      export GOPATH=$(realpath ../go)
      go get -t -d ./...

      # Setup for our shared libraries
      sed -i "/\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/canonical/go-dqlite/internal/bindings/server.go
      sed -i "/^\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/mattn/go-sqlite3/sqlite3.go

      # Run the standard build
      set +ex
      snapcraftctl build
      set -ex

      # Build the agent (special build tags)
      CGO_ENABLED=0 go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd-agent" -tags=agent,netgo github.com/lxc/lxd/lxd-agent

      # Setup bash completion
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/
      echo 'export PATH="${PATH}:/snap/bin:/var/lib/snapd/snap/bin"' > ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
      cat scripts/bash/lxd-client >> ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/share/misc/: share/misc/
      var/lib/usbutils/usb.ids: share/misc/
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/dnsmasq
      - bin/getfattr
      - bin/setfattr
      - bin/iw
      - bin/pigz
      - bin/rsync
      - bin/setfacl
      - bin/sgdisk
      - bin/unsquashfs
      - bin/xdelta3

      - etc/bash_completion.d/snap.lxd.lxc

      - share/misc

      - bin/lxc
      - bin/lxc-to-lxd
      - bin/lxd
      - bin/lxd-agent
      - bin/lxd-benchmark

  lxd-migrate:
    source: lxd-migrate/
    after:
      - lxd
      - sqlite
    plugin: go
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd-pkg-snap/lxd-migrate
    override-build: |
      set -ex

      # Setup for our shared libraries
      sed -i "/^\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/mattn/go-sqlite3/sqlite3.go

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p ${SNAPCRAFT_PART_INSTALL}/bin/
      cp scripts/upgrade-bridge ${SNAPCRAFT_PART_INSTALL}/bin/upgrade-bridge
    prime:
      - bin/lxd-migrate
      - bin/upgrade-bridge

  shmounts:
    source: shmounts/
    plugin: make
    prime:
      - bin/setup-shmounts

  snap-query:
    source: snap-query/
    plugin: go
    go-importpath: github.com/lxc/lxd-pkg-snap/snap-query
    prime:
      - bin/snap-query

  strip:
    source: snapcraft/empty
    after:
      - btrfs
      - ceph
      - dqlite
      - libco
      - libseccomp
      - logrotate
      - lvm
      - nano
      - nvidia-container
      - openvswitch
      - raft
      - sqlite
      - squashfs-tools-ng
      - vim
      - xfs
      - xtables
      - xz
      - zfs-0-6
      - zfs-0-7
      - zfs-0-8
      - lxc
      - lxcfs
      - criu
      - lxd
      - lxd-migrate
      - shmounts
      - snap-query
    plugin: nil
    override-prime: |
      set -x

      # Strip some of the heavy bits
      strip -s ${SNAPCRAFT_PRIME}/bin/lxc
      strip -s ${SNAPCRAFT_PRIME}/bin/lxd*
      strip -s ${SNAPCRAFT_PRIME}/bin/snap*
      strip -s ${SNAPCRAFT_PRIME}/lib/liblxc*
      strip -s ${SNAPCRAFT_PRIME}/lib/libdqlite*
      strip -s ${SNAPCRAFT_PRIME}/lib/libsqlite*

      for zfs in zfs-0.6 zfs-0.7 zfs-0.8; do
          [ ! -d "${SNAPCRAFT_PRIME}/${zfs}" ] && continue
          strip -s ${SNAPCRAFT_PRIME}/${zfs}/bin/* ${SNAPCRAFT_PRIME}/${zfs}/lib/*
      done

      [ -e "${SNAPCRAFT_PRIME}/criu/criu" ] && strip -s ${SNAPCRAFT_PRIME}/criu/criu

      exit 0

  wrappers:
    plugin: dump
    source: snapcraft/
    organize:
      hooks/: snap/hooks/
