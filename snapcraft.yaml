name: lxd
base: core20
assumes:
  - snapd2.39
version: "4.15"
grade: stable
summary: LXD - container and VM manager
description: |-
 LXD is a system container and virtual machine manager.

 It offers a simple CLI and REST API to manage local or remote instances,
 uses an image based workflow and support for a variety of advanced features.

 Images are available for all Ubuntu releases and architectures as well
 as for a wide number of other Linux distributions. Existing
 integrations with many deployment and operation tools, makes it work
 just like a public cloud, except everything is under your control.

 LXD containers are lightweight, secure by default and a great
 alternative to virtual machines when running Linux on Linux.

 LXD virtual machines are modern and secure, using UEFI and secure-boot
 by default and a great choice when a different kernel or operating
 system is needed.

 With clustering, up to 50 LXD servers can be easily joined and managed
 together with the same tools and APIs and without needing any external
 dependencies.


 Supported configuration options for the snap (snap set lxd [<key>=<value>...]):

   - ceph.builtin: Use snap-specific Ceph configuration [default=false]
   - ceph.external: Use the system's ceph tools (ignores ceph.builtin) [default=false]
   - criu.enable: Enable experimental live-migration support [default=false]
   - daemon.debug: Increase logging to debug level [default=false]
   - daemon.group: Set group of users that can interact with LXD [default=lxd]
   - daemon.preseed: Pass a YAML configuration to `lxd init` on initial start
   - daemon.syslog: Send LXD log events to syslog [default=false]
   - lvm.external: Use the system's LVM tools [default=false]
   - lxcfs.pidfd: Start per-container process tracking [default=false]
   - lxcfs.loadavg: Start tracking per-container load average [default=false]
   - lxcfs.cfs: Consider CPU shares for CPU usage [default=false]
   - openvswitch.builtin: Run a snap-specific OVS daemon [default=false]
   - shiftfs.enable: Enable shiftfs support [default=auto]

 For system-wide configuration of the CLI, place your configuration in
 /var/snap/lxd/common/global-conf/ (config.yml and servercerts)

confinement: strict

apps:
  # Main commands
  activate:
    command: commands/daemon.activate
    daemon: oneshot
    plugs:
      - lxd-support
      - system-observe

  daemon:
    command: commands/daemon.start
    reload-command: commands/daemon.reload
    stop-command: commands/daemon.stop
    stop-timeout: 600s
    restart-condition: on-failure
    daemon: simple
    slots:
      - lxd
    plugs:
      - lxd-support
      - network-bind
      - system-observe
    sockets:
      unix:
        listen-stream: $SNAP_COMMON/lxd/unix.socket
        socket-mode: 0660

  lxc:
    command: commands/lxc
    completer: etc/bash_completion.d/snap.lxd.lxc
    plugs:
      - lxd-support
      - system-observe

  lxd:
    command: commands/lxd
    plugs:
      - lxd-support
      - system-observe

  # Sub-commands
  benchmark:
    command: commands/lxd-benchmark
    plugs:
      - lxd-support
      - system-observe
  buginfo:
    command: commands/buginfo
    plugs:
      - lxd-support
      - system-observe
  check-kernel:
    command: commands/lxd-check-kernel
    plugs:
      - lxd-support
      - system-observe
  lxc-to-lxd:
    command: commands/lxc-to-lxd
    plugs:
      - lxd-support
      - system-observe
  migrate:
    command: commands/lxd-migrate
    plugs:
      - lxd-support
      - system-observe

hooks:
  configure:
    plugs:
      - network
      - system-observe
  remove:
    plugs:
      - lxd-support
      - system-observe

parts:
  # Dependencies
  btrfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - btrfs-progs
    organize:
      sbin/: bin/
    prime:
      - bin/btrfs
      - bin/btrfstune
      - bin/mkfs.btrfs

  ceph:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ceph-common
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/ceph
      - bin/rbd
      - lib/*/ceph
      - lib/*/libatomic.so*
      - lib/*/libboost_iostreams.so*
      - lib/*/libboost_program_options.so*
      - lib/*/libboost_thread.so*
      - lib/*/libcephfs*
      - lib/*/libibverbs.so*
      - lib/*/librados.so*
      - lib/*/librbd.so*
      - lib/*/librdmacm.so*
      - lib/*/libsnappy.so*
      - lib/python3

  criu:
    source: https://github.com/checkpoint-restore/criu
    source-tag: v3.15
    source-type: git
    source-depth: 1
    plugin: nil
    build-packages:
      - asciidoc
      - libcap-dev
      - libnet1-dev
      - libnl-3-dev
      - libprotobuf-c-dev
      - libprotobuf-dev
      - protobuf-c-compiler
      - protobuf-compiler
      - xmlto
    stage-packages:
      - libnet1
      - libprotobuf-c1
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "armv7l" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      make
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/criu/"
      cp criu/criu "${SNAPCRAFT_PART_INSTALL}/criu/"
    organize:
      usr/lib/: lib/
    prime:
      - criu/*
      - lib/*/libnet*
      - lib/*/libproto*

  dqlite:
    after:
      - raft
      - sqlite
    source: https://github.com/canonical/dqlite
    source-type: git
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libdqlite*so*
      - lib/*/libuv*

  edk2:
    source: https://github.com/tianocore/edk2
    source-type: git
    source-tag: IRRELEVANT
    source-depth: 1
    plugin: nil
    build-packages:
      - acpica-tools
      - nasm
      - uuid-dev
    override-pull: |-
      set -ex
      git clone https://github.com/tianocore/edk2 . -b edk2-stable202105

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      # Fix submodules
      sed -i "s#https://git.cryptomilk.org/projects/cmocka#https://gitlab.com/cmocka/cmocka#g" .gitmodules
      git submodule update --init --recursive

      # Apply patches
      patch -p1 < "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0001-force-DUID-LLT.patch"
      cp "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0002-logo.bmp" MdeModulePkg/Logo/Logo.bmp
      patch -p1 < "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0003-boot-delay.patch"
      patch -p1 < "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0004-gcc-errors.patch"

      ARCH="X64"
      PKG="OvmfPkg/OvmfPkgX64.dsc"
      FV_CODE="OVMF_CODE"
      FV_VARS="OVMF_VARS"
      if [ "$(uname -m)" = "aarch64" ]; then
          ARCH="AARCH64"
          PKG="ArmVirtPkg/ArmVirtQemu.dsc"
          FV_CODE="QEMU_EFI"
          FV_VARS="QEMU_VARS"
      fi

      # Run in a bash sub-shell as edksetup.sh requires it
      set -ex
      (
      cat << EOF
          . ./edksetup.sh
          make -C BaseTools ARCH=${ARCH}
          build -a ${ARCH} -t GCC49 -b RELEASE -p ${PKG} \
            -DSECURE_BOOT_ENABLE=TRUE \
            -DNETWORK_IP4_ENABLE=TRUE \
            -DNETWORK_IP6_ENABLE=TRUE \
            -DNETWORK_TLS_ENABLE=TRUE \
            -DNETWORK_HTTP_BOOT_ENABLE=TRUE \
            -DFD_SIZE_2MB \
            -DTPM2_ENABLE=TRUE
      EOF
      ) | bash -e

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      cp Build/*/*/FV/${FV_CODE}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
      cp Build/*/*/FV/${FV_VARS}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"

      if [ "$(uname -m)" = "aarch64" ]; then
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"
      fi

    prime:
      - share/qemu/*

  libmnl:
    source: https://git.netfilter.org/libmnl
    source-type: git
    source-tag: libmnl-1.0.4
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    organize:
      usr/lib/: lib/
    prime:
      - lib/libmnl*so*

  libnftnl:
    after:
      - libmnl
    source: https://git.netfilter.org/libnftnl
    source-type: git
    source-tag: libnftnl-1.2.0
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    organize:
      usr/lib/: lib/
    prime:
      - lib/libnftnl*so*
    override-build: |
      snapcraftctl build

      sed -i "s# /lib/libmnl.la# ${SNAPCRAFT_STAGE}/lib/libmnl.la#g" "${SNAPCRAFT_PART_INSTALL}/lib/libnftnl.la"

  libseccomp:
    source: https://github.com/seccomp/libseccomp
    source-type: git
    source-tag: v2.5.1
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    build-packages:
      - gperf
    organize:
      usr/lib/: lib/
    prime:
      - lib/libseccomp*so*

  libtpms:
    source: https://github.com/stefanberger/libtpms
    source-type: git
    source-tag: v0.8.3
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
      - --with-tpm2
      - --with-openssl
    organize:
      usr/lib/: lib/
    prime:
      - lib/libtpms*so*

  libusb:
    source: https://github.com/libusb/libusb
    source-type: git
    source-tag: v1.0.24
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    organize:
      usr/lib/: lib/
    prime:
      - lib/libusb*so*

  logrotate:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - logrotate
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    stage:
      - bin/logrotate
    prime:
      - bin/logrotate

  lvm:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - dmeventd
      - lvm2
      - thin-provisioning-tools
    organize:
      sbin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/cache_*
      - bin/dmeventd
      - bin/era_*
      - bin/lv*
      - bin/pdata_tools
      - bin/pv*
      - bin/thin_*
      - bin/vg*
      - -bin/vgimportclone
      - -bin/lvmconf
      - -bin/lvmdump
      - -bin/lvmetad
      - -bin/lvmpolld
      - etc/lvm/lvm.conf
      - lib/*/device-mapper/*
      - lib/*/libaio.so*
      - lib/*/libdevmapper*
      - lib/*/liblvm*
      - lib/*/libreadline.so*

  nano:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - nano
    organize:
      usr/bin/: bin/
    prime:
      - bin/nano
      - etc/nanorc

  nftables:
    after:
      - libmnl
      - libnftnl
    source: https://git.netfilter.org/nftables
    source-type: git
    source-tag: v0.9.8
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
      - --with-json
    build-packages:
      - libjansson-dev
      - libreadline-dev
    stage-packages:
      - libjansson4
    organize:
      sbin/: bin/
      usr/lib/: lib/
    prime:
      - bin/nft
      - lib/*/libjansson*so*
      - lib/libnftables*so*

  nvidia-container:
    after:
      - libseccomp
    source: https://github.com/NVIDIA/libnvidia-container
    source-type: git
    source-tag: v1.4.0
    source-depth: 1
    plugin: make
    build-packages:
      - bmake
      - curl
      - lsb-release
    override-build: |-
      set -ex

      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/bin/"
      cp ${SNAPCRAFT_PROJECT_DIR}/snapcraft/wrappers/nvidia-container-cli "${SNAPCRAFT_PART_INSTALL}/bin/"

      set +ex
      snapcraftctl build
    organize:
      usr/local/bin/nvidia-container-cli: bin/nvidia-container-cli.real
      usr/local/lib: lib/
    prime:
      - bin/nvidia-container-cli*
      - lib/libnvidia-container.so*

  openvswitch:
    source: https://github.com/openvswitch/ovs
    source-type: git
    source-tag: v2.15.0
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    stage-packages:
      - uuid-runtime
    organize:
      sbin/: bin/
      usr/bin/: bin/
    prime:
      - bin/ovs-appctl
      - bin/ovs-vsctl
      - bin/ovs-vswitchd
      - bin/ovsdb-*
      - bin/uuidgen
      - share/openvswitch/

  ovn:
    after:
      - openvswitch
    source: https://github.com/ovn-org/ovn
    source-type: git
    source-tag: v21.03.0
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
      - --with-ovs-source=../../openvswitch/build/
    prime:
      - bin/ovn-nbctl

  spice-protocol:
    source: https://gitlab.freedesktop.org/spice/spice-protocol
    source-type: git
    source-tag: v0.14.3
    source-depth: 1
    plugin: meson
    prime: []

  spice-server:
    after:
      - spice-protocol
    source: https://gitlab.freedesktop.org/spice/spice
    source-type: git
    source-tag: v0.15.0
    source-depth: 1
    plugin: meson
    meson-parameters:
      - --prefix=/
      - -Dgstreamer=no
      - -Dmanual=false
      - -Dlz4=false
      - -Dsasl=false
      - -Dopus=disabled
      - -Dsmartcard=disabled
      - -Dtests=false
    build-packages:
      - libjpeg-turbo8-dev
      - python3-pyparsing
      - python3-six
    stage-packages:
      - libjpeg-turbo8
      - libpixman-1-0
    organize:
      sbin/: bin/
      usr/lib: lib/
      usr/local/lib/: lib/
    prime:
      - lib/*/libjpeg*so*
      - lib/*/libspice-server*so*
      - lib/*/libpixman*so*

  swtpm:
    after:
      - libseccomp
      - libtpms
    source: https://github.com/stefanberger/swtpm
    source-type: git
    source-tag: v0.5.2
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
      - --with-seccomp
      - --with-openssl
      - --without-cuse
    build-packages:
      - expect
      - gawk
      - iproute2
      - python3-cryptography
      - python3-setuptools
      - socat
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      lib/swtpm/: lib/
    prime:
      - bin/swtpm
      - lib/libswtpm*so*

  qemu:
    after:
      - libseccomp
      - libusb
      - spice-protocol
      - spice-server
    source: IRRELEVANT
    source-type: git
    source-tag: IRRELEVANT
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --disable-bochs
      - --disable-cloop
      - --disable-dmg
      - --disable-docs
      - --disable-guest-agent
      - --disable-parallels
      - --disable-qed
      - --disable-sheepdog
      - --disable-slirp
      - --disable-user
      - --disable-vdi
      - --disable-vnc
      - --disable-xen
      - --enable-attr
      - --enable-cap-ng
      - --enable-kvm
      - --enable-libusb
      - --enable-usb-redir
      - --enable-linux-aio
      - --enable-numa
      - --enable-pie
      - --enable-rbd
      - --enable-seccomp
      - --enable-spice
      - --enable-system
      - --enable-tcg
      - --enable-tools
      - --enable-vhost-crypto
      - --enable-vhost-kernel
      - --enable-vhost-net
      - --enable-vhost-scsi
      - --enable-vhost-user
      - --enable-vhost-vsock
      - --enable-virtfs
      - --firmwarepath=/snap/lxd/current/share/qemu/
      - --localstatedir=/var/
    build-packages:
      - bison
      - flex
      - pkg-config
      - libaio-dev
      - libcap-ng-dev
      - libglib2.0-dev
      - libnuma-dev
      - libpixman-1-dev
      - librbd-dev
      - libusbredirhost-dev
    stage-packages:
      - genisoimage
      - libmagic1
      - libnuma1
      - libpixman-1-0
      - libusbredirhost1
      - libusbredirparser1
    override-pull: |-
      set -ex
      git clone https://github.com/qemu/qemu . -b v5.2.0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      patch -p1 < "${SNAPCRAFT_PROJECT_DIR}/patches/qemu-0001-hw-s390x-fix-build-for-virtio-9p-ccw.patch"
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && [ "$(uname -m)" != "ppc64le" ] && [ "$(uname -m)" != "s390x" ] && exit 0

      set -ex
      # Mangle the configure a bit
      QEMUARCH="$(uname -m)"
      [ "${QEMUARCH}" = "ppc64le" ] && QEMUARCH="ppc64"
      sed -i "s/^unset target_list$/target_list=\"${QEMUARCH}-softmmu\"/" configure
      sed -i 's#libseccomp_minver=".*#libseccomp_minver="0.0"#g' configure
      sed -i "s#https://git.qemu.org/git#https://github.com/qemu#g" .gitmodules

      set +ex
      snapcraftctl build
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/local/bin/: bin/
      usr/local/lib/: lib/
      usr/local/libexec/: bin/
      usr/local/share/: share/
    prime:
      - bin/genisoimage*
      - bin/mkisofs*
      - bin/qemu-system-*
      - bin/qemu-img*
      - bin/virtfs-proxy-helper*
      - bin/virtiofsd*
      - lib/*/libatomic.so*
      - lib/*/libmagic*so*
      - lib/*/libnuma*so*
      - lib/*/libpixman*so*
      - lib/*/libusbredir*so*
      - share/qemu/keymaps*
      - share/qemu/efi-virtio.rom*
      - share/qemu/kvmvapic.bin*
      - share/qemu/s390-*.img*
      - share/qemu/slof.bin*
      - share/qemu/vgabios-*.bin*

  qemu-ovmf-secureboot:
    after:
      - edk2
      - qemu
    source: https://github.com/puiterwijk/qemu-ovmf-secureboot
    source-type: git
    source-depth: 1
    plugin: nil
    build-packages:
      - xorriso
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      export ARCH="$(basename $(readlink -f ${SNAPCRAFT_STAGE}/lib/*-linux-gnu*/))"
      export LD_LIBRARY_PATH="${SNAPCRAFT_STAGE}/lib:${SNAPCRAFT_STAGE}/lib/${ARCH}"

      set -ex
      rm -Rf iso-root vfat-root shell.iso
      mkdir -p iso-root vfat-root/efi/boot
      cp ../../edk2/build/Build/*/*/*/Shell.efi vfat-root/efi/boot/bootx64.efi
      cp ../../edk2/build/Build/*/*/*/EnrollDefaultKeys.efi vfat-root/
      "${SNAPCRAFT_STAGE}/bin/qemu-img" convert --image-opts driver=vvfat,floppy=on,fat-type=12,label=UEFI_SHELL,dir=vfat-root iso-root/shell.img
      xorriso --as mkisofs -input-charset ASCII -J -rational-rock -e shell.img -no-emul-boot -o shell.iso iso-root/

      # Basic aarch64 support
      if [ "$(uname -m)" = "aarch64" ]; then
          sed -i ovmf-vars-generator \
              -e "s/'-machine', machinetype,/'-machine', 'virt', '-cpu', 'cortex-a57',/" \
              -e "/charserial1/d" \
              -e "s/ide-cd/scsi-cd/" \
              -e "s/'-device',$/'-device', 'virtio-scsi-pci,id=scsi', '-device',/"
      elif [ "$(uname -m)" = "x86_64" ]; then
          cp -f "${SNAPCRAFT_STAGE}/share/qemu/kvmvapic.bin" .
      fi

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      python3 ovmf-vars-generator \
        --qemu-binary "${SNAPCRAFT_STAGE}/bin/qemu-system-$(uname -m)" \
        --print-output --disable-smm --skip-testing \
        --oem-string "$(cat ${SNAPCRAFT_PROJECT_DIR}/snapcraft/etc/ubuntu-sb.crt)" \
        --ovmf-binary "${SNAPCRAFT_STAGE}/share/qemu/OVMF_CODE.fd" \
        --ovmf-template-vars "${SNAPCRAFT_STAGE}/share/qemu/OVMF_VARS.fd" \
        --uefi-shell-iso shell.iso \
        "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.ms.fd"
    prime:
      - share/qemu/*

  raft:
    source: https://github.com/canonical/raft
    source-type: git
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    stage-packages:
      - libuv1
      - liblz4-1
    build-packages:
      - libuv1-dev
      - liblz4-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libraft*so*
      - lib/*/libuv.so*

  sqlite:
    source: https://github.com/sqlite/sqlite
    source-type: git
    source-depth: 1
    source-tag: version-3.35.5
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    build-packages:
      - tcl
    override-build: |-
      set -ex

      git log -1 --format=format:%ci%n | sed -e 's/ [-+].*$//;s/ /T/;s/^/D /' > manifest
      git log -1 --format=format:%H > manifest.uuid
      cp /usr/share/misc/config.guess .
      cp /usr/share/misc/config.sub .
      autoreconf -f -i

      set +ex
      snapcraftctl build
    prime:
      - bin/sqlite3
      - lib/libsqlite3*so*

  squashfs-tools-ng:
    source: https://github.com/AgentD/squashfs-tools-ng
    source-type: git
    source-tag: v1.1.1
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    build-packages:
      - liblzma-dev
    prime:
      - bin/sqfs2tar
      - bin/tar2sqfs
      - lib/libsquashfs.so*

  vim:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - vim-common
      - vim-tiny
    organize:
      usr/bin/: bin/
      usr/share/vim/vim*/debian.vim: etc/vimrc
    prime:
      - bin/vim.tiny
      - etc/vimrc

  xfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xfsprogs
    organize:
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/xfs_admin
      - bin/xfs_db
      - bin/xfs_growfs
      - bin/xfs_repair
      - bin/mkfs.xfs

  xtables:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - arptables
      - ebtables
    organize:
      usr/lib/ebtables/: lib/
      usr/sbin/: bin/
    prime:
      - bin/arptables-legacy
      - bin/ebtables-legacy
      - etc/ethertypes
      - etc/protocols
      - lib/libebtc.so.*

  xz:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xz-utils
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/lzma
      - bin/xz
      - lib/*/liblzma*so*
    override-build: |
      snapcraftctl build

      # Include the lzma symlink
      ln -s xz "${SNAPCRAFT_PART_INSTALL}/usr/bin/lzma"

  zfs-0-6:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.6.5.11
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=/
      - --with-config=user
    build-packages:
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick fb963d33ee0dd350143ba1c9cd35d5f7d86910d2  # Fix endian build problem on ppc64el

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-7:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.7.13
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=/
      - --with-config=user
    build-packages:
      - libblkid-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-8:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.8.6
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=/
      - --with-config=user
    build-packages:
      - libblkid-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-2-0:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-2.0.4
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=/
      - --with-config=user
    build-packages:
      - libblkid-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zstd:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - zstd
    organize:
      usr/bin/: bin/
    prime:
      - bin/pzstd
      - bin/zstd

  # Core components
  lxc:
    after:
      - libseccomp
    source: https://github.com/lxc/lxc
    source-type: git
    source-tag: lxc-4.0.9
    build-packages:
      - libapparmor-dev
      - libcap-dev
      - libgnutls28-dev
      - libselinux1-dev
      - pkg-config
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
      - --disable-api-docs
      - --disable-bash
      - --disable-doc
      - --disable-examples
      - --disable-memfd-rexec
      - --disable-tests
      - --disable-tools
      - --enable-apparmor
      - --enable-seccomp
      - --enable-selinux
      - --enable-capabilities
      - --with-rootfs-path=/var/snap/lxd/common/lxc/
      - --libexecdir=/snap/lxd/current/libexec/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/libexec: libexec
      share/lxc/hooks: lxc/hooks
    prime:
      - bin/lxc-checkconfig
      - lib/liblxc.so.1
      - lib/liblxc.so.1.*
      - lxc/config/common.conf.d
      - lxc/hooks/nvidia
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/
      ln -s /var/snap/lxd/common/lxc/local.conf $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/01-local.conf
      sed -i "s#includedir=.*#includedir=$SNAPCRAFT_PART_INSTALL/include#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc
      sed -i "s#libdir=.*#libdir=$SNAPCRAFT_PART_INSTALL/lib#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc

  lxcfs:
    source: https://github.com/lxc/lxcfs
    source-type: git
    source-tag: lxcfs-4.0.8
    build-packages:
      - libfuse-dev
      - libpam0g-dev
      - pkg-config
    stage-packages:
      - fuse
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
      - --datarootdir=/snap/lxd/current/
      - --localstatedir=/var/snap/lxd/common/var/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/lxcfs: lxcfs
      lib/lxcfs: lib
    prime:
      - bin/fusermount
      - lib/*/libfuse.so.*

      - bin/lxcfs
      - lib/liblxcfs.so

      - lxc
      - lxcfs
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      set +ex
      snapcraftctl build
      set -ex

      sed -i "s#\${LXC_ROOTFS_MOUNT}/var/snap/lxd/common/var/lib/lxcfs/#\${LXC_ROOTFS_MOUNT}/var/lib/lxcfs/#g" $SNAPCRAFT_PART_INSTALL/snap/lxd/current/lxcfs/lxc.mount.hook

  lxd:
    source: https://github.com/lxc/lxd
    source-type: git
    source-tag: lxd-4.15
    after:
      - lxc
      - dqlite
      - sqlite
    build-packages:
      - libacl1-dev
      - libudev-dev
      - pkg-config
    build-snaps:
      - go
    stage-packages:
      - acl
      - attr
      - dnsmasq-base
      - gdisk
      - iw
      - netbase
      - pciutils
      - pigz
      - rsync
      - squashfs-tools
      - usbutils
      - xdelta3
    plugin: nil
    override-build: |
      set -ex

      # Git cherry-picks
      cd ../src
      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick 31d345ca4166fada764ecb132e6c24130665f5fd  # lxd/resources: Set RPM to 1 instead of 0 when rotational
      git cherry-pick df0b666c5c0a3d89d7cb24707aa93cdb9d73b0af  # include: add open_tree() and mount_setattr()
      git cherry-pick c15ca5916632fdbe8495b9bc97ad87c902489884  # doc/projects: Remove white list term
      git cherry-pick 7eb83523cb8efefce9c837fd6f1ab0490e3a3fe5  # Remove hang term
      git cherry-pick bcf09fd618565e06d08f32f250aec6d35c5629b8  # Remove white term
      git cherry-pick 49d663a4a999e0d9e9aa0bb70e9cf5f6c724902a  # lxd/cluster/gateway: Remove black term
      git cherry-pick 305a18a5b3172bebeff4fbc9120e82a416034cb0  # Remove dummy term
      git cherry-pick 34729f5c336a69c26a97cb5b400e12ab883fc779  # lxd/main/checkfeature: Remove dummy term
      git cherry-pick 1375c72b79b4975edd37a9cd6376d0035747cbf8  # shared/idmap/shift/linux: Rename set_dummy_fs_ns_caps to spoof_fs_ns_caps
      git cherry-pick 2b587eacb9e09b5019a5f11a543197746b5c2677  # Remove sanity term
      git cherry-pick 5f19a991c6f1c08070f9d144befa6061d5c0ee2a  # Replace Sanity Checks with Quick Checks
      git cherry-pick a002dc1b38fb48d1a1630ce524e7126da1e03f43  # lxd/db: Update schema to apply removal of sanity term
      git cherry-pick 31be48fcc038a0c4d11043c1652872160b2825be  # lxd: use idmapped mounts
      git cherry-pick 0b0b4068b15a590f3a982129311be6d883a65c3a  # lxd: ensure absolute paths when hotplugging mounts
      git cherry-pick f3596a15bb9cb9b6fadf419d311da60379540564  # forkmount: update terminology
      git cherry-pick 5625a8a81afaf37bf60af13f14ede2cbb60e5667  # disk: allow the use of idmapped mounts
      git cherry-pick f57af729a2fc58e380b2cf912ab62bac147b0713  # seccomp: handle idmapped mounts
      git cherry-pick c51e6e2d05be1dcc2bf42fb5ad35334b907c6a61  # lxd: split storage handling in startCommon() into separate helper
      git cherry-pick cf5ef0dee6e8af38d37d5860ff52946bf95e6537  # lxd: remove remaining DiskIdmap call in startCommon()
      git cherry-pick 26291fcabe6b81b92cfebe30a939e8458ac70571  # Makefile: Add "build" target
      git cherry-pick 5b09568073f770c7aa08cc011608564928aedb29  # lxd/instance/drivers/driver/common: Adds Internal MAAS handling functions
      git cherry-pick 6fd31bd80402c304725690e4007062f9dcdf23f5  # lxd/instance/drivers/driver/lxc: Switch to common MAAS handling functions
      git cherry-pick d30dabe0aa577ae88d8860501eacd049599acede  # lxd/instance/drivers/driver/qemu: Switch to common MAAS handling functions
      git cherry-pick 5322478e5f20d6299a2b708f8bad8c3f9a748945  # Revert "lxd/main_init_interactive: replace empty validator for choosing cluster config with nil"
      git cherry-pick 3b9ee52adcc7ab43a9d0fe8b1810d4fd8b7dd23f  # lxd/instance/drivers/load: Add revert arg to create
      git cherry-pick d308f9537be3ce60cdd7f8468cbcfb8b3de85e18  # lxd/instance/drivers/driver/common: Don't revert by calling inst.Delete() until after storage volume created in snapshotCommon
      git cherry-pick cac7c174d4f8a9a0c105003fc869c30f55dd28c9  # lxd/instance/drivers/driver/lxc: Add revert arg to lxcCreate and don't call d.Delete() in revert steps
      git cherry-pick 30f04eb3705813ceb26e8586e249a762658cf818  # lxd/instance/drivers/driver/qemu: Add revert arg to qemuCreate and don't call d.Delete() in revert steps
      git cherry-pick 49bb48e909cd938d5c5c246a4271a78a8b925a03  # lxd/instance/instance/utils: Updates Create signature with revert arg
      git cherry-pick d5e2067d01acc985e0f0d137d979cba3c57cd36c  # lxd/instance/instance/utils: Updates CreateInternal with a revert arg
      git cherry-pick 9cbe1128d6212f582cfdbc497e7816bc8cde390c  # lxd: instance.CreateInternal usage in tests
      git cherry-pick d3b2cacb04f4a23a7e69ef41d373d956c7658a22  # lxd/instance: Update instanceCreateAsEmpty to only revert with inst.Delete() after storage volume created
      git cherry-pick 84020c1736bf6ee3b0e441532d9191ad2288e0fd  # lxd/instance: Updates instanceCreateFromImage to only revert with inst.Delete() after storage volume created
      git cherry-pick 50540c2a559021543115782e893c972c837c70ae  # lxd/instance: Updates instanceCreateAsCopy to only revert with inst.Delete() after storage volume created
      git cherry-pick ae9966822f4ad93a24ade48ed9bab86221e857d5  # lxd/api/internal: instance.CreateInternal revert usage in internalImport
      git cherry-pick 3755e17ead356ec765812ad12d4d40e98ece3344  # lxd/instances/post: instance.CreateInternal usage in createFromMigration
      git cherry-pick 4571805186fd4bd41bf1f7cec9ed79ad2fa40f2d  # lxd/migrate/instance: Adds revert arg to Do function to allow usage of instance.CreateInternal
      git cherry-pick cf475bdc5ce041464c43d180a45dac00707f63fd  # lxd/migrate/instance: Add instance delete to revert after storage volume migration succeeded in Do
      git cherry-pick 98eedef05067668bf8cc32b13e794c62006b2a87  # lxd/instances/post: Updates createFromMigration to pass revert to instance.CreateInternal
      git cherry-pick 54a236bb234ece275d5aabd974adeb0db2da3963  # lxd/migrate/instance: Go var naming style suggestions
      git cherry-pick 05fa094d934580a0d8aecc39a530415a3b86a878  # lxd: check for new idmapped mounts extension in LXC
      git cherry-pick 64f8a3573868ede25ea492fd2e3d1a87ba2c39ce  # lxd/storage/backend/lxd: Remove post hook resize from CreateInstanceFromBackup
      git cherry-pick ec94c02331b01d382cc4125b28e81e5c45a1a505  # lxd/storage/drivers/driver/common: Adds createVolumeFromBackupInstancePostHookResize function
      git cherry-pick 47862a68a5bbc92c3d57606f480d8fb0a8e1a9b0  # lxd/storage/drivers/driver/btrfs/volumes: Updates CreateVolumeFromBackup to use createVolumeFromBackupInstancePostHookResize in generic post hook
      git cherry-pick 5b5b4c8bd6067af0ba7e2272156f6b272750d39f  # lxd/storage/drivers/driver/ceph/volumes: Updates CreateVolumeFromBackup to use createVolumeFromBackupInstancePostHookResize in generic post hook
      git cherry-pick 7ee17397e3432988e80ae499237371b7d177e0aa  # lxd/storage/drivers/driver/dir/volumes: Updates CreateVolumeFromBackup to use createVolumeFromBackupInstancePostHookResize in generic post hook
      git cherry-pick a458634bdb8283160a4884a3442574459ed6091d  # lxd/storage/drivers/driver/lvm/volumes: Updates CreateVolumeFromBackup to use createVolumeFromBackupInstancePostHookResize in generic post hook
      git cherry-pick 5568e42a73b28678417c7135de9f854852c8b39e  # lxd/storage/drivers/driver/zfs/volumes: Updates CreateVolumeFromBackup to use createVolumeFromBackupInstancePostHookResize in generic post hook
      git cherry-pick 7b47cf7a673d9b4df303996579bde070bbbe9dc8  # lxd/storage/drivers/driver/generic/vfs: Adds VMConfigDriveMountDir constant
      git cherry-pick 8cafd8f91430a65859ea6131d634133de5301a77  # lxd/storage/drivers/generic/vfs: Exclude config.mount directory in genericVFSBackupVolume
      git cherry-pick b5e76adcd4345684cbf323cae37d841fd1d8e811  # lxd/instance/drivers/driver/qemu: storageDrivers.VMConfigDriveMountDir usage
      git cherry-pick ba4e55f5e4ef7ce76e245297d2ac4d5537f7dfd1  # lxd/storage/drivers/utils: Adds force arg to shrinkFileSystem
      git cherry-pick 6f43748a2063f0b1185987b2e405ba36933fcaef  # lxd/storage/drivers: SetVolumeQuota comment consistency
      git cherry-pick 11995aeccc666cdc984abfd7e668b1d91f5483a8  # lxd/storage/drivers/driver/ceph/volumes: shrinkFileSystem force arg usage
      git cherry-pick ec290a4e919f4930c39dd7761384e3e309112ff3  # lxd/storage/drivers/driver/lvm/volumes: shrinkFileSystem force arg usage
      git cherry-pick 2adc0fd59bddf1353b88425e63764f2e80652e71  # lxd/storage/drivers/driver/common: runFiller comment improvement
      git cherry-pick cd7295cbb720ad0fcad650f88e648f194e66809e  # lxd/storage/drivers/driver/common: Enable unsafe resize for container volumes in createVolumeFromBackupInstancePostHookResize
      git cherry-pick 1c5db5e2b495c0170ccb18e93ac79194b3f61007  # lxd/network/network/utils: Fix error reporting bug in parseIPRange
      git cherry-pick 2a147af452bdb9393602a67d1eafeb80dc68adb8  # lxd/network/network/utils/test: Fix tests in Example_parseIPRange to work with Go tip
      git cherry-pick fe0e09f6ce5a03cdbeb3cedb164aac830acfab02  # Revert "lxd/storage/backend/lxd: Remove post hook resize from CreateInstanceFromBackup"
      git cherry-pick d7efd22c95a7a1a89f9283ac7308481f286d0ada  # Revert "lxd/storage/drivers/driver/btrfs/volumes: Updates CreateVolumeFromBackup to use createVolumeFromBackupInstancePostHookResize in generic post hook"
      git cherry-pick c634c44735b8d61545a412e47c6b16ef1bfbe678  # Revert "lxd/storage/drivers/driver/ceph/volumes: Updates CreateVolumeFromBackup to use createVolumeFromBackupInstancePostHookResize in generic post hook"
      git cherry-pick 92a70eb7fb5a962d7e3eb8dc1734b19a1ce82a39  # Revert "lxd/storage/drivers/driver/lvm/volumes: Updates CreateVolumeFromBackup to use createVolumeFromBackupInstancePostHookResize in generic post hook"
      git cherry-pick f70725a27d35680981695a8027151c89fa3525a2  # Revert "lxd/storage/drivers/driver/zfs/volumes: Updates CreateVolumeFromBackup to use createVolumeFromBackupInstancePostHookResize in generic post hook"
      git cherry-pick de0708edad77fbf3ffd58ae559c02916a782b101  # lxd/storage/drivers/driver/dir/volumes: Remove call to createVolumeFromBackupInstancePostHookResize
      git cherry-pick 01622c773a2de69b49d8b23a49385188218accd4  # lxd/storage/drivers/volume: Add VolumePostHook type
      git cherry-pick b0412c832bdd6475ea1f46d5b4326b6b044c3789  # lxd/storage/drivers: Update CreateVolumeFromBackup and associated function to use VolumePostHook type
      git cherry-pick 86099de474ffe0431239273309f0836564c72760  # lxd/revert/revert: Add Hook function type
      git cherry-pick bd64f4350fbcae6559f38da95ebcf08439b12409  # lxd/storage/backend: Update CreateInstanceFromBackup signature to use revert.Hook
      git cherry-pick d7c3f83437e1c1e0564b0e674b240209619b4ef2  # lxd/storage/drivers: Updates CreateVolumeFromBackup and associated function to use revert.Hook type
      git cherry-pick 413bc791252d360319ca4f72042e07d909978062  # lxd/storage/drivers/volume: Remove allowUnsafeResize var
      git cherry-pick a85d9b826669b3650d4ec85b994553d2764c6030  # lxd/storage/drivers/volume: Add allowUnsafeResize arg to SetQuota and pass to SetVolumeQuota
      git cherry-pick 42eb78374a97bf11a680b0bedc062934804cc12c  # lxd/storage/drivers/interface: Add allowUnsafeResize arg to SetVolumeQuota
      git cherry-pick 503ba2aecfc7944a007f5dcb546e571931afe6a1  # lxd/storage/backend/lxd: Add allowUnsafeResize arg to function returned from imageFiller
      git cherry-pick 9d1b176e39cb921cad3699513900b32dc1a95f1e  # lxd/storage/backend/lxd: b.driver.SetVolumeQuota usage
      git cherry-pick 255d9fd482f7e906205757a507445ff0fd5b21cb  # lxd/storage/utils: Adds allowUnsafeResize arg to ImageUnpack and pass to vol.SetQuota()
      git cherry-pick dfd336ea1e8fa7503cb1a5cb3b5589ee07c3a26f  # lxd/storage/drivers/utils: Adds allowUnsafeResize arg to ensureVolumeBlockFile
      git cherry-pick 804e8c40fb44fbdef885974949f4fb024786ab59  # lxd/storage/drivers/generic/vfs: d.SetVolumeQuota allowUnsafeResize arg usage
      git cherry-pick 5c7fc730975f6cdd8dd22f8cb1e8f7862ca8200a  # lxd/storage/drivers/driver/btrfs/volumes: ensureVolumeBlockFile allowUnsafeResize arg usage and comment
      git cherry-pick 31ebd7c4fbda515be21eae199a1dfcde3a9d9abd  # lxd/storage/drivers/driver/btrfs/volumes: Adds allowUnsafeResize arg to SetVolumeQuota
      git cherry-pick f1643db98bd7f8417122e0e9eeae45910e478677  # lxd/storage/drivers/driver/ceph/volumes: Adds allowUnsafeResize arg to SetVolumeQuota
      git cherry-pick 5d0251b12860b1b77921539f283cfe744b48acb1  # lxd/storage/drivers/driver/cephfs/volumes: Adds allowUnsafeResize arg to SetVolumeQuota
      git cherry-pick 319e97d89ea6cb3b4f654afe12cd6a647a5f6352  # lxd/storage/drivers/driver/dir/volumes: Adds allowUnsafeResize arg to SetVolumeQuota
      git cherry-pick df449837de0de460addb1638f96fc43b48e1218b  # lxd/storage/drivers/driver/lvm/volumes: Adds allowUnsafeResize arg to SetVolumeQuota
      git cherry-pick 552a94b50d32fd0e3206d1e72b3c94d444778c0d  # lxd/storage/drivers/driver/zfs/volumes: Adds allowUnsafeResize arg to SetVolumeQuota
      git cherry-pick 00ae0af9b963f8761a8ed33399d0385816f03806  # lxd/storage/drivers/driver/mock/volumes: Adds allowUnsafeResize arg to SetVolumeQuota
      git cherry-pick 74333dcc7f9c3dc3f5751c029167b62f9462e95c  # lxd/storage/drivers/driver/btrfs/volumes: d.SetVolumeQuota usage
      git cherry-pick 2b0aadb7ad20ce7dafca020e00c45db54b888d99  # lxd/storage/drivers/driver/ceph/volumes: d.SetVolumeQuota usage
      git cherry-pick 8d4b056762d3284be82c94b381c02defe7a466e4  # lxd/storage/drivers/driver/dir/volumes: d.SetVolumeQuota usage
      git cherry-pick 369540fdb073a242787699dba66b061857651908  # lxd/storage/drivers/driver/lvm/volumes: d.SetVolumeQuota usage
      git cherry-pick 0e91207fadba66718c5a30f8e7ffbfc2748f6a82  # lxd/storage/drivers/driver/btrfs/mock: d.SetVolumeQuota usage
      git cherry-pick 14e87426eae51f89a480e394d5c6dc687372c65f  # lxd/storage/drivers/driver/zfs/volumes: d.SetVolumeQuota usage
      git cherry-pick c7e51e1e4afd61b05f53da2d1e8a5020b0f2ae03  # lxd/storage/drivers/driver/cephfs/volumes: d.SetVolumeQuota usage
      git cherry-pick fd9219854599e635c4c090acff5321c7a2254aca  # lxd/storage/drivers/driver/types: Adds allowUnsafeResize arg to VolumeFiller's Fill function definition
      git cherry-pick 791f9cd0ccec49211cb44e1c2bdddd23d770f63c  # lxd/storage/drivers/driver/lvm/utils: d.SetVolumeQuota usage
      git cherry-pick 7b184f6f478be319f219b36d84e626c8d69e0a09  # lxd/storage/drivers/driver/dir/volumes: ensureVolumeBlockFile usage and comment
      git cherry-pick 36c79f1f0606c1c637dc371927f3c60a1d749550  # lxd/storage/drivers/common: Updates runFiller to pass allowUnsafeResize arg to filler's Fill function as needed
      git cherry-pick ea5cdc63dece63a588cace438f534aa52a1b5970  # lxd/storage/drivers/driver/common: Updates createVolumeFromBackupInstancePostHookResize to pass allowUnsafeResize to driver.SetVolumeQuota
      git cherry-pick 84d7d34428d8c876ee3917bc1934997c63839573  # lxd/storage/drivers/driver/common: Remove createVolumeFromBackupInstancePostHookResize
      git cherry-pick 3084c4dcad51abb569f175e1e8d1d1e4c243a4d9  # lxd/storage/drivers/generic/vfs: Error check Unmount in post hook from genericVFSBackupUnpack
      git cherry-pick b58b8ef127d2b0101eb881dc030350e967ea91fc  # lxd/storage/backend/lxd: Enable allowUnsafeResize for container imports in CreateInstanceFromBackup
      git cherry-pick 9975de9c10ef9931aa69f8f35229f3c2e3361716  # lxd/init: Update for token based join
      git cherry-pick 9bdd4fb2a3a8b3f398e43a7c7fa81356cfe533e7  # client: Simplify User-Agent logic
      git cherry-pick 743af8e283f2197d772b1fbfce8c2bf16e044e79  # lxd/instances: Fix requestor in bulk state changes
      git cherry-pick ac7fc06dd9fe8046906e43a5a93604ca51dd1022  # lxd/daemon: Add forwarded requestor to context
      git cherry-pick c114529d787f24f3677eeeb902fcf6014b6a636d  # lxd/operations: Support forwarded requestor
      git cherry-pick dc1922aac23ca11738e6db7f5d2d1e4a1aae9d7f  # lxd/cluster: Pass original requestor around
      git cherry-pick ae3093323a6c1b46880fbdaee87afddec7c7e0b4  # lxd: Pass request around
      git cherry-pick 210f2c1765cc35b3e98f770a14141b1a1ea4fd75  # lxd/storage/drivers/driver/zfs/volumes: Fix bug with VM optimized import not returning filesystem volume post hook
      git cherry-pick 2f5d49fbc242c2b1d16dcb03c099d33e92fd9681  # lxd/daemon: updateCertificateCacheFromLocal usage
      git cherry-pick 5607f2d148b3a05ce3cc4f6af8707b3bf964a29c  # lxd/certificates: Removes unused cert arg from updateCertificateCacheFromLocal
      git cherry-pick f8f0b556050b8003f007ff6b7827cdaf95673d8e  # lxd/request: Introduce new package
      git cherry-pick d1369fb4526b6f23226e5275c89532cb7d10037e  # lxd: Use the new request package
      git cherry-pick 45897e3fd55dff3ea19fc61cbf78fa05fd5b76f3  # lxd/device/nic/bridged: Allow using IP filtering with an unmanaged parent bridge
      git cherry-pick f70e47d99f9961963b2fd0ff8409e4812b4db64d  # lxd/firewall/firewall/interface: Adds parentManaged arg to InstanceSetupBridgeFilter
      git cherry-pick f7a116af7c27d4facf7c4d4d5acdecc1cc6cd389  # lxd/firewall/drivers/drivers/nftables: InstanceSetupBridgeFilter signature
      git cherry-pick a960fe5a57a387c9a8511e5188cecae424c397af  # lxd/firewall/drivers/driver/xtables: Adds parentManaged arg to InstanceSetupBridgeFilter
      git cherry-pick 9a58bf37aa0f0355a6e4fb19e7a756cb6a7e5aaf  # lxd/firewall/drivers/drivers/xtables: Adds parentManaged arg to generateFilterIptablesRules
      git cherry-pick 98958699f11cadf2f057d430ee26ce4170915843  # lxd/device/nic/bridged: Updates d.state.Firewall.InstanceSetupBridgeFilter usage to provide managed parent indicator
      git cherry-pick 44735fe287b0bdb161408e13e175689c26b68653  # test: Include the managed bridge in the nic counters for bridged NIC filtering
      git cherry-pick 7d5cfc87409b2798dcb1d1c2a9b4e32848a1c19a  # test: Add test for unmanaged bridge IP filtering
      git cherry-pick 5b618796079ff8523d73dcfb9687c74c27f22fcf  # lxd: update instructions for compilation from a release tarball
      git cherry-pick 2941128d8626224c5480228d22487daa6a1a104c  # lxd/init: show the new default value for password authentication
      git cherry-pick adc73d1ba814cd9499968ec3ba8e911ca19f0d57  # doc/networks: Use n.n.n.n rather than a real IP 1.2.3.4 for example IP in systemd-resolve command
      git cherry-pick 47372f2a7093992afc5b0776a070c8769bcd22ce  # doc/networks: Adds guide on how to get systemd to configure systemd-resolved on lxdbr0 start up
      git cherry-pick 2de45865017c38978a35258e2187f65a422f3ab3  # lxd/api/project: Error improvements in projectsPost
      git cherry-pick 17938446fa5941d335fb1c708f3ef9c06bc7a35b  # lxd/api/project: Comment ending consistency in projectsPost
      git cherry-pick a72eaa415af46856f848d88b7cdc89dada10f9c3  # lxd/api/project: Prevent project names that contain underscores in projectValidateName
      git cherry-pick 7be89ecd0f35214c28431feaef07de216cadb344  # lxd/api/project: Comment ending consistency in projectPost
      git cherry-pick 17291d5250da5e12bab528cfdb426d190e7521aa  # lxd/api/project: Error improvements in projectPost
      git cherry-pick 892fe6fd297ead442f5280ff632218d4a0f6258c  # lxd/api/project: Validate new project name not current when renaming in projectPost
      git cherry-pick 4156445e05f2871cbce4af7cc6ba0fe053d86325  # test: Add tests for banned underscore in project names during create and rename
      git cherry-pick f754880968ba6684f6d273fd92f5efb297ed6efb  # main/init: Define poolType type and constants
      git cherry-pick e6855554f3a2b1e43bea92358fa33d12a0338224  # main/init: Updates availableStorageDrivers to use poolType type and associated constants
      git cherry-pick a47c595a5d37c11d759758539aee606fa350e475  # lxd/main/init/auto: Updates RunAuto to use poolType and associated constants
      git cherry-pick e5cb6663f05d13e1ab9285ecd55bc14a3de2c7c1  # main/init/interactive: Updates askStoragePool to use poolType and associated constants
      git cherry-pick a17f29bcc5054e8caac7ad68a68dc0763a63f987  # lxd/main/init: Remove hard coded remote storage driver types in availableStorageDrivers
      git cherry-pick 469f3d0614ed57fac834e8b7fd7f214b2822a250  # lxd/main/init/interactive: Fix possible confusing missing storage backends error in askStoragePool
      git cherry-pick cf6d97a74f247e1b8047bc3cc5bbf0c63b0cb3b3  # lxd/main/init/interactive: Don't default to ceph if not available in askStoragePool
      git cherry-pick 489e05e66685cb726eeaae4a9ace2dc90e97628e  # lxd/main/init/interactive: Use validate.Optional in askClustering
      git cherry-pick 70ee9bbae91566ea5d0a4a4cea2f2595c9e09961  # shared/validate/validate/test: Adds tests for Required and Optional
      git cherry-pick 043490501a81e01e02a5dc3eeedadd9ffa40bfa0  # shared/validate/validate: Remove optional check in IsOneOf
      git cherry-pick 6c0b11e1d570a65b85c123436fbb7b7231ca954f  # lxd/api/project: validate.IsOneOf optional usage
      git cherry-pick 57c285d4badcf1fe4784346a1e2a64044f8ff90c  # lxd/storage: validate.IsOneOf optional usage
      git cherry-pick cfd3184f90e9766e324e976aa0a3b80ca4bdaf7a  # lxd/storage/pools/config: validate.IsOneOf optional usage
      git cherry-pick 259ee0d5cd17b6b764b2055ab349b2be3fb90930  # shared/instance: validate.IsOneOf optional usage
      git cherry-pick 3536af36f23c8de09777e958ea5f22cdebf1d179  # lxd/network: validate.IsOneOf optional usage
      git cherry-pick 2908b6edd6a321e5932f8ecb33c48a58bc3bf887  # lxd/network/driver/bridge: More consistent use of validate.Optional for fan.underlay_subnet
      git cherry-pick f3cd3aa6fe6f09adef94eefc33b58716b77fc70e  # lxd/cluster/config: Wraps images.default_architecture with validate.Optional due to IsOneOf change in IsArchitecture
      git cherry-pick 600cb4235b83cd550722f33209e744a7c9b4598c  # lxd/device/nic: Return -1 for Mtu in State() for bridged and ovn NICs if host interface not available
      git cherry-pick f4eb5e2f7b39ec6f7a1bbf2c3240a051a1f6db76  # shared/util: Fill Stderr in RunCommandWithFds
      git cherry-pick 4a4d16c4096cd5cb8be836167e8ca3b64df514d2  # shared/archive: Handle newer unsquashfs errors
      git cherry-pick d3f4adc73a76436ccb85655e223a5322e4a9475e  # doc: fix cluster.https_address' description
      git cherry-pick d55b049256ea84ef721779f227b01857f89c78cd  # lxd/patches: Fix duplicate warnings
      git cherry-pick a0c04ef1b99c94edb50084825365c2bab8dadb7c  # forkexec: handle broken close_range() backport in openSUSE Leap 15.3
      git cherry-pick 325fad2a40b63a842b6436b732133095b5a52f42  # lxd/apparmor/instance: Move instance profile generation into new function instanceProfileGenerate
      git cherry-pick be07297d30cfba3e29af7f66d7a11e697252d713  # lxd/apparmor/instance: Rename InstanceParse to InstanceValidate
      git cherry-pick 209c7db87340078e8dbfe72c598e4ed2f32dbf7e  # lxd/instance/drivers/driver/lxc: apparmor.InstanceValidate usage
      git cherry-pick c482cb12774caf4e5d4cd9348a409d5d0fc4763d  # lxd/instance/drivers/driver/qemu: Validate raw.apparmor if changed
      git cherry-pick 56c6e913ffbb1ee79b589a3fab8ddff13015548c  # doc/virtual-machines: Removes statement about VMs being considered experimental
      git cherry-pick 900ca01ab606d8aaece8812762e27bb3fafa0614  # lxd/network/driver/bridge: Surface dnsmasq specific start up errors via a warning log entry
      git cherry-pick 46fe2f1685113a81c0027b67b9081c90dd3400eb  # client: Only retry target addresses if initial connection fails

      # Setup build environment
      export GOPATH=$(realpath ./.go)
      export GO111MODULE=off
      export CGO_CFLAGS="-I${SNAPCRAFT_STAGE}/include/ -I${SNAPCRAFT_STAGE}/usr/local/include/"
      export CGO_LDFLAGS="-L${SNAPCRAFT_STAGE}/lib/ -L${SNAPCRAFT_STAGE}/usr/local/lib/"

      # Setup the GOPATH
      rm -Rf "${GOPATH}"
      mkdir -p "${GOPATH}/src/github.com/lxc"
      ln -s "$(pwd)" "${GOPATH}/src/github.com/lxc/lxd"

      # Download the dependencies
      go get -d -v ./...

      # Build the binaries
      go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxc" github.com/lxc/lxd/lxc
      go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxc-to-lxd" github.com/lxc/lxd/lxc-to-lxd
      go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd" -tags=libsqlite3 github.com/lxc/lxd/lxd
      CGO_ENABLED=0 go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd-agent" -tags=agent,netgo github.com/lxc/lxd/lxd-agent
      go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd-benchmark" github.com/lxc/lxd/lxd-benchmark

      # Setup bash completion
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/
      cp scripts/bash/lxd-client ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/share/misc/: share/misc/
      var/lib/usbutils/usb.ids: share/misc/
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/dnsmasq
      - bin/getfattr
      - bin/setfattr
      - bin/iw
      - bin/pigz
      - bin/rsync
      - bin/setfacl
      - bin/sgdisk
      - bin/unsquashfs
      - bin/xdelta3

      - lib/*/libidn.so.*

      - etc/bash_completion.d/snap.lxd.lxc

      - share/misc

      - bin/lxc
      - bin/lxc-to-lxd
      - bin/lxd
      - bin/lxd-agent
      - bin/lxd-benchmark

  lxd-migrate:
    source: lxd-migrate/
    after:
      - lxd
      - sqlite
    build-snaps:
      - go
    plugin: nil
    override-build: |
      set -ex

      # Setup build environment
      export GOPATH=$(realpath ./.go)
      export GO111MODULE=off
      export CGO_CFLAGS="-I${SNAPCRAFT_STAGE}/include/ -I${SNAPCRAFT_STAGE}/usr/local/include/"
      export CGO_LDFLAGS="-L${SNAPCRAFT_STAGE}/lib/ -L${SNAPCRAFT_STAGE}/usr/local/lib/"

      # Download the dependencies
      go get -d -v ./...

      # Build the binaries
      go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd-migrate" -tags=libsqlite3 ./

      # Install bridge script
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/bin/
      cp scripts/upgrade-bridge ${SNAPCRAFT_PART_INSTALL}/bin/upgrade-bridge
    prime:
      - bin/lxd-migrate
      - bin/upgrade-bridge

  shmounts:
    source: shmounts/
    plugin: make
    prime:
      - bin/setup-shmounts

  snap-query:
    source: snap-query/
    build-snaps:
      - go
    plugin: nil
    override-build: |
      set -ex

      # Setup build environment
      export GOPATH=$(realpath ./.go)
      export GO111MODULE=off

      # Download the dependencies
      go get -d -v ./...

      # Build the binaries
      go build -o "${SNAPCRAFT_PART_INSTALL}/bin/snap-query" ./
    prime:
      - bin/snap-query

  strip:
    source: snapcraft/empty
    after:
      - btrfs
      - ceph
      - dqlite
      - libseccomp
      - logrotate
      - lvm
      - nano
      - nvidia-container
      - openvswitch
      - ovn
      - raft
      - sqlite
      - squashfs-tools-ng
      - vim
      - xfs
      - xz
      - zfs-0-6
      - zfs-0-7
      - zfs-0-8
      - lxc
      - lxcfs
      - criu
      - lxd
      - lxd-migrate
      - shmounts
      - snap-query
    plugin: nil
    override-prime: |
      set -x

      # Strip some of the heavy bits
      strip -s ${SNAPCRAFT_PRIME}/bin/lxc
      strip -s ${SNAPCRAFT_PRIME}/bin/lxd*
      strip -s ${SNAPCRAFT_PRIME}/bin/snap*
      strip -s ${SNAPCRAFT_PRIME}/lib/liblxc*
      strip -s ${SNAPCRAFT_PRIME}/lib/libdqlite*
      strip -s ${SNAPCRAFT_PRIME}/lib/libsqlite*

      for zfs in zfs-0.6 zfs-0.7 zfs-0.8 zfs-2.0; do
          [ ! -d "${SNAPCRAFT_PRIME}/${zfs}" ] && continue
          strip -s ${SNAPCRAFT_PRIME}/${zfs}/bin/* ${SNAPCRAFT_PRIME}/${zfs}/lib/*
      done

      [ -e "${SNAPCRAFT_PRIME}/criu/criu" ] && strip -s ${SNAPCRAFT_PRIME}/criu/criu

      exit 0

  wrappers:
    plugin: dump
    source: snapcraft/
    organize:
      hooks/: snap/hooks/
