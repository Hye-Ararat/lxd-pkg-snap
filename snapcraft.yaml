name: lxd
base: core18
assumes:
  - snapd2.39
version: "4.0.1"
grade: stable
summary: LXD - the container lightervisor
description: |-
 LXD is a container manager for system containers.

 It offers a REST API to remotely manage containers over the network,
 using an image based workflow and with support for live migration.

 Images are available for all Ubuntu releases and architectures as well
 as for a wide number of other Linux distributions.

 LXD containers are lightweight, secure by default and a great
 alternative to virtual machines.

 Supported configuration options (snap set lxd [<key>=<value>...]):
   - ceph.builtin: Use snap-specific ceph configuration [default=false]
   - criu.enable: Enable experimental live-migration support [default=false]
   - daemon.debug: Increases logging to debug level [default=false]
   - daemon.group: Group of users that can interact with LXD [default=lxd]
   - daemon.preseed: A YAML configuration to feed `lxd init` on initial start
   - lxcfs.pidfd: Start per-container process tracking [default=false]
   - lxcfs.loadavg: Start tracking per-container load average [default=false]
   - lxcfs.cfs: Consider CPU shares for CPU usage [default=false]
   - openvswitch.builtin: Run a snap-specific OVS daemon [default=false]
   - shiftfs.enable: Enable shiftfs support [default=auto]

confinement: strict

apps:
  # Main commands
  activate:
    command: commands/daemon.activate
    daemon: oneshot
    plugs:
      - lxd-support
      - system-observe

  daemon:
    command: commands/daemon.start
    reload-command: commands/daemon.reload
    stop-command: commands/daemon.stop
    stop-timeout: 600s
    restart-condition: on-failure
    daemon: simple
    slots: [lxd]
    plugs:
      - lxd-support
      - network-bind
      - system-observe
    sockets:
      unix:
        listen-stream: $SNAP_COMMON/lxd/unix.socket
        socket-mode: 0660

  lxc:
    command: commands/lxc
    completer: etc/bash_completion.d/snap.lxd.lxc
    plugs:
      - lxd-support
      - system-observe

  lxd:
    command: commands/lxd
    plugs:
      - lxd-support
      - system-observe

  # Sub-commands
  benchmark:
    command: commands/lxd-benchmark
    plugs:
      - lxd-support
      - system-observe
  buginfo:
    command: commands/buginfo
    plugs:
      - lxd-support
      - system-observe
  check-kernel:
    command: commands/lxd-check-kernel
    plugs:
      - lxd-support
      - system-observe
  lxc-to-lxd:
    command: commands/lxc-to-lxd
    plugs:
      - lxd-support
      - system-observe
  migrate:
    command: commands/lxd-migrate
    plugs:
      - lxd-support
      - system-observe

hooks:
  configure:
    plugs:
      - network
      - system-observe
  remove:
    plugs:
      - lxd-support
      - system-observe

parts:
  # Dependencies
  btrfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - btrfs-tools
    prime:
      - bin/btrfs
      - bin/btrfstune
      - bin/mkfs.btrfs

  ceph:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ceph-common
      - libdb5.3
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/ceph
      - bin/python
      - bin/python2*
      - bin/rbd
      - lib/python2.7
      - lib/*/libpython2.7.so*
      - -lib/python2.7/sitecustomize.py
      - lib/*/ceph
      - lib/*/libboost_iostreams.so.*
      - lib/*/libboost_program_options.so.*
      - lib/*/libboost_random.so.*
      - lib/*/libboost_regex.so.*
      - lib/*/libboost_system.so.*
      - lib/*/libboost_thread.so.*
      - lib/*/libcephfs*
      - lib/*/libdb-5.3.so
      - lib/*/libicudata.so.*
      - lib/*/libicui18n.so.*
      - lib/*/libicuuc.so.*
      - lib/*/libnspr4.so
      - lib/*/libnss3.so
      - lib/*/libibverbs.so*
      - lib/*/nss/libsoftokn3.so
      - lib/*/nss/libfreeblpriv3.so
      - lib/*/libnssutil3.so
      - lib/*/libplc4.so
      - lib/*/libplds4.so
      - lib/*/librados.so.*
      - lib/*/librbd.so.*
      - lib/*/libsmime3.so
      - lib/*/libsnappy*

  dqlite:
    after:
      - libco
      - raft
      - sqlite
    source: https://github.com/canonical/dqlite
    source-type: git
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libdqlite*so*
      - lib/*/libuv*

  edk2:
    after:
      - qemu
    source: https://github.com/tianocore/edk2
    source-type: git
    source-tag: edk2-stable202002
    plugin: nil
    build-packages:
      - acpica-tools
      - nasm
      - uuid-dev
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      ARCH="X64"
      PKG="OvmfPkg/OvmfPkgX64.dsc"
      FV_CODE="OVMF_CODE"
      FV_VARS="OVMF_VARS"
      if [ "$(uname -m)" = "aarch64" ]; then
          ARCH="AARCH64"
          PKG="ArmVirtPkg/ArmVirtQemu.dsc"
          FV_CODE="QEMU_EFI"
          FV_VARS="QEMU_VARS"
      fi

      # Run in a bash sub-shell as edksetup.sh requires it
      set -ex
      (
      cat << EOF
          . ./edksetup.sh
          make -C BaseTools ARCH=${ARCH}
          build -a ${ARCH} -t GCC49 -b RELEASE -p ${PKG} \
            -DNETWORK_HTTP_BOOT_ENABLE=TRUE \
            -DSECURE_BOOT_ENABLE=TRUE \
            -DFD_SIZE_2MB \
            -DTPM2_ENABLE=TRUE
      EOF
      ) | bash -e

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      cp Build/*/*/FV/${FV_CODE}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
      cp Build/*/*/FV/${FV_VARS}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"

      if [ "$(uname -m)" = "aarch64" ]; then
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"
      fi

    prime:
      - share/qemu/*

  libco:
    source: https://github.com/canonical/libco
    source-type: git
    plugin: make
    organize:
      usr/lib/: lib/
    prime:
      - lib/libco*so*

  libmnl:
    source: https://git.netfilter.org/libmnl
    source-type: git
    source-tag: libmnl-1.0.4
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libmnl*so*

  libnftnl:
    after:
      - libmnl
    source: https://git.netfilter.org/libnftnl
    source-type: git
    source-tag: libnftnl-1.1.6
    plugin: autotools
    organize:
      usr/lib/: lib/
    prime:
      - lib/libnftnl*so*

  libseccomp:
    source: https://github.com/seccomp/libseccomp
    source-type: git
    plugin: autotools
    build-packages:
      - gperf
    organize:
      usr/lib/: lib/
    prime:
      - lib/libseccomp*so*

  logrotate:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - logrotate
      - libpopt0
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    stage:
      - bin/logrotate
    prime:
      - bin/logrotate
      - lib/*/libpopt*so*

  lvm:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - dmeventd
      - lvm2
      - thin-provisioning-tools
    organize:
      sbin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/cache_*
      - bin/dmeventd
      - bin/era_*
      - bin/lv*
      - bin/pdata_tools
      - bin/pv*
      - bin/thin_*
      - bin/vg*
      - -bin/vgimportclone
      - -bin/lvmconf
      - -bin/lvmdump
      - -bin/lvmetad
      - -bin/lvmpolld
      - etc/lvm/lvm.conf
      - lib/*/device-mapper/*
      - lib/*/libaio.so*
      - lib/*/libdevmapper*
      - lib/*/liblvm*
      - lib/*/libreadline.so*

  nano:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - nano
    organize:
      usr/bin/: bin/
    prime:
      - bin/nano
      - etc/nanorc

  nftables:
    after:
      - libmnl
      - libnftnl
    source: https://git.netfilter.org/nftables
    source-type: git
    source-tag: v0.9.4
    plugin: autotools
    configflags:
      - --with-json
    build-packages:
      - libjansson-dev
      - libreadline-dev
    stage-packages:
      - libjansson4
    organize:
      sbin/: bin/
      usr/lib/: lib/
    prime:
      - bin/nft
      - lib/*/libjansson*so*
      - lib/libnftables*so*

  nvidia-container:
    after:
      - libseccomp
    source: https://github.com/NVIDIA/libnvidia-container
    source-type: git
    source-tag: v1.0.6
    plugin: make
    build-packages:
      - bmake
      - curl
      - lsb-release
    override-build: |-
      set -ex

      # Supposedly supports x86_64, aarch64 and ppc64le but only x86_64 builds
      [ "$(uname -m)" != "x86_64" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/bin/"
      cp ${SNAPCRAFT_PROJECT_DIR}/snapcraft/wrappers/nvidia-container-cli "${SNAPCRAFT_PART_INSTALL}/bin/"

      set +ex
      snapcraftctl build
    organize:
      usr/local/bin/nvidia-container-cli: bin/nvidia-container-cli.real
      usr/local/lib: lib/
    prime:
      - bin/nvidia-container-cli*
      - lib/libnvidia-container.so*

  openvswitch:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - openvswitch-switch
      - uuid-runtime
    organize:
      usr/bin/: bin/
      usr/lib/openvswitch-switch/: bin/
      usr/sbin/: bin/
      usr/share/: share/
    prime:
      - bin/ovs-appctl
      - bin/ovs-vsctl
      - bin/ovs-vswitchd
      - bin/ovsdb-*
      - bin/uuidgen
      - share/openvswitch/

  qemu:
    after:
      - libseccomp
    source: https://git.qemu.org/git/qemu.git
    source-type: git
    source-tag: v5.0.0
    plugin: autotools
    configflags:
      - --disable-docs
      - --disable-slirp
      - --disable-user
      - --enable-attr
      - --enable-cap-ng
      - --enable-kvm
      - --enable-linux-aio
      - --enable-pie
      - --enable-rbd
      - --enable-seccomp
      - --enable-system
      - --enable-tools
      - --enable-vhost-crypto
      - --enable-vhost-kernel
      - --enable-vhost-net
      - --enable-vhost-scsi
      - --enable-vhost-user
      - --enable-vhost-vsock
      - --enable-virtfs
      - --enable-vnc
      - --firmwarepath=/snap/lxd/current/share/qemu/
    build-packages:
      - bison
      - flex
      - pkg-config
      - libcap-ng-dev
      - libglib2.0-dev
      - libpixman-1-dev
      - libaio-dev
      - librbd-dev
    stage-packages:
      - genisoimage
      - libmagic1
      - libpixman-1-0
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && [ "$(uname -m)" != "ppc64le" ] && [ "$(uname -m)" != "s390x" ] && exit 0

      set -ex
      # Mangle the configure a bit
      QEMUARCH="$(uname -m)"
      [ "${QEMUARCH}" = "ppc64le" ] && QEMUARCH="ppc64"
      sed -i "s/^unset target_list$/target_list=\"${QEMUARCH}-softmmu\"/" configure
      sed -i 's#libseccomp_minver=".*#libseccomp_minver="0.0"#g' configure

      set +ex
      snapcraftctl build
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/genisoimage*
      - bin/mkisofs*
      - bin/qemu-system-*
      - bin/qemu-img*
      - bin/virtfs-proxy-helper*
      - lib/*/libmagic*so*
      - lib/*/libpixman*so*
      - share/qemu/keymaps*
      - share/qemu/efi-virtio.rom*
      - share/qemu/kvmvapic.bin*
      - share/qemu/s390-*.img*
      - share/qemu/slof.bin*
      - share/qemu/vgabios-*.bin*

  qemu-ovmf-secureboot:
    after:
      - edk2
      - qemu
    source: https://github.com/puiterwijk/qemu-ovmf-secureboot
    source-type: git
    plugin: nil
    build-packages:
      - xorriso
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      set -ex
      rm -Rf iso-root vfat-root shell.iso
      mkdir -p iso-root vfat-root/efi/boot
      cp ../../edk2/build/Build/*/*/*/Shell.efi vfat-root/efi/boot/bootx64.efi
      cp ../../edk2/build/Build/*/*/*/EnrollDefaultKeys.efi vfat-root/
      "${SNAPCRAFT_STAGE}/bin/qemu-img" convert --image-opts driver=vvfat,floppy=on,fat-type=12,label=UEFI_SHELL,dir=vfat-root iso-root/shell.img
      xorriso --as mkisofs -input-charset ASCII -J -rational-rock -e shell.img -no-emul-boot -o shell.iso iso-root/

      # Basic aarch64 support
      if [ "$(uname -m)" = "aarch64" ]; then
          sed -i ovmf-vars-generator \
              -e "s/'-machine', machinetype,/'-machine', 'virt', '-cpu', 'cortex-a57',/" \
              -e "/charserial1/d" \
              -e "s/ide-cd/scsi-cd/" \
              -e "s/'-device',$/'-device', 'virtio-scsi-pci,id=scsi', '-device',/"
      elif [ "$(uname -m)" = "x86_64" ]; then
          cp -f "${SNAPCRAFT_STAGE}/share/qemu/kvmvapic.bin" .
      fi

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      python3 ovmf-vars-generator \
        --qemu-binary "${SNAPCRAFT_STAGE}/bin/qemu-system-$(uname -m)" \
        --print-output --disable-smm --skip-testing \
        --oem-string "$(cat ${SNAPCRAFT_PROJECT_DIR}/snapcraft/etc/ubuntu-sb.crt)" \
        --ovmf-binary "${SNAPCRAFT_STAGE}/share/qemu/OVMF_CODE.fd" \
        --ovmf-template-vars "${SNAPCRAFT_STAGE}/share/qemu/OVMF_VARS.fd" \
        --uefi-shell-iso shell.iso \
        "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.ms.fd"
    prime:
      - share/qemu/*

  raft:
    source: https://github.com/canonical/raft
    source-type: git
    plugin: autotools
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libraft*so*

  sqlite:
    source: https://github.com/canonical/sqlite
    source-type: git
    source-tag: version-3.30.1+replication4
    plugin: autotools
    configflags:
      - --enable-replication
    build-packages:
      - tclsh
    override-build: |-
      set -ex

      git log -1 --format=format:%ci%n | sed -e 's/ [-+].*$//;s/ /T/;s/^/D /' > manifest
      git log -1 --format=format:%H > manifest.uuid
      cp /usr/share/misc/config.guess .
      cp /usr/share/misc/config.sub .
      autoreconf -f -i

      set +ex
      snapcraftctl build
    prime:
      - bin/sqlite3
      - lib/libsqlite3*so*

  squashfs-tools-ng:
    source: https://github.com/AgentD/squashfs-tools-ng
    source-type: git
    source-tag: v0.8
    plugin: autotools
    build-packages:
      - liblzma-dev
    prime:
      - bin/sqfs2tar
      - bin/tar2sqfs
      - lib/libsquashfs.so*

  vim:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - vim-tiny
    organize:
      usr/bin/: bin/
      usr/share/vim/vim*/debian.vim: etc/vimrc
    prime:
      - bin/vim.tiny
      - etc/vimrc

  xfs:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xfsprogs
    organize:
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/xfs_admin
      - bin/xfs_db
      - bin/xfs_growfs
      - bin/xfs_repair
      - bin/mkfs.xfs

  xtables:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ebtables
      - iptables
      - xtables-addons-common
    organize:
      usr/lib/*/xtables/*: lib/xtables/
      lib/ebtables/*: lib/
      sbin/: bin/
    prime:
      - bin/ebtables
      - etc/ethertypes
      - etc/protocols
      - lib/libebt*
      - lib/xtables/*

  xz:
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xz-utils
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/xz
      - lib/*/liblzma*so*

  zfs-0-6:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.6.5.11
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick fb963d33ee0dd350143ba1c9cd35d5f7d86910d2  # Fix endian build problem on ppc64el

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-7:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.7.13
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-8:
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.8.3
    plugin: autotools
    configflags:
      - --with-config=user
    build-packages:
      - libblkid-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  # Core components
  lxc:
    after:
      - libseccomp
    source: https://github.com/lxc/lxc
    source-type: git
    source-tag: lxc-4.0.2
    build-packages:
      - libapparmor-dev
      - libcap-dev
      - libgnutls28-dev
      - libselinux1-dev
      - pkg-config
    plugin: autotools
    configflags:
      - --disable-selinux
      - --disable-tests
      - --disable-examples
      - --disable-doc
      - --disable-tools
      - --disable-api-docs
      - --disable-bash
      - --disable-memfd-rexec
      - --enable-apparmor
      - --enable-seccomp
      - --enable-selinux
      - --enable-capabilities
      - --with-rootfs-path=/var/snap/lxd/common/lxc/
      - --libexecdir=/snap/lxd/current/libexec/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/libexec: libexec
      share/lxc/hooks: lxc/hooks
    prime:
      - bin/lxc-checkconfig
      - lib/liblxc.so.1
      - lib/liblxc.so.1.*
      - lxc/config/common.conf.d
      - lxc/hooks/nvidia
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick d51d0df41ef0f85a127daf84468189655499a6e3  # apparmor: Allow boot_id
      git cherry-pick 3a4031f03696e339c9d6d4cc16af2e771ae7e45f  # src/lxc/network: Fixes netlink attribute type 1 has an invalid length message
      git cherry-pick ba9eab74b8e7c9bcafadb83809f5f07c21318e2d  # cgroups: ignore cgroup2 limits on non-cgroup2 layouts
      git cherry-pick 6001872d082dffce5e328049788c7f1ae0864789  # common.conf: add cgroup2 default device limits
      git cherry-pick 8cce8b5930d3718b11217561bda78dcaa84dfdee  # cgroups: premount cgroups on cgroup2-only systems
      git cherry-pick 0343423e578ef608d6a5c2518de0d7bcbac5887b  # conf: introduce userns_exec_mapped_root()
      git cherry-pick 0baff7b7f54824d8f829a8d7a82b3423db03d305  # conf: support console setup on containers without rootfs
      git cherry-pick 63910a22283059853f0c799f6dcdc369c83518a0  # terminal: remove unneeded if condition
      git cherry-pick c91e492a17a1b24bb77f8089db7c98ca6619fa40  # gcc: add -Warray-bounds, -Wrestrict, -Wreturn-local-addr, -Wstringop-overflow
      git cherry-pick 52d2862cf6965596a2c0eb6bd3c8d9a2e66e9bb2  # compiler: support new access attributes

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/
      ln -s /var/snap/lxd/common/lxc/local.conf $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/01-local.conf
      sed -i "s#includedir=.*#includedir=$SNAPCRAFT_PART_INSTALL/include#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc
      sed -i "s#libdir=.*#libdir=$SNAPCRAFT_PART_INSTALL/lib#g" $SNAPCRAFT_PART_INSTALL/lib/pkgconfig/lxc.pc

  lxcfs:
    source: https://github.com/lxc/lxcfs
    source-type: git
    source-tag: lxcfs-4.0.3
    build-packages:
      - libfuse-dev
      - libpam0g-dev
      - pkg-config
    stage-packages:
      - fuse
    plugin: autotools
    configflags:
      - --datarootdir=/snap/lxd/current/
      - --localstatedir=/var/snap/lxd/common/var/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/lxcfs: lxcfs
      lib/lxcfs: lib
    prime:
      - bin/fusermount
      - lib/*/libfuse.so.*

      - bin/lxcfs
      - lib/liblxcfs.so

      - lxc
      - lxcfs
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick 7dddc7f335ec5644663112d346ecbd7fe5882163  # proc_fuse: silence error when we find no memlimit
      git cherry-pick 2e7b4138eae5b1cb4c4b6d2c87b45c5425f0c693  # sysfs: cpuinfo: show cgroup cpuset value
      git cherry-pick 10f4d9fb7b28a59a0f4e1104bf2e788cf6726c5b  # sysfs_fuse: remove logically dead code

      set +ex
      snapcraftctl build
      set -ex

      sed -i "s#\${LXC_ROOTFS_MOUNT}/var/snap/lxd/common/var/lib/lxcfs/#\${LXC_ROOTFS_MOUNT}/var/lib/lxcfs/#g" $SNAPCRAFT_PART_INSTALL/snap/lxd/current/lxcfs/lxc.mount.hook

  criu:
    source: https://github.com/checkpoint-restore/criu
    source-tag: v3.14
    source-type: git
    plugin: nil
    build-packages:
      - asciidoc
      - libcap-dev
      - libnet1-dev
      - libnl-3-dev
      - libprotobuf-c-dev
      - libprotobuf-dev
      - protobuf-c-compiler
      - protobuf-compiler
      - python
      - xmlto
    stage-packages:
      - libnet1
      - libprotobuf-c1
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "armv7l" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      make
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/criu/"
      cp criu/criu "${SNAPCRAFT_PART_INSTALL}/criu/"
    organize:
      usr/lib/: lib/
    prime:
      - criu/*
      - lib/*/libnet*
      - lib/*/libproto*

  lxd:
    source: https://github.com/lxc/lxd
    source-type: git
    source-tag: lxd-4.0.1
    after:
      - lxc
      - dqlite
      - sqlite
    build-packages:
      - libacl1-dev
      - libudev-dev
      - pkg-config
    stage-packages:
      - acl
      - attr
      - dnsmasq-base
      - gdisk
      - iw
      - netbase
      - pciutils
      - pigz
      - rsync
      - squashfs-tools
      - usbutils
      - xdelta3
    plugin: go
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd
    go-packages:
      - github.com/lxc/lxd/lxc
      - github.com/lxc/lxd/lxc-to-lxd
      - github.com/lxc/lxd/lxd
      - github.com/lxc/lxd/lxd-benchmark
    override-build: |
      set -ex

      # Setup for our shared libraries
      sed -i "/\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/canonical/go-dqlite/internal/bindings/server.go
      sed -i "/^\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/mattn/go-sqlite3/sqlite3.go

      # Git cherry-picks
      cd ../src
      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick fe7e8253a2e314c6474d1378df6a7ef49c41e6b0  # lxd-agent: Support systemd-notify
      git cherry-pick 8bd0a5078aa94eb55712a47492adc48894ca13e6  # lxd/qemu: Switch default unit type to notify
      git cherry-pick b719cf6220373f8d730bdd04be456afbcfe39ccf  # lxd/storage/backend/lxd: Updates CreateInstanceFromImage to use reverter
      git cherry-pick 028e18400b8cbcbec645ac8579a29f20f7c2f8f0  # lxd/storage/drivers/errors: Adds ErrCannotBeShrunk error
      git cherry-pick 41cf2a4c8b99fbcc0df5a33299893cb765590bc3  # lxd/storage/drivers/utils: Updates to shrinkFileSystem ErrCannotBeShrunk error
      git cherry-pick 929fd6f68e2d7ed0aad3debc47c07c6c488f8179  # lxd/storage/backend/lxd: Updates CreateInstanceFromImage to detect ErrCannotBeShrunk
      git cherry-pick 9624ad69e3ba2c1c8ba14a288a0eee970484d119  # lxd/storage/drivers: Returns ErrCannotBeShrunk when block volume cannot be shrunk
      git cherry-pick f864ce5effb67f1ed9852c29291ca2a5f6a24519  # lxd/device/proxy: Dont allow proxy_protocol to be set when in nat mode
      git cherry-pick 643f1296c05473f401e2c4e4d5745eb502f8ed1c  # lxd/device/proxy: Dont wrap lines
      git cherry-pick 7f22d930ec4a8d3c60e400b098df66e692234ef9  # lxd/device/proxy: Improves validation
      git cherry-pick ba88444e7d0635f37122c7ec0dc1032d06b4afc1  # test/suites/container/devices/proxy: Updates tests with new validation rules
      git cherry-pick cdf47d40b2f684150e22bbea47a6ab91b670b4ce  # lxd: Updates snapshotProtobufToInstanceArgs to support instance type
      git cherry-pick 7f2f18e83051a88ac61151bcd4c2be082bc1ddec  # lxd/qemu: Match basic NUMA layout
      git cherry-pick 953c075d2b619deeb21fca85697a1b23de0f45d0  # lxd/storage/drivers/driver/zfs/volumes: Delete volume on error in CreateVolumeFromCopy
      git cherry-pick c209482eb7c76566fe522e439f23efafb0c0956f  # lxd-agent/main/agent: Adds comment about reason for systemd-notify usage
      git cherry-pick 0ec712d6e995ca59b9769e3f0a2ea8e2325e1100  # lxd/cgroup: Fix memory controller detection
      git cherry-pick b14ace4af2e0209efa7abdd8ed0e5444ca574be5  # lxd/migration/migrate/proto: Fix alignment
      git cherry-pick da955ef426a676fc45c1dc3851231114c3bf7dea  # lxd/migration: Adds volumeSize field to MigrationHeader
      git cherry-pick 8e00069f36e6253a4651764ca5168d83427004c8  # lxd/migrate: Adds VolumeSize to MigrationSinkArgs
      git cherry-pick 59f89a4a49f7ff3c68ca23b8b755328226918715  # lxd/migration/migration/volumes: Adds VolumeSize to VolumeTargetArgs
      git cherry-pick ace13c37405cd0e23e4cfcd43870ad63bf9cbcda  # lxd/migrate/instance: Use VolumeSize from offer header in Do()
      git cherry-pick 12468feff4d67d593a18a44263244fafe3690906  # lxd/storage/backend/lxd: Use VolumeSize from migration header in CreateInstanceFromMigration
      git cherry-pick 1511db3593ba3ad14cb74fdbc2e2fee42093c277  # lxd/storage/drivers: Exports BlockDevSizeBytes function
      git cherry-pick cbbece54ddf40b458b53c0d50fb4f44a38f52b8e  # lxd/storage/utils: Adds InstanceDiskBlockSize
      git cherry-pick 7d9d5625670d015b15099ac90de57c44e38a762c  # lxd/migrate/instance: Populate offerHeader.VolumeSize for VMs
      git cherry-pick 5237d512c91cea230e2f5c8d74384bcee306ecba  # lxd/storage/backend/lxd: Adds VM volume size hint to CreateInstanceFromCopy
      git cherry-pick 053321c6f9f078f4b4edcb3e9d7b938be43308ac  # lxd/device/utils: Do not add the Ceph mon port if already present in /etc/ceph config file
      git cherry-pick e2777010e5042d19e3c2e7a89570ca4e04d18022  # lxd/instance/qemu: Add comment on cpuTopology
      git cherry-pick 9e363b3a410779d7e0c01bbad29d6d64bfad68d0  # lxd/storage/ceph: Support port in URL
      git cherry-pick fbb6ff13313308d43444ec5e1d6deb9ca419c59e  # lxd/storage/drivers/utils: Makes minBlockBoundary available to other functions
      git cherry-pick f9983eee16735cbf4397f52d7e61d917f912ffbe  # lxd/storage/drivers/driver/zfs/utils: Updates createVolume to use minBlockBoundary
      git cherry-pick 3becb34ab08249c46754f1bede0b6ab98b19555b  # lxd/storage/drivers/driver/zfs/volumes: Updates SetVolumeQuota to use minBlockBoundary
      git cherry-pick 851fcd487056c4e28702277fbe483dd008213573  # lxd/storage/drivers/zfs/volumes: Updates CreateVolume to allow regeneration of deleted image volumes
      git cherry-pick 55a2f160de02e336ed026cd2c07868b14852ede8  # lxd/storage/drivers/driver/zfs/volumes: Dont revert on rename success
      git cherry-pick fb1b8a6136296f027a7a97f74fba444c439af729  # lxd/daemon: Remove duplicated logic
      git cherry-pick 018226a6c4183a07bc17fd0a072de615b80cd3e1  # lxd/instance/qemu: Announce LXD in SMBIOS
      git cherry-pick 6a209bae87959c8c58dbe28e3f3c0775843bc32a  # share/usbid: Don't print error when missing
      git cherry-pick 6cb0cef36e186e130baef46f40f7b65dd126b968  # lxd/init: Auto-detect and use Ubuntu ZFS setup
      git cherry-pick 0b619bebb0bdf8f5b79c7aea52d48f52a770f4ce  # lxc/config: Add --expanded to get
      git cherry-pick e89c82d9c45ae95f97f406bab6e08d11a99b22d2  # client/interfaces: Add Mode to ImageCopyArgs
      git cherry-pick 2a7a528044ec228d515b63a35ecd84447515e3ad  # shared/api/image: Add ImageExportPost
      git cherry-pick e47fea3944356914476eddc2f35f42537401c932  # client/lxd_images: Set fingerprint and secret headers
      git cherry-pick a909c0e4473a805caa9567c6e997bf33ef02bfc1  # i18n: Update translation templates
      git cherry-pick 7919869be9caf3863f4bc59e98a70846163e93c8  # client: Add relay mode for image copy
      git cherry-pick 5084a520c7bdd086788ff7ae3d9fb2c5ff929a5a  # client: Add ExportImage to ImageServer
      git cherry-pick 856e60d9ba0d8f2dd09460dd1d619a6cb206259d  # client: Add push mode for image copy
      git cherry-pick 791e5993e64da3f3112c1ca877a8a19d1c66c00c  # client: Add GetOperationWaitSecret
      git cherry-pick 3f51ef6c79c603fcd73ee816891bc2a5776d5869  # Resolve both core.https_address and cluster.https_address when comparing IPs
      git cherry-pick 24cc2554642d17485e24ebc9b9dbf4e0a865e5e9  # lxd/storage/drivers/generic/vfs: Skip missing files during export
      git cherry-pick 0b2852fb1fe9f06afbeb9a9c5280745176cd50a4  # lxd/images: Fixes hang in export when invalid --compression argument passed
      git cherry-pick ca5f8217bb5f7985cca257173d8392bf7d5c061f  # lxd/storage/drivers/driver/btrfs/volumes: CreateVolumeFromCopy only use expanded volume size when source is image
      git cherry-pick b6e6bfd6e888476d367a806d58a9d531521db41a  # lxd/storage/drivers/driver/ceph/volumes: Allow cached volume regeneration in CreateVolume
      git cherry-pick fe02656d19505d45dbe125a49ac82b6e134db816  # lxd/storage/drivers/driver/ceph/utils: Uses defaultBlockSize rather than hardcoded 10GB
      git cherry-pick 44d99824f508e66b48c44d893bc9ae2ea145346a  # lxd/storage/drivers/driver/ceph/volumes: Adds getVolumeSize function
      git cherry-pick aebd0e192e6721e1caf31898434e10943e53ce8e  # lxd/storage/drivers/driver/ceph/volumes: Removes unnecessary mount/unmount
      git cherry-pick e7e5f7a9d3f73e97db3ca523a01560c14b0a0274  # lxd/storage/drivers/driver/zfs/volumes: Clarify clone comments
      git cherry-pick 790ee77e0cb3c46eecff5e63d3ccd374b4cf9a91  # lxd/storage/drivers/driver/ceph/volumes: Dont wrap lines
      git cherry-pick 00a6c7770b01b5cd73bb79bcdc53c05922d9142c  # lxd/storage/drivers/driver/ceph/volumes: Dont use clone mode when creating volume from cached image when it is disabled
      git cherry-pick 3413284bcb0a5c9d42a8570ec2fbd8db4f0d1be2  # lxd/storage/utils: VolumeDBCreate comment formatting
      git cherry-pick 44dcac77ab507c95991d12a087b93c759eac8d5c  # lxd/storage/drivers/driver/lvm/volumes: CreateVolumeFromCopy only set volume size from expanded config when source is image
      git cherry-pick 0d5f9a324a958a481374669ab751127c17270840  # lxd/storage/drivers/driver/zfs/volumes: CreateVolumeFromCopy only set volume size from expanded config when source is image
      git cherry-pick 813a797f427121e219039aea2f1fc34f4381c030  # lxc/storage/drivers/driver/ceph/utils: Reworks parseParent to return a Volume struct
      git cherry-pick 71453ec8c58a8cf7e6317e770362e034d1089364  # lxd/storage/drivers/driver/ceph/utils: Adds tests for parseParent
      git cherry-pick a0b5406938fec12aa81148c7d7b37e52b3a38ea7  # lxd/storage/drivers/driver/ceph/utils: Adds cephVolumeTypeZombieImage constant
      git cherry-pick 5755802b5290b84606ea119122fa544913d6aaa4  # lxd/storage/drivers/driver/ceph/utils: Updates rbdCreateVolume to accept string size
      git cherry-pick d25bec8b4fc179048f98dc2ffd8d076dd7ec1647  # lxd/storage/drivers/driver/ceph/utils: Pass volume config in rbdMarkVolumeDeleted
      git cherry-pick 0b2e09873d28edfd7385434e751331d2ec51d628  # lxd/storage/drivers/driver/ceph/utils: Pass volume config in rbdRenameVolume
      git cherry-pick 26760bc9245ae479fcf6dcd912d6d5bc3bc0cc83  # lxd/storage/drivers/driver/ceph/utils: Replaces getRBDSize with volumeSize
      git cherry-pick 83b4105ba62b14a843c3585df771d2d7735f5a8c  # lxd/storage/drivers/driver/ceph/utils: Dont wrap lines
      git cherry-pick 094a858ee02c8a90eba98b4f52109cef1ef3c7b3  # lxd/storage/drivers/driver/ceph/utils: Updates usage of d.parseParent in deleteVolume
      git cherry-pick dd2148057c11136abf7a4dd0e3dadbdf76cef480  # lxd/storage/drivers/driver/ceph/utils: Updates RBD naming logic in getRBDVolumeName
      git cherry-pick e61c85c359aedfef5e2d2b57a98d8eb6578b3d6c  # lxd/storage/drivers/driver/ceph/volumes: Ensures CreateVolumeFromCopy correctly sizes new volume
      git cherry-pick 9c7f23b7f17b48629f64c2197325b785ec7d1c71  # lxd/storage/drivers/driver/ceph/volumes: If volume doesnt exist in DeleteVolume do nothing
      git cherry-pick 94ba5ce73d7fc621d6f2c8838f0b37587450c09b  # lxd/storage/drivers/driver/ceph/utils: Dont wrap lines
      git cherry-pick ff88d4f18c60348db4ff591a408b7d8ad630da5f  # lxd/db: Rename CertificatesGet to GetCertificates
      git cherry-pick cdfa8f3f3738a7c44b3498ef96d28460fa932dce  # lxd/db: Rename CertificateGet to GetCertificate
      git cherry-pick 27c1097010705d1724d3135433812ecf30d3242c  # lxd/db: Rename CertSave to CreateCertificate
      git cherry-pick 7a1842670c0aab0c0cca93b6ec5c364a539520c5  # lxd/db: Rename CertDelete to DeleteCertificate
      git cherry-pick 418ccb6b95d13ac846bfe428aefb01b7449cab37  # lxd/db: Rename CertUpdate to UpdateCertificate
      git cherry-pick 97c7d51626a9046e85fc4a8f5dac45643fb62f65  # lxd/db: Drop unused ConfigValueSet
      git cherry-pick d6e56f9327e97d85fa68d7ebd9c572de59fec5c3  # lxd/instances/post: Fix revert in createFromBackup
      git cherry-pick e92790bc480eedd3a8726da33f6e6d68e83851e7  # lxd/storage/drivers/volume: Adds allowUnsafeResize bool to Volume struct
      git cherry-pick eee1abaac859b552988f0577ddac13656b5790ee  # lxd/storage/backend/lxd: Adds cannot shrink error handling in CreateInstanceFromBackup
      git cherry-pick 50d79f98605fbfe33505c215ccb724e9eba05b93  # lxd/storage/drivers/generic/vfs: Sets block volume size to file size of volume in tarball in genericVFSBackupUnpack
      git cherry-pick e1e805880dbaaecd367fe8e876dae14a1984e79f  # lxd/storage/drivers/driver/btrfs/volumes: No need to move GPT header if no filler used in CreateVolume
      git cherry-pick a6d5a56c6e7c172ebb2439840c6ac13db0f34e65  # lxd/storage/drivers/driver/btrfs/volumes: Skip GPT header move in SetVolumeQuota when allowUnsafeResize is enabled
      git cherry-pick a1dd144e05899f98fb09d51a07da218bffa2c5d6  # lxd/storage/drivers/driver/dir/volumes: Skip GPT header move in SetVolumeQuota when allowUnsafeResize is enabled
      git cherry-pick 1744f91cb52d9ea1dc1b339d9ee29b1f97d5315d  # lxd/storage/drivers/driver/lvm/volumes: Allow unsafe shrinking when allowUnsafeResize is enabled
      git cherry-pick cedfc8b7646e994352d3c9b1f1929c94bd351960  # lxd/storage/drivers/driver/zfs/volumes: Allow unsafe shrinking when allowUnsafeResize is enabled
      git cherry-pick 19c7dadb6a04413307026a07d9f42a088a64a027  # lxd/storage/drivers/driver/ceph/volumes: Allow unsafe shrinking when allowUnsafeResize is enabled
      git cherry-pick afb9172f3af2b806a2bd5ed4951110fa885df4aa  # lxd/db: Rename InstanceNames to GetInstanceNames
      git cherry-pick 99125274126b335670e5cb55554427fada6433c6  # lxd/db: Rename ContainerNodeAddress to GetNodeAddressOfInstance
      git cherry-pick 81a83fdd13e68c4862f6926e07d4dab95c8b4c15  # lxd/db: Rename ContainersListByNodeAddress to GetInstanceNamesByNodeAddress
      git cherry-pick 31eeab8418c7a8611468110ba227370107964960  # lxd/db: Rename ContainersByNodeName to GetInstanceToNodeMap
      git cherry-pick 612f9712b0db9e0b1251011a5983260b28d0023a  # lxd/db: Rename ContainerNodeMove to UpdateInstanceNode
      git cherry-pick b36d3064ad6365e904afc7503c1b24cfbaf4c843  # lxd/db: Rename ContainerNodeProjectList to GetLocalInstancesInProject
      git cherry-pick b6025db0459dcd6ad933dd8c78995eea693bd03c  # lxd/db: Rename ContainerConfigInsert to CreateInstanceConfig
      git cherry-pick ab78f59ee65358ce7c41280794ffcfdccee6b5c3  # lxd/db: Rename ContainerConfigUpdate to UpdateInstanceConfig
      git cherry-pick 676bb32f99e81b8c7a0c91193c66f982924bcc46  # lxd/db: Rename InstanceRemove to RemoveInstance
      git cherry-pick 386d7704d3260189e95a62aebf0ae850dc43c9ca  # lxd/db: Rename ContainerProjectAndName to GetInstanceProjectAndName
      git cherry-pick 70412decda9d41e2b1d01f52f447acd492734903  # lxd/db: Rename ContainerConfigClear to DeleteInstanceConfig
      git cherry-pick 8c04295d8c2599003dee6f0a52b7e072389e3ea1  # lxd/db: Rename ContainerConfigGet to GetInstanceConfig
      git cherry-pick d58aab6e44e7e34c5e7f0351b0d38225f6addc2f  # lxd/db: Rename ContainerConfigRemove to DeleteInstanceConfigKey
      git cherry-pick 1a01b07b4f49c5f24d19be49c00f5de4d1632270  # lxd/db: Rename ContainerSetStateful to UpdateInstanceStatefulFlag
      git cherry-pick ac04592170fb79c55b1db04e2f496821fee106de  # lxd/db: Rename ContainerProfilesInsert to AddProfilesToInstance
      git cherry-pick a9807280f9f4d86b70a615f9d42a59f8eaeaf8e7  # lxd/db: Drop unused ContainerProfiles
      git cherry-pick e6055551c8845a2d50aa90327ae0ababcd6e4a55  # lxd/db: Drop unused ContainerConfig
      git cherry-pick 64cbd2619a5ef624ebb655f8d971be9829c04427  # lxd/db: Remove unused ContainersNodeList
      git cherry-pick 06cdc378ba9fd40e0a82f3f7fcf355985a06d7af  # lxd/db: Rename ContainersResetState to ResetInstancesPowerState
      git cherry-pick 26c4f8b11be08e8fddd36b99aae28adf89f440c3  # lxd/db: Rename ContainerSetState to UpdateInstancePowerState
      git cherry-pick 93ee2f3e6606c3ca1f6f5b83ed1a2487ae974a39  # lxd/db: Rename ContainerUpdate to UpdateInstance
      git cherry-pick 4c0e6b31e6a308bca4557517cf8a79a2f5d24298  # lxd/db: Rename InstanceSnapshotCreationUpdate to UpdateInstanceSnapshotCreationDate
      git cherry-pick bf68759d3602878bce7b3690d7f4e07714fb49ff  # lxd/db: Rename ContainerLastUsedUpdate to UpdateInstanceLastUsedDate
      git cherry-pick 0e234b997795ce560f084a9dd4096ec4a9685274  # lxd/db: Rename ContainerGetSnapshots to GetInstanceSnapshotsNames
      git cherry-pick 31dc9e244a11db0b1d1974a3a7edc0e3186d799b  # lxd/db: Rename ContainerNextSnapshot to GetNextInstanceSnapshotIndex
      git cherry-pick 6d9f6c377ff9b066878296cdddc83692c0c9ef61  # lxd/db: Rename InstancePool to GetInstancePool
      git cherry-pick fff7f6b7788bfe77dcf46deacb3287be9a7ebbe0  # lxd/db: Rename ContainerBackupID to getInstanceBackupID
      git cherry-pick dd4706117adee09129a546c615c34ea3094310de  # Rename ContainerGetBackup to GetInstanceBackup
      git cherry-pick 9fa3b01f22477b3f8335dd46e9dcf9046feecf21  # lxd/db: Rename InstanceCreateBackup to CreateInstanceBackup
      git cherry-pick fdb6b57e97b6f37eec7ef50dabbb3fed229c4423  # lxd/db: Rename InstanceBackupRemove to DeleteInstanceBackup
      git cherry-pick bc906acd9cb6ef730a8864a7931c7cede118810b  # lxd/db: ContainerBackupRename to RenameInstanceBackup
      git cherry-pick a272ee7c075a631d5a48c5c828e21e7035275f4e  # lxd/db: Rename ContainerBackupsGetExpired to GetExpiredInstanceBackups
      git cherry-pick 85184bd7050b70ed0022635d7c2aee90a1828b50  # lxd/storage/drivers/utils: Updates roundVolumeBlockFileSizeBytes and ensureVolumeBlockFile to take size as bytes
      git cherry-pick ed02d2b7298d59813922cb4b27650a4eb279dc5a  # lxd/storage/drivers/generic/vfs: Updates genericVFSResizeBlockFile to accept size as bytes
      git cherry-pick 2f2a62d923136d2fd720055e4cef13d5e774258b  # lxd/storage/drivers/driver/btrfs/utils: Adds volumeSize function
      git cherry-pick 173e7a0225ab1dcaeadcd3f199a1dca6f7870adc  # lxd/storage/drivers/driver/btrfs/volumes: Updates CreateVolume to use volumeSize()
      git cherry-pick 2e3c5a23b4ed3124b8ba529b65bea0a707feb919  # lxd/storage/drivers/driver/btrfs/volumes: Updates SetVolumeQuota to be byte oriented internally
      git cherry-pick 0093df46cf44d1a6ebaf0904b1cfa5f3c174ef4d  # lxd/storage/drivers/driver/ceph/utils: Updates volumeSize comment for consistency
      git cherry-pick 93357cd7225bccfd85e3f90753901f4e9a907c56  # lxd/storage/drivers/driver/ceph/volumes: Updates CreateVolumeFromCopy to use volumeSize()
      git cherry-pick 5092b76d49178dcac5b2cc14000ffa961f439d51  # lxd/storage/drivers/driver/ceph/volumes: Updates SetVolumeQuota to be byte oriented internally
      git cherry-pick 1a7887ec52592477c48c6eefedaa44671d52fef9  # lxd/storage/drivers/driver/dir/utils: Adds volumeSize function
      git cherry-pick da6bc47fc0039621bffc01c43aa419dfebe7250e  # lxd/storage/drivers/driver/dir/volumes: Updates CreateVolume to use volumeSize
      git cherry-pick b14165a3b5beca1aa7b2d65b28fe33ee292105bd  # lxd/storage/drivers/driver/dir/volumes: Updates SetVolumeQuota to be byte oriented internally
      git cherry-pick f9c06471aa4ce7e0149a1053af48e9cf77ea61c7  # lxd/storage/drivers/driver/lvm/utils: Updates copyThinpoolVolume to use volumeSize()
      git cherry-pick 3158c186620b3ce8417821a8a8b8b48f1c58e979  # lxd/storage/drivers/driver/lvm/volumes: Updates SetVolumeQuota variables and comments
      git cherry-pick 5c074fdb7a92471902b7027a51ac4866b11d290b  # lxd/storage/drivers/driver/zfs/utils: Adds volumeSize function
      git cherry-pick 9899586adad1b27c5d98de49e94524dcba6f9fd2  # lxd/storage/drivers/driver/zfs/volumes: Updates CreateVolume to use volumeSize()
      git cherry-pick 089ced64214211c4d3e0069ed218ea5d41978570  # lxd/storage/drivers/driver/zfs/volumes: Updates CreateVolumeFromCopy to use volumeSize()
      git cherry-pick 4a8dd0008ad762d3d1b4829471ea8b996ef7b427  # lxd/storage/drivers/driver/zfs/volumes: Updates SetVolumeQuota to be byte oriented internally
      git cherry-pick 02fff5f11c52b162e5add3f78f972b6bc4d0cf7d  # lxd/db: Rename DevicesAdd to AddDevicesToEntity
      git cherry-pick 2d854bd21eb30a24885dc2e3252b4817190941d8  # lxd/storage/backend/lxd: Detect cached image filesystem changes for VM images too
      git cherry-pick e6f4abcaf8704c9a02c4a8285f7916cb2c2ce0c7  # lxd/db: Remove unused Devices
      git cherry-pick 5ca738f3df65d697dcba37dfdda6cf84d9da3c2c  # lxd/db: Rename ImagesGetLocal to GetLocalImages
      git cherry-pick c205e8d28848a1a47acda29ef694188829b6b49f  # lxd/db: Rename ImagesGet to GetImages
      git cherry-pick 006cec454574f881e5d6fb50736fb7afee504aaf  # lxd/db: Rename ImagesGetExpired to GetExpiredImages
      git cherry-pick 9433020dc3bc47f5f8e1074ec74b5f651511c2a9  # lxd/db: Rename ImageSourceInsert to CreateImageSource
      git cherry-pick 630266b241b2b0c37e5004f9b6f616f2e6aa2b6d  # lxd/db: Rename ImageSourceGet to GetImageSource
      git cherry-pick 072fb7b9c41880dd2e06e615b23af4a9f1e13462  # lxd/db: Rename ImageGetFromAnyProject to GetImageFromAnyProject
      git cherry-pick e536b8d6ff3ae7e46188aeda98f9910ea9cc2b8f  # lxd/db: Rename ImageLocate to LocateImage
      git cherry-pick bd78e0587667c17e204ead1356ff095b751f0497  # lxd/db: Rename ImageDelete to DeleteImage
      git cherry-pick 97b32f828b30074d04ff1703c69d25e12280db6d  # lxd/db: Rename ImageAliasesGet GetImageAliases
      git cherry-pick 8d03d1e521e588dcae76d10ac5e0133d2f4abb4a  # lxd/db: Rename ImageAliasGet to GetImageAlaias
      git cherry-pick 23aa5bab8e1280ed1ff83f5d7920e2e39c71853a  # lxd/db: Rename ImageAliasRename to RenameImageAlias
      git cherry-pick c1cbf7e064219ccaaf8f934edce2b0c08048fc5f  # lxd/db: Rename ImageAliasDelete to DeleteImageAlias
      git cherry-pick 19ac7af2fb2c5acdd113f86b500a5da85f485adf  # lxd/db: Rename ImageAliasesMove to MoveImageAlias
      git cherry-pick dba67de2ea722f476fe20516653264b8a12271df  # lxd/db: Rename ImageAliasAdd to CreateImageAlias
      git cherry-pick f50947061640cbaf650de57acc939360c4e1f7ca  # lxd/db: Rename ImageAliasUpdate to UpdateImageAlias
      git cherry-pick af59967ef8ee1cfeb94e44a01243d1c005e11937  # lxd/db: Rename ImageCopyDefaultProfiles to CopyDefaultImageProfiles
      git cherry-pick 06f8038e67663931941ff7d68b7d7d88d6aed342  # lxd/db: Rename ImageLastAccessUpdate to UpdateImageLastUseDate
      git cherry-pick 86cefde06c49bbee7a383a8be6fc2d2352a86aeb  # lxd/db: Rename ImageLastAccessInit to InitImageLastUseDate
      git cherry-pick 87f4261f752f38b67b1758cf7d58ff07f6b322bc  # lxd/db: Rename ImageUpdate to UpdateImage
      git cherry-pick ca633a1a22bcd6237bc37a99e3e0ab673649d673  # lxd/db: Rename ImageInsert to CreateImage
      git cherry-pick 546fce76dfe3725072f7c26b9b39e24da249d966  # lxd/db: Rename ImageGetPools to GetPoolsWithImage
      git cherry-pick 0fcdf9a1a833504c951e0c0151456ac69ffa6f28  # lxd/db: Rename ImageGetPoolNamesFromIDs to GetPoolNamesFromIDs
      git cherry-pick d6a41915201f42a91904d7ce373798881504c053  # lxd/db: Rename ImageUploadedAt to UpdateImageUploadDate
      git cherry-pick 7ca2beb84c7fac245d54ccde42583fd6b9a93120  # lxd/db: Rename ImagesGetOnCurrentNode to GetImagesOnLocalNode
      git cherry-pick a06b6c1989fbf6a994e8a5d72cd2b97d740f887e  # lxd/db: Rename ImagesGetByNodeID to GetImagesOnNode
      git cherry-pick dd72ad1f519243e39fd72307a55d87b2defef43d  # lxd/db: Replace ImageGetNodesWithImage with GetNodesWithImage
      git cherry-pick c7d29c6866cee3a72e2f3ea2a9fa7125fac589af  # lxd/db: Rename ImageGetNodesWithoutImage to GetNodesWithoutImage
      git cherry-pick 8d00c8ba9ac543aaf9d79aab8c2194570b36ea88  # lxc/image: Actually refresh multiple images
      git cherry-pick 2628132ea2c536ad1bbdd5e9a349c54a9122c29c  # lxd/resources: Use permanent MAC when available
      git cherry-pick 19b3ac1df13a49e7d14318157cf8d68a5ea65df5  # lxd/qemu: Restrict NUMA layout to x86_64
      git cherry-pick 9ade049f6e2eab90b896b8bc3b142ebfafc484e0  # Consider all nodes when looking for the leader, not only voters
      git cherry-pick a585ab72234de81b432e74bc7ec57bff4d930882  # Only attempt to transfer leadership if we are not standalone
      git cherry-pick f99103978ba416cb7e24225d21c654ed6cf3e234  # lxd/db: Rename NetworksNodeConfig to GetNetworksLocalConfig
      git cherry-pick c80e52d4ec81bc7d51f66483db9ba8e91eaab4d4  # lxd/db: Rename NetworkIDsNotPending to GetNonPendingNetworkIDs
      git cherry-pick 3274b3c2d1f113ac69111658b3deedeb08b80d04  # lxd/db: Rename NetworkID to GetNetworkID
      git cherry-pick 6176be5b331cb74fcc2b88596fb282906940423e  # lxd/db: Rename NetworkConfigAdd to CreateNetworkConfig
      git cherry-pick e38269844af4b3af46774ad73bdefa14f8312eec  # lxd/db: Rename Networks to GetNetworks
      git cherry-pick 1c2cb74f2ff21294bd9638ce02449b2bd68f7b90  # lxd/db: Rename NetworksNotPending to GetNonPendingNetworks
      git cherry-pick c140027c7010a0a5f439c33915bed8137eee0512  # lxd/db: Rename NetworksNotPending to GetNonNetworks
      git cherry-pick 3213d8bf6863381d41c2d00769a1b036d9d43c53  # lxd/db: Rename NetworkGetInterface to GetNetworkWithInterface
      git cherry-pick 5a33a6331f24a6a85d86fd5d1e4f1f6bb84a1c01  # lxd/db: Rename NetworkConfig to getNetworkConfig
      git cherry-pick bc462a5d898496cd4fe3596a725eb66f024e45bc  # lxd/db: Rename NetworkCreate to CreateNetwork
      git cherry-pick 87bcda10cb23dcfe496d8819cee75eb167e87ed9  # lxd/db: Rename NetworkUpdate to UpdateNetwork
      git cherry-pick d80958c242303f836b7720a815ef9ff6db0c2be7  # lxd/db: Rename NetworkConfigClear to clearNetworkConfig
      git cherry-pick 4eb0f964dc69346884f074805e9c491d86044897  # lxd/db: Rename NetworkDelete to DeleteNetwork
      git cherry-pick 13776f1ac048299395e3acd7bc9ee3d35a33eeb5  # lxd/db: Rename NetworkRename to RenameNetwork
      git cherry-pick 7305407b6b7949bc9f7f095c87b12a9f0549ddbc  # lxd/db: Rename NetworkNodeConfigKeys to NodeSpecificNetworkNodeConfig
      git cherry-pick aeba82796b4d1f5c05bed48c9ed4c45524ad2124  # lxd/db: Rename ImageGet to GetImage
      git cherry-pick 4842c532e0cf07bc25617dc5fa8a64e5c705bdbe  # lxd/db: Rename ImageAssociateNode to AddImageToLocalNode
      git cherry-pick eacaa4c12c62c644c9fe5044e7cefc6562198495  # lxd/daemon: Detect nodev and improve errors
      git cherry-pick eb1461291cec267fce1950a2672f1d5e10f9e472  # lxd/db: Rename NodeByAddress to GetNodeByAddress
      git cherry-pick 673bbb2b7f61781c1ebef041324cb8da62115476  # lxd/db: Rename NodePendingByAddress to GetPendingNodeByAddress
      git cherry-pick c26e4297fc722ed70e6fc8a870b50309cc485ae3  # lxd/db: Rename NodeByName to GetNodeByName
      git cherry-pick 1c0618e7406b46b02683927811bb65759669a140  # lxd/db: Rename NodeName to GetLocalNodeName
      git cherry-pick 082ac40c88388b19e272aa5949b8a0d29ee9b2a6  # lxd/db: Rename NodeAddress to GetLocalNodeAddress
      git cherry-pick 5c831d3d77efe1a06d364176bad0319294ed0fc8  # lxd/db: Rename Nodes to GetNodes
      git cherry-pick 94a0ec4671e6ab3450d81523834fe9134e031c7e  # lxd/db: Rename NodesCount to GetNodesCount
      git cherry-pick 8756ab609ba06abf62ec4e18496f57eadc37c2b0  # lxd/db: Rename NodeRename to RenameNode
      git cherry-pick 77d1087a83c1c77b40532e6ee08c9ba45de4f8f6  # lxd/db: Rename NodeAdd to CreateNode
      git cherry-pick 9004af5d182ef553092df4841bee573a0982379f  # lxd/db: Rename NodeAddWithArch to CreateNodeWithArch
      git cherry-pick 213e430488c6503a30c5f10a7063583c06c1d5ad  # lxd/db: Rename NodePending to SetNodePendingFlag
      git cherry-pick ae5bce006c8e11cfef16051fe88dbe662607f12f  # lxd/db: Rename NodeUpdate to UpdateNode
      git cherry-pick 5871c17ab325a0fb9a0c1d22e5aae4ac1a4f0fcc  # lxd/db: Rename NodeAddRole to CreateNodeRole
      git cherry-pick ebd6abc3c0efa267b8dec3ab66636dd777b78be9  # lxd/db: Rename NodeRemoveRole to RemoveNodeRole
      git cherry-pick 79c952b500df51f4bfbfb5a8db5674efed46c344  # lxd/db: Rename NodeUpdateRoles to UpdateNodeRoles
      git cherry-pick dfdf87c1aa527f9a4e747da378eed82ff9339658  # lxd/db: Rename NodeRemove to RemoveNode
      git cherry-pick c16432ecb87559059f1419641441a6a984074ddd  # lxd/db: Rename NodeHeartbeat to SetNodeHeartbeat
      git cherry-pick bc1b9e5921fa2ab160387c47e2c4613119c12037  # lxd/db: Rename NodeOfflineThreshold to GetNodeOfflineThreshold
      git cherry-pick 3c4752134a02ee270054e5f37f847aea015e1c13  # lxd/db: Rename NodeClear to ClearNode
      git cherry-pick 427ac9ecd7709122a05c46f836fa420260f07248  # lxd/db: Rename NodeWithLeastContainers to GetNodeWithLeastInstances
      git cherry-pick 7771150929da15f9462d26ae33ccf82efd51b1bb  # lxd/db: Rename NodeUpdateVersion to SetNodeVersion
      git cherry-pick d6e4a5f2018819ea2c5db9f93b5db5cfdda5cfa1  # lxd/db: Rename Operations to GetLocalOperations
      git cherry-pick aac55c05ee7414e32d0b3feaf36dea0cc2e845d2  # lxd/db: Rename OperationsUUIDs to GetLocalOperationsUUIDs
      git cherry-pick f2ae1acc3e54442ab46eb0c37d9d876e9d392634  # lxd/db: Rename OperationNodes to GetNodesWithRunningOperations
      git cherry-pick b4d4108ca770923cfdb4a5fc29880d07908f2353  # lxd/db: Rename OperationByUUID to GetOperationByUUID
      git cherry-pick a4a4c8a705a568b7d2b188b9ca32e393d270fd12  # lxd/db: Rename OperationAdd to CreateOperation
      git cherry-pick 005c2715191262fd5ce0d08a9eb115a9263a7ded  # lxd/db: Rename OperationRemove to RemoveOperation
      git cherry-pick e669128cd057f51dadbeced7781d9e4873f24003  # lxd/db: Rename OperationFlush to removeNodeOperations
      git cherry-pick 97448ef145a3ee3221fc936e445443c11d290ecf  # lxd/db: Rename Patches to GetAppliedPatches
      git cherry-pick e8cf703b0743caa1af584bd32f718fcf44905357  # lxd/db: Rename PatchesMarkApplied to MarkPatchAsApplied
      git cherry-pick 4a8e810d8ee0f3a66a7b0e58238bfba33dd80936  # lxd/db: Rename Profiles to GetProfileNames
      git cherry-pick 1bc900e36b0cda90c1e78ccff2fd38b98e64f19e  # lxd/db: Rename ProfileGet to GetProfile
      git cherry-pick 28e5d258ff9207608c17e694521ee55fa495445e  # lxd/db: Rename ProfilesGet to GetProfiles
      git cherry-pick 88dd2da55a8de6f167fb9cd0670994219934a6cb  # lxd/db: Drop ProfileConfig
      git cherry-pick 2c3e9c2ab0f85a985d8ccb973096f5e46de27960  # lxd/db: Rename ProfileDescriptionUpdate to UpdateProfileDescription
      git cherry-pick 8b349148b2e0ed155c3e76d44e44432a5f1754bf  # lxd/db: Rename ProfileConfigClear to ClearProfileConfig
      git cherry-pick d474a27600b33c05f19f4452b1bb64f896f1c0d5  # lxd/db: Rename ProfileConfigAdd to CreateProfileConfig
      git cherry-pick 57044959e7c4d17ce000a9e8ed19972d6a60bd77  # lxd/db: Rename ProfileContainersGet to GetInstancesWithProfile
      git cherry-pick f58545ac039c8cca4fb7b1a267a5d96105693277  # lxd/db: Rename ProfileCleanupLeftover to RemoveUnreferencedProfiles
      git cherry-pick 94a68627ac27e15b25fc1a91f3ae3e59a853e5ec  # lxd/db: Rename ProfilesExpandConfig to ExpandInstanceConfig
      git cherry-pick 016d7ca2abcc58179d8697e96d382fa5231afa2f  # lxd/db: Rename ProfilesExpandDevices to ExpandInstanceDevices

      # Download any new dependencies
      export GOPATH=$(realpath ../go)
      go get -t -d ./...

      # Run the standard build
      set +ex
      snapcraftctl build
      set -ex

      # Build the agent (special build tags)
      go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd-agent" -tags=agent github.com/lxc/lxd/lxd-agent

      # Setup bash completion
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/
      echo 'export PATH="${PATH}:/snap/bin:/var/lib/snapd/snap/bin"' > ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
      cat scripts/bash/lxd-client >> ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/share/misc/: share/misc/
      var/lib/usbutils/usb.ids: share/misc/
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/dnsmasq
      - bin/getfattr
      - bin/setfattr
      - bin/iw
      - bin/pigz
      - bin/rsync
      - bin/setfacl
      - bin/sgdisk
      - bin/unsquashfs
      - bin/xdelta3

      - etc/bash_completion.d/snap.lxd.lxc

      - share/misc

      - bin/lxc
      - bin/lxc-to-lxd
      - bin/lxd
      - bin/lxd-agent
      - bin/lxd-benchmark

  lxd-migrate:
    source: lxd-migrate/
    after:
      - lxd
      - sqlite
    plugin: go
    go-buildtags:
      - libsqlite3
    go-importpath: github.com/lxc/lxd-pkg-snap/lxd-migrate
    override-build: |
      set -ex

      # Setup for our shared libraries
      sed -i "/^\/\*/a #cgo CFLAGS: -I${SNAPCRAFT_STAGE}/include/" ../go/src/github.com/mattn/go-sqlite3/sqlite3.go

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p ${SNAPCRAFT_PART_INSTALL}/bin/
      cp scripts/upgrade-bridge ${SNAPCRAFT_PART_INSTALL}/bin/upgrade-bridge
    prime:
      - bin/lxd-migrate
      - bin/upgrade-bridge

  shmounts:
    source: shmounts/
    plugin: make
    prime:
      - bin/setup-shmounts

  snap-query:
    source: snap-query/
    plugin: go
    go-importpath: github.com/lxc/lxd-pkg-snap/snap-query
    prime:
      - bin/snap-query

  strip:
    source: snapcraft/empty
    after:
      - btrfs
      - ceph
      - dqlite
      - libco
      - libseccomp
      - logrotate
      - lvm
      - nano
      - nvidia-container
      - openvswitch
      - raft
      - sqlite
      - squashfs-tools-ng
      - vim
      - xfs
      - xtables
      - xz
      - zfs-0-6
      - zfs-0-7
      - zfs-0-8
      - lxc
      - lxcfs
      - criu
      - lxd
      - lxd-migrate
      - shmounts
      - snap-query
    plugin: nil
    override-prime: |
      set -x

      # Strip some of the heavy bits
      strip -s ${SNAPCRAFT_PRIME}/bin/lxc
      strip -s ${SNAPCRAFT_PRIME}/bin/lxd*
      strip -s ${SNAPCRAFT_PRIME}/bin/snap*
      strip -s ${SNAPCRAFT_PRIME}/lib/liblxc*
      strip -s ${SNAPCRAFT_PRIME}/lib/libdqlite*
      strip -s ${SNAPCRAFT_PRIME}/lib/libsqlite*

      for zfs in zfs-0.6 zfs-0.7 zfs-0.8; do
          [ ! -d "${SNAPCRAFT_PRIME}/${zfs}" ] && continue
          strip -s ${SNAPCRAFT_PRIME}/${zfs}/bin/* ${SNAPCRAFT_PRIME}/${zfs}/lib/*
      done

      [ -e "${SNAPCRAFT_PRIME}/criu/criu" ] && strip -s ${SNAPCRAFT_PRIME}/criu/criu

      exit 0

  wrappers:
    plugin: dump
    source: snapcraft/
    organize:
      hooks/: snap/hooks/
